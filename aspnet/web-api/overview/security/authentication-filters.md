---
uid: web-api/overview/security/authentication-filters
title: Filtry uwierzytelniania w programie ASP.NET Web API 2 | Microsoft Docs
author: MikeWasson
description: Filtr uwierzytelniania to składnik, który uwierzytelnia żądanie HTTP. Interfejsy Web API 2 i MVC 5 obsługują filtry uwierzytelniania, ale różnią się nieznacznie.
ms.author: riande
ms.date: 09/25/2014
ms.assetid: b9882e53-b3ca-4def-89b0-322846973ccb
msc.legacyurl: /web-api/overview/security/authentication-filters
msc.type: authoredcontent
ms.openlocfilehash: 2ef9e62a6c634237e920b6d7aba2127b835f959d
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: pl-PL
ms.lasthandoff: 03/06/2020
ms.locfileid: "78555889"
---
# <a name="authentication-filters-in-aspnet-web-api-2"></a><span data-ttu-id="c99f8-104">Filtry uwierzytelniania w programie ASP.NET Web API 2</span><span class="sxs-lookup"><span data-stu-id="c99f8-104">Authentication Filters in ASP.NET Web API 2</span></span>

<span data-ttu-id="c99f8-105">według [Jan Wasson](https://github.com/MikeWasson)</span><span class="sxs-lookup"><span data-stu-id="c99f8-105">by [Mike Wasson](https://github.com/MikeWasson)</span></span>

> <span data-ttu-id="c99f8-106">Filtr uwierzytelniania to składnik, który uwierzytelnia żądanie HTTP.</span><span class="sxs-lookup"><span data-stu-id="c99f8-106">An authentication filter is a component that authenticates an HTTP request.</span></span> <span data-ttu-id="c99f8-107">Interfejsy Web API 2 i MVC 5 obsługują filtry uwierzytelniania, ale różnią się one nieznacznie w odniesieniu do konwencji nazewnictwa dla interfejsu filtru.</span><span class="sxs-lookup"><span data-stu-id="c99f8-107">Web API 2 and MVC 5 both support authentication filters, but they differ slightly, mostly in the naming conventions for the filter interface.</span></span> <span data-ttu-id="c99f8-108">W tym temacie opisano filtry uwierzytelniania interfejsu API sieci Web.</span><span class="sxs-lookup"><span data-stu-id="c99f8-108">This topic describes Web API authentication filters.</span></span>

<span data-ttu-id="c99f8-109">Filtry uwierzytelniania umożliwiają ustawienie schematu uwierzytelniania dla poszczególnych kontrolerów lub akcji.</span><span class="sxs-lookup"><span data-stu-id="c99f8-109">Authentication filters let you set an authentication scheme for individual controllers or actions.</span></span> <span data-ttu-id="c99f8-110">Dzięki temu aplikacja może obsługiwać różne mechanizmy uwierzytelniania dla różnych zasobów HTTP.</span><span class="sxs-lookup"><span data-stu-id="c99f8-110">That way, your app can support different authentication mechanisms for different HTTP resources.</span></span>

<span data-ttu-id="c99f8-111">W tym artykule pokazywać kod z przykładu [uwierzytelniania podstawowego](https://github.com/aspnet/samples/tree/master/samples/aspnet/WebApi/BasicAuthentication) na [https://github.com/aspnet/samples](https://github.com/aspnet/samples).</span><span class="sxs-lookup"><span data-stu-id="c99f8-111">In this article, I'll show code from the [Basic Authentication](https://github.com/aspnet/samples/tree/master/samples/aspnet/WebApi/BasicAuthentication) sample on [https://github.com/aspnet/samples](https://github.com/aspnet/samples).</span></span> <span data-ttu-id="c99f8-112">Przykład pokazuje filtr uwierzytelniania, który implementuje schemat uwierzytelniania dostępu podstawowego protokołu HTTP (RFC 2617).</span><span class="sxs-lookup"><span data-stu-id="c99f8-112">The sample shows an authentication filter that implements the HTTP Basic Access Authentication scheme (RFC 2617).</span></span> <span data-ttu-id="c99f8-113">Filtr jest zaimplementowany w klasie o nazwie `IdentityBasicAuthenticationAttribute`.</span><span class="sxs-lookup"><span data-stu-id="c99f8-113">The filter is implemented in a class named `IdentityBasicAuthenticationAttribute`.</span></span> <span data-ttu-id="c99f8-114">Nie pokazujemy całego kodu z próbki, tylko części, które ilustrują sposób pisania filtru uwierzytelniania.</span><span class="sxs-lookup"><span data-stu-id="c99f8-114">I won't show all of the code from the sample, just the parts that illustrate how to write an authentication filter.</span></span>

## <a name="setting-an-authentication-filter"></a><span data-ttu-id="c99f8-115">Ustawianie filtru uwierzytelniania</span><span class="sxs-lookup"><span data-stu-id="c99f8-115">Setting an Authentication Filter</span></span>

<span data-ttu-id="c99f8-116">Podobnie jak w przypadku innych filtrów, filtry uwierzytelniania mogą być stosowane do poszczególnych kontrolerów interfejsu API sieci Web.</span><span class="sxs-lookup"><span data-stu-id="c99f8-116">Like other filters, authentication filters can be applied per-controller, per-action, or globally to all Web API controllers.</span></span>

<span data-ttu-id="c99f8-117">Aby zastosować filtr uwierzytelniania do kontrolera, dekorować klasę kontrolera z atrybutem Filter.</span><span class="sxs-lookup"><span data-stu-id="c99f8-117">To apply an authentication filter to a controller, decorate the controller class with the filter attribute.</span></span> <span data-ttu-id="c99f8-118">Poniższy kod ustawia filtr `[IdentityBasicAuthentication]` dla klasy kontrolera, co umożliwia uwierzytelnianie podstawowe dla wszystkich akcji kontrolera.</span><span class="sxs-lookup"><span data-stu-id="c99f8-118">The following code sets the `[IdentityBasicAuthentication]` filter on a controller class, which enables Basic Authentication for all of the controller's actions.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample1.cs)]

<span data-ttu-id="c99f8-119">Aby zastosować filtr do jednej akcji, dekorować akcję z filtrem.</span><span class="sxs-lookup"><span data-stu-id="c99f8-119">To apply the filter to one action, decorate the action with the filter.</span></span> <span data-ttu-id="c99f8-120">Poniższy kod ustawia filtr `[IdentityBasicAuthentication]` na metodzie `Post` kontrolera.</span><span class="sxs-lookup"><span data-stu-id="c99f8-120">The following code sets the `[IdentityBasicAuthentication]` filter on the controller's `Post` method.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample2.cs)]

<span data-ttu-id="c99f8-121">Aby zastosować filtr do wszystkich kontrolerów internetowego interfejsu API, Dodaj go do **GlobalConfiguration. filters**.</span><span class="sxs-lookup"><span data-stu-id="c99f8-121">To apply the filter to all Web API controllers, add it to **GlobalConfiguration.Filters**.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample3.cs)]

## <a name="implementing-a-web-api-authentication-filter"></a><span data-ttu-id="c99f8-122">Implementowanie filtru uwierzytelniania interfejsu API sieci Web</span><span class="sxs-lookup"><span data-stu-id="c99f8-122">Implementing a Web API Authentication Filter</span></span>

<span data-ttu-id="c99f8-123">W interfejsie API sieci Web filtry uwierzytelniania implementują interfejs [System. Web. http. filters. IAuthenticationFilter](https://msdn.microsoft.com/library/system.web.http.filters.iauthenticationfilter.aspx) .</span><span class="sxs-lookup"><span data-stu-id="c99f8-123">In Web API, authentication filters implement the [System.Web.Http.Filters.IAuthenticationFilter](https://msdn.microsoft.com/library/system.web.http.filters.iauthenticationfilter.aspx) interface.</span></span> <span data-ttu-id="c99f8-124">Powinny one również dziedziczyć z **System. Attribute**, aby można było je zastosować jako atrybuty.</span><span class="sxs-lookup"><span data-stu-id="c99f8-124">They should also inherit from **System.Attribute**, in order to be applied as attributes.</span></span>

<span data-ttu-id="c99f8-125">Interfejs **IAuthenticationFilter** ma dwie metody:</span><span class="sxs-lookup"><span data-stu-id="c99f8-125">The **IAuthenticationFilter** interface has two methods:</span></span>

- <span data-ttu-id="c99f8-126">**AuthenticateAsync** uwierzytelnia żądanie, sprawdzając poświadczenia w żądaniu, jeśli są obecne.</span><span class="sxs-lookup"><span data-stu-id="c99f8-126">**AuthenticateAsync** authenticates the request by validating credentials in the request, if present.</span></span>
- <span data-ttu-id="c99f8-127">**ChallengeAsync** dodaje wyzwanie uwierzytelniania do odpowiedzi HTTP, w razie potrzeby.</span><span class="sxs-lookup"><span data-stu-id="c99f8-127">**ChallengeAsync** adds an authentication challenge to the HTTP response, if needed.</span></span>

<span data-ttu-id="c99f8-128">Metody te odnoszą się do przepływu uwierzytelniania zdefiniowanego w [rfc 2612](http://tools.ietf.org/html/rfc2616) i [RFC 2617](http://tools.ietf.org/html/rfc2617):</span><span class="sxs-lookup"><span data-stu-id="c99f8-128">These methods correspond to the authentication flow defined in [RFC 2612](http://tools.ietf.org/html/rfc2616) and [RFC 2617](http://tools.ietf.org/html/rfc2617):</span></span>

1. <span data-ttu-id="c99f8-129">Klient wysyła poświadczenia w nagłówku autoryzacji.</span><span class="sxs-lookup"><span data-stu-id="c99f8-129">The client sends credentials in the Authorization header.</span></span> <span data-ttu-id="c99f8-130">Zwykle dzieje się tak, gdy klient otrzymuje odpowiedź 401 (nieautoryzowaną) z serwera.</span><span class="sxs-lookup"><span data-stu-id="c99f8-130">This typically happens after the client receives a 401 (Unauthorized) response from the server.</span></span> <span data-ttu-id="c99f8-131">Klient może jednak wysyłać poświadczenia z dowolnym żądaniem, a nie zaraz po otrzymaniu 401.</span><span class="sxs-lookup"><span data-stu-id="c99f8-131">However, a client can send credentials with any request, not just after getting a 401.</span></span>
2. <span data-ttu-id="c99f8-132">Jeśli serwer nie akceptuje poświadczeń, zwraca odpowiedź 401 (bez autoryzacji).</span><span class="sxs-lookup"><span data-stu-id="c99f8-132">If the server does not accept the credentials, it returns a 401 (Unauthorized) response.</span></span> <span data-ttu-id="c99f8-133">Odpowiedź zawiera nagłówek WWW-Authenticate, który zawiera jedno lub kilka wyzwań.</span><span class="sxs-lookup"><span data-stu-id="c99f8-133">The response includes a Www-Authenticate header that contains one or more challenges.</span></span> <span data-ttu-id="c99f8-134">Każde wyzwanie określa schemat uwierzytelniania rozpoznany przez serwer.</span><span class="sxs-lookup"><span data-stu-id="c99f8-134">Each challenge specifies an authentication scheme recognized by the server.</span></span>

<span data-ttu-id="c99f8-135">Serwer może również zwrócić 401 z anonimowego żądania.</span><span class="sxs-lookup"><span data-stu-id="c99f8-135">The server can also return 401 from an anonymous request.</span></span> <span data-ttu-id="c99f8-136">W rzeczywistości zazwyczaj jest inicjowany proces uwierzytelniania:</span><span class="sxs-lookup"><span data-stu-id="c99f8-136">In fact, that's typically how the authentication process is initiated:</span></span>

1. <span data-ttu-id="c99f8-137">Klient wysyła żądanie anonimowe.</span><span class="sxs-lookup"><span data-stu-id="c99f8-137">The client sends an anonymous request.</span></span>
2. <span data-ttu-id="c99f8-138">Serwer zwraca 401.</span><span class="sxs-lookup"><span data-stu-id="c99f8-138">The server returns 401.</span></span>
3. <span data-ttu-id="c99f8-139">Klienci ponownie wysyłają żądanie z poświadczeniami.</span><span class="sxs-lookup"><span data-stu-id="c99f8-139">The clients resends the request with credentials.</span></span>

<span data-ttu-id="c99f8-140">Ten przepływ obejmuje procedurę *uwierzytelniania* i *autoryzacji* .</span><span class="sxs-lookup"><span data-stu-id="c99f8-140">This flow includes both *authentication* and *authorization* steps.</span></span>

- <span data-ttu-id="c99f8-141">Uwierzytelnianie udowadnia tożsamość klienta.</span><span class="sxs-lookup"><span data-stu-id="c99f8-141">Authentication proves the identity of the client.</span></span>
- <span data-ttu-id="c99f8-142">Autoryzacja określa, czy klient może uzyskać dostęp do określonego zasobu.</span><span class="sxs-lookup"><span data-stu-id="c99f8-142">Authorization determines whether the client can access a particular resource.</span></span>

<span data-ttu-id="c99f8-143">W interfejsie API sieci Web filtry uwierzytelniania obsługują uwierzytelnianie, ale nie autoryzację.</span><span class="sxs-lookup"><span data-stu-id="c99f8-143">In Web API, authentication filters handle authentication, but not authorization.</span></span> <span data-ttu-id="c99f8-144">Autoryzacja powinna odbywać się przez filtr autoryzacji lub wewnątrz akcji kontrolera.</span><span class="sxs-lookup"><span data-stu-id="c99f8-144">Authorization should be done by an authorization filter or inside the controller action.</span></span>

<span data-ttu-id="c99f8-145">Oto przepływ w potoku Web API 2:</span><span class="sxs-lookup"><span data-stu-id="c99f8-145">Here is the flow in the Web API 2 pipeline:</span></span>

1. <span data-ttu-id="c99f8-146">Przed wywołaniem akcji interfejs API sieci Web tworzy listę filtrów uwierzytelniania dla tej akcji.</span><span class="sxs-lookup"><span data-stu-id="c99f8-146">Before invoking an action, Web API creates a list of the authentication filters for that action.</span></span> <span data-ttu-id="c99f8-147">Obejmuje to filtry z zakresem akcji, zakresem kontrolera i zakresem globalnym.</span><span class="sxs-lookup"><span data-stu-id="c99f8-147">This includes filters with action scope, controller scope, and global scope.</span></span>
2. <span data-ttu-id="c99f8-148">Interfejs API sieci Web wywołuje **AuthenticateAsync** na każdym filtrze na liście.</span><span class="sxs-lookup"><span data-stu-id="c99f8-148">Web API calls **AuthenticateAsync** on every filter in the list.</span></span> <span data-ttu-id="c99f8-149">Każdy filtr może sprawdzać poprawność poświadczeń w żądaniu.</span><span class="sxs-lookup"><span data-stu-id="c99f8-149">Each filter can validate credentials in the request.</span></span> <span data-ttu-id="c99f8-150">Jeśli dowolny filtr pomyślnie sprawdza poprawność poświadczeń, filtr tworzy **IPrincipal** i dołącza go do żądania.</span><span class="sxs-lookup"><span data-stu-id="c99f8-150">If any filter successfully validates credentials, the filter creates an **IPrincipal** and attaches it to the request.</span></span> <span data-ttu-id="c99f8-151">Filtr może również wyzwolić błąd w tym momencie.</span><span class="sxs-lookup"><span data-stu-id="c99f8-151">A filter can also trigger an error at this point.</span></span> <span data-ttu-id="c99f8-152">Jeśli tak, pozostała część potoku nie zostanie uruchomiona.</span><span class="sxs-lookup"><span data-stu-id="c99f8-152">If so, the rest of the pipeline does not run.</span></span>
3. <span data-ttu-id="c99f8-153">Przy założeniu, że nie ma żadnych błędów, żądanie przepływa przez resztę potoku.</span><span class="sxs-lookup"><span data-stu-id="c99f8-153">Assuming there is no error, the request flows through the rest of the pipeline.</span></span>
4. <span data-ttu-id="c99f8-154">Na koniec interfejs API sieci Web wywołuje metodę **ChallengeAsync** każdego filtru uwierzytelniania.</span><span class="sxs-lookup"><span data-stu-id="c99f8-154">Finally, Web API calls every authentication filter's **ChallengeAsync** method.</span></span> <span data-ttu-id="c99f8-155">Filtry używają tej metody w celu dodania wyzwania do odpowiedzi, w razie potrzeby.</span><span class="sxs-lookup"><span data-stu-id="c99f8-155">Filters use this method to add a challenge to the response, if needed.</span></span> <span data-ttu-id="c99f8-156">Zwykle (ale nie zawsze), co się stanie w odpowiedzi na błąd 401.</span><span class="sxs-lookup"><span data-stu-id="c99f8-156">Typically (but not always) that would happen in response to a 401 error.</span></span>

<span data-ttu-id="c99f8-157">Na poniższych diagramach przedstawiono dwa możliwe przypadki.</span><span class="sxs-lookup"><span data-stu-id="c99f8-157">The following diagrams show two possible cases.</span></span> <span data-ttu-id="c99f8-158">W pierwszej kolejności filtr uwierzytelniania pomyślnie uwierzytelnia żądanie, filtr autoryzacji autoryzuje żądanie, a akcja kontrolera zwraca 200 (OK).</span><span class="sxs-lookup"><span data-stu-id="c99f8-158">In the first, the authentication filter successfully authenticates the request, an authorization filter authorizes the request, and the controller action returns 200 (OK).</span></span>

![](authentication-filters/_static/image1.png)

<span data-ttu-id="c99f8-159">W drugim przykładzie filtr uwierzytelniania uwierzytelnia żądanie, ale filtr autoryzacji zwraca 401 (bez autoryzacji).</span><span class="sxs-lookup"><span data-stu-id="c99f8-159">In the second example, the authentication filter authenticates the request, but the authorization filter returns 401 (Unauthorized).</span></span> <span data-ttu-id="c99f8-160">W takim przypadku akcja kontrolera nie zostanie wywołana.</span><span class="sxs-lookup"><span data-stu-id="c99f8-160">In this case, the controller action is not invoked.</span></span> <span data-ttu-id="c99f8-161">Filtr uwierzytelniania dodaje nagłówek WWW-Authenticate do odpowiedzi.</span><span class="sxs-lookup"><span data-stu-id="c99f8-161">The authentication filter adds a Www-Authenticate header to the response.</span></span>

![](authentication-filters/_static/image2.png)

<span data-ttu-id="c99f8-162">Inne kombinacje są możliwe&mdash;na przykład, jeśli akcja kontrolera zezwala na żądania anonimowe, może istnieć filtr uwierzytelniania, ale brak autoryzacji.</span><span class="sxs-lookup"><span data-stu-id="c99f8-162">Other combinations are possible&mdash;for example, if the controller action allows anonymous requests, you might have an authentication filter but no authorization.</span></span>

## <a name="implementing-the-authenticateasync-method"></a><span data-ttu-id="c99f8-163">Implementowanie metody AuthenticateAsync</span><span class="sxs-lookup"><span data-stu-id="c99f8-163">Implementing the AuthenticateAsync Method</span></span>

<span data-ttu-id="c99f8-164">Metoda **AuthenticateAsync** próbuje uwierzytelnić żądanie.</span><span class="sxs-lookup"><span data-stu-id="c99f8-164">The **AuthenticateAsync** method tries to authenticate the request.</span></span> <span data-ttu-id="c99f8-165">W tym miejscu znajduje się sygnatura metody:</span><span class="sxs-lookup"><span data-stu-id="c99f8-165">Here is the method signature:</span></span>

[!code-csharp[Main](authentication-filters/samples/sample4.cs)]

<span data-ttu-id="c99f8-166">Metoda **AuthenticateAsync** musi wykonać jedną z następujących czynności:</span><span class="sxs-lookup"><span data-stu-id="c99f8-166">The **AuthenticateAsync** method must do one of the following:</span></span>

1. <span data-ttu-id="c99f8-167">Nic (No-op).</span><span class="sxs-lookup"><span data-stu-id="c99f8-167">Nothing (no-op).</span></span>
2. <span data-ttu-id="c99f8-168">Utwórz element **IPrincipal** i ustaw go na żądanie.</span><span class="sxs-lookup"><span data-stu-id="c99f8-168">Create an **IPrincipal** and set it on the request.</span></span>
3. <span data-ttu-id="c99f8-169">Ustaw wynik błędu.</span><span class="sxs-lookup"><span data-stu-id="c99f8-169">Set an error result.</span></span>

<span data-ttu-id="c99f8-170">Opcja (1) oznacza, że żądanie nie miało żadnych poświadczeń, które rozpoznaje filtr.</span><span class="sxs-lookup"><span data-stu-id="c99f8-170">Option (1) means the request did not have any credentials that the filter understands.</span></span> <span data-ttu-id="c99f8-171">Opcja (2) oznacza, że filtr pomyślnie uwierzytelnił żądanie.</span><span class="sxs-lookup"><span data-stu-id="c99f8-171">Option (2) means the filter successfully authenticated the request.</span></span> <span data-ttu-id="c99f8-172">Opcja (3) oznacza, że żądanie miało nieprawidłowe poświadczenia (takie jak nieprawidłowe hasło), które wyzwala odpowiedź na błąd.</span><span class="sxs-lookup"><span data-stu-id="c99f8-172">Option (3) means the request had invalid credentials (like the wrong password), which triggers an error response.</span></span>

<span data-ttu-id="c99f8-173">Oto ogólny zarys implementacji **AuthenticateAsync**.</span><span class="sxs-lookup"><span data-stu-id="c99f8-173">Here is a general outline for implementing **AuthenticateAsync**.</span></span>

1. <span data-ttu-id="c99f8-174">Wyszukaj poświadczenia w żądaniu.</span><span class="sxs-lookup"><span data-stu-id="c99f8-174">Look for credentials in the request.</span></span>
2. <span data-ttu-id="c99f8-175">Jeśli nie ma żadnych poświadczeń, nic nie rób i zwróć (No-op).</span><span class="sxs-lookup"><span data-stu-id="c99f8-175">If there are no credentials, do nothing and return (no-op).</span></span>
3. <span data-ttu-id="c99f8-176">Jeśli istnieją poświadczenia, ale filtr nie rozpoznaje schematu uwierzytelniania, nic nie rób ani nie zwraca (No-op).</span><span class="sxs-lookup"><span data-stu-id="c99f8-176">If there are credentials but the filter does not recognize the authentication scheme, do nothing and return (no-op).</span></span> <span data-ttu-id="c99f8-177">Inny filtr w potoku może zrozumieć schemat.</span><span class="sxs-lookup"><span data-stu-id="c99f8-177">Another filter in the pipeline might understand the scheme.</span></span>
4. <span data-ttu-id="c99f8-178">Jeśli istnieją poświadczenia zrozumiałe dla filtru, spróbuj je uwierzytelnić.</span><span class="sxs-lookup"><span data-stu-id="c99f8-178">If there are credentials that the filter understands, try to authenticate them.</span></span>
5. <span data-ttu-id="c99f8-179">Jeśli poświadczenia są nieprawidłowe, zwróć 401 przez ustawienie `context.ErrorResult`.</span><span class="sxs-lookup"><span data-stu-id="c99f8-179">If the credentials are bad, return 401 by setting `context.ErrorResult`.</span></span>
6. <span data-ttu-id="c99f8-180">Jeśli poświadczenia są prawidłowe, Utwórz **IPrincipal** i ustaw `context.Principal`.</span><span class="sxs-lookup"><span data-stu-id="c99f8-180">If the credentials are valid, create an **IPrincipal** and set `context.Principal`.</span></span>

<span data-ttu-id="c99f8-181">W poniższym kodzie przedstawiono metodę **AuthenticateAsync** z przykładu [podstawowego uwierzytelniania](https://github.com/aspnet/samples/tree/master/samples/aspnet/WebApi/BasicAuthentication) .</span><span class="sxs-lookup"><span data-stu-id="c99f8-181">The follow code shows the **AuthenticateAsync** method from the [Basic Authentication](https://github.com/aspnet/samples/tree/master/samples/aspnet/WebApi/BasicAuthentication) sample.</span></span> <span data-ttu-id="c99f8-182">Komentarze wskazują każdy krok.</span><span class="sxs-lookup"><span data-stu-id="c99f8-182">The comments indicate each step.</span></span> <span data-ttu-id="c99f8-183">Kod pokazuje kilka typów błędu: nagłówek autoryzacji bez poświadczeń, źle sformułowane poświadczenia i zła nazwa użytkownika/hasło.</span><span class="sxs-lookup"><span data-stu-id="c99f8-183">The code shows several types of error: An Authorization header with no credentials, malformed credentials, and bad username/password.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample5.cs)]

## <a name="setting-an-error-result"></a><span data-ttu-id="c99f8-184">Ustawianie wyniku błędu</span><span class="sxs-lookup"><span data-stu-id="c99f8-184">Setting an Error Result</span></span>

<span data-ttu-id="c99f8-185">Jeśli poświadczenia są nieprawidłowe, filtr musi ustawić `context.ErrorResult` na **IHttpActionResult** , który tworzy odpowiedź na błąd.</span><span class="sxs-lookup"><span data-stu-id="c99f8-185">If the credentials are invalid, the filter must set `context.ErrorResult` to an **IHttpActionResult** that creates an error response.</span></span> <span data-ttu-id="c99f8-186">Aby uzyskać więcej informacji na temat **IHttpActionResult**, zobacz [wyniki akcji w interfejsie Web API 2](../getting-started-with-aspnet-web-api/action-results.md).</span><span class="sxs-lookup"><span data-stu-id="c99f8-186">For more information about **IHttpActionResult**, see [Action Results in Web API 2](../getting-started-with-aspnet-web-api/action-results.md).</span></span>

<span data-ttu-id="c99f8-187">Przykład uwierzytelniania podstawowego zawiera klasę `AuthenticationFailureResult`, która jest odpowiednia do tego celu.</span><span class="sxs-lookup"><span data-stu-id="c99f8-187">The Basic Authentication sample includes an `AuthenticationFailureResult` class that is suitable for this purpose.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample6.cs)]

## <a name="implementing-challengeasync"></a><span data-ttu-id="c99f8-188">Implementowanie ChallengeAsync</span><span class="sxs-lookup"><span data-stu-id="c99f8-188">Implementing ChallengeAsync</span></span>

<span data-ttu-id="c99f8-189">Celem metody **ChallengeAsync** jest dodanie wyzwań uwierzytelniania do odpowiedzi, w razie potrzeby.</span><span class="sxs-lookup"><span data-stu-id="c99f8-189">The purpose of the **ChallengeAsync** method is to add authentication challenges to the response, if needed.</span></span> <span data-ttu-id="c99f8-190">W tym miejscu znajduje się sygnatura metody:</span><span class="sxs-lookup"><span data-stu-id="c99f8-190">Here is the method signature:</span></span>

[!code-csharp[Main](authentication-filters/samples/sample7.cs)]

<span data-ttu-id="c99f8-191">Metoda jest wywoływana dla każdego filtru uwierzytelniania w potoku żądania.</span><span class="sxs-lookup"><span data-stu-id="c99f8-191">The method is called on every authentication filter in the request pipeline.</span></span>

<span data-ttu-id="c99f8-192">Ważne jest, aby zrozumieć, że **ChallengeAsync** jest wywoływana *przed utworzeniem* odpowiedzi HTTP i prawdopodobnie nawet przed uruchomieniem akcji kontrolera.</span><span class="sxs-lookup"><span data-stu-id="c99f8-192">It's important to understand that **ChallengeAsync** is called *before* the HTTP response is created, and possibly even before the controller action runs.</span></span> <span data-ttu-id="c99f8-193">Gdy **ChallengeAsync** jest wywoływana, `context.Result` zawiera **IHttpActionResult**, który jest używany później do utworzenia odpowiedzi HTTP.</span><span class="sxs-lookup"><span data-stu-id="c99f8-193">When **ChallengeAsync** is called, `context.Result` contains an **IHttpActionResult**, which is used later to create the HTTP response.</span></span> <span data-ttu-id="c99f8-194">Więc gdy **ChallengeAsync** jest wywoływana, nie wiesz jeszcze niczego o odpowiedzi HTTP.</span><span class="sxs-lookup"><span data-stu-id="c99f8-194">So when **ChallengeAsync** is called, you don't know anything about the HTTP response yet.</span></span> <span data-ttu-id="c99f8-195">Metoda **ChallengeAsync** powinna zastąpić oryginalną wartość `context.Result` nową **IHttpActionResult**.</span><span class="sxs-lookup"><span data-stu-id="c99f8-195">The **ChallengeAsync** method should replace the original value of `context.Result` with a new **IHttpActionResult**.</span></span> <span data-ttu-id="c99f8-196">Ta **IHttpActionResult** musi otaczać oryginalny `context.Result`.</span><span class="sxs-lookup"><span data-stu-id="c99f8-196">This **IHttpActionResult** must wrap the original `context.Result`.</span></span>

![](authentication-filters/_static/image3.png)

<span data-ttu-id="c99f8-197">Wywołaję oryginalny **IHttpActionResult** *wyniku wewnętrznego*i nowy **IHttpActionResult** *wynik zewnętrzny*.</span><span class="sxs-lookup"><span data-stu-id="c99f8-197">I'll call the original **IHttpActionResult** the *inner result*, and the new **IHttpActionResult** the *outer result*.</span></span> <span data-ttu-id="c99f8-198">Zewnętrzny wynik musi wykonać następujące czynności:</span><span class="sxs-lookup"><span data-stu-id="c99f8-198">The outer result must do the following:</span></span>

1. <span data-ttu-id="c99f8-199">Wywołaj wynik wewnętrzny, aby utworzyć odpowiedź HTTP.</span><span class="sxs-lookup"><span data-stu-id="c99f8-199">Invoke the inner result to create the HTTP response.</span></span>
2. <span data-ttu-id="c99f8-200">Badanie odpowiedzi.</span><span class="sxs-lookup"><span data-stu-id="c99f8-200">Examine the response.</span></span>
3. <span data-ttu-id="c99f8-201">W razie potrzeby Dodaj wyzwanie uwierzytelniania do odpowiedzi.</span><span class="sxs-lookup"><span data-stu-id="c99f8-201">Add an authentication challenge to the response, if needed.</span></span>

<span data-ttu-id="c99f8-202">Poniższy przykład jest pobierany z przykładu podstawowego uwierzytelniania.</span><span class="sxs-lookup"><span data-stu-id="c99f8-202">The following example is taken from the Basic Authentication sample.</span></span> <span data-ttu-id="c99f8-203">Definiuje **IHttpActionResult** dla zewnętrznego wyniku.</span><span class="sxs-lookup"><span data-stu-id="c99f8-203">It defines an **IHttpActionResult** for the outer result.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample8.cs)]

<span data-ttu-id="c99f8-204">Właściwość `InnerResult` zawiera wewnętrzny **IHttpActionResult**.</span><span class="sxs-lookup"><span data-stu-id="c99f8-204">The `InnerResult` property holds the inner **IHttpActionResult**.</span></span> <span data-ttu-id="c99f8-205">Właściwość `Challenge` reprezentuje nagłówek uwierzytelniania www.</span><span class="sxs-lookup"><span data-stu-id="c99f8-205">The `Challenge` property represents a Www-Authentication header.</span></span> <span data-ttu-id="c99f8-206">Zwróć uwagę, że **wywoływanie ExecuteAsync** najpierw wywołuje `InnerResult.ExecuteAsync` w celu utworzenia odpowiedzi HTTP, a następnie dodaje wyzwanie w razie potrzeby.</span><span class="sxs-lookup"><span data-stu-id="c99f8-206">Notice that **ExecuteAsync** first calls `InnerResult.ExecuteAsync` to create the HTTP response, and then adds the challenge if needed.</span></span>

<span data-ttu-id="c99f8-207">Przed dodaniem wyzwania Sprawdź kod odpowiedzi.</span><span class="sxs-lookup"><span data-stu-id="c99f8-207">Check the response code before adding the challenge.</span></span> <span data-ttu-id="c99f8-208">Większość schematów uwierzytelniania dodaje wyzwanie tylko wtedy, gdy odpowiedź to 401, jak pokazano poniżej.</span><span class="sxs-lookup"><span data-stu-id="c99f8-208">Most authentication schemes only add a challenge if the response is 401, as shown here.</span></span> <span data-ttu-id="c99f8-209">Niektóre schematy uwierzytelniania umożliwiają jednak dodanie wyzwania do odpowiedzi o powodzeniu.</span><span class="sxs-lookup"><span data-stu-id="c99f8-209">However, some authentication schemes do add a challenge to a success response.</span></span> <span data-ttu-id="c99f8-210">Na przykład zobacz [Negotiate](http://tools.ietf.org/html/rfc4559#section-5) (RFC 4559).</span><span class="sxs-lookup"><span data-stu-id="c99f8-210">For example, see [Negotiate](http://tools.ietf.org/html/rfc4559#section-5) (RFC 4559).</span></span>

<span data-ttu-id="c99f8-211">W przypadku klasy `AddChallengeOnUnauthorizedResult` rzeczywista wartość kodu w **ChallengeAsync** jest prosta.</span><span class="sxs-lookup"><span data-stu-id="c99f8-211">Given the `AddChallengeOnUnauthorizedResult` class, the actual code in **ChallengeAsync** is simple.</span></span> <span data-ttu-id="c99f8-212">Wystarczy utworzyć wynik i dołączyć go do `context.Result`.</span><span class="sxs-lookup"><span data-stu-id="c99f8-212">You just create the result and attach it to `context.Result`.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample9.cs)]

<span data-ttu-id="c99f8-213">Uwaga: przykład uwierzytelniania podstawowego jest abstrakcyjny dla tej logiki jako bit, umieszczając ją w metodzie rozszerzenia.</span><span class="sxs-lookup"><span data-stu-id="c99f8-213">Note: The Basic Authentication sample abstracts this logic a bit, by placing it in an extension method.</span></span>

## <a name="combining-authentication-filters-with-host-level-authentication"></a><span data-ttu-id="c99f8-214">Łączenie filtrów uwierzytelniania z uwierzytelnianiem na poziomie hosta</span><span class="sxs-lookup"><span data-stu-id="c99f8-214">Combining Authentication Filters with Host-Level Authentication</span></span>

<span data-ttu-id="c99f8-215">"Uwierzytelnianie na poziomie hosta" to uwierzytelnianie wykonywane przez hosta (na przykład IIS), zanim żądanie osiągnie strukturę internetowego interfejsu API.</span><span class="sxs-lookup"><span data-stu-id="c99f8-215">"Host-level authentication" is authentication performed by the host (such as IIS), before the request reaches the Web API framework.</span></span>

<span data-ttu-id="c99f8-216">Często można włączyć uwierzytelnianie na poziomie hosta dla pozostałej części aplikacji, ale wyłączyć je dla kontrolerów interfejsu API sieci Web.</span><span class="sxs-lookup"><span data-stu-id="c99f8-216">Often, you may want to enable host-level authentication for the rest of your application, but disable it for your Web API controllers.</span></span> <span data-ttu-id="c99f8-217">Typowym scenariuszem jest na przykład włączenie uwierzytelniania formularzy na poziomie hosta, ale użycie uwierzytelniania opartego na tokenach dla internetowego interfejsu API.</span><span class="sxs-lookup"><span data-stu-id="c99f8-217">For example, a typical scenario is to enable Forms Authentication at the host level, but use token-based authentication for Web API.</span></span>

<span data-ttu-id="c99f8-218">Aby wyłączyć uwierzytelnianie na poziomie hosta w potoku interfejsu API sieci Web, wywołaj `config.SuppressHostPrincipal()` w konfiguracji.</span><span class="sxs-lookup"><span data-stu-id="c99f8-218">To disable host-level authentication inside the Web API pipeline, call `config.SuppressHostPrincipal()` in your configuration.</span></span> <span data-ttu-id="c99f8-219">Powoduje to, że interfejs API sieci Web usuwa **IPrincipal** z dowolnych żądań, które wprowadzają potok interfejsu API sieci Web.</span><span class="sxs-lookup"><span data-stu-id="c99f8-219">This causes Web API to remove the **IPrincipal** from any request that enters the Web API pipeline.</span></span> <span data-ttu-id="c99f8-220">Skutecznie &quot;nie uwierzytelnia&quot; żądania.</span><span class="sxs-lookup"><span data-stu-id="c99f8-220">Effectively, it &quot;un-authenticates&quot; the request.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample10.cs)]

## <a name="additional-resources"></a><span data-ttu-id="c99f8-221">Dodatkowe materiały</span><span class="sxs-lookup"><span data-stu-id="c99f8-221">Additional Resources</span></span>

<span data-ttu-id="c99f8-222">[Filtry zabezpieczeń interfejsu API sieci Web ASP.NET](https://msdn.microsoft.com/magazine/dn781361.aspx) (Magazyn MSDN)</span><span class="sxs-lookup"><span data-stu-id="c99f8-222">[ASP.NET Web API Security Filters](https://msdn.microsoft.com/magazine/dn781361.aspx) (MSDN Magazine)</span></span>
