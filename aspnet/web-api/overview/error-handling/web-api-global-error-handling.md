---
uid: web-api/overview/error-handling/web-api-global-error-handling
title: Globalna obsługa błędów w ASP.NET Web API 2-ASP.NET 4. x
author: davidmatson
description: Omówienie globalnej obsługi błędów w ASP.NET Web API 2 dla ASP.NET 4. x.
ms.author: riande
ms.date: 02/03/2014
ms.custom: seoapril2019
ms.assetid: bffd7863-f63b-4b23-a13c-372b5492e9fb
msc.legacyurl: /web-api/overview/error-handling/web-api-global-error-handling
msc.type: authoredcontent
ms.openlocfilehash: 94f2d6d31d0b37f9bb0077e6258c70a2dfb1918d
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: pl-PL
ms.lasthandoff: 03/06/2020
ms.locfileid: "78557282"
---
# <a name="global-error-handling-in-aspnet-web-api-2"></a><span data-ttu-id="3247e-103">Globalna obsługa błędów w ASP.NET Web API 2</span><span class="sxs-lookup"><span data-stu-id="3247e-103">Global Error Handling in ASP.NET Web API 2</span></span>

<span data-ttu-id="3247e-104">przez [David Matson](https://github.com/davidmatson), [Rick Anderson](https://twitter.com/RickAndMSFT)</span><span class="sxs-lookup"><span data-stu-id="3247e-104">by [David Matson](https://github.com/davidmatson), [Rick Anderson](https://twitter.com/RickAndMSFT)</span></span>

<span data-ttu-id="3247e-105">Ten temat zawiera omówienie globalnej obsługi błędów w ASP.NET Web API 2 dla ASP.NET 4. x.</span><span class="sxs-lookup"><span data-stu-id="3247e-105">This topic provides an overview of global error handling in ASP.NET Web API 2 for ASP.NET 4.x.</span></span> <span data-ttu-id="3247e-106">Obecnie nie ma łatwego sposobu na interfejs API sieci Web do rejestrowania lub obsługi błędów globalnie.</span><span class="sxs-lookup"><span data-stu-id="3247e-106">Today there's no easy way in Web API to log or handle errors globally.</span></span> <span data-ttu-id="3247e-107">Niektóre Nieobsłużone wyjątki mogą być przetwarzane za pośrednictwem [filtrów wyjątków](exception-handling.md), ale istnieją różne przypadki, w których nie można obsłużyć filtrów wyjątków.</span><span class="sxs-lookup"><span data-stu-id="3247e-107">Some unhandled exceptions can be processed via [exception filters](exception-handling.md), but there are a number of cases that exception filters can't handle.</span></span> <span data-ttu-id="3247e-108">Na przykład:</span><span class="sxs-lookup"><span data-stu-id="3247e-108">For example:</span></span>

1. <span data-ttu-id="3247e-109">Wyjątki zgłoszone przez konstruktory kontrolerów.</span><span class="sxs-lookup"><span data-stu-id="3247e-109">Exceptions thrown from controller constructors.</span></span>
2. <span data-ttu-id="3247e-110">Wyjątki zgłoszone przez programy obsługi komunikatów.</span><span class="sxs-lookup"><span data-stu-id="3247e-110">Exceptions thrown from message handlers.</span></span>
3. <span data-ttu-id="3247e-111">Wyjątki zgłoszone podczas routingu.</span><span class="sxs-lookup"><span data-stu-id="3247e-111">Exceptions thrown during routing.</span></span>
4. <span data-ttu-id="3247e-112">Wyjątki zgłoszone podczas serializacji zawartości odpowiedzi.</span><span class="sxs-lookup"><span data-stu-id="3247e-112">Exceptions thrown during response content serialization .</span></span>

<span data-ttu-id="3247e-113">Chcemy zapewnić prosty, spójny sposób rejestrowania i obsługi (tam, gdzie to możliwe) tych wyjątków.</span><span class="sxs-lookup"><span data-stu-id="3247e-113">We want to provide a simple, consistent way to log and handle (where possible) these exceptions.</span></span> 

<span data-ttu-id="3247e-114">Istnieją dwa główne przypadki obsługi wyjątków, przypadek, w którym możemy wysłać odpowiedź na błąd i przypadek, gdzie wszystko, co możemy zrobić, rejestruje wyjątek.</span><span class="sxs-lookup"><span data-stu-id="3247e-114">There are two major cases for handling exceptions, the case where we are able to send an error response and the case where all we can do is log the exception.</span></span> <span data-ttu-id="3247e-115">Przykładem dla ostatniego przypadku jest zgłaszanie wyjątku w środku zawartości odpowiedzi przesyłania strumieniowego; w takim przypadku zbyt późno na wysłanie nowego komunikatu odpowiedzi, ponieważ kod stanu, nagłówki i częściowa zawartość już zniknęły w sieci, dlatego po prostu przerywamy połączenie.</span><span class="sxs-lookup"><span data-stu-id="3247e-115">An example for the latter case is when an exception is thrown in the middle of streaming response content; in that case it is too late to send a new response message since the status code, headers, and partial content have already gone across the wire, so we simply abort the connection.</span></span> <span data-ttu-id="3247e-116">Mimo że nie można obsłużyć tego wyjątku, aby utworzyć nowy komunikat odpowiedzi, nadal obsługujemy rejestrowanie wyjątku.</span><span class="sxs-lookup"><span data-stu-id="3247e-116">Even though the exception can't be handled to produce a new response message, we still support logging the exception.</span></span> <span data-ttu-id="3247e-117">W przypadkach, w których możemy wykryć błąd, możemy zwrócić odpowiednią odpowiedź na błąd, jak pokazano na poniższej liście:</span><span class="sxs-lookup"><span data-stu-id="3247e-117">In cases where we can detect an error, we can return an appropriate error response as shown in the following:</span></span>

[!code-csharp[Main](web-api-global-error-handling/samples/sample1.cs?highlight=6)]

### <a name="existing-options"></a><span data-ttu-id="3247e-118">Istniejące opcje</span><span class="sxs-lookup"><span data-stu-id="3247e-118">Existing Options</span></span>

<span data-ttu-id="3247e-119">Oprócz [filtrów wyjątków](exception-handling.md), [procedury obsługi komunikatów](../advanced/http-message-handlers.md) mogą być używane dzisiaj do obserwowania wszystkich odpowiedzi na poziomie 500, ale działające na tych odpowiedzi jest trudne, ponieważ nie mają kontekstu o pierwotnym błędzie.</span><span class="sxs-lookup"><span data-stu-id="3247e-119">In addition to [exception filters](exception-handling.md), [message handlers](../advanced/http-message-handlers.md) can be used today to observe all 500-level responses, but acting on those responses is difficult, as they lack context about the original error.</span></span> <span data-ttu-id="3247e-120">Procedury obsługi komunikatów mają także niektóre z tych samych ograniczeń co filtry wyjątków dotyczące przypadków, w których mogą one obsłużyć. Mimo że interfejs API sieci Web ma infrastrukturę śledzenia, która przechwytuje warunki błędu, Infrastruktura śledzenia jest przeznaczona do celów diagnostycznych i nie jest zaprojektowana ani odpowiednia do uruchamiania w środowiskach produkcyjnych.</span><span class="sxs-lookup"><span data-stu-id="3247e-120">Message handlers also have some of the same limitations as exception filters regarding the cases they can handle.While Web API does have tracing infrastructure that captures error conditions the tracing infrastructure is for diagnostics purposes and is not designed or suited for running in production environments.</span></span> <span data-ttu-id="3247e-121">Globalna obsługa wyjątków i rejestrowanie powinna być usługami, które mogą być uruchamiane w trakcie produkcji i są podłączane do istniejących rozwiązań monitorowania (na przykład [ELMAH](https://code.google.com/p/elmah/) ).</span><span class="sxs-lookup"><span data-stu-id="3247e-121">Global exception handling and logging should be services that can run during production and be plugged into existing monitoring solutions (for example, [ELMAH](https://code.google.com/p/elmah/) ).</span></span>

### <a name="solution-overview"></a><span data-ttu-id="3247e-122">Przegląd rozwiązania</span><span class="sxs-lookup"><span data-stu-id="3247e-122">Solution Overview</span></span>

 <span data-ttu-id="3247e-123">Udostępniamy dwie nowe, wymienne usługi, [interfejsu iexceptionlogger](../releases/whats-new-in-aspnet-web-api-21.md) i IExceptionHandler, aby rejestrować i obsługiwać Nieobsłużone wyjątki.</span><span class="sxs-lookup"><span data-stu-id="3247e-123">We provide two new user-replaceable services, [IExceptionLogger](../releases/whats-new-in-aspnet-web-api-21.md) and IExceptionHandler, to log and handle unhandled exceptions.</span></span> <span data-ttu-id="3247e-124">Usługi są bardzo podobne i mają dwie główne różnice:</span><span class="sxs-lookup"><span data-stu-id="3247e-124">The services are very similar, with two main differences:</span></span>

1. <span data-ttu-id="3247e-125">Obsługujemy rejestrowanie wielu rejestratorów wyjątków, ale tylko jednego programu obsługi wyjątków.</span><span class="sxs-lookup"><span data-stu-id="3247e-125">We support registering multiple exception loggers but only a single exception handler.</span></span>
2. <span data-ttu-id="3247e-126">Rejestratory wyjątków zawsze są wywoływane, nawet jeśli zamierzasz przerwać połączenie.</span><span class="sxs-lookup"><span data-stu-id="3247e-126">Exception loggers always get called, even if we're about to abort the connection.</span></span> <span data-ttu-id="3247e-127">Programy obsługi wyjątków są wywoływane tylko wtedy, gdy nadal można wybrać komunikat odpowiedzi do wysłania.</span><span class="sxs-lookup"><span data-stu-id="3247e-127">Exception handlers only get called when we're still able to choose which response message to send.</span></span>

<span data-ttu-id="3247e-128">Obie usługi zapewniają dostęp do kontekstu wyjątku zawierającego istotne informacje od punktu, w którym został wykryty wyjątek, szczególnie [HttpRequestMessage](https://msdn.microsoft.com/library/system.net.http.httprequestmessage(v=vs.110).aspx), [HttpRequestContext](https://msdn.microsoft.com/library/system.web.http.controllers.httprequestcontext(v=vs.118).aspx), zgłoszony wyjątek i źródło wyjątku (szczegóły poniżej).</span><span class="sxs-lookup"><span data-stu-id="3247e-128">Both services provide access to an exception context containing relevant information from the point where the exception was detected, particularly the [HttpRequestMessage](https://msdn.microsoft.com/library/system.net.http.httprequestmessage(v=vs.110).aspx), the [HttpRequestContext](https://msdn.microsoft.com/library/system.web.http.controllers.httprequestcontext(v=vs.118).aspx), the thrown exception and the exception source (details below).</span></span>

### <a name="design-principles"></a><span data-ttu-id="3247e-129">Zasady projektowania</span><span class="sxs-lookup"><span data-stu-id="3247e-129">Design Principles</span></span>

1. <span data-ttu-id="3247e-130">**Brak zmian powodujących przerwanie** Ponieważ ta funkcja jest dodawana w wersji pomocniczej, jedno ważne ograniczenie wpływające na rozwiązanie polega na tym, że nie ma żadnych znaczących zmian w przypadku kontraktów lub zachowania.</span><span class="sxs-lookup"><span data-stu-id="3247e-130">**No breaking changes** Because this functionality is being added in a minor release, one important constraint impacting the solution is that there be no breaking changes, either to type contracts or to behavior.</span></span> <span data-ttu-id="3247e-131">To ograniczenie ogranicza pewne czynności, które należy wykonać w ramach istniejących bloków catch, włączając wyjątki do 500 odpowiedzi.</span><span class="sxs-lookup"><span data-stu-id="3247e-131">This constraint ruled out some cleanup we would like to have done in terms of existing catch blocks turning exceptions into 500 responses.</span></span> <span data-ttu-id="3247e-132">To dodatkowe czyszczenie jest coś, co możemy wziąć pod uwagę w przypadku kolejnej wersji głównej.</span><span class="sxs-lookup"><span data-stu-id="3247e-132">This additional cleanup is something we might consider for a subsequent major release.</span></span> <span data-ttu-id="3247e-133">Jeśli jest to ważne, należy zagłosować na nim przy [ASP.NET użytkownika interfejsu API sieci Web](http://aspnet.uservoice.com/forums/147201-asp-net-web-api/suggestions/5451321-add-flag-to-enable-iexceptionlogger-and-iexception).</span><span class="sxs-lookup"><span data-stu-id="3247e-133">If this is important to you please vote on it at [ASP.NET Web API user voice](http://aspnet.uservoice.com/forums/147201-asp-net-web-api/suggestions/5451321-add-flag-to-enable-iexceptionlogger-and-iexception).</span></span>
2. <span data-ttu-id="3247e-134">**Zachowanie spójności z konstrukcjami interfejsów API sieci Web** Potok filtru internetowego interfejsu API to świetny sposób na objęcie problemów związanych z wycinaniem i elastycznością zastosowania logiki w zakresie konkretnych czynności, specyficznych dla kontrolera lub globalnych.</span><span class="sxs-lookup"><span data-stu-id="3247e-134">**Maintaining consistency with Web API constructs** Web API's filter pipeline is a great way to handle cross-cutting concerns with the flexibility of applying the logic at an action-specific, controller-specific or global scope.</span></span> <span data-ttu-id="3247e-135">Filtry, w tym filtry wyjątków, zawsze mają konteksty akcji i kontrolerów, nawet w przypadku zarejestrowania w zakresie globalnym.</span><span class="sxs-lookup"><span data-stu-id="3247e-135">Filters, including exception filters, always have action and controller contexts, even when registered at the global scope.</span></span> <span data-ttu-id="3247e-136">Ta umowa ma sens dla filtrów, ale oznacza, że filtry wyjątków, nawet z zakresem globalnym, nie są dobrym rozwiązaniem w przypadku niektórych przypadków obsługi wyjątków, takich jak wyjątki od programów obsługi komunikatów, gdzie nie istnieje kontekst akcji ani kontrolera.</span><span class="sxs-lookup"><span data-stu-id="3247e-136">That contract makes sense for filters, but it means that exception filters, even globally scoped ones, aren't a good fit for some exception handling cases, such as exceptions from message handlers, where no action or controller context exists.</span></span> <span data-ttu-id="3247e-137">Jeśli chcemy używać elastycznego zakresu, który jest obsługiwany przez filtry dla obsługi wyjątków, nadal potrzebujemy filtrów wyjątków.</span><span class="sxs-lookup"><span data-stu-id="3247e-137">If we want to use the flexible scoping afforded by filters for exception handling, we still need exception filters.</span></span> <span data-ttu-id="3247e-138">Jeśli jednak musimy obsłużyć wyjątek poza kontekstem kontrolera, potrzebujemy również oddzielnej konstrukcji dla pełnej globalnej obsługi błędów (coś bez kontekstu kontrolera i ograniczeń kontekstu akcji).</span><span class="sxs-lookup"><span data-stu-id="3247e-138">But if we need to handle exception outside of a controller context, we also need a separate construct for full global error handling (something without the controller context and action context constraints).</span></span>

### <a name="when-to-use"></a><span data-ttu-id="3247e-139">Kiedy używać</span><span class="sxs-lookup"><span data-stu-id="3247e-139">When to Use</span></span>

- <span data-ttu-id="3247e-140">Rejestratory wyjątków to rozwiązanie do wyświetlania wszystkich nieobsłużonych wyjątków przechwyconych przez internetowy interfejs API.</span><span class="sxs-lookup"><span data-stu-id="3247e-140">Exception loggers are the solution to seeing all unhandled exception caught by Web API.</span></span>
- <span data-ttu-id="3247e-141">Obsługa wyjątków to rozwiązanie służące do dostosowywania wszystkich możliwych odpowiedzi do nieobsłużonych wyjątków przechwyconych przez internetowy interfejs API.</span><span class="sxs-lookup"><span data-stu-id="3247e-141">Exception handlers are the solution for customizing all possible responses to unhandled exceptions caught by Web API.</span></span>
- <span data-ttu-id="3247e-142">Filtry wyjątków są najłatwiejszym rozwiązaniem do przetwarzania nieobsługiwanych wyjątków podzbioru związanych z określoną akcją lub kontrolerem.</span><span class="sxs-lookup"><span data-stu-id="3247e-142">Exception filters are the easiest solution for processing the subset unhandled exceptions related to a specific action or controller.</span></span>

### <a name="service-details"></a><span data-ttu-id="3247e-143">Szczegóły usługi</span><span class="sxs-lookup"><span data-stu-id="3247e-143">Service Details</span></span>

 <span data-ttu-id="3247e-144">Interfejsy usługi rejestrowania wyjątków i obsługi są prostymi metodami asynchronicznymi, które pobierają odpowiednie konteksty:</span><span class="sxs-lookup"><span data-stu-id="3247e-144">The exception logger and handler service interfaces are simple async methods taking the respective contexts:</span></span> 

[!code-csharp[Main](web-api-global-error-handling/samples/sample2.cs)]

 <span data-ttu-id="3247e-145">Udostępniamy również klasy bazowe dla obu tych interfejsów.</span><span class="sxs-lookup"><span data-stu-id="3247e-145">We also provide base classes for both of these interfaces.</span></span> <span data-ttu-id="3247e-146">Zastępowanie metod Core (Synchronize lub Async) jest wymagane do zarejestrowania lub obsłużenia w zalecanej godzinie.</span><span class="sxs-lookup"><span data-stu-id="3247e-146">Overriding the core (sync or async) methods is all that is required to log or handle at the recommended times.</span></span> <span data-ttu-id="3247e-147">W przypadku rejestrowania, Klasa bazowa `ExceptionLogger` zapewnia, że podstawowa Metoda rejestrowania jest wywoływana tylko raz dla każdego wyjątku (nawet jeśli później propaguje dalej stos wywołań i zostanie przechwycony ponownie).</span><span class="sxs-lookup"><span data-stu-id="3247e-147">For logging, the `ExceptionLogger` base class will ensure that the core logging method is only called once for each exception (even if it later propagates further up the call stack and is caught again).</span></span> <span data-ttu-id="3247e-148">Klasa bazowa `ExceptionHandler` wywoła podstawową metodę obsługi tylko dla wyjątków w górnej części stosu wywołań, ignorując starsze zagnieżdżone bloki catch.</span><span class="sxs-lookup"><span data-stu-id="3247e-148">The `ExceptionHandler` base class will call the core handling method only for exceptions at the top of the call stack, ignoring legacy nested catch blocks.</span></span> <span data-ttu-id="3247e-149">(Uproszczone wersje tych klas podstawowych znajdują się w załączniku poniżej). Zarówno `IExceptionLogger`, jak i `IExceptionHandler` otrzymują informacje o wyjątku za pośrednictwem `ExceptionContext`.</span><span class="sxs-lookup"><span data-stu-id="3247e-149">(Simplified versions of these base classes are in the appendix below.) Both `IExceptionLogger` and `IExceptionHandler` receive information about the exception via an `ExceptionContext`.</span></span>

[!code-csharp[Main](web-api-global-error-handling/samples/sample3.cs)]

<span data-ttu-id="3247e-150">Gdy struktura wywołuje rejestratora wyjątków lub procedurę obsługi wyjątków, zawsze będzie zapewniać `Exception` i `Request`.</span><span class="sxs-lookup"><span data-stu-id="3247e-150">When the framework calls an exception logger or an exception handler, it will always provide an `Exception` and a `Request`.</span></span> <span data-ttu-id="3247e-151">Z wyjątkiem testów jednostkowych, będzie również zawsze zapewniać `RequestContext`.</span><span class="sxs-lookup"><span data-stu-id="3247e-151">Except for unit testing, it will also always provide a `RequestContext`.</span></span> <span data-ttu-id="3247e-152">Będzie rzadko zapewniał `ControllerContext` i `ActionContext` (tylko w przypadku wywołania z bloku catch dla filtrów wyjątków).</span><span class="sxs-lookup"><span data-stu-id="3247e-152">It will rarely provide a `ControllerContext` and `ActionContext` (only when calling from the catch block for exception filters).</span></span> <span data-ttu-id="3247e-153">Bardzo rzadko zapewnia `Response`(tylko w niektórych przypadkach usług IIS, gdy w trakcie próby zapisania odpowiedzi).</span><span class="sxs-lookup"><span data-stu-id="3247e-153">It will very rarely provide a `Response`(only in certain IIS cases when in the middle of trying to write the response).</span></span> <span data-ttu-id="3247e-154">Należy pamiętać, że niektóre z tych właściwości mogą być `null` przed uzyskaniem dostępu do elementów członkowskich klasy wyjątków, aby sprawdzić, czy nie `null`.`CatchBlock`</span><span class="sxs-lookup"><span data-stu-id="3247e-154">Note that because some of these properties may be `null` it is up to the consumer to check for `null` before accessing members of the exception class.`CatchBlock`</span></span> <span data-ttu-id="3247e-155">jest ciągiem wskazującym, który blok catch wykrywa wyjątek.</span><span class="sxs-lookup"><span data-stu-id="3247e-155">is a string indicating which catch block saw the exception.</span></span> <span data-ttu-id="3247e-156">Ciągi bloku catch są następujące:</span><span class="sxs-lookup"><span data-stu-id="3247e-156">The catch block strings are as follows:</span></span>

- <span data-ttu-id="3247e-157">HttpServer (Metoda SendAsync)</span><span class="sxs-lookup"><span data-stu-id="3247e-157">HttpServer (SendAsync method)</span></span>
- <span data-ttu-id="3247e-158">HttpControllerDispatcher (Metoda SendAsync)</span><span class="sxs-lookup"><span data-stu-id="3247e-158">HttpControllerDispatcher (SendAsync method)</span></span>
- <span data-ttu-id="3247e-159">HttpBatchHandler (Metoda SendAsync)</span><span class="sxs-lookup"><span data-stu-id="3247e-159">HttpBatchHandler (SendAsync method)</span></span>
- <span data-ttu-id="3247e-160">IExceptionFilter (ApiController przetworzenia potoku filtru wyjątków w wywoływanie ExecuteAsync)</span><span class="sxs-lookup"><span data-stu-id="3247e-160">IExceptionFilter (ApiController's processing of the exception filter pipeline in ExecuteAsync)</span></span>
- <span data-ttu-id="3247e-161">Host OWIN:</span><span class="sxs-lookup"><span data-stu-id="3247e-161">OWIN host:</span></span>

    - <span data-ttu-id="3247e-162">HttpMessageHandlerAdapter. BufferResponseContentAsync (do buforowania danych wyjściowych)</span><span class="sxs-lookup"><span data-stu-id="3247e-162">HttpMessageHandlerAdapter.BufferResponseContentAsync (for buffering output)</span></span>
    - <span data-ttu-id="3247e-163">HttpMessageHandlerAdapter. CopyResponseContentAsync (do przesyłania strumieniowego danych wyjściowych)</span><span class="sxs-lookup"><span data-stu-id="3247e-163">HttpMessageHandlerAdapter.CopyResponseContentAsync (for streaming output)</span></span>
- <span data-ttu-id="3247e-164">Host sieci Web:</span><span class="sxs-lookup"><span data-stu-id="3247e-164">Web host:</span></span>

    - <span data-ttu-id="3247e-165">HttpControllerHandler. WriteBufferedResponseContentAsync (do buforowania danych wyjściowych)</span><span class="sxs-lookup"><span data-stu-id="3247e-165">HttpControllerHandler.WriteBufferedResponseContentAsync (for buffering output)</span></span>
    - <span data-ttu-id="3247e-166">HttpControllerHandler. WriteStreamedResponseContentAsync (do przesyłania strumieniowego danych wyjściowych)</span><span class="sxs-lookup"><span data-stu-id="3247e-166">HttpControllerHandler.WriteStreamedResponseContentAsync (for streaming output)</span></span>
    - <span data-ttu-id="3247e-167">HttpControllerHandler. WriteErrorResponseContentAsync (w przypadku błędów odzyskiwania błędów w trybie buforowanego wyjścia)</span><span class="sxs-lookup"><span data-stu-id="3247e-167">HttpControllerHandler.WriteErrorResponseContentAsync (for failures in error recovery under buffered output mode)</span></span>

<span data-ttu-id="3247e-168">Lista ciągów bloku catch jest również dostępna za pośrednictwem statycznych właściwości tylko do odczytu.</span><span class="sxs-lookup"><span data-stu-id="3247e-168">The list of catch block strings is also available via static readonly properties.</span></span> <span data-ttu-id="3247e-169">(Rdzeń podstawowego bloku catch znajduje się na statycznej ExceptionCatchBlocks; reszta jest wyświetlana w jednej klasie statycznej każdy dla OWIN i hosta sieci Web).`IsTopLevelCatchBlock`</span><span class="sxs-lookup"><span data-stu-id="3247e-169">(The core catch block string are on the static ExceptionCatchBlocks; the remainder appear on one static class each for OWIN and web host).`IsTopLevelCatchBlock`</span></span> <span data-ttu-id="3247e-170">jest przydatne w przypadku stosowania zalecanego wzorca obsługi wyjątków tylko w górnej części stosu wywołań.</span><span class="sxs-lookup"><span data-stu-id="3247e-170">is helpful for following the recommended pattern of handling exceptions only at the top of the call stack.</span></span> <span data-ttu-id="3247e-171">Zamiast przełączać wyjątki do 500 odpowiedzi wszędzie tam, gdzie występuje zagnieżdżony blok catch, program obsługi wyjątków może pozwolić na propagację wyjątków do momentu, gdy mają być widoczne dla hosta.</span><span class="sxs-lookup"><span data-stu-id="3247e-171">Rather than turning exceptions into 500 responses anywhere a nested catch block occurs, an exception handler can let exceptions propagate until they are about to be seen by the host.</span></span>

<span data-ttu-id="3247e-172">Oprócz `ExceptionContext`, rejestrator pobiera jedną więcej informacji za pośrednictwem pełnego `ExceptionLoggerContext`:</span><span class="sxs-lookup"><span data-stu-id="3247e-172">In addition to the `ExceptionContext`, a logger gets one more piece of information via the full `ExceptionLoggerContext`:</span></span>

[!code-csharp[Main](web-api-global-error-handling/samples/sample4.cs)]

<span data-ttu-id="3247e-173">Druga właściwość, `CanBeHandled`, umożliwia Rejestratorowi zidentyfikowanie wyjątku, którego nie można obsłużyć.</span><span class="sxs-lookup"><span data-stu-id="3247e-173">The second property, `CanBeHandled`, allows a logger to identify an exception that cannot be handled.</span></span> <span data-ttu-id="3247e-174">Gdy połączenie zostanie przerwane i nie można wysłać nowego komunikatu odpowiedzi, rejestratory będą wywoływane, ale procedura obsługi ***nie*** zostanie wywołana, a rejestratory mogą zidentyfikować ten scenariusz z tej właściwości.</span><span class="sxs-lookup"><span data-stu-id="3247e-174">When the connection is about to be aborted and no new response message can be sent, the loggers will be called but the handler will ***not*** be called, and the loggers can identify this scenario from this property.</span></span>

<span data-ttu-id="3247e-175">W przypadku dodatkowych `ExceptionContext`program obsługi pobiera jeszcze jedną właściwość, którą można ustawić dla pełnego `ExceptionHandlerContext`, aby obsłużyć wyjątek:</span><span class="sxs-lookup"><span data-stu-id="3247e-175">In additional to the `ExceptionContext`, a handler gets one more property it can set on the full `ExceptionHandlerContext` to handle the exception:</span></span>

[!code-csharp[Main](web-api-global-error-handling/samples/sample5.cs)]

<span data-ttu-id="3247e-176">Procedura obsługi wyjątków wskazuje, że obsłużył wyjątek przez ustawienie właściwości `Result` na wynik akcji (na przykład [ExceptionResult](https://msdn.microsoft.com/library/system.web.http.results.exceptionresult(v=vs.118).aspx), [InternalServerErrorResult](https://msdn.microsoft.com/library/system.web.http.results.internalservererrorresult(v=vs.118).aspx), [StatusCodeResult](https://msdn.microsoft.com/library/system.web.http.results.statuscoderesult(v=vs.118).aspx)lub wynik niestandardowy).</span><span class="sxs-lookup"><span data-stu-id="3247e-176">An exception handler indicates that it has handled an exception by setting the `Result` property to an action result (for example, an [ExceptionResult](https://msdn.microsoft.com/library/system.web.http.results.exceptionresult(v=vs.118).aspx), [InternalServerErrorResult](https://msdn.microsoft.com/library/system.web.http.results.internalservererrorresult(v=vs.118).aspx), [StatusCodeResult](https://msdn.microsoft.com/library/system.web.http.results.statuscoderesult(v=vs.118).aspx), or a custom result).</span></span> <span data-ttu-id="3247e-177">Jeśli właściwość `Result` ma wartość null, wyjątek nie jest obsługiwany, a oryginalny wyjątek zostanie ponownie wygenerowany.</span><span class="sxs-lookup"><span data-stu-id="3247e-177">If the `Result` property is null, the exception is unhandled and the original exception will be re-thrown.</span></span>

<span data-ttu-id="3247e-178">W przypadku wyjątków w górnej części stosu wywołań wprowadziliśmy dodatkowy krok, aby upewnić się, że odpowiedź jest odpowiednia dla wywołań interfejsu API.</span><span class="sxs-lookup"><span data-stu-id="3247e-178">For exceptions at the top of the call stack, we took an extra step to ensure the response is appropriate for API callers.</span></span> <span data-ttu-id="3247e-179">Jeśli wyjątek propaguje do hosta, obiekt wywołujący zobaczy żółty ekran zgonu lub inny dostarczony Host odpowiedzi, który zwykle jest w formacie HTML i nie jest zazwyczaj odpowiednią odpowiedzią błędu interfejsu API.</span><span class="sxs-lookup"><span data-stu-id="3247e-179">If the exception propagates up to the host, the caller would see the yellow screen of death or some other host provided response which is typically HTML and not usually an appropriate API error response.</span></span> <span data-ttu-id="3247e-180">W takich przypadkach wynik zaczyna się nierówna null i tylko wtedy, gdy niestandardowa procedura obsługi wyjątków jawnie ustawi ją z powrotem na `null` (nieobsłużony), spowoduje to przekazanie wyjątku do hosta.</span><span class="sxs-lookup"><span data-stu-id="3247e-180">In these cases, the Result starts out non-null, and only if a custom exception handler explicitly sets it back to `null` (unhandled) will the exception propagate to the host.</span></span> <span data-ttu-id="3247e-181">Ustawienie `Result` na `null` w takich przypadkach może być przydatne w przypadku dwóch scenariuszy:</span><span class="sxs-lookup"><span data-stu-id="3247e-181">Setting `Result` to `null` in such cases can be useful for two scenarios:</span></span>

1. <span data-ttu-id="3247e-182">OWIN hostowany interfejs API sieci Web z niestandardowym obsługą wyjątków zarejestrowanego przed/poza interfejsem API sieci Web.</span><span class="sxs-lookup"><span data-stu-id="3247e-182">OWIN hosted Web API with custom exception handling middleware registered before/outside Web API.</span></span>
2. <span data-ttu-id="3247e-183">Debugowanie lokalne za pośrednictwem przeglądarki, gdzie żółty ekran zgonu jest w rzeczywistości przydatną odpowiedzią na nieobsługiwany wyjątek.</span><span class="sxs-lookup"><span data-stu-id="3247e-183">Local debugging via a browser, where the yellow screen of death is actually a helpful response for an unhandled exception.</span></span>

<span data-ttu-id="3247e-184">W przypadku rejestratorów wyjątków i obsługi wyjątków nie robimy niczego do odzyskania, jeśli Rejestrator lub procedura obsługi zgłasza wyjątek.</span><span class="sxs-lookup"><span data-stu-id="3247e-184">For both exception loggers and exception handlers, we don't do anything to recover if the logger or handler itself throws an exception.</span></span> <span data-ttu-id="3247e-185">(Inne niż to, aby umożliwić propagowanie wyjątku, wystaw opinię w dolnej części tej strony, jeśli masz lepsze podejście). Umowa dotycząca rejestratorów wyjątków i programów obsługi polega na tym, że nie powinny one zezwalać na propagację wyjątków do ich wywołujących; w przeciwnym razie, wyjątek zostanie po prostu rozpropagowany, często cały sposób do hosta, co spowoduje błąd HTML (np. ASP. Żółty ekran sieci jest wysyłany z powrotem do klienta (zazwyczaj nie jest to preferowana opcja dla wywołań interfejsu API, które oczekują JSON lub XML).</span><span class="sxs-lookup"><span data-stu-id="3247e-185">(Other than letting the exception propagate, leave feedback at the bottom of this page if you have a better approach.) The contract for exception loggers and handlers is that they should not let exceptions propagate up to their callers; otherwise, the exception will just propagate, often all the way to the host resulting in an HTML error (like the ASP.NET's yellow screen) being sent back to the client (which usually isn't the preferred option for API callers that expect JSON or XML).</span></span>

## <a name="examples"></a><span data-ttu-id="3247e-186">Przykłady</span><span class="sxs-lookup"><span data-stu-id="3247e-186">Examples</span></span>

### <a name="tracing-exception-logger"></a><span data-ttu-id="3247e-187">Rejestrator wyjątków śledzenia</span><span class="sxs-lookup"><span data-stu-id="3247e-187">Tracing Exception Logger</span></span>

<span data-ttu-id="3247e-188">Rejestrator wyjątków poniżej wysyła dane wyjątku do skonfigurowanych źródeł śladów (w tym okna dane wyjściowe debugowania w programie Visual Studio).</span><span class="sxs-lookup"><span data-stu-id="3247e-188">The exception logger below send exception data to configured Trace sources (including the Debug output window in Visual Studio).</span></span>

[!code-csharp[Main](web-api-global-error-handling/samples/sample6.cs)]

### <a name="custom-error-message-exception-handler"></a><span data-ttu-id="3247e-189">Procedura obsługi wyjątków niestandardowych komunikatów o błędach</span><span class="sxs-lookup"><span data-stu-id="3247e-189">Custom Error Message Exception Handler</span></span>

<span data-ttu-id="3247e-190">Poniższy poniżej generuje niestandardową odpowiedź na błędy dla klientów, w tym adres e-mail do kontaktowania się z pomocą techniczną.</span><span class="sxs-lookup"><span data-stu-id="3247e-190">The following below produces a custom error response to clients, including an email address for contacting support.</span></span>

[!code-csharp[Main](web-api-global-error-handling/samples/sample7.cs)]

## <a name="registering-exception-filters"></a><span data-ttu-id="3247e-191">Rejestrowanie filtrów wyjątków</span><span class="sxs-lookup"><span data-stu-id="3247e-191">Registering Exception Filters</span></span>

<span data-ttu-id="3247e-192">Jeśli tworzysz projekt przy użyciu szablonu projektu "aplikacja sieci Web ASP.NET MVC 4", umieść kod konfiguracyjny interfejsu API sieci Web wewnątrz klasy `WebApiConfig`, w folderze *aplikacji/_Start* :</span><span class="sxs-lookup"><span data-stu-id="3247e-192">If you use the "ASP.NET MVC 4 Web Application" project template to create your project, put your Web API configuration code inside the `WebApiConfig` class, in the *App/_Start* folder:</span></span>

[!code-csharp[Main](exception-handling/samples/sample7.cs?highlight=5)]

## <a name="appendix-base-class-details"></a><span data-ttu-id="3247e-193">Dodatek: Szczegóły klasy bazowej</span><span class="sxs-lookup"><span data-stu-id="3247e-193">Appendix: Base Class Details</span></span>

[!code-csharp[Main](web-api-global-error-handling/samples/sample8.cs)]
