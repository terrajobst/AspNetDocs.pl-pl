---
uid: web-forms/overview/data-access/working-with-batched-data/wrapping-database-modifications-within-a-transaction-cs
title: OPAKOWYWANIE modyfikacji bazy danych w ramach transakcji (C#) | Dokumentacja firmy Microsoft
author: rick-anderson
description: Ten samouczek jest pierwszą czterech, który sprawdza, aktualizowanie, usuwanie i wstawianie partie danych. W tym samouczku będziemy Dowiedz się, jak zezwolić transakcji bazy danych...
ms.author: riande
ms.date: 06/26/2007
ms.assetid: b45fede3-c53a-4ea1-824b-20200808dbae
msc.legacyurl: /web-forms/overview/data-access/working-with-batched-data/wrapping-database-modifications-within-a-transaction-cs
msc.type: authoredcontent
ms.openlocfilehash: bbc54a39ba6ca3771acd7c4da37795a23e8ee2df
ms.sourcegitcommit: 0f1119340e4464720cfd16d0ff15764746ea1fea
ms.translationtype: MT
ms.contentlocale: pl-PL
ms.lasthandoff: 04/09/2019
ms.locfileid: "59383385"
---
# <a name="wrapping-database-modifications-within-a-transaction-c"></a><span data-ttu-id="9b074-104">Opakowywanie modyfikacji bazy danych w ramach transakcji (C#)</span><span class="sxs-lookup"><span data-stu-id="9b074-104">Wrapping Database Modifications within a Transaction (C#)</span></span>

<span data-ttu-id="9b074-105">przez [Bento Scott](https://twitter.com/ScottOnWriting)</span><span class="sxs-lookup"><span data-stu-id="9b074-105">by [Scott Mitchell](https://twitter.com/ScottOnWriting)</span></span>

<span data-ttu-id="9b074-106">[Pobierz program Code](http://download.microsoft.com/download/3/9/f/39f92b37-e92e-4ab3-909e-b4ef23d01aa3/ASPNET_Data_Tutorial_63_CS.zip) lub [Pobierz plik PDF](wrapping-database-modifications-within-a-transaction-cs/_static/datatutorial63cs1.pdf)</span><span class="sxs-lookup"><span data-stu-id="9b074-106">[Download Code](http://download.microsoft.com/download/3/9/f/39f92b37-e92e-4ab3-909e-b4ef23d01aa3/ASPNET_Data_Tutorial_63_CS.zip) or [Download PDF](wrapping-database-modifications-within-a-transaction-cs/_static/datatutorial63cs1.pdf)</span></span>

> <span data-ttu-id="9b074-107">Ten samouczek jest pierwszą czterech, który sprawdza, aktualizowanie, usuwanie i wstawianie partie danych.</span><span class="sxs-lookup"><span data-stu-id="9b074-107">This tutorial is the first of four that looks at updating, deleting, and inserting batches of data.</span></span> <span data-ttu-id="9b074-108">W tym samouczku dowie się, jak zezwolić zmian usługi batch należy przeprowadzić jako operacją niepodzielną gwarantuje, że wszystkie kroki powodzenie lub niepowodzenie wszystkich kroków w transakcji bazy danych.</span><span class="sxs-lookup"><span data-stu-id="9b074-108">In this tutorial we learn how database transactions allow batch modifications to be carried out as an atomic operation, which ensures that either all steps succeed or all steps fail.</span></span>


## <a name="introduction"></a><span data-ttu-id="9b074-109">Wprowadzenie</span><span class="sxs-lookup"><span data-stu-id="9b074-109">Introduction</span></span>

<span data-ttu-id="9b074-110">Jak widzieliśmy, począwszy od [Przegląd Wstawianie, aktualizowanie i usuwanie danych](../editing-inserting-and-deleting-data/an-overview-of-inserting-updating-and-deleting-data-cs.md) samouczku widoku GridView udostępnia wbudowaną obsługę na poziomie wiersza, edytowania i usuwania.</span><span class="sxs-lookup"><span data-stu-id="9b074-110">As we saw starting with the [An Overview of Inserting, Updating, and Deleting Data](../editing-inserting-and-deleting-data/an-overview-of-inserting-updating-and-deleting-data-cs.md) tutorial, the GridView provides built-in support for row-level editing and deleting.</span></span> <span data-ttu-id="9b074-111">Za pomocą kilku kliknięć myszą jest możliwe utworzenie interfejsu modyfikacji danych bez konieczności pisania nawet wiersza kodu, tak długo, jak się zawartość edytowania i usuwania na zasadzie na wiersz.</span><span class="sxs-lookup"><span data-stu-id="9b074-111">With a few clicks of the mouse it is possible to create a rich data modification interface without writing a line of code, so long as you are content with editing and deleting on a per-row basis.</span></span> <span data-ttu-id="9b074-112">Jednak w niektórych scenariuszach to za mało, więc chcemy zapewnić użytkownikom możliwość edytowania lub usunięcia partii rekordów.</span><span class="sxs-lookup"><span data-stu-id="9b074-112">However, in certain scenarios this is insufficient and we need to provide users with the ability to edit or delete a batch of records.</span></span>

<span data-ttu-id="9b074-113">Na przykład najbardziej opartego na sieci web klientów poczty e-mail umożliwia siatki listy każdy komunikat gdzie każdy wiersz zawiera pola wyboru wraz z informacjami s poczty e-mail (temat, nadawca i tak dalej).</span><span class="sxs-lookup"><span data-stu-id="9b074-113">For example, most web-based email clients use a grid to list each message where each row includes a checkbox along with the email s information (subject, sender, and so forth).</span></span> <span data-ttu-id="9b074-114">Ten interfejs umożliwia użytkownikowi usuwanie wielu komunikatów, zaznaczając je, a następnie klikając przycisk Usuń zaznaczone komunikaty o.</span><span class="sxs-lookup"><span data-stu-id="9b074-114">This interface permits the user to delete multiple messages by checking them and then clicking a Delete Selected Messages button.</span></span> <span data-ttu-id="9b074-115">Edytowanie interfejsu usługi batch jest idealne w sytuacji, w którym użytkownicy często edytować wiele różnych rekordów.</span><span class="sxs-lookup"><span data-stu-id="9b074-115">A batch editing interface is ideal in situations where users commonly edit many different records.</span></span> <span data-ttu-id="9b074-116">Zamiast zmuszania użytkownika, kliknij pozycję Edytuj, wprowadzić swoje zmiany i następnie kliknij przycisk Aktualizuj dla każdego rekordu, który ma zostać zmodyfikowana, partii edytowanie interfejsu renderuje każdy wiersz kończy jego edycji interfejsu.</span><span class="sxs-lookup"><span data-stu-id="9b074-116">Rather than forcing the user to click Edit, make their change, and then click Update for each record that needs to be modified, a batch editing interface renders each row with its editing interface.</span></span> <span data-ttu-id="9b074-117">Użytkownika można szybko zmodyfikować zestawu wierszy, które muszą zostać zmienione, a następnie zapisz te zmiany, klikając przycisk Aktualizuj wszystkie.</span><span class="sxs-lookup"><span data-stu-id="9b074-117">The user can quickly modify the set of rows that need to be changed and then save these changes by clicking an Update All button.</span></span> <span data-ttu-id="9b074-118">W tym zestawie samouczków zajmiemy się, jak utworzyć interfejsy do wstawiania, edytowanie i usuwanie partii danych.</span><span class="sxs-lookup"><span data-stu-id="9b074-118">In this set of tutorials we'll examine how to create interfaces for inserting, editing, and deleting batches of data.</span></span>

<span data-ttu-id="9b074-119">Podczas wykonywania operacji wsadowych jego ważne określić, czy powinno być możliwe w przypadku niektórych operacji w usłudze batch zakończyło się sukcesem, podczas gdy inne się nie powieść.</span><span class="sxs-lookup"><span data-stu-id="9b074-119">When performing batch operations it s important to determine whether it should be possible for some of the operations in the batch to succeed while others fail.</span></span> <span data-ttu-id="9b074-120">Należy wziąć pod uwagę partii usuwanie interfejs — co ma się zdarzyć, jeśli pierwszy wybrany rekord został pomyślnie usunięty, ale drugi kończy się niepowodzeniem, powiedz, ze względu na naruszenie ograniczenia klucza obcego?</span><span class="sxs-lookup"><span data-stu-id="9b074-120">Consider a batch deleting interface - what should happen if the first selected record is deleted successfully, but the second one fails, say, because of a foreign key constraint violation?</span></span> <span data-ttu-id="9b074-121">Najpierw usuń rekord s konieczność wycofania, czy jest to dopuszczalne dla pierwszego rekordu zachować usuniętych?</span><span class="sxs-lookup"><span data-stu-id="9b074-121">Should the first record s delete be rolled back or is it acceptable for the first record to remain deleted?</span></span>

<span data-ttu-id="9b074-122">Jeśli chcesz, aby operacji zbiorczej powinien być traktowany jako [niepodzielna operacja](http://en.wikipedia.org/wiki/Atomic_operation), jeden gdzie albo wszystkich kroków powiedzie się lub wszystkie kroki zakończyć się niepowodzeniem, a następnie warstwy dostępu do danych musi zostać rozszerzony o obsługę [bazy danych Transakcje](http://en.wikipedia.org/wiki/Database_transaction).</span><span class="sxs-lookup"><span data-stu-id="9b074-122">If you want the batch operation to be treated as an [atomic operation](http://en.wikipedia.org/wiki/Atomic_operation), one where either all of the steps succeed or all of the steps fail, then the Data Access Layer needs to be augmented to include support for [database transactions](http://en.wikipedia.org/wiki/Database_transaction).</span></span> <span data-ttu-id="9b074-123">Transakcje bazy danych gwarantuje niepodzielność zestawu `INSERT`, `UPDATE`, i `DELETE` instrukcje wykonywane w obszarze parasola transakcji i są obsługiwane przez większość systemów nowoczesnych bazy danych wszystkich funkcji.</span><span class="sxs-lookup"><span data-stu-id="9b074-123">Database transactions guarantee atomicity for the set of `INSERT`, `UPDATE`, and `DELETE` statements executed under the umbrella of the transaction and are a feature supported by most all modern database systems.</span></span>

<span data-ttu-id="9b074-124">W tym samouczku Zapoznamy się jak rozszerzyć warstwę DAL, aby móc używać transakcji bazy danych.</span><span class="sxs-lookup"><span data-stu-id="9b074-124">In this tutorial we'll look at how to extend the DAL to use database transactions.</span></span> <span data-ttu-id="9b074-125">Kolejne samouczki zbada Implementowanie strony sieci web dla usługi batch, wstawianie, aktualizowanie i usuwanie interfejsów.</span><span class="sxs-lookup"><span data-stu-id="9b074-125">Subsequent tutorials will examine implementing web pages for batch inserting, updating, and deleting interfaces.</span></span> <span data-ttu-id="9b074-126">Rozpocznij pracę dzięki s!</span><span class="sxs-lookup"><span data-stu-id="9b074-126">Let s get started!</span></span>

> [!NOTE]
> <span data-ttu-id="9b074-127">Podczas modyfikowania danych w transakcji usługi batch, niepodzielność nie jest zawsze potrzebny.</span><span class="sxs-lookup"><span data-stu-id="9b074-127">When modifying data in a batch transaction, atomicity is not always needed.</span></span> <span data-ttu-id="9b074-128">W niektórych scenariuszach może być możliwe do zaakceptowania mają pewne modyfikacje danych powiodło się i inni użytkownicy w tej samej partii nie powiedzie się, takie jak czas usuwania zestawu wiadomości e-mail z klienta e-mail opartego na sieci web.</span><span class="sxs-lookup"><span data-stu-id="9b074-128">In some scenarios, it may be acceptable to have some data modifications succeed and others in the same batch fail, such as when deleting a set of emails from a web-based email client.</span></span> <span data-ttu-id="9b074-129">Jeśli występują s midway błąd bazy danych, poprzez usunięcie procesu jej s prawdopodobnie dopuszczalne usunięto pozostawienie tych rekordów przetwarzania bez błędów.</span><span class="sxs-lookup"><span data-stu-id="9b074-129">If there s a database error midway through the deletion process, it s probably acceptable that those records processed without error remain deleted.</span></span> <span data-ttu-id="9b074-130">W takich przypadkach warstwy DAL nie musi zostać zmodyfikowane w celu obsługi transakcji bazy danych.</span><span class="sxs-lookup"><span data-stu-id="9b074-130">In such cases, the DAL does not need to be modified to support database transactions.</span></span> <span data-ttu-id="9b074-131">Brak innych operacji scenariuszach wsadowych, jednak gdzie niepodzielność jest istotne.</span><span class="sxs-lookup"><span data-stu-id="9b074-131">There are other batch operation scenarios, however, where atomicity is vital.</span></span> <span data-ttu-id="9b074-132">Jeśli klient jej środków jest przenoszony z jednego konta bankowego do innego, należy wykonać dwie operacje: środków należy odjąć od pierwszego konta i następnie dodawane do drugiego.</span><span class="sxs-lookup"><span data-stu-id="9b074-132">When a customer moves her funds from one bank account to another, two operations must be performed: the funds must be deducted from the first account and then added to the second.</span></span> <span data-ttu-id="9b074-133">Bank może nie mieć nic przeciwko po pierwszym krokiem powiedzie się, ale drugi etap się nie powieść, swoim klientom understandably byłaby zła, ponieważ.</span><span class="sxs-lookup"><span data-stu-id="9b074-133">While the bank may not mind having the first step succeed but the second step fail, its customers would understandably be upset.</span></span> <span data-ttu-id="9b074-134">Zachęcam Cię do pracy za pomocą tego samouczka i wdrożenie rozszerzenia z warstwą dal do obsługi transakcji bazy danych, nawet jeśli nie planujesz używania ich w partii, wstawianie, aktualizowanie i usuwanie interfejsów, które będziemy tworzyć w następujących trzech samouczków.</span><span class="sxs-lookup"><span data-stu-id="9b074-134">I encourage you to work through this tutorial and implement the enhancements to the DAL to support database transactions even if you do not plan on using them in the batch inserting, updating, and deleting interfaces we'll be building in the following three tutorials.</span></span>


## <a name="an-overview-of-transactions"></a><span data-ttu-id="9b074-135">Przegląd transakcji</span><span class="sxs-lookup"><span data-stu-id="9b074-135">An Overview of Transactions</span></span>

<span data-ttu-id="9b074-136">Większość baz danych obejmują obsługę *transakcji*, która umożliwia wielu poleceń bazy danych można podzielić na pojedynczą jednostką logiczną pracy.</span><span class="sxs-lookup"><span data-stu-id="9b074-136">Most databases include support for *transactions*, which enable multiple database commands to be grouped into a single logical unit of work.</span></span> <span data-ttu-id="9b074-137">Polecenia bazy danych, wchodzące w skład transakcji jest gwarantowana niepodzielnych, co oznacza, że wszystkie polecenia zakończy się niepowodzeniem lub wszystkie zakończy się powodzeniem.</span><span class="sxs-lookup"><span data-stu-id="9b074-137">The database commands that comprise a transaction are guaranteed to be atomic, meaning that either all commands will fail or all will succeed.</span></span>

<span data-ttu-id="9b074-138">Ogólnie rzecz biorąc transakcje są implementowane za pomocą instrukcji języka SQL przy użyciu następującego wzorca:</span><span class="sxs-lookup"><span data-stu-id="9b074-138">In general, transactions are implemented through SQL statements using the following pattern:</span></span>

1. <span data-ttu-id="9b074-139">Wskazuje początek transakcji.</span><span class="sxs-lookup"><span data-stu-id="9b074-139">Indicate the start of a transaction.</span></span>
2. <span data-ttu-id="9b074-140">Wykonaj instrukcje SQL, wchodzące w skład transakcji.</span><span class="sxs-lookup"><span data-stu-id="9b074-140">Execute the SQL statements that comprise the transaction.</span></span>
3. <span data-ttu-id="9b074-141">Jeśli występuje błąd w jednej instrukcji z kroku nr 2 wycofywania transakcji.</span><span class="sxs-lookup"><span data-stu-id="9b074-141">If there is an error in one of the statements from Step 2, rollback the transaction.</span></span>
4. <span data-ttu-id="9b074-142">Jeśli wszystkie instrukcje z kroku nr 2 zakończy się bez błędów, należy zatwierdzić transakcji.</span><span class="sxs-lookup"><span data-stu-id="9b074-142">If all of the statements from Step 2 complete without error, commit the transaction.</span></span>

<span data-ttu-id="9b074-143">Instrukcje SQL używane do tworzenia, zatwierdzania i wycofać transakcji, można wprowadzić ręcznie podczas pisania skryptów SQL lub tworzenie procedur składowanych lub za pośrednictwem programowe oznacza, że za pomocą ADO.NET lub klas w [ `System.Transactions` przestrzeń nazw](https://msdn.microsoft.com/library/system.transactions.aspx).</span><span class="sxs-lookup"><span data-stu-id="9b074-143">The SQL statements used to create, commit, and roll back the transaction can be entered manually when writing SQL scripts or creating stored procedures, or through programmatic means using either ADO.NET or the classes in the [`System.Transactions` namespace](https://msdn.microsoft.com/library/system.transactions.aspx).</span></span> <span data-ttu-id="9b074-144">W tym samouczku będziemy tylko sprawdzać Zarządzanie transakcji za pomocą ADO.NET.</span><span class="sxs-lookup"><span data-stu-id="9b074-144">In this tutorial we will only examine managing transactions using ADO.NET.</span></span> <span data-ttu-id="9b074-145">W przyszłości samouczku przedstawiony zostanie sposób użycia procedur składowanych w warstwie dostępu do danych, które omówimy następujące zagadnienia instrukcji SQL do tworzenia, wycofywanie i zatwierdzania transakcji.</span><span class="sxs-lookup"><span data-stu-id="9b074-145">In a future tutorial we will look at how to use stored procedures in the Data Access Layer, at which time we'll explore the SQL statements for creating, rolling back, and committing transactions.</span></span> <span data-ttu-id="9b074-146">W międzyczasie, zapoznaj się z [zarządzania transakcji w procedur składowanych serwera SQL](http://www.4guysfromrolla.com/webtech/080305-1.shtml) Aby uzyskać więcej informacji.</span><span class="sxs-lookup"><span data-stu-id="9b074-146">In the meantime, consult [Managing Transactions in SQL Server Stored Procedures](http://www.4guysfromrolla.com/webtech/080305-1.shtml) for more information.</span></span>

> [!NOTE]
> <span data-ttu-id="9b074-147">[ `TransactionScope` Klasy](https://msdn.microsoft.com/library/system.transactions.transactionscope.aspx) w `System.Transactions` przestrzeń nazw umożliwia deweloperom programowo zawinąć serię instrukcji w zakresie transakcji i obejmuje obsługę złożonych transakcji, które obejmują wiele źródeł, takich jak dwóch różnych bazach danych lub nawet heterogenicznych typów magazynów danych, takich jak bazy danych programu Microsoft SQL Server, Oracle database oraz usługi sieci Web.</span><span class="sxs-lookup"><span data-stu-id="9b074-147">The [`TransactionScope` class](https://msdn.microsoft.com/library/system.transactions.transactionscope.aspx) in the `System.Transactions` namespace enables developers to programmatically wrap a series of statements within the scope of a transaction and includes support for complex transactions that involve multiple sources, such as two different databases or even heterogeneous types of data stores, such as a Microsoft SQL Server database, an Oracle database, and a Web service.</span></span> <span data-ttu-id="9b074-148">Czy mogę ve zdecydowała się na potrzeby tego samouczka, a nie przy użyciu transakcji ADO.NET `TransactionScope` klasy ADO.NET jest bardziej szczegółowe dla transakcji bazy danych, a w wielu przypadkach jest znacznie mniej dużej ilości zasobów.</span><span class="sxs-lookup"><span data-stu-id="9b074-148">I ve decided to use ADO.NET transactions for this tutorial instead of the `TransactionScope` class because ADO.NET is more specific for database transactions and, in many cases, is far less resource intensive.</span></span> <span data-ttu-id="9b074-149">Ponadto w pewnych scenariuszach `TransactionScope` klasa używa transakcji Koordynator MSDTC (Microsoft Distributed).</span><span class="sxs-lookup"><span data-stu-id="9b074-149">In addition, under certain scenarios the `TransactionScope` class uses the Microsoft Distributed Transaction Coordinator (MSDTC).</span></span> <span data-ttu-id="9b074-150">Problemy konfiguracji, wdrażania i wydajności otaczającego MSDTC sprawia, że zamiast wyspecjalizowanych i zaawansowane tematu i poza zakres tego samouczka.</span><span class="sxs-lookup"><span data-stu-id="9b074-150">The configuration, implementation, and performance issues surrounding MSDTC makes it a rather specialized and advanced topic and beyond the scope of these tutorials.</span></span>


<span data-ttu-id="9b074-151">Podczas pracy z dostawcy SqlClient w ADO.NET, transakcje są inicjowane za pomocą wywołania [ `SqlConnection` klasy](https://msdn.microsoft.com/library/system.data.sqlclient.sqlconnection.aspx) s [ `BeginTransaction` metoda](https://msdn.microsoft.com/library/system.data.sqlclient.sqlconnection.begintransaction.aspx), co powoduje zwrócenie [ `SqlTransaction` obiektu](https://msdn.microsoft.com/library/system.data.sqlclient.sqltransaction.aspx).</span><span class="sxs-lookup"><span data-stu-id="9b074-151">When working with the SqlClient provider in ADO.NET, transactions are initiated through a call to the [`SqlConnection` class](https://msdn.microsoft.com/library/system.data.sqlclient.sqlconnection.aspx) s [`BeginTransaction` method](https://msdn.microsoft.com/library/system.data.sqlclient.sqlconnection.begintransaction.aspx), which returns a [`SqlTransaction` object](https://msdn.microsoft.com/library/system.data.sqlclient.sqltransaction.aspx).</span></span> <span data-ttu-id="9b074-152">Instrukcje modyfikacji danych, które korzeń transakcji są umieszczane w ramach `try...catch` bloku.</span><span class="sxs-lookup"><span data-stu-id="9b074-152">The data modification statements that makeup the transaction are placed within a `try...catch` block.</span></span> <span data-ttu-id="9b074-153">Jeśli wystąpi błąd w instrukcji w `try` block przenosi wykonanie do `catch` bloku, w którym transakcji można wycofać za pośrednictwem `SqlTransaction` obiektu s [ `Rollback` metoda](https://msdn.microsoft.com/library/system.data.sqlclient.sqltransaction.rollback.aspx).</span><span class="sxs-lookup"><span data-stu-id="9b074-153">If an error occurs in a statement in the `try` block, execution transfers to the `catch` block where the transaction can be rolled back via the `SqlTransaction` object s [`Rollback` method](https://msdn.microsoft.com/library/system.data.sqlclient.sqltransaction.rollback.aspx).</span></span> <span data-ttu-id="9b074-154">Jeśli wszystkie instrukcje zakończy się pomyślnie, wywołanie `SqlTransaction` obiektu s [ `Commit` metoda](https://msdn.microsoft.com/library/system.data.sqlclient.sqltransaction.commit.aspx) na końcu `try` bloku zatwierdzeń transakcji.</span><span class="sxs-lookup"><span data-stu-id="9b074-154">If all of the statements complete successfully, a call to the `SqlTransaction` object s [`Commit` method](https://msdn.microsoft.com/library/system.data.sqlclient.sqltransaction.commit.aspx) at the end of the `try` block commits the transaction.</span></span> <span data-ttu-id="9b074-155">Poniższy fragment kodu ilustruje ten wzorzec.</span><span class="sxs-lookup"><span data-stu-id="9b074-155">The following code snippet illustrates this pattern.</span></span> <span data-ttu-id="9b074-156">Zobacz [utrzymania spójności bazy danych z transakcjami](http://aspnet.4guysfromrolla.com/articles/072705-1.aspx) dodatkowej składni i przykłady za pomocą transakcji za pomocą narzędzia ADO.NET.</span><span class="sxs-lookup"><span data-stu-id="9b074-156">See [Maintaining Database Consistency with Transactions](http://aspnet.4guysfromrolla.com/articles/072705-1.aspx) for additional syntax and examples of using transactions with ADO.NET.</span></span>


[!code-csharp[Main](wrapping-database-modifications-within-a-transaction-cs/samples/sample1.cs)]

<span data-ttu-id="9b074-157">Domyślnie adapterów TableAdapter w zestawie danych wpisane nie należy używać transakcji.</span><span class="sxs-lookup"><span data-stu-id="9b074-157">By default, the TableAdapters in a Typed DataSet do not use transactions.</span></span> <span data-ttu-id="9b074-158">Aby zapewnić obsługę dla transakcji należy rozszerzyć klasy TableAdapter, aby uwzględnić dodatkowe metody, za pomocą wzorca powyżej szereg instrukcji modyfikacji danych w zakresie transakcji.</span><span class="sxs-lookup"><span data-stu-id="9b074-158">To provide support for transactions we need to augment the TableAdapter classes to include additional methods that use the above pattern to perform a series of data modification statements within the scope of a transaction.</span></span> <span data-ttu-id="9b074-159">W kroku 2 Zobaczymy się, jak używać klas częściowych można dodać te metody.</span><span class="sxs-lookup"><span data-stu-id="9b074-159">In Step 2 we'll see how to use partial classes to add these methods.</span></span>

## <a name="step-1-creating-the-working-with-batched-data-web-pages"></a><span data-ttu-id="9b074-160">Krok 1. Tworzenie pracy ze stronami sieci Web partiami danych</span><span class="sxs-lookup"><span data-stu-id="9b074-160">Step 1: Creating the Working with Batched Data Web Pages</span></span>

<span data-ttu-id="9b074-161">Zanim zaczniemy, eksplorowanie sposób rozszerzyć warstwę DAL do obsługi transakcji bazy danych, niech s najpierw Poświęć chwilę, do tworzenia strony sieci web ASP.NET, które są wymagane na potrzeby tego samouczka i trzech, które należy wykonać.</span><span class="sxs-lookup"><span data-stu-id="9b074-161">Before we start exploring how to augment the DAL to support database transactions, let s first take a moment to create the ASP.NET web pages that we will need for this tutorial and the three that follow.</span></span> <span data-ttu-id="9b074-162">Rozpocznij od dodania nowy folder o nazwie `BatchData` , a następnie dodaj następujące strony ASP.NET, kojarzenie każdej strony zawierającej `Site.master` strony wzorcowej.</span><span class="sxs-lookup"><span data-stu-id="9b074-162">Start by adding a new folder named `BatchData` and then add the following ASP.NET pages, associating each page with the `Site.master` master page.</span></span>

- `Default.aspx`
- `Transactions.aspx`
- `BatchUpdate.aspx`
- `BatchDelete.aspx`
- `BatchInsert.aspx`


![Dodawanie stron ASP.NET związane z kontrolką SqlDataSource samouczki](wrapping-database-modifications-within-a-transaction-cs/_static/image1.gif)

<span data-ttu-id="9b074-164">**Rysunek 1**: Dodawanie stron ASP.NET związane z kontrolką SqlDataSource samouczki</span><span class="sxs-lookup"><span data-stu-id="9b074-164">**Figure 1**: Add the ASP.NET Pages for the SqlDataSource-Related Tutorials</span></span>


<span data-ttu-id="9b074-165">Podobnie jak w przypadku innych folderów `Default.aspx` użyje `SectionLevelTutorialListing.ascx` kontrolki użytkownika, aby wyświetlić listę samouczków w obrębie sekcji.</span><span class="sxs-lookup"><span data-stu-id="9b074-165">As with the other folders, `Default.aspx` will use the `SectionLevelTutorialListing.ascx` User Control to list the tutorials within its section.</span></span> <span data-ttu-id="9b074-166">W związku z tym, Dodaj ten formant użytkownika do `Default.aspx` , przeciągając go z poziomu Eksploratora rozwiązań na stronę s widoku projektu.</span><span class="sxs-lookup"><span data-stu-id="9b074-166">Therefore, add this User Control to `Default.aspx` by dragging it from the Solution Explorer onto the page s Design view.</span></span>


[![A<span data-ttu-id="9b074-167">Dodaj formant użytkownika SectionLevelTutorialListing.ascx Default.aspx]</span><span class="sxs-lookup"><span data-stu-id="9b074-167">dd the SectionLevelTutorialListing.ascx User Control to Default.aspx]</span></span>(wrapping-database-modifications-within-a-transaction-cs/_static/image2.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image1.png)

<span data-ttu-id="9b074-168">**Rysunek 2**: Dodaj `SectionLevelTutorialListing.ascx` kontrolki użytkownika do `Default.aspx` ([kliknij, aby wyświetlić obraz w pełnym rozmiarze](wrapping-database-modifications-within-a-transaction-cs/_static/image2.png))</span><span class="sxs-lookup"><span data-stu-id="9b074-168">**Figure 2**: Add the `SectionLevelTutorialListing.ascx` User Control to `Default.aspx` ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-cs/_static/image2.png))</span></span>


<span data-ttu-id="9b074-169">Wreszcie, Dodaj te cztery strony jako wpisy, aby `Web.sitemap` pliku.</span><span class="sxs-lookup"><span data-stu-id="9b074-169">Lastly, add these four pages as entries to the `Web.sitemap` file.</span></span> <span data-ttu-id="9b074-170">W szczególności należy dodać następujące znaczniki po Dostosowywanie mapy witryny `<siteMapNode>`:</span><span class="sxs-lookup"><span data-stu-id="9b074-170">Specifically, add the following markup after the Customizing the Site Map `<siteMapNode>`:</span></span>


[!code-xml[Main](wrapping-database-modifications-within-a-transaction-cs/samples/sample2.xml)]

<span data-ttu-id="9b074-171">Po zaktualizowaniu `Web.sitemap`, Poświęć chwilę, aby wyświetlić witrynę sieci Web w samouczkach, za pośrednictwem przeglądarki.</span><span class="sxs-lookup"><span data-stu-id="9b074-171">After updating `Web.sitemap`, take a moment to view the tutorials website through a browser.</span></span> <span data-ttu-id="9b074-172">Menu po lewej stronie zawiera teraz elementów do pracy z samouczkami partiami danych.</span><span class="sxs-lookup"><span data-stu-id="9b074-172">The menu on the left now includes items for the working with batched data tutorials.</span></span>


![Mapa witryny zawiera teraz wpisy dotyczące pracy z samouczkami partiami danych](wrapping-database-modifications-within-a-transaction-cs/_static/image3.gif)

<span data-ttu-id="9b074-174">**Rysunek 3**: Mapa witryny zawiera teraz wpisy dotyczące pracy z samouczkami partiami danych</span><span class="sxs-lookup"><span data-stu-id="9b074-174">**Figure 3**: The Site Map Now Includes Entries for the Working with Batched Data Tutorials</span></span>


## <a name="step-2-updating-the-data-access-layer-to-support-database-transactions"></a><span data-ttu-id="9b074-175">Krok 2. Aktualizowanie warstwy dostępu do danych do obsługi transakcji bazy danych</span><span class="sxs-lookup"><span data-stu-id="9b074-175">Step 2: Updating the Data Access Layer to Support Database Transactions</span></span>

<span data-ttu-id="9b074-176">Jak wspomniano w pierwszym samouczku [Tworzenie warstwy dostępu do danych](../introduction/creating-a-data-access-layer-cs.md), wpisana zestawu danych w naszym DAL składa się z DataTable i TableAdapters.</span><span class="sxs-lookup"><span data-stu-id="9b074-176">As we discussed back in the first tutorial, [Creating a Data Access Layer](../introduction/creating-a-data-access-layer-cs.md), the Typed DataSet in our DAL is composed of DataTables and TableAdapters.</span></span> <span data-ttu-id="9b074-177">DataTable przechowywania danych, podczas gdy elementów TableAdapter udostępniają funkcje, które można odczytać danych z bazy danych do DataTable, aby zaktualizować bazę danych ze zmianami wprowadzonymi do DataTable i tak dalej.</span><span class="sxs-lookup"><span data-stu-id="9b074-177">The DataTables hold data while the TableAdapters provide the functionality to read data from the database into the DataTables, to update the database with changes made to the DataTables, and so forth.</span></span> <span data-ttu-id="9b074-178">Pamiętaj, że elementów TableAdapter zapewnić dwa wzorce dla uaktualnienie danych, którego mogę nazywa się aktualizacji usługi Batch i bazy danych bezpośrednio.</span><span class="sxs-lookup"><span data-stu-id="9b074-178">Recall that the TableAdapters provide two patterns for updating data, which I referred to as Batch Update and DB-Direct.</span></span> <span data-ttu-id="9b074-179">Za pomocą wzorca aktualizacji wsadowych TableAdapter jest przekazywany w DataSet, DataTable lub kolekcji wierszy danych.</span><span class="sxs-lookup"><span data-stu-id="9b074-179">With the Batch Update pattern, the TableAdapter is passed a DataSet, DataTable, or collection of DataRows.</span></span> <span data-ttu-id="9b074-180">Te dane są wyliczane i dla każdego wstawiania, zmodyfikować lub usunąć wiersza, `InsertCommand`, `UpdateCommand`, lub `DeleteCommand` jest wykonywany.</span><span class="sxs-lookup"><span data-stu-id="9b074-180">This data is enumerated and for each inserted, modified, or deleted row, the `InsertCommand`, `UpdateCommand`, or `DeleteCommand` is executed.</span></span> <span data-ttu-id="9b074-181">Za pomocą wzorca bazy danych bezpośrednio TableAdapter jest przekazywany zamiast wartości kolumn, które są niezbędne do wstawiania, aktualizowania lub usuwania pojedynczy rekord.</span><span class="sxs-lookup"><span data-stu-id="9b074-181">With the DB-Direct pattern, the TableAdapter is instead passed the values of the columns necessary for inserting, updating, or deleting a single record.</span></span> <span data-ttu-id="9b074-182">Metody bezpośredniej DB wzorzec następnie używa tych wartości przekazywane w wykonać odpowiednie `InsertCommand`, `UpdateCommand`, lub `DeleteCommand` instrukcji.</span><span class="sxs-lookup"><span data-stu-id="9b074-182">The DB Direct pattern method then uses those passed-in values to execute the appropriate `InsertCommand`, `UpdateCommand`, or `DeleteCommand` statement.</span></span>

<span data-ttu-id="9b074-183">Niezależnie od tego wzorca aktualizacji używane metody automatycznego generowania adapterów TableAdapter nie należy używać transakcji.</span><span class="sxs-lookup"><span data-stu-id="9b074-183">Regardless of the update pattern used, the TableAdapters auto-generated methods do not use transactions.</span></span> <span data-ttu-id="9b074-184">Domyślnie każdy insert, update lub delete wykonywanych przez TableAdapter jest traktowany jako pojedyncza operacja dyskretnych.</span><span class="sxs-lookup"><span data-stu-id="9b074-184">By default each insert, update, or delete performed by the TableAdapter is treated as a single discrete operation.</span></span> <span data-ttu-id="9b074-185">Na przykład załóżmy, że wzorzec bezpośrednio z bazy danych jest używany przez jakiś kod w LOGIKI można wstawić dziesięć rekordów do bazy danych.</span><span class="sxs-lookup"><span data-stu-id="9b074-185">For instance, imagine that the DB-Direct pattern is used by some code in the BLL to insert ten records into the database.</span></span> <span data-ttu-id="9b074-186">Ten kod może wywołać metodę TableAdapter `Insert` metoda dziesięć razy.</span><span class="sxs-lookup"><span data-stu-id="9b074-186">This code would call the TableAdapter s `Insert` method ten times.</span></span> <span data-ttu-id="9b074-187">Jeśli pięciu pierwszych wstawia powiedzie się, ale szóstego co spowodowało wyjątek, pierwsze pięć rekordów wstawiono pozostanie w bazie danych.</span><span class="sxs-lookup"><span data-stu-id="9b074-187">If the first five inserts succeed, but the sixth one resulted in an exception, the first five inserted records would remain in the database.</span></span> <span data-ttu-id="9b074-188">Podobnie, jeśli wzorzec aktualizacji usługi Batch jest używany do wykonywania operacji wstawiania, aktualizacji i usuwania do wstawionego, modyfikacji i usunięto wierszy w DataTable, jeśli pierwsze kilka zmian zakończyło się pomyślnie, ale późniejszą napotkał błąd, te wcześniejszych zmian, Ukończono pozostanie w bazie danych.</span><span class="sxs-lookup"><span data-stu-id="9b074-188">Similarly, if the Batch Update pattern is used to perform inserts, updates, and deletes to the inserted, modified, and deleted rows in a DataTable, if the first several modifications succeeded but a later one encountered an error, those earlier modifications that completed would remain in the database.</span></span>

<span data-ttu-id="9b074-189">W niektórych scenariuszach chcemy zapewnić niepodzielność w szereg zmian.</span><span class="sxs-lookup"><span data-stu-id="9b074-189">In certain scenarios we want to ensure atomicity across a series of modifications.</span></span> <span data-ttu-id="9b074-190">Firma Microsoft musi ręcznie rozszerzyć TableAdapter, dodając nowe metody, które są wykonywane w tym celu `InsertCommand`, `UpdateCommand`, i `DeleteCommand` s w obszarze parasola transakcji.</span><span class="sxs-lookup"><span data-stu-id="9b074-190">To accomplish this we must manually extend the TableAdapter by adding new methods that execute the `InsertCommand`, `UpdateCommand`, and `DeleteCommand` s under the umbrella of a transaction.</span></span> <span data-ttu-id="9b074-191">W [Tworzenie warstwy dostępu do danych](../introduction/creating-a-data-access-layer-cs.md) przyjrzeliśmy się przy użyciu [klas częściowych](http://en.wikipedia.org/wiki/Partial_type) do rozszerzenia funkcji DataTable w DataSet wpisane.</span><span class="sxs-lookup"><span data-stu-id="9b074-191">In [Creating a Data Access Layer](../introduction/creating-a-data-access-layer-cs.md) we looked at using [partial classes](http://en.wikipedia.org/wiki/Partial_type) to extend the functionality of the DataTables within the Typed DataSet.</span></span> <span data-ttu-id="9b074-192">Tej techniki można również za pomocą adapterów TableAdapter.</span><span class="sxs-lookup"><span data-stu-id="9b074-192">This technique can also be used with TableAdapters.</span></span>

<span data-ttu-id="9b074-193">Wpisany zestaw danych `Northwind.xsd` znajduje się w `App_Code` folderu s `DAL` podfolderu.</span><span class="sxs-lookup"><span data-stu-id="9b074-193">The Typed DataSet `Northwind.xsd` is located in the `App_Code` folder s `DAL` subfolder.</span></span> <span data-ttu-id="9b074-194">Utwórz podfolder w `DAL` folder o nazwie `TransactionSupport` i Dodaj plik klasy o nazwie `ProductsTableAdapter.TransactionSupport.cs` (zobacz rysunek 4).</span><span class="sxs-lookup"><span data-stu-id="9b074-194">Create a subfolder in the `DAL` folder named `TransactionSupport` and add a new class file named `ProductsTableAdapter.TransactionSupport.cs` (see Figure 4).</span></span> <span data-ttu-id="9b074-195">Ten plik będzie zawierać wdrożony częściowo `ProductsTableAdapter` zawierającej metody służące do wykonywania modyfikacji danych przy użyciu transakcji.</span><span class="sxs-lookup"><span data-stu-id="9b074-195">This file will hold the partial implementation of the `ProductsTableAdapter` that includes methods for performing data modifications using a transaction.</span></span>


![Dodaj Folder o nazwie TransactionSupport i plik klasy o nazwie ProductsTableAdapter.TransactionSupport.cs](wrapping-database-modifications-within-a-transaction-cs/_static/image4.gif)

<span data-ttu-id="9b074-197">**Rysunek 4**: Dodaj Folder o nazwie `TransactionSupport` i plik klasy o nazwie</span><span class="sxs-lookup"><span data-stu-id="9b074-197">**Figure 4**: Add a Folder Named `TransactionSupport` and a Class File Named</span></span> `ProductsTableAdapter.TransactionSupport.cs`


<span data-ttu-id="9b074-198">Wprowadź następujący kod do `ProductsTableAdapter.TransactionSupport.cs` pliku:</span><span class="sxs-lookup"><span data-stu-id="9b074-198">Enter the following code into the `ProductsTableAdapter.TransactionSupport.cs` file:</span></span>


[!code-csharp[Main](wrapping-database-modifications-within-a-transaction-cs/samples/sample3.cs)]

<span data-ttu-id="9b074-199">`partial` Wskazuje — słowo kluczowe w deklaracji klasy, w tym miejscu, aby kompilator, że dodane w obrębie elementów członkowskich mają być dodawane do `ProductsTableAdapter` klasy w `NorthwindTableAdapters` przestrzeni nazw.</span><span class="sxs-lookup"><span data-stu-id="9b074-199">The `partial` keyword in the class declaration here indicates to the compiler that the members added within are to be added to the `ProductsTableAdapter` class in the `NorthwindTableAdapters` namespace.</span></span> <span data-ttu-id="9b074-200">Uwaga `using System.Data.SqlClient` instrukcji w górnej części pliku.</span><span class="sxs-lookup"><span data-stu-id="9b074-200">Note the `using System.Data.SqlClient` statement at the top of the file.</span></span> <span data-ttu-id="9b074-201">Ponieważ TableAdapter został skonfigurowany do używania dostawcy SqlClient, wewnętrznie używa [ `SqlDataAdapter` ](https://msdn.microsoft.com/library/system.data.sqlclient.sqldataadapter.aspx) obiekt do wysyłania poleceń do bazy danych.</span><span class="sxs-lookup"><span data-stu-id="9b074-201">Since the TableAdapter was configured to use the SqlClient provider, internally it uses a [`SqlDataAdapter`](https://msdn.microsoft.com/library/system.data.sqlclient.sqldataadapter.aspx) object to issue its commands to the database.</span></span> <span data-ttu-id="9b074-202">W związku z tym, należy wykonać `SqlTransaction` klasy, aby rozpocząć transakcji, a następnie przekazać go ani go wycofać.</span><span class="sxs-lookup"><span data-stu-id="9b074-202">Consequently, we need to use the `SqlTransaction` class to begin the transaction and then to commit it or roll it back.</span></span> <span data-ttu-id="9b074-203">Jeśli używasz magazynu danych innych niż Microsoft SQL Server, należy użyć odpowiedniego dostawcy.</span><span class="sxs-lookup"><span data-stu-id="9b074-203">If you are using a data store other than Microsoft SQL Server, you'll need to use the appropriate provider.</span></span>

<span data-ttu-id="9b074-204">Metody te zapewniają bloki konstrukcyjne potrzebne do uruchomienia, wycofywania i zatwierdzić transakcji.</span><span class="sxs-lookup"><span data-stu-id="9b074-204">These methods provide the building blocks needed to start, rollback, and commit a transaction.</span></span> <span data-ttu-id="9b074-205">Są one oznaczone `public`, umożliwiając im można używać z poziomu `ProductsTableAdapter`z innej klasy w warstwy DAL i z innej warstwy w architekturze, takich jak LOGIKI.</span><span class="sxs-lookup"><span data-stu-id="9b074-205">They are marked `public`, enabling them to be used from within the `ProductsTableAdapter`, from another class in the DAL, or from another layer in the architecture, such as the BLL.</span></span> `BeginTransaction` <span data-ttu-id="9b074-206">Otwiera wewnętrzny s TableAdapter `SqlConnection` (jeśli jest to konieczne), rozpoczyna się transakcji, a następnie przypisuje go do `Transaction` właściwości i dołącza transakcji do wewnętrznego `SqlDataAdapter` s `SqlCommand` obiektów.</span><span class="sxs-lookup"><span data-stu-id="9b074-206">opens the TableAdapter s internal `SqlConnection` (if needed), begins the transaction and assigns it to the `Transaction` property, and attaches the transaction to the internal `SqlDataAdapter` s `SqlCommand` objects.</span></span> `CommitTransaction` <span data-ttu-id="9b074-207">i `RollbackTransaction` wywołania `Transaction` obiektu s `Commit` i `Rollback` metod, odpowiednio, przed zamknięciem wewnętrzny `Connection` obiektu.</span><span class="sxs-lookup"><span data-stu-id="9b074-207">and `RollbackTransaction` call the `Transaction` object s `Commit` and `Rollback` methods, respectively, before closing the internal `Connection` object.</span></span>

## <a name="step-3-adding-methods-to-update-and-delete-data-under-the-umbrella-of-a-transaction"></a><span data-ttu-id="9b074-208">Krok 3. Dodawanie metod do aktualizowania i usuwania danych w obszarze parasola transakcji</span><span class="sxs-lookup"><span data-stu-id="9b074-208">Step 3: Adding Methods to Update and Delete Data Under the Umbrella of a Transaction</span></span>

<span data-ttu-id="9b074-209">Za pomocą tych metod pełną, możemy ponownie gotowa do Dodaj metody do `ProductsDataTable` lub LOGIKI, które wykonują serię poleceń w obszarze parasola transakcji.</span><span class="sxs-lookup"><span data-stu-id="9b074-209">With these methods complete, we re ready to add methods to `ProductsDataTable` or the BLL that perform a series of commands under the umbrella of a transaction.</span></span> <span data-ttu-id="9b074-210">Poniższa metoda używa wzorca aktualizacji usługi Batch do aktualizacji `ProductsDataTable` przy użyciu transakcji.</span><span class="sxs-lookup"><span data-stu-id="9b074-210">The following method uses the Batch Update pattern to update a `ProductsDataTable` instance using a transaction.</span></span> <span data-ttu-id="9b074-211">Rozpoczyna transakcji wywoływania `BeginTransaction` metody, a następnie używa `try...catch` bloku, aby wydać instrukcji modyfikacji danych.</span><span class="sxs-lookup"><span data-stu-id="9b074-211">It starts a transaction by calling the `BeginTransaction` method and then uses a `try...catch` block to issue the data modification statements.</span></span> <span data-ttu-id="9b074-212">Jeśli wywołanie `Adapter` obiektu s `Update` wykonanie metody powoduje wyjątek, zostaną przeniesione do `catch` blok, gdy transakcja zostanie wycofana i ponownie zgłoszony wyjątek.</span><span class="sxs-lookup"><span data-stu-id="9b074-212">If the call to the `Adapter` object s `Update` method results in an exception, execution will transfer to the `catch` block where the transaction will be rolled back and the exception re-thrown.</span></span> <span data-ttu-id="9b074-213">Pamiętamy `Update` metoda implementuje wzorzec aktualizacji usługi Batch, wyliczając wiersze podane `ProductsDataTable` i wykonując niezbędne `InsertCommand`, `UpdateCommand`, i `DeleteCommand` s.</span><span class="sxs-lookup"><span data-stu-id="9b074-213">Recall that the `Update` method implements the Batch Update pattern by enumerating the rows of the supplied `ProductsDataTable` and performing the necessary `InsertCommand`, `UpdateCommand`, and `DeleteCommand` s.</span></span> <span data-ttu-id="9b074-214">Jeśli jeden z tych poleceń będzie skutkowało błędem, transakcja zostanie wycofana, cofnięcie wcześniejszych zmian wprowadzonych w okresie istnienia s transakcji.</span><span class="sxs-lookup"><span data-stu-id="9b074-214">If any one of these commands results in an error, the transaction is rolled back, undoing the previous modifications made during the transaction s lifetime.</span></span> <span data-ttu-id="9b074-215">Należy `Update` instrukcji zakończenia bez błędów, transakcja zostaje zatwierdzona w całości.</span><span class="sxs-lookup"><span data-stu-id="9b074-215">Should the `Update` statement complete without error, the transaction is committed in its entirety.</span></span>


[!code-csharp[Main](wrapping-database-modifications-within-a-transaction-cs/samples/sample4.cs)]

<span data-ttu-id="9b074-216">Dodaj `UpdateWithTransaction` metody `ProductsTableAdapter` klasy do klasy częściowej w `ProductsTableAdapter.TransactionSupport.cs`.</span><span class="sxs-lookup"><span data-stu-id="9b074-216">Add the `UpdateWithTransaction` method to the `ProductsTableAdapter` class through the partial class in `ProductsTableAdapter.TransactionSupport.cs`.</span></span> <span data-ttu-id="9b074-217">Alternatywnie, można dodać tej metody w s warstwy logiki biznesowej `ProductsBLL` klasy za pomocą kilku drobne zmiany syntaktyczne.</span><span class="sxs-lookup"><span data-stu-id="9b074-217">Alternatively, this method could be added to the Business Logic Layer s `ProductsBLL` class with a few minor syntactical changes.</span></span> <span data-ttu-id="9b074-218">To znaczy, słowo kluczowe w `this.BeginTransaction()`, `this.CommitTransaction()`, i `this.RollbackTransaction()` musi zostać zamieniona `Adapter` (pamiętamy `Adapter` jest nazwą właściwości w `ProductsBLL` typu `ProductsTableAdapter`).</span><span class="sxs-lookup"><span data-stu-id="9b074-218">Namely, the keyword this in `this.BeginTransaction()`, `this.CommitTransaction()`, and `this.RollbackTransaction()` would need to be replaced with `Adapter` (recall that `Adapter` is the name of a property in `ProductsBLL` of type `ProductsTableAdapter`).</span></span>

<span data-ttu-id="9b074-219">`UpdateWithTransaction` Metoda używa wzorca aktualizacji usługi Batch, ale może również służyć szereg wywołań bazy danych bezpośrednio w zakresie transakcji, co pokazuje poniższa metoda.</span><span class="sxs-lookup"><span data-stu-id="9b074-219">The `UpdateWithTransaction` method uses the Batch Update pattern, but a series of DB-Direct calls can also be used within the scope of a transaction, as the following method shows.</span></span> <span data-ttu-id="9b074-220">`DeleteProductsWithTransaction` Metoda przyjmuje jako dane wejściowe `List<T>` typu `int`, które są `ProductID` s do usunięcia.</span><span class="sxs-lookup"><span data-stu-id="9b074-220">The `DeleteProductsWithTransaction` method accepts as input a `List<T>` of type `int`, which are the `ProductID` s to delete.</span></span> <span data-ttu-id="9b074-221">Metoda inicjuje transakcji za pośrednictwem wywołania `BeginTransaction` a następnie w `try` zablokować, iterację na liście podany wzorzec DB bezpośrednie wywołanie `Delete` metody dla każdego `ProductID` wartość.</span><span class="sxs-lookup"><span data-stu-id="9b074-221">The method initiates the transaction via a call to `BeginTransaction` and then, in the `try` block, iterates through the supplied list calling the DB-Direct pattern `Delete` method for each `ProductID` value.</span></span> <span data-ttu-id="9b074-222">Jeśli dowolny z wywołania `Delete` zakończy się niepowodzeniem, kontrola jest przekazywana do `catch` blok, gdy transakcja zostanie wycofana i ponownie zgłoszony wyjątek.</span><span class="sxs-lookup"><span data-stu-id="9b074-222">If any of the calls to `Delete` fails, control is transferred to the `catch` block where the transaction is rolled back and the exception re-thrown.</span></span> <span data-ttu-id="9b074-223">Jeśli wszystkie wywołania `Delete` powiedzie się, a następnie transakcja została zatwierdzona.</span><span class="sxs-lookup"><span data-stu-id="9b074-223">If all calls to `Delete` succeed, then transaction is committed.</span></span> <span data-ttu-id="9b074-224">Dodaj tę metodę w celu `ProductsBLL` klasy.</span><span class="sxs-lookup"><span data-stu-id="9b074-224">Add this method to the `ProductsBLL` class.</span></span>


[!code-csharp[Main](wrapping-database-modifications-within-a-transaction-cs/samples/sample5.cs)]

## <a name="applying-transactions-across-multiple-tableadapters"></a><span data-ttu-id="9b074-225">Stosowanie transakcji w przypadku wielu TableAdapters</span><span class="sxs-lookup"><span data-stu-id="9b074-225">Applying Transactions Across Multiple TableAdapters</span></span>

<span data-ttu-id="9b074-226">Umożliwia użycie wielu instrukcji względem transakcji powiązanych z kodu, w tym samouczku `ProductsTableAdapter` powinien być traktowany jako operację niepodzielną.</span><span class="sxs-lookup"><span data-stu-id="9b074-226">The transaction-related code examined in this tutorial allows for multiple statements against the `ProductsTableAdapter` to be treated as an atomic operation.</span></span> <span data-ttu-id="9b074-227">Ale co zrobić, jeśli wprowadzanie wielu modyfikacji innych tabelach bazy danych muszą być wykonywane atomowo?</span><span class="sxs-lookup"><span data-stu-id="9b074-227">But what if multiple modifications to different database tables need to be performed atomically?</span></span> <span data-ttu-id="9b074-228">Na przykład podczas usuwania kategorii, firma Microsoft może najpierw chcesz ponownie przypisać jej aktualne produkty do niektórych innych kategorii.</span><span class="sxs-lookup"><span data-stu-id="9b074-228">For instance, when deleting a category, we might first want to reassign its current products to some other category.</span></span> <span data-ttu-id="9b074-229">Następujące dwa kroki ponowne przypisywanie produktów i usuwania kategorii powinna zostać wykonana jako operację niepodzielną.</span><span class="sxs-lookup"><span data-stu-id="9b074-229">These two steps reassigning the products and deleting the category should be executed as an atomic operation.</span></span> <span data-ttu-id="9b074-230">Ale `ProductsTableAdapter` obejmuje tylko metody modyfikowania `Products` tabeli i `CategoriesTableAdapter` obejmuje tylko metody modyfikowania `Categories` tabeli.</span><span class="sxs-lookup"><span data-stu-id="9b074-230">But the `ProductsTableAdapter` includes only methods for modifying the `Products` table and the `CategoriesTableAdapter` includes only methods for modifying the `Categories` table.</span></span> <span data-ttu-id="9b074-231">W jaki sposób transakcji może obejmować zarówno TableAdapters</span><span class="sxs-lookup"><span data-stu-id="9b074-231">So how can a transaction encompass both TableAdapters?</span></span>

<span data-ttu-id="9b074-232">Dodaj metodę, która jest jedną z opcji `CategoriesTableAdapter` o nazwie `DeleteCategoryAndReassignProducts(categoryIDtoDelete, reassignToCategoryID)` i ma tę metodę wywołać procedurę składowaną, ponownie przypisuje produktów i usuwa kategorii w zakresie transakcji zdefiniowanych w ramach procedury składowanej.</span><span class="sxs-lookup"><span data-stu-id="9b074-232">One option is to add a method to the `CategoriesTableAdapter` named `DeleteCategoryAndReassignProducts(categoryIDtoDelete, reassignToCategoryID)` and have that method call a stored procedure that both reassigns the products and deletes the category within the scope of a transaction defined within the stored procedure.</span></span> <span data-ttu-id="9b074-233">Omówimy sposób rozpoczęcia, zatwierdzanie i wycofywania transakcji w procedurach składowanych w przyszłości zapoznać się z samouczkiem.</span><span class="sxs-lookup"><span data-stu-id="9b074-233">We'll look at how to begin, commit, and rollback transactions in stored procedures in a future tutorial.</span></span>

<span data-ttu-id="9b074-234">Innym rozwiązaniem jest utworzenie klasę pomocy w DAL, który zawiera `DeleteCategoryAndReassignProducts(categoryIDtoDelete, reassignToCategoryID)` metody.</span><span class="sxs-lookup"><span data-stu-id="9b074-234">Another option is to create a helper class in the DAL that contains the `DeleteCategoryAndReassignProducts(categoryIDtoDelete, reassignToCategoryID)` method.</span></span> <span data-ttu-id="9b074-235">Ta metoda może utworzyć wystąpienia `CategoriesTableAdapter` i `ProductsTableAdapter` , a następnie ustaw te dwa TableAdapters `Connection` właściwości do tej samej `SqlConnection` wystąpienia.</span><span class="sxs-lookup"><span data-stu-id="9b074-235">This method would create an instance of the `CategoriesTableAdapter` and the `ProductsTableAdapter` and then set these two TableAdapters `Connection` properties to the same `SqlConnection` instance.</span></span> <span data-ttu-id="9b074-236">At tego punktu, jeden z dwóch elementów TableAdapter może zainicjować transakcji przy użyciu wywołania do `BeginTransaction`.</span><span class="sxs-lookup"><span data-stu-id="9b074-236">At that point, either one of the two TableAdapters would initiate the transaction with a call to `BeginTransaction`.</span></span> <span data-ttu-id="9b074-237">Czy można wywołać metody TableAdapter, ponowne przypisywanie produktów i usuwania kategorii w `try...catch` blok z transakcja przekazana lub wycofana ponownie zgodnie z potrzebami.</span><span class="sxs-lookup"><span data-stu-id="9b074-237">The TableAdapters methods for reassigning the products and deleting the category would be invoked in a `try...catch` block with the transaction committed or rolled back as needed.</span></span>

## <a name="step-4-adding-theupdatewithtransactionmethod-to-the-business-logic-layer"></a><span data-ttu-id="9b074-238">Krok 4. Dodawanie`UpdateWithTransaction`metody warstwy logiki biznesowej</span><span class="sxs-lookup"><span data-stu-id="9b074-238">Step 4: Adding the`UpdateWithTransaction`Method to the Business Logic Layer</span></span>

<span data-ttu-id="9b074-239">W kroku 3 dodaliśmy `UpdateWithTransaction` metody `ProductsTableAdapter` w warstwy DAL.</span><span class="sxs-lookup"><span data-stu-id="9b074-239">In Step 3 we added an `UpdateWithTransaction` method to the `ProductsTableAdapter` in the DAL.</span></span> <span data-ttu-id="9b074-240">Możemy dodać do LOGIKI odpowiadającą im metodę.</span><span class="sxs-lookup"><span data-stu-id="9b074-240">We should add a corresponding method to the BLL.</span></span> <span data-ttu-id="9b074-241">Podczas gdy Warstwa prezentacji może wywołać bezpośrednio do warstwy DAL do wywołania `UpdateWithTransaction` metody, w tych samouczkach mają strived do definiowania architektury warstwowej, który powoduje, że warstwy DAL z warstwy prezentacji.</span><span class="sxs-lookup"><span data-stu-id="9b074-241">While the Presentation Layer could call directly down to the DAL to invoke the `UpdateWithTransaction` method, these tutorials have strived to define a layered architecture that insulates the DAL from the Presentation Layer.</span></span> <span data-ttu-id="9b074-242">W związku z tym jego behooves nam to podejście.</span><span class="sxs-lookup"><span data-stu-id="9b074-242">Therefore, it behooves us to continue this approach.</span></span>

<span data-ttu-id="9b074-243">Otwórz `ProductsBLL` klasy plików i Dodaj metodę o nazwie `UpdateWithTransaction` który po prostu wywołuje metodę do odpowiedniej metody warstwy DAL.</span><span class="sxs-lookup"><span data-stu-id="9b074-243">Open the `ProductsBLL` class file and add a method named `UpdateWithTransaction` that simply calls down to the corresponding DAL method.</span></span> <span data-ttu-id="9b074-244">Teraz należy dwóch nowych metod w `ProductsBLL`: `UpdateWithTransaction`, który właśnie został dodany, i `DeleteProductsWithTransaction`, który został dodany w kroku 3.</span><span class="sxs-lookup"><span data-stu-id="9b074-244">There should now be two new methods in `ProductsBLL`: `UpdateWithTransaction`, which you just added, and `DeleteProductsWithTransaction`, which was added in Step 3.</span></span>


[!code-csharp[Main](wrapping-database-modifications-within-a-transaction-cs/samples/sample6.cs)]

> [!NOTE]
> <span data-ttu-id="9b074-245">Te metody nie obejmują `DataObjectMethodAttribute` atrybut przypisany do większości metod w `ProductsBLL` klasy, ponieważ firma Microsoft będzie wywoływanie tych metod bezpośrednio z klasy CodeBehind stron ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="9b074-245">These methods do not include the `DataObjectMethodAttribute` attribute assigned to most other methods in the `ProductsBLL` class because we'll be invoking these methods directly from the ASP.NET pages code-behind classes.</span></span> <span data-ttu-id="9b074-246">Pamiętamy `DataObjectMethodAttribute` służy do flagi, jakie metody powinna zostać wyświetlona na ObjectDataSource s Konfigurowanie źródła danych pracę kreatora i jakie karcie (SELECT, UPDATE, INSERT lub DELETE).</span><span class="sxs-lookup"><span data-stu-id="9b074-246">Recall that `DataObjectMethodAttribute` is used to flag what methods should appear in the ObjectDataSource s Configure Data Source wizard and under what tab (SELECT, UPDATE, INSERT, or DELETE).</span></span> <span data-ttu-id="9b074-247">Ponieważ w widoku GridView nie posiada wbudowanej pomocy technicznej dla usługi batch, edytowania lub usuwania, będziemy musieli wywoływanie tych metod programowo, zamiast używać podejścia deklaratywnego niekorzystające z kodu.</span><span class="sxs-lookup"><span data-stu-id="9b074-247">Since the GridView lacks any built-in support for batch editing or deleting, we'll have to invoke these methods programmatically rather than use the code-free declarative approach.</span></span>


## <a name="step-5-atomically-updating-database-data-from-the-presentation-layer"></a><span data-ttu-id="9b074-248">Krok 5. Niepodzielnie aktualizowanie danych bazy danych z warstwy prezentacji</span><span class="sxs-lookup"><span data-stu-id="9b074-248">Step 5: Atomically Updating Database Data from the Presentation Layer</span></span>

<span data-ttu-id="9b074-249">Aby zilustrować wpływ transakcji podczas aktualizowania partii rekordów, umożliwiają s utworzyć interfejs użytkownika, który zawiera wszystkie produkty z GridView i Web przycisk kontrolkę, która, po kliknięciu ponownie przypisuje produktów `CategoryID` wartości.</span><span class="sxs-lookup"><span data-stu-id="9b074-249">To illustrate the effect that the transaction has when updating a batch of records, let s create a user interface that lists all products in a GridView and includes a Button Web control that, when clicked, reassigns the products `CategoryID` values.</span></span> <span data-ttu-id="9b074-250">W szczególności, ponowne przypisanie kategorii przyszłego postępu tak, aby pierwsze kilka produktów są przypisane prawidłowe `CategoryID` nieistniejącej przypisano jej wartości, a inne są celowo `CategoryID` wartość.</span><span class="sxs-lookup"><span data-stu-id="9b074-250">In particular, the category reassignment will progress so that the first several products are assigned a valid `CategoryID` value while others are purposefully assigned a non-existent `CategoryID` value.</span></span> <span data-ttu-id="9b074-251">Jeśli próby aktualizacji bazy danych z produktem, którego `CategoryID` jest niezgodna z istniejącą kategorię s `CategoryID`, nastąpi naruszenie ograniczenia klucza obcego i będzie zgłaszany wyjątek.</span><span class="sxs-lookup"><span data-stu-id="9b074-251">If we attempt to update the database with a product whose `CategoryID` does not match an existing category s `CategoryID`, a foreign key constraint violation will occur and an exception will be raised.</span></span> <span data-ttu-id="9b074-252">Zobaczymy w tym przykładzie jest to, że przy użyciu transakcji wyjątek zgłoszony z naruszenie ograniczenia klucza obcego spowoduje, że poprzednie prawidłowe `CategoryID` zmiany można wycofać.</span><span class="sxs-lookup"><span data-stu-id="9b074-252">What we'll see in this example is that when using a transaction the exception raised from the foreign key constraint violation will cause the previous valid `CategoryID` changes to be rolled back.</span></span> <span data-ttu-id="9b074-253">Bez korzystania z transakcji, jednak będą nadal modyfikacje do początkowego kategorii.</span><span class="sxs-lookup"><span data-stu-id="9b074-253">When not using a transaction, however, the modifications to the initial categories will remain.</span></span>

<span data-ttu-id="9b074-254">Zacznij od otwarcia `Transactions.aspx` stronie `BatchData` folder i przeciągnij GridView z przybornika do projektanta.</span><span class="sxs-lookup"><span data-stu-id="9b074-254">Start by opening the `Transactions.aspx` page in the `BatchData` folder and drag a GridView from the Toolbox onto the Designer.</span></span> <span data-ttu-id="9b074-255">Ustaw jego `ID` do `Products` i z jego tag inteligentny powiązać go do nowego elementu ObjectDataSource, o nazwie `ProductsDataSource`.</span><span class="sxs-lookup"><span data-stu-id="9b074-255">Set its `ID` to `Products` and, from its smart tag, bind it to a new ObjectDataSource named `ProductsDataSource`.</span></span> <span data-ttu-id="9b074-256">Konfigurowanie kontrolki ObjectDataSource swoich danych z `ProductsBLL` klasy s `GetProducts` metody.</span><span class="sxs-lookup"><span data-stu-id="9b074-256">Configure the ObjectDataSource to pull its data from the `ProductsBLL` class s `GetProducts` method.</span></span> <span data-ttu-id="9b074-257">Zostanie można GridView tylko do odczytu, więc zestawu list rozwijanych w UPDATE, INSERT i usuwanie kart (Brak) i kliknij przycisk Zakończ.</span><span class="sxs-lookup"><span data-stu-id="9b074-257">This will be a read-only GridView, so set the drop-down lists in the UPDATE, INSERT, and DELETE tabs to (None) and click Finish.</span></span>


[![F<span data-ttu-id="9b074-258">igure 5: Konfigurowanie kontrolki ObjectDataSource przy użyciu metody GetProducts ProductsBLL klasy s]</span><span class="sxs-lookup"><span data-stu-id="9b074-258">igure 5: Configure the ObjectDataSource to Use the ProductsBLL Class s GetProducts Method]</span></span>(wrapping-database-modifications-within-a-transaction-cs/_static/image5.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image3.png)

<span data-ttu-id="9b074-259">**Rysunek 5**: Rysunek 5: Konfigurowanie kontrolki ObjectDataSource do użycia `ProductsBLL` klasy s `GetProducts` — metoda ([kliknij, aby wyświetlić obraz w pełnym rozmiarze](wrapping-database-modifications-within-a-transaction-cs/_static/image4.png))</span><span class="sxs-lookup"><span data-stu-id="9b074-259">**Figure 5**: Figure 5: Configure the ObjectDataSource to Use the `ProductsBLL` Class s `GetProducts` Method ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-cs/_static/image4.png))</span></span>


[![S<span data-ttu-id="9b074-260">et list rozwijanych w aktualizacji, WSTAWIANIA i usuwania karty (Brak)]</span><span class="sxs-lookup"><span data-stu-id="9b074-260">et the Drop-Down Lists in the UPDATE, INSERT, and DELETE Tabs to (None)]</span></span>(wrapping-database-modifications-within-a-transaction-cs/_static/image6.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image5.png)

<span data-ttu-id="9b074-261">**Rysunek 6**: Ustaw listy rozwijane w aktualizacji, WSTAWIANIA i usuwania karty (Brak) ([kliknij, aby wyświetlić obraz w pełnym rozmiarze](wrapping-database-modifications-within-a-transaction-cs/_static/image6.png))</span><span class="sxs-lookup"><span data-stu-id="9b074-261">**Figure 6**: Set the Drop-Down Lists in the UPDATE, INSERT, and DELETE Tabs to (None) ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-cs/_static/image6.png))</span></span>


<span data-ttu-id="9b074-262">Po zakończeniu pracy kreatora Konfigurowanie źródła danych, program Visual Studio utworzy BoundFields i CheckBoxField dla pól danych produktu.</span><span class="sxs-lookup"><span data-stu-id="9b074-262">After completing the Configure Data Source wizard, Visual Studio will create BoundFields and a CheckBoxField for the product data fields.</span></span> <span data-ttu-id="9b074-263">Usuń wszystkie te pola z wyjątkiem `ProductID`, `ProductName`, `CategoryID`, i `CategoryName` i Zmień nazwę `ProductName` i `CategoryName` BoundFields `HeaderText` właściwości do produktu i kategorii, odpowiednio.</span><span class="sxs-lookup"><span data-stu-id="9b074-263">Remove all of these fields except for `ProductID`, `ProductName`, `CategoryID`, and `CategoryName` and rename the `ProductName` and `CategoryName` BoundFields `HeaderText` properties to Product and Category, respectively.</span></span> <span data-ttu-id="9b074-264">Za pomocą tagu inteligentnego zaznacz opcję włączenia stronicowania.</span><span class="sxs-lookup"><span data-stu-id="9b074-264">From the smart tag, check the Enable Paging option.</span></span> <span data-ttu-id="9b074-265">Po wprowadzeniu tych zmian, kontrolkami GridView i kontrolki ObjectDataSource s oznaczeniu deklaracyjnym powinien wyglądać następująco:</span><span class="sxs-lookup"><span data-stu-id="9b074-265">After making these modifications, the GridView and ObjectDataSource s declarative markup should look like the following:</span></span>


[!code-aspx[Main](wrapping-database-modifications-within-a-transaction-cs/samples/sample7.aspx)]

<span data-ttu-id="9b074-266">Następnie dodaj trzy kontrolki przycisku w sieci Web powyżej widoku GridView.</span><span class="sxs-lookup"><span data-stu-id="9b074-266">Next, add three Button Web controls above the GridView.</span></span> <span data-ttu-id="9b074-267">Wartość pierwszy przycisk s właściwości Text Odśwież siatki, drugi s, aby zmodyfikować kategorie (przy użyciu transakcji), a trzeci jeden s, aby zmodyfikować kategorie (bez transakcji).</span><span class="sxs-lookup"><span data-stu-id="9b074-267">Set the first Button s Text property to Refresh Grid, the second s to Modify Categories (WITH TRANSACTION), and the third one s to Modify Categories (WITHOUT TRANSACTION) .</span></span>


[!code-aspx[Main](wrapping-database-modifications-within-a-transaction-cs/samples/sample8.aspx)]

<span data-ttu-id="9b074-268">W tym momencie widok projektu w programie Visual Studio, powinny wyglądać podobnie do ekranu zrzut, jak pokazano na rysunku 7.</span><span class="sxs-lookup"><span data-stu-id="9b074-268">At this point the Design view in Visual Studio should look similar to the screen shot shown in Figure 7.</span></span>


[![T<span data-ttu-id="9b074-269">Zawiera on strony GridView i trzech przycisków umieszczonych w sieci Web]</span><span class="sxs-lookup"><span data-stu-id="9b074-269">he Page Contains a GridView and Three Button Web Controls]</span></span>(wrapping-database-modifications-within-a-transaction-cs/_static/image7.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image7.png)

<span data-ttu-id="9b074-270">**Rysunek 7**: Ta strona zawiera GridView i trzy kontrolki sieci Web przycisku ([kliknij, aby wyświetlić obraz w pełnym rozmiarze](wrapping-database-modifications-within-a-transaction-cs/_static/image8.png))</span><span class="sxs-lookup"><span data-stu-id="9b074-270">**Figure 7**: The Page Contains a GridView and Three Button Web Controls ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-cs/_static/image8.png))</span></span>


<span data-ttu-id="9b074-271">Tworzenie obsługi zdarzeń dla każdego z trzech przycisk s `Click` zdarzenia i użyj następującego kodu:</span><span class="sxs-lookup"><span data-stu-id="9b074-271">Create event handlers for each of the three Button s `Click` events and use the following code:</span></span>


[!code-csharp[Main](wrapping-database-modifications-within-a-transaction-cs/samples/sample9.cs)]

<span data-ttu-id="9b074-272">Odświeżanie przycisk s `Click` programu obsługi zdarzeń po prostu rebinds dane do widoku GridView przez wywołanie metody `Products` GridView s `DataBind` metody.</span><span class="sxs-lookup"><span data-stu-id="9b074-272">The refresh Button s `Click` event handler simply rebinds the data to the GridView by calling the `Products` GridView s `DataBind` method.</span></span>

<span data-ttu-id="9b074-273">Drugi program obsługi zdarzeń ponownie przypisuje produktów `CategoryID` s i używa nowej metody transakcji od LOGIKI do wydajna niż baza danych aktualizacji w obszarze parasola transakcji.</span><span class="sxs-lookup"><span data-stu-id="9b074-273">The second event handler reassigns the products `CategoryID` s and uses the new transaction method from the BLL to perform the database updates under the umbrella of a transaction.</span></span> <span data-ttu-id="9b074-274">Należy pamiętać, że każdy produkt s `CategoryID` arbitralnie jest ustawiona na taką samą wartość jak jego `ProductID`.</span><span class="sxs-lookup"><span data-stu-id="9b074-274">Note that each product s `CategoryID` is arbitrarily set to the same value as its `ProductID`.</span></span> <span data-ttu-id="9b074-275">To będzie działać prawidłowo w pierwszym kilka produktów, ponieważ te produkty mają `ProductID` wartości, które zdarzają się do mapowania na nieprawidłowy `CategoryID` s.</span><span class="sxs-lookup"><span data-stu-id="9b074-275">This will work fine for the first few products, since those products have `ProductID` values that happen to map to valid `CategoryID` s.</span></span> <span data-ttu-id="9b074-276">Ale raz `ProductID` start s wprowadzenie zbyt duży, to przypadkowe nachodzące na siebie `ProductID` s i `CategoryID` s nie ma już zastosowania.</span><span class="sxs-lookup"><span data-stu-id="9b074-276">But once the `ProductID` s start getting too large, this coincidental overlap of `ProductID` s and `CategoryID` s no longer applies.</span></span>

<span data-ttu-id="9b074-277">Trzeci `Click` programu obsługi zdarzeń aktualizacji produktów `CategoryID` s w taki sam sposób, ale wysyła aktualizacji do bazy danych przy użyciu `ProductsTableAdapter` domyślne s `Update` metody.</span><span class="sxs-lookup"><span data-stu-id="9b074-277">The third `Click` event handler updates the products `CategoryID` s in the same manner, but sends the update to the database using the `ProductsTableAdapter` s default `Update` method.</span></span> <span data-ttu-id="9b074-278">To `Update` metoda nie jest zawijany serię poleceń w ramach transakcji, aby zmiany zostały wprowadzone przed pierwszym błędzie naruszenie napotkano ograniczenie klucza obcego utrwali.</span><span class="sxs-lookup"><span data-stu-id="9b074-278">This `Update` method does not wrap the series of commands within a transaction, so those changes are made prior to the first encountered foreign key constraint violation error will persist.</span></span>

<span data-ttu-id="9b074-279">Aby zademonstrować to zachowanie, odwiedź tę stronę za pośrednictwem przeglądarki.</span><span class="sxs-lookup"><span data-stu-id="9b074-279">To demonstrate this behavior, visit this page through a browser.</span></span> <span data-ttu-id="9b074-280">Początkowo pierwszej strony danych powinny Zobacz, jak pokazano na rysunku 8.</span><span class="sxs-lookup"><span data-stu-id="9b074-280">Initially you should see the first page of data as shown in Figure 8.</span></span> <span data-ttu-id="9b074-281">Następnie kliknij przycisk zmodyfikować kategorie (przy użyciu transakcji).</span><span class="sxs-lookup"><span data-stu-id="9b074-281">Next, click the Modify Categories (WITH TRANSACTION) button.</span></span> <span data-ttu-id="9b074-282">Spowoduje to powoduje odświeżenie strony i próba aktualizacji wszystkich produktów `CategoryID` wartości, ale będą powodować naruszenie ograniczenia klucza obcego (patrz rysunek 9).</span><span class="sxs-lookup"><span data-stu-id="9b074-282">This will cause a postback and attempt to update all of the products `CategoryID` values, but will result in a foreign key constraint violation (see Figure 9).</span></span>


[![T<span data-ttu-id="9b074-283">Produktów są wyświetlane w stronicowanej GridView]</span><span class="sxs-lookup"><span data-stu-id="9b074-283">he Products are Displayed in a Pageable GridView]</span></span>(wrapping-database-modifications-within-a-transaction-cs/_static/image8.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image9.png)

<span data-ttu-id="9b074-284">**Rysunek 8**: Produkty są wyświetlane w stronicowanej kontrolki GridView ([kliknij, aby wyświetlić obraz w pełnym rozmiarze](wrapping-database-modifications-within-a-transaction-cs/_static/image10.png))</span><span class="sxs-lookup"><span data-stu-id="9b074-284">**Figure 8**: The Products are Displayed in a Pageable GridView ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-cs/_static/image10.png))</span></span>


[![R<span data-ttu-id="9b074-285">eassigning kategorie skutkuje naruszenie ograniczenia klucza obcego]</span><span class="sxs-lookup"><span data-stu-id="9b074-285">eassigning the Categories Results in a Foreign Key Constraint Violation]</span></span>(wrapping-database-modifications-within-a-transaction-cs/_static/image9.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image11.png)

<span data-ttu-id="9b074-286">**Rysunek 9**: Ponowne przypisywanie kategorii skutkuje naruszenie ograniczenia klucza obcego ([kliknij, aby wyświetlić obraz w pełnym rozmiarze](wrapping-database-modifications-within-a-transaction-cs/_static/image12.png))</span><span class="sxs-lookup"><span data-stu-id="9b074-286">**Figure 9**: Reassigning the Categories Results in a Foreign Key Constraint Violation ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-cs/_static/image12.png))</span></span>


<span data-ttu-id="9b074-287">Teraz, kliknij przycisk Wstecz Twojej przeglądarki s, a następnie kliknij przycisk Odśwież siatki.</span><span class="sxs-lookup"><span data-stu-id="9b074-287">Now hit your browser s Back button and then click the Refresh Grid button.</span></span> <span data-ttu-id="9b074-288">Po odświeżeniu danych powinny być widoczne dokładnie ten sam wynik, jak pokazano na rysunku 8.</span><span class="sxs-lookup"><span data-stu-id="9b074-288">Upon refreshing the data you should see the exact same output as shown in Figure 8.</span></span> <span data-ttu-id="9b074-289">Oznacza to, nawet jeśli niektóre produkty `CategoryID` s zostały zmienione na prawne wartości i zaktualizowane w bazie danych, ich zostały wycofane po wystąpiło naruszenie ograniczenia klucza obcego.</span><span class="sxs-lookup"><span data-stu-id="9b074-289">That is, even though some of the products `CategoryID` s were changed to legal values and updated in the database, they were rolled back when the foreign key constraint violation occurred.</span></span>

<span data-ttu-id="9b074-290">Teraz spróbuj, kliknięcie przycisku Modyfikuj kategorii (bez transakcji).</span><span class="sxs-lookup"><span data-stu-id="9b074-290">Now try clicking the Modify Categories (WITHOUT TRANSACTION) button.</span></span> <span data-ttu-id="9b074-291">Spowoduje to ten sam błąd naruszenie ograniczenia klucza obcego (patrz rysunek 9), ale tym razem tych produktów którego `CategoryID` wartości zostały zmienione na prawnych i wartość będą nie można wycofać.</span><span class="sxs-lookup"><span data-stu-id="9b074-291">This will result in the same foreign key constraint violation error (see Figure 9), but this time those products whose `CategoryID` values were changed to a legal value will not be rolled back.</span></span> <span data-ttu-id="9b074-292">Wprowadzam polecenie przeglądarki s przycisku Wstecz, a następnie przycisk Odśwież siatki.</span><span class="sxs-lookup"><span data-stu-id="9b074-292">Hit your browser s Back button and then the Refresh Grid button.</span></span> <span data-ttu-id="9b074-293">Jak pokazano na rysunku nr 10, `CategoryID` ponownie przypisane s produktów pierwsze osiem.</span><span class="sxs-lookup"><span data-stu-id="9b074-293">As Figure 10 shows, the `CategoryID` s of the first eight products have been reassigned.</span></span> <span data-ttu-id="9b074-294">Na przykład na rysunku 8 zmian centralnych miał `CategoryID` 1, ale w rysunek 10 it s przypisane do 2.</span><span class="sxs-lookup"><span data-stu-id="9b074-294">For example, in Figure 8, Chang had a `CategoryID` of 1, but in Figure 10 it s been reassigned to 2.</span></span>


[![S<span data-ttu-id="9b074-295">niektó produktów CategoryID wartości zostały zaktualizowane podczas gdy inne osoby zostały nie]</span><span class="sxs-lookup"><span data-stu-id="9b074-295">ome Products CategoryID Values were Updated While Others Were Not]</span></span>(wrapping-database-modifications-within-a-transaction-cs/_static/image10.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image13.png)

<span data-ttu-id="9b074-296">**Na rysunku nr 10**: Niektóre produkty `CategoryID` wartości zostały zaktualizowane podczas gdy inne osoby zostały nie ([kliknij, aby wyświetlić obraz w pełnym rozmiarze](wrapping-database-modifications-within-a-transaction-cs/_static/image14.png))</span><span class="sxs-lookup"><span data-stu-id="9b074-296">**Figure 10**: Some Products `CategoryID` Values were Updated While Others Were Not ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-cs/_static/image14.png))</span></span>


## <a name="summary"></a><span data-ttu-id="9b074-297">Podsumowanie</span><span class="sxs-lookup"><span data-stu-id="9b074-297">Summary</span></span>

<span data-ttu-id="9b074-298">Domyślnie metody s TableAdapter nie jest zawijany instrukcji wykonanych bazy danych w zakresie transakcji, ale z niewielką ilością pracy możemy dodać metody, które spowoduje utworzenie, zatwierdzenia i wycofać transakcji.</span><span class="sxs-lookup"><span data-stu-id="9b074-298">By default, the TableAdapter s methods do not wrap the executed database statements within the scope of a transaction, but with a little work we can add methods that will create, commit, and rollback a transaction.</span></span> <span data-ttu-id="9b074-299">W tym samouczku utworzyliśmy tych trzech metod w `ProductsTableAdapter` klasy: `BeginTransaction`, `CommitTransaction`, i `RollbackTransaction`.</span><span class="sxs-lookup"><span data-stu-id="9b074-299">In this tutorial we created three such methods in the `ProductsTableAdapter` class: `BeginTransaction`, `CommitTransaction`, and `RollbackTransaction`.</span></span> <span data-ttu-id="9b074-300">Widzieliśmy sposób użycia tych metod wraz z `try...catch` bloku, aby upewnić atomic szereg instrukcji modyfikacji danych.</span><span class="sxs-lookup"><span data-stu-id="9b074-300">We saw how to use these methods along with a `try...catch` block to make a series of data modification statements atomic.</span></span> <span data-ttu-id="9b074-301">W szczególności utworzyliśmy `UpdateWithTransaction` method in Class metoda `ProductsTableAdapter`, który używa wzorca aktualizacji usługi Batch do wykonania niezbędnych zmian w wierszach, podane `ProductsDataTable`.</span><span class="sxs-lookup"><span data-stu-id="9b074-301">In particular, we created the `UpdateWithTransaction` method in the `ProductsTableAdapter`, which uses the Batch Update pattern to perform the necessary modifications to the rows of a supplied `ProductsDataTable`.</span></span> <span data-ttu-id="9b074-302">Dodaliśmy również `DeleteProductsWithTransaction` metody `ProductsBLL` klasy w LOGIKI, która przyjmuje `List` z `ProductID` wartości jako dane wejściowe, a następnie wywołuje metodę wzorca bazy danych bezpośrednio `Delete` dla każdego `ProductID`.</span><span class="sxs-lookup"><span data-stu-id="9b074-302">We also added the `DeleteProductsWithTransaction` method to the `ProductsBLL` class in the BLL, which accepts a `List` of `ProductID` values as its input and calls the DB-Direct pattern method `Delete` for each `ProductID`.</span></span> <span data-ttu-id="9b074-303">Obie metody start tworzenia transakcji, a następnie wykonywania instrukcji modyfikacji danych w ramach `try...catch` bloku.</span><span class="sxs-lookup"><span data-stu-id="9b074-303">Both methods start by creating a transaction and then executing the data modification statements within a `try...catch` block.</span></span> <span data-ttu-id="9b074-304">Jeśli wystąpi wyjątek, transakcja zostanie wycofana, w przeciwnym razie zostanie zatwierdzony.</span><span class="sxs-lookup"><span data-stu-id="9b074-304">If an exception occurs, the transaction is rolled back, otherwise it is committed.</span></span>

<span data-ttu-id="9b074-305">Krok 5 ilustruje efekt aktualizacji partii transakcji, jak i aktualizacje usługi batch, które zwrócenia przez niego użyć transakcji.</span><span class="sxs-lookup"><span data-stu-id="9b074-305">Step 5 illustrated the effect of transactional batch updates versus batch updates that neglected to use a transaction.</span></span> <span data-ttu-id="9b074-306">W ramach trzech kolejnych samouczków Rozpoczniemy bazują na podstawę, w tym samouczku i twórz interfejsy użytkownika umożliwiające wykonywanie aktualizacji wsadowych, usunięcia i wstawienia.</span><span class="sxs-lookup"><span data-stu-id="9b074-306">In the next three tutorials we will build upon the foundation laid in this tutorial and create user interfaces for performing batch updates, deletes, and inserts.</span></span>

<span data-ttu-id="9b074-307">Wszystkiego najlepszego programowania!</span><span class="sxs-lookup"><span data-stu-id="9b074-307">Happy Programming!</span></span>

## <a name="further-reading"></a><span data-ttu-id="9b074-308">Dalsze informacje</span><span class="sxs-lookup"><span data-stu-id="9b074-308">Further Reading</span></span>

<span data-ttu-id="9b074-309">Więcej informacji na tematów omówionych w tym samouczku można znaleźć w następujących zasobach:</span><span class="sxs-lookup"><span data-stu-id="9b074-309">For more information on the topics discussed in this tutorial, refer to the following resources:</span></span>

- [<span data-ttu-id="9b074-310">Utrzymywanie spójności bazy danych za pomocą transakcji</span><span class="sxs-lookup"><span data-stu-id="9b074-310">Maintaining Database Consistency with Transactions</span></span>](http://aspnet.4guysfromrolla.com/articles/072705-1.aspx)
- [<span data-ttu-id="9b074-311">Zarządzanie transakcjami w programie SQL Server procedur składowanych</span><span class="sxs-lookup"><span data-stu-id="9b074-311">Managing Transactions in SQL Server Stored Procedures</span></span>](http://www.4guysfromrolla.com/webtech/080305-1.shtml)
- [<span data-ttu-id="9b074-312">Transakcje łatwe:</span><span class="sxs-lookup"><span data-stu-id="9b074-312">Transactions Made Easy:</span></span> `System.Transactions`](https://blogs.msdn.com/florinlazar/archive/2004/07/23/192239.aspx)
- [<span data-ttu-id="9b074-313">TransactionScope i elementów DataAdapters</span><span class="sxs-lookup"><span data-stu-id="9b074-313">TransactionScope and DataAdapters</span></span>](http://andyclymer.blogspot.com/2007/01/transactionscope-and-dataadapters.html)
- [<span data-ttu-id="9b074-314">Za pomocą transakcji bazy danych Oracle na platformie .NET</span><span class="sxs-lookup"><span data-stu-id="9b074-314">Using Oracle Database Transactions in .NET</span></span>](http://www.oracle.com/technology/pub/articles/price_dbtrans_dotnet.html)

## <a name="about-the-author"></a><span data-ttu-id="9b074-315">Informacje o autorze</span><span class="sxs-lookup"><span data-stu-id="9b074-315">About the Author</span></span>

<span data-ttu-id="9b074-316">[Scott Bento](http://www.4guysfromrolla.com/ScottMitchell.shtml), autor siedem ASP/ASP.NET książek i założycielem [4GuysFromRolla.com](http://www.4guysfromrolla.com), pracował nad przy użyciu technologii Microsoft Web od 1998 r.</span><span class="sxs-lookup"><span data-stu-id="9b074-316">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml), author of seven ASP/ASP.NET books and founder of [4GuysFromRolla.com](http://www.4guysfromrolla.com), has been working with Microsoft Web technologies since 1998.</span></span> <span data-ttu-id="9b074-317">Scott działa jako niezależny Konsultant, trainer i składnika zapisywania.</span><span class="sxs-lookup"><span data-stu-id="9b074-317">Scott works as an independent consultant, trainer, and writer.</span></span> <span data-ttu-id="9b074-318">Jego najnowszą książkę Stephena [ *Sams uczyć się ASP.NET 2.0 w ciągu 24 godzin*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span><span class="sxs-lookup"><span data-stu-id="9b074-318">His latest book is [*Sams Teach Yourself ASP.NET 2.0 in 24 Hours*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span></span> <span data-ttu-id="9b074-319">ADAM można z Tobą skontaktować w [ mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="9b074-319">He can be reached at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span> <span data-ttu-id="9b074-320">lub za pośrednictwem jego blogu, który znajduje się w temacie [ http://ScottOnWriting.NET ](http://ScottOnWriting.NET).</span><span class="sxs-lookup"><span data-stu-id="9b074-320">or via his blog, which can be found at [http://ScottOnWriting.NET](http://ScottOnWriting.NET).</span></span>

## <a name="special-thanks-to"></a><span data-ttu-id="9b074-321">Specjalne podziękowania dla</span><span class="sxs-lookup"><span data-stu-id="9b074-321">Special Thanks To</span></span>

<span data-ttu-id="9b074-322">W tej serii samouczków został zrecenzowany przez wielu recenzentów pomocne.</span><span class="sxs-lookup"><span data-stu-id="9b074-322">This tutorial series was reviewed by many helpful reviewers.</span></span> <span data-ttu-id="9b074-323">Wiodące osób dokonujących przeglądu, w tym samouczku zostały Dave Gardner Hilton Giesenow i Teresa Murphy.</span><span class="sxs-lookup"><span data-stu-id="9b074-323">Lead reviewers for this tutorial were Dave Gardner, Hilton Giesenow, and Teresa Murphy.</span></span> <span data-ttu-id="9b074-324">Zainteresowani zapoznaniem Moje kolejnych artykułów MSDN?</span><span class="sxs-lookup"><span data-stu-id="9b074-324">Interested in reviewing my upcoming MSDN articles?</span></span> <span data-ttu-id="9b074-325">Jeśli tak, Porzuć mnie linii w [ mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="9b074-325">If so, drop me a line at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span>

> [!div class="step-by-step"]
> [<span data-ttu-id="9b074-326">Next</span><span class="sxs-lookup"><span data-stu-id="9b074-326">Next</span></span>](batch-updating-cs.md)
