---
uid: web-forms/overview/data-access/editing-inserting-and-deleting-data/implementing-optimistic-concurrency-vb
title: Implementowanie optymistycznej współbieżności (VB) | Dokumentacja firmy Microsoft
author: rick-anderson
description: Dla aplikacji sieci web, która umożliwia wielu użytkownikom edytowanie danych istnieje ryzyko, że dwaj użytkownicy mogą edytować tych samych danych w tym samym czasie. W tym tutori...
ms.author: riande
ms.date: 07/17/2006
ms.assetid: 2646968c-2826-4418-b1d0-62610ed177e3
msc.legacyurl: /web-forms/overview/data-access/editing-inserting-and-deleting-data/implementing-optimistic-concurrency-vb
msc.type: authoredcontent
ms.openlocfilehash: e33e4b401d957f4aa5560193dd8af0e53ca3b631
ms.sourcegitcommit: 24b1f6decbb17bb22a45166e5fdb0845c65af498
ms.translationtype: MT
ms.contentlocale: pl-PL
ms.lasthandoff: 03/01/2019
ms.locfileid: "57068429"
---
<a name="implementing-optimistic-concurrency-vb"></a><span data-ttu-id="95ae3-104">Implementowanie optymistycznej współbieżności (VB)</span><span class="sxs-lookup"><span data-stu-id="95ae3-104">Implementing Optimistic Concurrency (VB)</span></span>
====================
<span data-ttu-id="95ae3-105">przez [Bento Scott](https://twitter.com/ScottOnWriting)</span><span class="sxs-lookup"><span data-stu-id="95ae3-105">by [Scott Mitchell](https://twitter.com/ScottOnWriting)</span></span>

<span data-ttu-id="95ae3-106">[Pobierz przykładową aplikację](http://download.microsoft.com/download/9/c/1/9c1d03ee-29ba-4d58-aa1a-f201dcc822ea/ASPNET_Data_Tutorial_21_VB.exe) lub [Pobierz plik PDF](implementing-optimistic-concurrency-vb/_static/datatutorial21vb1.pdf)</span><span class="sxs-lookup"><span data-stu-id="95ae3-106">[Download Sample App](http://download.microsoft.com/download/9/c/1/9c1d03ee-29ba-4d58-aa1a-f201dcc822ea/ASPNET_Data_Tutorial_21_VB.exe) or [Download PDF](implementing-optimistic-concurrency-vb/_static/datatutorial21vb1.pdf)</span></span>

> <span data-ttu-id="95ae3-107">Dla aplikacji sieci web, która umożliwia wielu użytkownikom edytowanie danych istnieje ryzyko, że dwaj użytkownicy mogą edytować tych samych danych w tym samym czasie.</span><span class="sxs-lookup"><span data-stu-id="95ae3-107">For a web application that allows multiple users to edit data, there is the risk that two users may be editing the same data at the same time.</span></span> <span data-ttu-id="95ae3-108">W tym samouczku będziesz wdrażamy mechanizmu kontroli optymistycznej współbieżności do obsługi tego ryzyka.</span><span class="sxs-lookup"><span data-stu-id="95ae3-108">In this tutorial we'll implement optimistic concurrency control to handle this risk.</span></span>


## <a name="introduction"></a><span data-ttu-id="95ae3-109">Wprowadzenie</span><span class="sxs-lookup"><span data-stu-id="95ae3-109">Introduction</span></span>

<span data-ttu-id="95ae3-110">Dla aplikacji sieci web, które Zezwalaj tylko użytkownikom na wyświetlanie danych, lub takie, które zawierają tylko pojedynczego użytkownika, kto może modyfikować danych nie ma żadnych zagrożeń dwóch jednoczesnych użytkowników przypadkowemu zastąpieniu zmiany siebie nawzajem.</span><span class="sxs-lookup"><span data-stu-id="95ae3-110">For web applications that only allow users to view data, or for those that include only a single user who can modify data, there's no threat of two concurrent users accidentally overwriting one another's changes.</span></span> <span data-ttu-id="95ae3-111">Dla aplikacji sieci web, które umożliwiają wielu użytkownikom aktualizować lub usuwać dane jednak istnieje możliwość modyfikacji jednego użytkownika mogą powodować konfliktów z jednoczesnych przez innego użytkownika.</span><span class="sxs-lookup"><span data-stu-id="95ae3-111">For web applications that allow multiple users to update or delete data, however, there's the potential for one user's modifications to clash with another concurrent user's.</span></span> <span data-ttu-id="95ae3-112">Bez żadnych zasad współbieżności w miejscu gdy dwóch użytkowników będzie jednocześnie edytować pojedynczy rekord użytkownika, który potwierdza jej zmiany ostatnio spowoduje zastąpienie zmian wprowadzonych przez pierwszy.</span><span class="sxs-lookup"><span data-stu-id="95ae3-112">Without any concurrency policy in place, when two users are simultaneously editing a single record, the user who commits her changes last will override the changes made by the first.</span></span>

<span data-ttu-id="95ae3-113">Na przykład załóżmy, że dwóch użytkowników, Jisun i Sam, zostały oba odwiedzając strony w naszej aplikacji, które dozwolone osoby odwiedzające aktualizowanie i usuwanie produktów za pomocą kontrolki GridView.</span><span class="sxs-lookup"><span data-stu-id="95ae3-113">For example, imagine that two users, Jisun and Sam, were both visiting a page in our application that allowed visitors to update and delete the products through a GridView control.</span></span> <span data-ttu-id="95ae3-114">Zarówno kliknij przycisk edycji, w widoku GridView w tym samym czasie.</span><span class="sxs-lookup"><span data-stu-id="95ae3-114">Both click the Edit button in the GridView around the same time.</span></span> <span data-ttu-id="95ae3-115">Jisun zmiany nazwy produktu "Chai herbaty" i klika przycisk Aktualizuj.</span><span class="sxs-lookup"><span data-stu-id="95ae3-115">Jisun changes the product name to "Chai Tea" and clicks the Update button.</span></span> <span data-ttu-id="95ae3-116">Wynikiem jest `UPDATE` instrukcji, które są wysyłane do bazy danych, która ustawia *wszystkich* pól można aktualizować produktu (mimo że Jisun aktualizowane tylko jedno pole `ProductName`).</span><span class="sxs-lookup"><span data-stu-id="95ae3-116">The net result is an `UPDATE` statement that is sent to the database, which sets *all* of the product's updateable fields (even though Jisun only updated one field, `ProductName`).</span></span> <span data-ttu-id="95ae3-117">W tym momencie baza danych ma wartość "Chai herbaty," kategorii Beverages, dostawca egzotycznych płynów, i tak dalej dla tego konkretnego produktu.</span><span class="sxs-lookup"><span data-stu-id="95ae3-117">At this point in time, the database has the values "Chai Tea," the category Beverages, the supplier Exotic Liquids, and so on for this particular product.</span></span> <span data-ttu-id="95ae3-118">Jednak GridView na ekranie przez Sam nadal zawiera nazwy produktu w można edytować wiersza w widoku GridView jako "Chai".</span><span class="sxs-lookup"><span data-stu-id="95ae3-118">However, the GridView on Sam's screen still shows the product name in the editable GridView row as "Chai".</span></span> <span data-ttu-id="95ae3-119">Kilka sekund po jego Jisun zmiany zostały zatwierdzone, Sam aktualizacje kategorii Condiments i klika aktualizacji.</span><span class="sxs-lookup"><span data-stu-id="95ae3-119">A few seconds after Jisun's changes have been committed, Sam updates the category to Condiments and clicks Update.</span></span> <span data-ttu-id="95ae3-120">Skutkuje to `UPDATE` instrukcji wysyłane do bazy danych, która ustawia nazwę produktu, aby "Chai," `CategoryID` do odpowiedniego Identyfikatora kategorii Beverages i tak dalej.</span><span class="sxs-lookup"><span data-stu-id="95ae3-120">This results in an `UPDATE` statement sent to the database that sets the product name to "Chai," the `CategoryID` to the corresponding Beverages category ID, and so on.</span></span> <span data-ttu-id="95ae3-121">Zostały zastąpione przez Jisun zmiany nazwy produktu.</span><span class="sxs-lookup"><span data-stu-id="95ae3-121">Jisun's changes to the product name have been overwritten.</span></span> <span data-ttu-id="95ae3-122">Rysunek 1 przedstawia graficznie w tej serii zdarzeń.</span><span class="sxs-lookup"><span data-stu-id="95ae3-122">Figure 1 graphically depicts this series of events.</span></span>


<span data-ttu-id="95ae3-123">[![Gdy dwóch użytkowników jednoczesne aktualizowanie rekordów s tam potencjalne zmiany jednego użytkownika do zastąpienia jej](implementing-optimistic-concurrency-vb/_static/image2.png)](implementing-optimistic-concurrency-vb/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="95ae3-123">[![When Two Users Simultaneously Update a Record There s Potential for One User 's Changes to Overwrite the Other 's](implementing-optimistic-concurrency-vb/_static/image2.png)](implementing-optimistic-concurrency-vb/_static/image1.png)</span></span>

<span data-ttu-id="95ae3-124">**Rysunek 1**: Gdy dwóch użytkowników jednoczesne aktualizowanie istnieje rekord s potencjał dla jednego użytkownika zmieni się do zastąpienia jej ([kliknij, aby wyświetlić obraz w pełnym rozmiarze](implementing-optimistic-concurrency-vb/_static/image3.png))</span><span class="sxs-lookup"><span data-stu-id="95ae3-124">**Figure 1**: When Two Users Simultaneously Update a Record There s Potential for One User 's Changes to Overwrite the Other 's ([Click to view full-size image](implementing-optimistic-concurrency-vb/_static/image3.png))</span></span>


<span data-ttu-id="95ae3-125">Podobnie gdy dwóch użytkowników odwiedzających stronę, jeden użytkownik może być podczas aktualizowania rekordu, gdy zostanie usunięty przez innego użytkownika.</span><span class="sxs-lookup"><span data-stu-id="95ae3-125">Similarly, when two users are visiting a page, one user might be in the midst of updating a record when it is deleted by another user.</span></span> <span data-ttu-id="95ae3-126">Lub między po użytkownik załaduje stronę, a po kliknięciu przycisku Usuń, inny użytkownik zmienił zawartość tego rekordu.</span><span class="sxs-lookup"><span data-stu-id="95ae3-126">Or, between when a user loads a page and when they click the Delete button, another user may have modified the contents of that record.</span></span>

<span data-ttu-id="95ae3-127">Dostępne są trzy [kontroli współbieżności](http://en.wikipedia.org/wiki/Concurrency_control) strategie dostępności:</span><span class="sxs-lookup"><span data-stu-id="95ae3-127">There are three [concurrency control](http://en.wikipedia.org/wiki/Concurrency_control) strategies available:</span></span>

- <span data-ttu-id="95ae3-128">**Nic nie rób** -równoczesnych użytkowników modyfikowania ten sam rekord, umożliwić ostatniego zatwierdzenia, wygrać (zachowanie domyślne)</span><span class="sxs-lookup"><span data-stu-id="95ae3-128">**Do Nothing** -if concurrent users are modifying the same record, let the last commit win (the default behavior)</span></span>
- <span data-ttu-id="95ae3-129">[**Optymistyczna współbieżność** ](http://en.wikipedia.org/wiki/Optimistic_concurrency_control) -przyjęto założenie, który może być współbieżności jest w konflikcie every teraz, a następnie, większość czasu nie będą występować takie konflikty; w związku z tym, jeśli wystąpić konflikt, po prostu informować użytkownika, ich zmiany Nie można zapisać, ponieważ inny użytkownik zmodyfikował te same dane</span><span class="sxs-lookup"><span data-stu-id="95ae3-129">[**Optimistic Concurrency**](http://en.wikipedia.org/wiki/Optimistic_concurrency_control) - assume that while there may be concurrency conflicts every now and then, the vast majority of the time such conflicts won't arise; therefore, if a conflict does arise, simply inform the user that their changes can't be saved because another user has modified the same data</span></span>
- <span data-ttu-id="95ae3-130">**Współbieżność pesymistyczna** -założono, że konfliktów współbieżności są powszechnie znanych i że użytkownicy nie będą tolerować zwrócenia informację, ich zmiany nie zostały zapisane, ze względu na jednoczesną aktywność innego użytkownika; w związku z tym, po uruchomieniu jednemu użytkownikowi aktualizowania rekordu je zablokować , zapobiegając w ten sposób inni użytkownicy, edycji lub usuwania tego rekordu, dopóki użytkownik zobowiązuje się ich modyfikacji</span><span class="sxs-lookup"><span data-stu-id="95ae3-130">**Pessimistic Concurrency** - assume that concurrency conflicts are commonplace and that users won't tolerate being told their changes weren't saved due to another user's concurrent activity; therefore, when one user starts updating a record, lock it, thereby preventing any other users from editing or deleting that record until the user commits their modifications</span></span>

<span data-ttu-id="95ae3-131">Pory ma wszystkich naszych samouczków używany strategię rozpoznawania współbieżności domyślne — to znaczy, Otrzymaliśmy opinie zapisana jako ostatnia wygrać.</span><span class="sxs-lookup"><span data-stu-id="95ae3-131">All of our tutorials thus far have used the default concurrency resolution strategy - namely, we've let the last write win.</span></span> <span data-ttu-id="95ae3-132">W tym samouczku zajmiemy się, jak zaimplementować mechanizmu kontroli optymistycznej współbieżności.</span><span class="sxs-lookup"><span data-stu-id="95ae3-132">In this tutorial we'll examine how to implement optimistic concurrency control.</span></span>

> [!NOTE]
> <span data-ttu-id="95ae3-133">Nie będzie przyjrzymy się Współbieżność pesymistyczna przykładów w tej serii samouczków.</span><span class="sxs-lookup"><span data-stu-id="95ae3-133">We won't look at pessimistic concurrency examples in this tutorial series.</span></span> <span data-ttu-id="95ae3-134">Współbieżność pesymistyczna jest rzadko używana, ponieważ takie blokady, w przeciwnym razie poprawnie opuści, może uniemożliwić innym użytkownikom aktualizowanie danych.</span><span class="sxs-lookup"><span data-stu-id="95ae3-134">Pessimistic concurrency is rarely used because such locks, if not properly relinquished, can prevent other users from updating data.</span></span> <span data-ttu-id="95ae3-135">Na przykład jeśli użytkownik blokuje rekord do edycji i pozostawia dzień przed trwa odblokowywanie, żaden inny użytkownik będzie na zaktualizowanie rekordu do momentu użytkownika oryginalnego zwraca i zakończeniu jego aktualizacji.</span><span class="sxs-lookup"><span data-stu-id="95ae3-135">For example, if a user locks a record for editing and then leaves for the day before unlocking it, no other user will be able to update that record until the original user returns and completes his update.</span></span> <span data-ttu-id="95ae3-136">Dlatego w sytuacjach, w których jest używana funkcja pesymistycznej współbieżności, ma zwykle limit czasu, który, jeśli osiągnięty, anuluje blokady.</span><span class="sxs-lookup"><span data-stu-id="95ae3-136">Therefore, in situations where pessimistic concurrency is used, there's typically a timeout that, if reached, cancels the lock.</span></span> <span data-ttu-id="95ae3-137">Bilet sprzedaży witryn sieci Web, których zablokować lokalizacji miejsc siedzących określonego przez krótki okres, gdy użytkownik kończy proces kolejności, jest przykładem mechanizm kontroli pesymistycznej współbieżności.</span><span class="sxs-lookup"><span data-stu-id="95ae3-137">Ticket sales websites, which lock a particular seating location for short period while the user completes the order process, is an example of pessimistic concurrency control.</span></span>


## <a name="step-1-looking-at-how-optimistic-concurrency-is-implemented"></a><span data-ttu-id="95ae3-138">Krok 1. Patrząc jak Optymistyczna współbieżność jest zaimplementowana.</span><span class="sxs-lookup"><span data-stu-id="95ae3-138">Step 1: Looking at How Optimistic Concurrency is Implemented</span></span>

<span data-ttu-id="95ae3-139">Mechanizmu kontroli optymistycznej współbieżności działa przez zapewnienie im rekordu są zaktualizowane lub usunięte ma takie same wartości, tak jak podczas aktualizowania lub usuwania procesu uruchamiania.</span><span class="sxs-lookup"><span data-stu-id="95ae3-139">Optimistic concurrency control works by ensuring that the record being updated or deleted has the same values as it did when the updating or deleting process started.</span></span> <span data-ttu-id="95ae3-140">Na przykład po kliknięciu przycisku edycji w edycji kontrolki GridView wartości rekordu są odczytu z bazy danych i wyświetlane w polach tekstowych i innych formantów sieci Web.</span><span class="sxs-lookup"><span data-stu-id="95ae3-140">For example, when clicking the Edit button in an editable GridView, the record's values are read from the database and displayed in TextBoxes and other Web controls.</span></span> <span data-ttu-id="95ae3-141">Te oryginalne wartości są zapisywane w widoku GridView.</span><span class="sxs-lookup"><span data-stu-id="95ae3-141">These original values are saved by the GridView.</span></span> <span data-ttu-id="95ae3-142">Później po użytkownik wprowadza swoje zmiany i kliknie przycisk Aktualizuj, oryginalne wartości, a także nowe wartości są wysyłane do warstwy logiki biznesowej, a następnie w dół do warstwy dostępu do danych.</span><span class="sxs-lookup"><span data-stu-id="95ae3-142">Later, after the user makes her changes and clicks the Update button, the original values plus the new values are sent to the Business Logic Layer, and then down to the Data Access Layer.</span></span> <span data-ttu-id="95ae3-143">Warstwa dostępu do danych należy wydać instrukcji SQL, który będzie aktualizować jedynie rekord Jeśli oryginalne wartości, które użytkownik rozpoczął edycję są identyczne do wartości w bazie danych.</span><span class="sxs-lookup"><span data-stu-id="95ae3-143">The Data Access Layer must issue a SQL statement that will only update the record if the original values that the user started editing are identical to the values still in the database.</span></span> <span data-ttu-id="95ae3-144">Rysunek 2 przedstawia następująca sekwencja zdarzeń.</span><span class="sxs-lookup"><span data-stu-id="95ae3-144">Figure 2 depicts this sequence of events.</span></span>


<span data-ttu-id="95ae3-145">[![Update lub Delete, które zakończyło się sukcesem oryginalne wartości, musi być równa wartości bieżącej bazy danych](implementing-optimistic-concurrency-vb/_static/image5.png)](implementing-optimistic-concurrency-vb/_static/image4.png)</span><span class="sxs-lookup"><span data-stu-id="95ae3-145">[![For the Update or Delete to Succeed, the Original Values Must Be Equal to the Current Database Values](implementing-optimistic-concurrency-vb/_static/image5.png)](implementing-optimistic-concurrency-vb/_static/image4.png)</span></span>

<span data-ttu-id="95ae3-146">**Rysunek 2**: Update lub Delete, aby odnieść sukces, oryginalnym wartości musi być równa wartości bieżącej bazy danych ([kliknij, aby wyświetlić obraz w pełnym rozmiarze](implementing-optimistic-concurrency-vb/_static/image6.png))</span><span class="sxs-lookup"><span data-stu-id="95ae3-146">**Figure 2**: For the Update or Delete to Succeed, the Original Values Must Be Equal to the Current Database Values ([Click to view full-size image](implementing-optimistic-concurrency-vb/_static/image6.png))</span></span>


<span data-ttu-id="95ae3-147">Istnieją różne metody Implementowanie optymistycznej współbieżności (zobacz [Peter A. Bromberg](http://peterbromberg.net/)firmy [Optmistic współbieżności aktualizowanie logiki](http://www.eggheadcafe.com/articles/20050719.asp) dla krótki przegląd szereg opcji).</span><span class="sxs-lookup"><span data-stu-id="95ae3-147">There are various approaches to implementing optimistic concurrency (see [Peter A. Bromberg](http://peterbromberg.net/)'s [Optmistic Concurrency Updating Logic](http://www.eggheadcafe.com/articles/20050719.asp) for a brief look at a number of options).</span></span> <span data-ttu-id="95ae3-148">ADO.NET DataSet wpisane zapewnia co wdrożenia, które można skonfigurować tylko znaczników pola wyboru.</span><span class="sxs-lookup"><span data-stu-id="95ae3-148">The ADO.NET Typed DataSet provides one implementation that can be configured with just the tick of a checkbox.</span></span> <span data-ttu-id="95ae3-149">Włączanie optymistycznej współbieżności dla TableAdapter w zestawie danych wpisane rozszerzają TableAdapter `UPDATE` i `DELETE` porównanie wszystkich oryginalnej wartości w instrukcji `WHERE` klauzuli.</span><span class="sxs-lookup"><span data-stu-id="95ae3-149">Enabling optimistic concurrency for a TableAdapter in the Typed DataSet augments the TableAdapter's `UPDATE` and `DELETE` statements to include a comparison of all of the original values in the `WHERE` clause.</span></span> <span data-ttu-id="95ae3-150">Następujące `UPDATE` instrukcji, na przykład aktualizuje nazwę i cena produktu tylko wtedy, gdy wartości bieżącej bazy danych są równe wartości, które zostały pierwotnie pobrany podczas aktualizowania rekordu w widoku GridView.</span><span class="sxs-lookup"><span data-stu-id="95ae3-150">The following `UPDATE` statement, for example, updates the name and price of a product only if the current database values are equal to the values that were originally retrieved when updating the record in the GridView.</span></span> <span data-ttu-id="95ae3-151">`@ProductName` i `@UnitPrice` parametrów zawiera nowe wartości wprowadzonej przez użytkownika, natomiast `@original_ProductName` i `@original_UnitPrice` zawierają wartości, które zostały pierwotnie załadowane do kontrolki GridView kliknięcie przycisku Edytuj:</span><span class="sxs-lookup"><span data-stu-id="95ae3-151">The `@ProductName` and `@UnitPrice` parameters contain the new values entered by the user, whereas `@original_ProductName` and `@original_UnitPrice` contain the values that were originally loaded into the GridView when the Edit button was clicked:</span></span>


[!code-sql[Main](implementing-optimistic-concurrency-vb/samples/sample1.sql)]

> [!NOTE]
> <span data-ttu-id="95ae3-152">To `UPDATE` instrukcji został uproszczony dla czytelności.</span><span class="sxs-lookup"><span data-stu-id="95ae3-152">This `UPDATE` statement has been simplified for readability.</span></span> <span data-ttu-id="95ae3-153">W praktyce `UnitPrice` zaewidencjonować `WHERE` klauzuli byłoby bardziej skomplikowane, ponieważ `UnitPrice` może zawierać `NULL` s i sprawdzanie, czy gdy `NULL = NULL` zawsze zwraca wartość FAŁSZ (zamiast tego należy użyć `IS NULL`).</span><span class="sxs-lookup"><span data-stu-id="95ae3-153">In practice, the `UnitPrice` check in the `WHERE` clause would be more involved since `UnitPrice` can contain `NULL` s and checking if `NULL = NULL` always returns False (instead you must use `IS NULL`).</span></span>


<span data-ttu-id="95ae3-154">Oprócz używania różnych podstawowych `UPDATE` metody bezpośrednie instrukcji konfigurowania TableAdapter, aby użyć optymistycznej współbieżności również modyfikowanie podpis jego bazy danych.</span><span class="sxs-lookup"><span data-stu-id="95ae3-154">In addition to using a different underlying `UPDATE` statement, configuring a TableAdapter to use optimistic concurrency also modifies the signature of its DB direct methods.</span></span> <span data-ttu-id="95ae3-155">Odwoływanie się z naszym pierwszym samouczku [ *Tworzenie warstwy dostępu do danych*](../introduction/creating-a-data-access-layer-cs.md), metod bezpośrednich DB były te, które akceptuje listę skalarną wartości parametrów jako danych wejściowych (zamiast elementu DataRow silnie typizowane lub Wystąpienie elementu DataTable).</span><span class="sxs-lookup"><span data-stu-id="95ae3-155">Recall from our first tutorial, [*Creating a Data Access Layer*](../introduction/creating-a-data-access-layer-cs.md), that DB direct methods were those that accepts a list of scalar values as input parameters (rather than a strongly-typed DataRow or DataTable instance).</span></span> <span data-ttu-id="95ae3-156">Gdy optymistycznej współbieżności, bezpośrednie DB `Update()` i `Delete()` metody obejmują parametry wejściowe dla wartości oryginalne.</span><span class="sxs-lookup"><span data-stu-id="95ae3-156">When using optimistic concurrency, the DB direct `Update()` and `Delete()` methods include input parameters for the original values as well.</span></span> <span data-ttu-id="95ae3-157">Ponadto kod LOGIKI dotyczące korzystania z usługi batch aktualizacji wzorca ( `Update()` przeciążenia metody, które akceptują dotyczy to również utworzeń i DataTable, a nie wartości skalarnych) można także zmienić.</span><span class="sxs-lookup"><span data-stu-id="95ae3-157">Moreover, the code in the BLL for using the batch update pattern (the `Update()` method overloads that accept DataRows and DataTables rather than scalar values) must be changed as well.</span></span>

<span data-ttu-id="95ae3-158">Raczej niż rozszerzyć nasze istniejące TableAdapters przez warstwę DAL do możemy użyć optymistycznej współbieżności, (które wymagałyby zmiany LOGIKI w celu uwzględnienia), zamiast tego utworzyć nowy wpisany zestaw danych o nazwie `NorthwindOptimisticConcurrency`, do którego dodamy `Products` TableAdapter, używa optymistycznej współbieżności.</span><span class="sxs-lookup"><span data-stu-id="95ae3-158">Rather than extend our existing DAL's TableAdapters to use optimistic concurrency (which would necessitate changing the BLL to accommodate), let's instead create a new Typed DataSet named `NorthwindOptimisticConcurrency`, to which we'll add a `Products` TableAdapter that uses optimistic concurrency.</span></span> <span data-ttu-id="95ae3-159">Poniżej, utworzymy `ProductsOptimisticConcurrencyBLL` klasy warstwy logiki biznesowej, która ma odpowiednie modyfikacje Obsługa optymistycznej współbieżności warstwy DAL.</span><span class="sxs-lookup"><span data-stu-id="95ae3-159">Following that, we'll create a `ProductsOptimisticConcurrencyBLL` Business Logic Layer class that has the appropriate modifications to support the optimistic concurrency DAL.</span></span> <span data-ttu-id="95ae3-160">Po tym podwaliny pod Projekt wdrożenia został utworzony, będziemy gotowi do utworzenia strony ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="95ae3-160">Once this groundwork has been laid, we'll be ready to create the ASP.NET page.</span></span>

## <a name="step-2-creating-a-data-access-layer-that-supports-optimistic-concurrency"></a><span data-ttu-id="95ae3-161">Krok 2. Tworzenie warstwy dostępu do danych, który obsługuje optymistycznej współbieżności</span><span class="sxs-lookup"><span data-stu-id="95ae3-161">Step 2: Creating a Data Access Layer That Supports Optimistic Concurrency</span></span>

<span data-ttu-id="95ae3-162">Aby utworzyć nowy zestaw danych wpisane, kliknij prawym przyciskiem myszy `DAL` folder wewnątrz `App_Code` folderze i Dodaj nowy zestaw danych o nazwie `NorthwindOptimisticConcurrency`.</span><span class="sxs-lookup"><span data-stu-id="95ae3-162">To create a new Typed DataSet, right-click on the `DAL` folder within the `App_Code` folder and add a new DataSet named `NorthwindOptimisticConcurrency`.</span></span> <span data-ttu-id="95ae3-163">Jak widzieliśmy w pierwszym samouczku spowoduje więc doda nowy obiekt TableAdapter do wpisany zestaw danych, automatyczne uruchamianie Kreatora konfiguracji TableAdapter.</span><span class="sxs-lookup"><span data-stu-id="95ae3-163">As we saw in the first tutorial, doing so will add a new TableAdapter to the Typed DataSet, automatically launching the TableAdapter Configuration Wizard.</span></span> <span data-ttu-id="95ae3-164">Na pierwszym ekranie możemy monit Określ bazę danych, można połączyć się — connect do tego samego Northwind bazy danych przy użyciu `NORTHWNDConnectionString` z `Web.config`.</span><span class="sxs-lookup"><span data-stu-id="95ae3-164">In the first screen, we're prompted to specify the database to connect to - connect to the same Northwind database using the `NORTHWNDConnectionString` setting from `Web.config`.</span></span>


<span data-ttu-id="95ae3-165">[![Nawiązać połączenie z tej samej bazy danych Northwind](implementing-optimistic-concurrency-vb/_static/image8.png)](implementing-optimistic-concurrency-vb/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="95ae3-165">[![Connect to the Same Northwind Database](implementing-optimistic-concurrency-vb/_static/image8.png)](implementing-optimistic-concurrency-vb/_static/image7.png)</span></span>

<span data-ttu-id="95ae3-166">**Rysunek 3**: Nawiązać połączenie z tej samej bazy danych Northwind ([kliknij, aby wyświetlić obraz w pełnym rozmiarze](implementing-optimistic-concurrency-vb/_static/image9.png))</span><span class="sxs-lookup"><span data-stu-id="95ae3-166">**Figure 3**: Connect to the Same Northwind Database ([Click to view full-size image](implementing-optimistic-concurrency-vb/_static/image9.png))</span></span>


<span data-ttu-id="95ae3-167">Następnie możemy monit sposobów wysłać zapytanie dotyczące danych: za pomocą instrukcji SQL zapytań ad-hoc nową procedurę składowaną lub istniejącej procedury składowanej.</span><span class="sxs-lookup"><span data-stu-id="95ae3-167">Next, we are prompted as to how to query the data: through an ad-hoc SQL statement, a new stored procedure, or an existing stored procedure.</span></span> <span data-ttu-id="95ae3-168">Ponieważ użyliśmy zapytań SQL ad hoc w naszym oryginalnego DAL Użyj tej opcji w tym miejscu także.</span><span class="sxs-lookup"><span data-stu-id="95ae3-168">Since we used ad-hoc SQL queries in our original DAL, use this option here as well.</span></span>


<span data-ttu-id="95ae3-169">[![Określ dane, które można pobrać przy użyciu instrukcji SQL zapytań Ad-Hoc](implementing-optimistic-concurrency-vb/_static/image11.png)](implementing-optimistic-concurrency-vb/_static/image10.png)</span><span class="sxs-lookup"><span data-stu-id="95ae3-169">[![Specify the Data to Retrieve Using an Ad-Hoc SQL Statement](implementing-optimistic-concurrency-vb/_static/image11.png)](implementing-optimistic-concurrency-vb/_static/image10.png)</span></span>

<span data-ttu-id="95ae3-170">**Rysunek 4**: Określ dane, które można pobrać przy użyciu instrukcji SQL zapytań Ad-Hoc ([kliknij, aby wyświetlić obraz w pełnym rozmiarze](implementing-optimistic-concurrency-vb/_static/image12.png))</span><span class="sxs-lookup"><span data-stu-id="95ae3-170">**Figure 4**: Specify the Data to Retrieve Using an Ad-Hoc SQL Statement ([Click to view full-size image](implementing-optimistic-concurrency-vb/_static/image12.png))</span></span>


<span data-ttu-id="95ae3-171">Na poniższym ekranie wprowadź zapytanie SQL, aby pobrać informacje o produkcie.</span><span class="sxs-lookup"><span data-stu-id="95ae3-171">On the following screen, enter the SQL query to use to retrieve the product information.</span></span> <span data-ttu-id="95ae3-172">Można użyć dokładnie tego samego zapytania SQL używany do `Products` TableAdapter z naszych oryginalnego warstwy DAL, które zwraca wszystkie `Product` kolumn wraz z nazwy dostawcy i Kategoria produktu:</span><span class="sxs-lookup"><span data-stu-id="95ae3-172">Let's use the exact same SQL query used for the `Products` TableAdapter from our original DAL, which returns all of the `Product` columns along with the product's supplier and category names:</span></span>


[!code-sql[Main](implementing-optimistic-concurrency-vb/samples/sample2.sql)]


<span data-ttu-id="95ae3-173">[![Użyj tego samego zapytania SQL z TableAdapter produktów w oryginalnym warstwy DAL](implementing-optimistic-concurrency-vb/_static/image14.png)](implementing-optimistic-concurrency-vb/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="95ae3-173">[![Use the Same SQL Query from the Products TableAdapter in the Original DAL](implementing-optimistic-concurrency-vb/_static/image14.png)](implementing-optimistic-concurrency-vb/_static/image13.png)</span></span>

<span data-ttu-id="95ae3-174">**Rysunek 5**: Użyj tego samego zapytania SQL z `Products` TableAdapter w oryginalnym DAL ([kliknij, aby wyświetlić obraz w pełnym rozmiarze](implementing-optimistic-concurrency-vb/_static/image15.png))</span><span class="sxs-lookup"><span data-stu-id="95ae3-174">**Figure 5**: Use the Same SQL Query from the `Products` TableAdapter in the Original DAL ([Click to view full-size image](implementing-optimistic-concurrency-vb/_static/image15.png))</span></span>


<span data-ttu-id="95ae3-175">Przed przejściem do następnego ekranu, kliknij przycisk Opcje zaawansowane.</span><span class="sxs-lookup"><span data-stu-id="95ae3-175">Before moving onto the next screen, click the Advanced Options button.</span></span> <span data-ttu-id="95ae3-176">Aby tego mechanizmu kontroli optymistycznej współbieżności stosują TableAdapter, po prostu zaznacz pole wyboru "Użyj optymistycznej współbieżności".</span><span class="sxs-lookup"><span data-stu-id="95ae3-176">To have this TableAdapter employ optimistic concurrency control, simply check the "Use optimistic concurrency" checkbox.</span></span>


<span data-ttu-id="95ae3-177">[![Włącz kontrolę optymistycznej współbieżności, przez sprawdzanie &quot;używaj optymistycznej współbieżności&quot; pola wyboru](implementing-optimistic-concurrency-vb/_static/image17.png)](implementing-optimistic-concurrency-vb/_static/image16.png)</span><span class="sxs-lookup"><span data-stu-id="95ae3-177">[![Enable Optimistic Concurrency Control by Checking the &quot;Use optimistic concurrency&quot; CheckBox](implementing-optimistic-concurrency-vb/_static/image17.png)](implementing-optimistic-concurrency-vb/_static/image16.png)</span></span>

<span data-ttu-id="95ae3-178">**Rysunek 6**: Włączanie mechanizmu kontroli optymistycznej współbieżności, zaznaczając pole wyboru "Użyj optymistycznej współbieżności" ([kliknij, aby wyświetlić obraz w pełnym rozmiarze](implementing-optimistic-concurrency-vb/_static/image18.png))</span><span class="sxs-lookup"><span data-stu-id="95ae3-178">**Figure 6**: Enable Optimistic Concurrency Control by Checking the "Use optimistic concurrency" CheckBox ([Click to view full-size image](implementing-optimistic-concurrency-vb/_static/image18.png))</span></span>


<span data-ttu-id="95ae3-179">Na koniec wskazują, że wzorców dostępu do danych, które zwraca DataTable; i Wypełnij tabelę danych powinien używać TableAdapter również wskazywać, że metod bezpośrednich bazy danych powinny być tworzone.</span><span class="sxs-lookup"><span data-stu-id="95ae3-179">Lastly, indicate that the TableAdapter should use the data access patterns that both fill a DataTable and return a DataTable; also indicate that the DB direct methods should be created.</span></span> <span data-ttu-id="95ae3-180">Zmień nazwę metody dotyczące zwracania wzorzec DataTable z GetData na GetProducts, w celu utworzenia duplikatów konwencji nazewnictwa użytymi w naszym oryginalnego warstwy DAL.</span><span class="sxs-lookup"><span data-stu-id="95ae3-180">Change the method name for the Return a DataTable pattern from GetData to GetProducts, so as to mirror the naming conventions we used in our original DAL.</span></span>


<span data-ttu-id="95ae3-181">[![Masz TableAdapter wykorzystywać wszystkie wzorce dostępu do danych](implementing-optimistic-concurrency-vb/_static/image20.png)](implementing-optimistic-concurrency-vb/_static/image19.png)</span><span class="sxs-lookup"><span data-stu-id="95ae3-181">[![Have the TableAdapter Utilize All Data Access Patterns](implementing-optimistic-concurrency-vb/_static/image20.png)](implementing-optimistic-concurrency-vb/_static/image19.png)</span></span>

<span data-ttu-id="95ae3-182">**Rysunek 7**: TableAdapter korzystanie z wszystkich danych programu Access wzorców ([kliknij, aby wyświetlić obraz w pełnym rozmiarze](implementing-optimistic-concurrency-vb/_static/image21.png))</span><span class="sxs-lookup"><span data-stu-id="95ae3-182">**Figure 7**: Have the TableAdapter Utilize All Data Access Patterns ([Click to view full-size image](implementing-optimistic-concurrency-vb/_static/image21.png))</span></span>


<span data-ttu-id="95ae3-183">Po ukończeniu kreatora, Projektant obiektów DataSet będzie zawierać silnie typizowanego `Products` DataTable i TableAdapter.</span><span class="sxs-lookup"><span data-stu-id="95ae3-183">After completing the wizard, the DataSet Designer will include a strongly-typed `Products` DataTable and TableAdapter.</span></span> <span data-ttu-id="95ae3-184">Poświęć chwilę, aby zmienić nazwę elementu DataTable z `Products` do `ProductsOptimisticConcurrency`, co można zrobić, klikając prawym przyciskiem myszy pasek tytułu tabeli DataTable i wybierając zmiany nazwy z menu kontekstowego.</span><span class="sxs-lookup"><span data-stu-id="95ae3-184">Take a moment to rename the DataTable from `Products` to `ProductsOptimisticConcurrency`, which you can do by right-clicking on the DataTable's title bar and choosing Rename from the context menu.</span></span>


<span data-ttu-id="95ae3-185">[![DataTable i TableAdapter zostały dodane do zestawu danych](implementing-optimistic-concurrency-vb/_static/image23.png)](implementing-optimistic-concurrency-vb/_static/image22.png)</span><span class="sxs-lookup"><span data-stu-id="95ae3-185">[![A DataTable and TableAdapter Have Been Added to the Typed DataSet](implementing-optimistic-concurrency-vb/_static/image23.png)](implementing-optimistic-concurrency-vb/_static/image22.png)</span></span>

<span data-ttu-id="95ae3-186">**Rysunek 8**: DataTable i TableAdapter zostały dodane do zestawu danych wpisane ([kliknij, aby wyświetlić obraz w pełnym rozmiarze](implementing-optimistic-concurrency-vb/_static/image24.png))</span><span class="sxs-lookup"><span data-stu-id="95ae3-186">**Figure 8**: A DataTable and TableAdapter Have Been Added to the Typed DataSet ([Click to view full-size image](implementing-optimistic-concurrency-vb/_static/image24.png))</span></span>


<span data-ttu-id="95ae3-187">Aby zobaczyć różnice między `UPDATE` i `DELETE` zapytań między `ProductsOptimisticConcurrency` TableAdapter (używający optymistycznej współbieżności) i TableAdapter produktów, (które nie), kliknij na obiekt TableAdapter i przejdź do okna właściwości.</span><span class="sxs-lookup"><span data-stu-id="95ae3-187">To see the differences between the `UPDATE` and `DELETE` queries between the `ProductsOptimisticConcurrency` TableAdapter (which uses optimistic concurrency) and the Products TableAdapter (which doesn't), click on the TableAdapter and go to the Properties window.</span></span> <span data-ttu-id="95ae3-188">W `DeleteCommand` i `UpdateCommand` właściwości `CommandText` właściwości podrzędnych widać rzeczywistej składni SQL, które są wysyłane do bazy danych, wywołana aktualizację DAL lub metody dotyczące usuwania.</span><span class="sxs-lookup"><span data-stu-id="95ae3-188">In the `DeleteCommand` and `UpdateCommand` properties' `CommandText` subproperties you can see the actual SQL syntax that is sent to the database when the DAL's update or delete-related methods are invoked.</span></span> <span data-ttu-id="95ae3-189">Aby uzyskać `ProductsOptimisticConcurrency` TableAdapter `DELETE` jest używana instrukcja:</span><span class="sxs-lookup"><span data-stu-id="95ae3-189">For the `ProductsOptimisticConcurrency` TableAdapter the `DELETE` statement used is:</span></span>


[!code-sql[Main](implementing-optimistic-concurrency-vb/samples/sample3.sql)]

<span data-ttu-id="95ae3-190">Natomiast `DELETE` poufności informacji dotyczące TableAdapter produktu w naszym oryginalnego DAL jest znacznie prostsza:</span><span class="sxs-lookup"><span data-stu-id="95ae3-190">Whereas the `DELETE` statement for the Product TableAdapter in our original DAL is the much simpler:</span></span>


[!code-sql[Main](implementing-optimistic-concurrency-vb/samples/sample4.sql)]

<span data-ttu-id="95ae3-191">Jak widać, `WHERE` w klauzuli `DELETE` poufności informacji dotyczące TableAdapter, która używa optymistycznej współbieżności zawiera porównanie między poszczególnymi `Product` tabeli istniejącej wartości w kolumnie i oryginalne wartości w czasie Ostatniej chwili wypełniania kontrolki GridView (lub DetailsView lub FormView).</span><span class="sxs-lookup"><span data-stu-id="95ae3-191">As you can see, the `WHERE` clause in the `DELETE` statement for the TableAdapter that uses optimistic concurrency includes a comparison between each of the `Product` table's existing column values and the original values at the time the GridView (or DetailsView or FormView) was last populated.</span></span> <span data-ttu-id="95ae3-192">Od wszystkich pól innych niż `ProductID`, `ProductName`, i `Discontinued` może mieć `NULL` wartości, dodatkowe parametry i kontrole są dołączone do porównania poprawnie `NULL` wartości w `WHERE` klauzuli.</span><span class="sxs-lookup"><span data-stu-id="95ae3-192">Since all fields other than `ProductID`, `ProductName`, and `Discontinued` can have `NULL` values, additional parameters and checks are included to correctly compare `NULL` values in the `WHERE` clause.</span></span>

<span data-ttu-id="95ae3-193">Firma Microsoft nie będzie dodawać żadnych dodatkowych DataTable optymistycznej współbieżności, włączone DataSet w tym samouczku jako tylko zapewnia strony ASP.NET, aktualizowanie i usuwanie informacji o produkcie.</span><span class="sxs-lookup"><span data-stu-id="95ae3-193">We won't be adding any additional DataTables to the optimistic concurrency-enabled DataSet for this tutorial, as our ASP.NET page will only provide updating and deleting product information.</span></span> <span data-ttu-id="95ae3-194">Jednak nadal musimy dodać `GetProductByProductID(productID)` metody `ProductsOptimisticConcurrency` TableAdapter.</span><span class="sxs-lookup"><span data-stu-id="95ae3-194">However, we do still need to add the `GetProductByProductID(productID)` method to the `ProductsOptimisticConcurrency` TableAdapter.</span></span>

<span data-ttu-id="95ae3-195">W tym celu kliknij prawym przyciskiem myszy pasek tytułu TableAdapter (po prawej stronie obszaru powyżej `Fill` i `GetProducts` nazwy metod) i wybierz polecenie Dodaj zapytanie z menu kontekstowego.</span><span class="sxs-lookup"><span data-stu-id="95ae3-195">To accomplish this, right-click on the TableAdapter's title bar (the area right above the `Fill` and `GetProducts` method names) and choose Add Query from the context menu.</span></span> <span data-ttu-id="95ae3-196">Spowoduje to uruchomienie Kreatora konfiguracji zapytań TableAdapter.</span><span class="sxs-lookup"><span data-stu-id="95ae3-196">This will launch the TableAdapter Query Configuration Wizard.</span></span> <span data-ttu-id="95ae3-197">Zgodnie z naszym TableAdapter wstępną konfigurację, wybrać opcję utworzenia `GetProductByProductID(productID)` metody za pomocą instrukcji SQL zapytań ad-hoc (zobacz rysunek 4).</span><span class="sxs-lookup"><span data-stu-id="95ae3-197">As with our TableAdapter's initial configuration, opt to create the `GetProductByProductID(productID)` method using an ad-hoc SQL statement (see Figure 4).</span></span> <span data-ttu-id="95ae3-198">Ponieważ `GetProductByProductID(productID)` metoda zwraca informacje o konkretnym produktem, wskazują, że to zapytanie jest `SELECT` zapytania typu, która zwraca wiersze.</span><span class="sxs-lookup"><span data-stu-id="95ae3-198">Since the `GetProductByProductID(productID)` method returns information about a particular product, indicate that this query is a `SELECT` query type that returns rows.</span></span>


<span data-ttu-id="95ae3-199">[![Oznacz typ zapytania jako &quot;SELECT, która zwraca wiersze&quot;](implementing-optimistic-concurrency-vb/_static/image26.png)](implementing-optimistic-concurrency-vb/_static/image25.png)</span><span class="sxs-lookup"><span data-stu-id="95ae3-199">[![Mark the Query Type as a &quot;SELECT which returns rows&quot;](implementing-optimistic-concurrency-vb/_static/image26.png)](implementing-optimistic-concurrency-vb/_static/image25.png)</span></span>

<span data-ttu-id="95ae3-200">**Rysunek 9**: Oznacz typ zapytania jako "`SELECT` która zwraca wiersze" ([kliknij, aby wyświetlić obraz w pełnym rozmiarze](implementing-optimistic-concurrency-vb/_static/image27.png))</span><span class="sxs-lookup"><span data-stu-id="95ae3-200">**Figure 9**: Mark the Query Type as a "`SELECT` which returns rows" ([Click to view full-size image](implementing-optimistic-concurrency-vb/_static/image27.png))</span></span>


<span data-ttu-id="95ae3-201">Na następnym ekranie możemy monit o podanie zapytanie SQL do użycia przy użyciu domyślnego zapytania TableAdapter wstępnie załadowane.</span><span class="sxs-lookup"><span data-stu-id="95ae3-201">On the next screen we're prompted for the SQL query to use, with the TableAdapter's default query pre-loaded.</span></span> <span data-ttu-id="95ae3-202">Rozszerzaj istniejące zapytanie, aby uwzględnić w klauzuli `WHERE ProductID = @ProductID`, jak pokazano na rysunku nr 10.</span><span class="sxs-lookup"><span data-stu-id="95ae3-202">Augment the existing query to include the clause `WHERE ProductID = @ProductID`, as shown in Figure 10.</span></span>


<span data-ttu-id="95ae3-203">[![Dodaj WHERE — klauzula zapytania wstępnie załadowane w celu zwrócenia rekordu określonego produktu](implementing-optimistic-concurrency-vb/_static/image29.png)](implementing-optimistic-concurrency-vb/_static/image28.png)</span><span class="sxs-lookup"><span data-stu-id="95ae3-203">[![Add a WHERE Clause to the Pre-Loaded Query to Return a Specific Product Record](implementing-optimistic-concurrency-vb/_static/image29.png)](implementing-optimistic-concurrency-vb/_static/image28.png)</span></span>

<span data-ttu-id="95ae3-204">**Na rysunku nr 10**: Dodaj `WHERE` klauzula zapytania Pre-Loaded w celu zwrócenia określonego rekordu produktu ([kliknij, aby wyświetlić obraz w pełnym rozmiarze](implementing-optimistic-concurrency-vb/_static/image30.png))</span><span class="sxs-lookup"><span data-stu-id="95ae3-204">**Figure 10**: Add a `WHERE` Clause to the Pre-Loaded Query to Return a Specific Product Record ([Click to view full-size image](implementing-optimistic-concurrency-vb/_static/image30.png))</span></span>


<span data-ttu-id="95ae3-205">Na koniec zmień nazwy wygenerowana metoda `FillByProductID` i `GetProductByProductID`.</span><span class="sxs-lookup"><span data-stu-id="95ae3-205">Finally, change the generated method names to `FillByProductID` and `GetProductByProductID`.</span></span>


<span data-ttu-id="95ae3-206">[![Zmień nazwę metody FillByProductID i GetProductByProductID](implementing-optimistic-concurrency-vb/_static/image32.png)](implementing-optimistic-concurrency-vb/_static/image31.png)</span><span class="sxs-lookup"><span data-stu-id="95ae3-206">[![Rename the Methods to FillByProductID and GetProductByProductID](implementing-optimistic-concurrency-vb/_static/image32.png)](implementing-optimistic-concurrency-vb/_static/image31.png)</span></span>

<span data-ttu-id="95ae3-207">**Rysunek 11**: Zmień nazwę metody służące do `FillByProductID` i `GetProductByProductID` ([kliknij, aby wyświetlić obraz w pełnym rozmiarze](implementing-optimistic-concurrency-vb/_static/image33.png))</span><span class="sxs-lookup"><span data-stu-id="95ae3-207">**Figure 11**: Rename the Methods to `FillByProductID` and `GetProductByProductID` ([Click to view full-size image](implementing-optimistic-concurrency-vb/_static/image33.png))</span></span>


<span data-ttu-id="95ae3-208">Za pomocą tego kreatora pełną TableAdapter zawiera teraz dwie metody do pobierania danych: `GetProducts()`, co powoduje zwrócenie *wszystkich* produktów; i `GetProductByProductID(productID)`, która zwraca określony produkt.</span><span class="sxs-lookup"><span data-stu-id="95ae3-208">With this wizard complete, the TableAdapter now contains two methods for retrieving data: `GetProducts()`, which returns *all* products; and `GetProductByProductID(productID)`, which returns the specified product.</span></span>

## <a name="step-3-creating-a-business-logic-layer-for-the-optimistic-concurrency-enabled-dal"></a><span data-ttu-id="95ae3-209">Krok 3. Tworzenie warstwy logiki biznesowej dla optymistycznej współbieżności, włączone DAL</span><span class="sxs-lookup"><span data-stu-id="95ae3-209">Step 3: Creating a Business Logic Layer for the Optimistic Concurrency-Enabled DAL</span></span>

<span data-ttu-id="95ae3-210">Nasze istniejące `ProductsBLL` klasa zawiera przykłady przy użyciu aktualizacji usługi batch i wzorce bezpośrednie bazy danych.</span><span class="sxs-lookup"><span data-stu-id="95ae3-210">Our existing `ProductsBLL` class has examples of using both the batch update and DB direct patterns.</span></span> <span data-ttu-id="95ae3-211">`AddProduct` Metody i `UpdateProduct` przeciążenia obu użyć wzorca aktualizacji usługi batch, przekazując `ProductRow` wystąpienia metody aktualizacji TableAdapter.</span><span class="sxs-lookup"><span data-stu-id="95ae3-211">The `AddProduct` method and `UpdateProduct` overloads both use the batch update pattern, passing in a `ProductRow` instance to the TableAdapter's Update method.</span></span> <span data-ttu-id="95ae3-212">`DeleteProduct` Metody, z drugiej strony, używa wzorca bezpośrednie bazy danych, wywoływania TableAdapter `Delete(productID)` metody.</span><span class="sxs-lookup"><span data-stu-id="95ae3-212">The `DeleteProduct` method, on the other hand, uses the DB direct pattern, calling the TableAdapter's `Delete(productID)` method.</span></span>

<span data-ttu-id="95ae3-213">Przy użyciu nowego `ProductsOptimisticConcurrency` TableAdapter, baza danych bezpośrednie metody teraz wymagają, że oryginalne wartości zostać przekazany w.</span><span class="sxs-lookup"><span data-stu-id="95ae3-213">With the new `ProductsOptimisticConcurrency` TableAdapter, the DB direct methods now require that the original values also be passed in.</span></span> <span data-ttu-id="95ae3-214">Na przykład `Delete` metoda oczekuje teraz dziesięciu parametry wejściowe: oryginalna `ProductID`, `ProductName`, `SupplierID`, `CategoryID`, `QuantityPerUnit`, `UnitPrice`, `UnitsInStock`, `UnitsOnOrder`, `ReorderLevel`, i `Discontinued`.</span><span class="sxs-lookup"><span data-stu-id="95ae3-214">For example, the `Delete` method now expects ten input parameters: the original `ProductID`, `ProductName`, `SupplierID`, `CategoryID`, `QuantityPerUnit`, `UnitPrice`, `UnitsInStock`, `UnitsOnOrder`, `ReorderLevel`, and `Discontinued`.</span></span> <span data-ttu-id="95ae3-215">Używa wartości te dodatkowe parametry wejściowe `WHERE` klauzuli `DELETE` instrukcji wysyłane do bazy danych tylko do usuwania określonego rekordu, jeśli mapowania wartości bieżącej bazy danych do oryginalnych.</span><span class="sxs-lookup"><span data-stu-id="95ae3-215">It uses these additional input parameters' values in `WHERE` clause of the `DELETE` statement sent to the database, only deleting the specified record if the database's current values map up to the original ones.</span></span>

<span data-ttu-id="95ae3-216">Podczas gdy podpis metody dla TableAdapter `Update` metody używane we wzorcu aktualizacji wsadowych nie zmienił, zawiera kod potrzebny do rejestrowania wartości oryginalne i nowe.</span><span class="sxs-lookup"><span data-stu-id="95ae3-216">While the method signature for the TableAdapter's `Update` method used in the batch update pattern hasn't changed, the code needed to record the original and new values has.</span></span> <span data-ttu-id="95ae3-217">W związku z tym a nie próbują użyć optymistycznej współbieżności, włączone DAL z naszym istniejącym `ProductsBLL` klasy, Utwórz nową klasę warstwy logiki biznesowej do pracy z naszej nowej warstwy DAL.</span><span class="sxs-lookup"><span data-stu-id="95ae3-217">Therefore, rather than attempt to use the optimistic concurrency-enabled DAL with our existing `ProductsBLL` class, let's create a new Business Logic Layer class for working with our new DAL.</span></span>

<span data-ttu-id="95ae3-218">Dodaj klasę o nazwie `ProductsOptimisticConcurrencyBLL` do `BLL` folder wewnątrz `App_Code` folderu.</span><span class="sxs-lookup"><span data-stu-id="95ae3-218">Add a class named `ProductsOptimisticConcurrencyBLL` to the `BLL` folder within the `App_Code` folder.</span></span>


![Dodaj klasę ProductsOptimisticConcurrencyBLL do folderu LOGIKI](implementing-optimistic-concurrency-vb/_static/image34.png)

<span data-ttu-id="95ae3-220">**Rysunek 12**: Dodaj `ProductsOptimisticConcurrencyBLL` klasy do folderu LOGIKI</span><span class="sxs-lookup"><span data-stu-id="95ae3-220">**Figure 12**: Add the `ProductsOptimisticConcurrencyBLL` Class to the BLL Folder</span></span>


<span data-ttu-id="95ae3-221">Następnie dodaj następujący kod, aby `ProductsOptimisticConcurrencyBLL` klasy:</span><span class="sxs-lookup"><span data-stu-id="95ae3-221">Next, add the following code to the `ProductsOptimisticConcurrencyBLL` class:</span></span>


[!code-vb[Main](implementing-optimistic-concurrency-vb/samples/sample5.vb)]

<span data-ttu-id="95ae3-222">Należy pamiętać używając `NorthwindOptimisticConcurrencyTableAdapters` instrukcji powyżej początku deklaracji klasy.</span><span class="sxs-lookup"><span data-stu-id="95ae3-222">Note the using `NorthwindOptimisticConcurrencyTableAdapters` statement above the start of the class declaration.</span></span> <span data-ttu-id="95ae3-223">`NorthwindOptimisticConcurrencyTableAdapters` Przestrzeń nazw zawiera `ProductsOptimisticConcurrencyTableAdapter` klasy, która zapewnia metody DAL.</span><span class="sxs-lookup"><span data-stu-id="95ae3-223">The `NorthwindOptimisticConcurrencyTableAdapters` namespace contains the `ProductsOptimisticConcurrencyTableAdapter` class, which provides the DAL's methods.</span></span> <span data-ttu-id="95ae3-224">Ponadto przed deklaracją klasy znajdziesz `System.ComponentModel.DataObject` atrybut, który powoduje, że Visual Studio, rozszerzając tej klasy w Kreatorze ObjectDataSource listy rozwijanej.</span><span class="sxs-lookup"><span data-stu-id="95ae3-224">Also before the class declaration you'll find the `System.ComponentModel.DataObject` attribute, which instructs Visual Studio to include this class in the ObjectDataSource wizard's drop-down list.</span></span>

<span data-ttu-id="95ae3-225">`ProductsOptimisticConcurrencyBLL`Firmy `Adapter` właściwości zapewnia szybki dostęp do wystąpienia `ProductsOptimisticConcurrencyTableAdapter` klasy i jest zgodna z wzorcem, używane w naszych oryginalnej klasy LOGIKI (`ProductsBLL`, `CategoriesBLL`i tak dalej).</span><span class="sxs-lookup"><span data-stu-id="95ae3-225">The `ProductsOptimisticConcurrencyBLL`'s `Adapter` property provides quick access to an instance of the `ProductsOptimisticConcurrencyTableAdapter` class, and follows the pattern used in our original BLL classes (`ProductsBLL`, `CategoriesBLL`, and so on).</span></span> <span data-ttu-id="95ae3-226">Na koniec `GetProducts()` metoda wywołuje po prostu DAL `GetProducts()` metodę i zwraca `ProductsOptimisticConcurrencyDataTable` object wypełniany `ProductsOptimisticConcurrencyRow` wystąpienia dla każdego rekordu produktu w bazie danych.</span><span class="sxs-lookup"><span data-stu-id="95ae3-226">Finally, the `GetProducts()` method simply calls down into the DAL's `GetProducts()` method and returns a `ProductsOptimisticConcurrencyDataTable` object populated with a `ProductsOptimisticConcurrencyRow` instance for each product record in the database.</span></span>

## <a name="deleting-a-product-using-the-db-direct-pattern-with-optimistic-concurrency"></a><span data-ttu-id="95ae3-227">Usuwanie produktu przy użyciu wzorca bezpośrednie bazy danych za pomocą optymistycznej współbieżności</span><span class="sxs-lookup"><span data-stu-id="95ae3-227">Deleting a Product Using the DB Direct Pattern with Optimistic Concurrency</span></span>

<span data-ttu-id="95ae3-228">Korzystając z wzorca bezpośrednie bazy danych dla warstwy, która używa optymistycznej współbieżności, metody muszą być przekazywane wartości nowymi i oryginalnymi.</span><span class="sxs-lookup"><span data-stu-id="95ae3-228">When using the DB direct pattern against a DAL that uses optimistic concurrency, the methods must be passed the new and original values.</span></span> <span data-ttu-id="95ae3-229">Związanych z usuwaniem, istnieją nowe wartości, więc należy przekazać oryginalnych wartości.</span><span class="sxs-lookup"><span data-stu-id="95ae3-229">For deleting, there are no new values, so only the original values need be passed in.</span></span> <span data-ttu-id="95ae3-230">W naszym LOGIKI następnie firma Microsoft musi zaakceptować wszystkie parametry oryginalnego jako parametry wejściowe.</span><span class="sxs-lookup"><span data-stu-id="95ae3-230">In our BLL, then, we must accept all of the original parameters as input parameters.</span></span> <span data-ttu-id="95ae3-231">Przyjrzyjmy się `DeleteProduct` method in Class metoda `ProductsOptimisticConcurrencyBLL` klasy należy użyć metody bezpośrednie bazy danych.</span><span class="sxs-lookup"><span data-stu-id="95ae3-231">Let's have the `DeleteProduct` method in the `ProductsOptimisticConcurrencyBLL` class use the DB direct method.</span></span> <span data-ttu-id="95ae3-232">Oznacza to, że ta metoda musi wykonać we wszystkich polach danych dziesięć produktu jako parametry wejściowe i przekazać je do warstwy DAL, jak pokazano w poniższym kodzie:</span><span class="sxs-lookup"><span data-stu-id="95ae3-232">This means that this method needs to take in all ten product data fields as input parameters, and pass these to the DAL, as shown in the following code:</span></span>


[!code-vb[Main](implementing-optimistic-concurrency-vb/samples/sample6.vb)]

<span data-ttu-id="95ae3-233">Jeżeli oryginalne wartości - tych wartości, które zostały ostatnio załadowane do kontrolki GridView (lub DetailsView lub FormView) — różnią się od wartości w bazie danych, gdy użytkownik kliknie przycisk Usuń `WHERE` klauzuli nie będzie zgodny z dowolnego rekordu bazy danych i żadnych rekordów będzie to miało wpływu.</span><span class="sxs-lookup"><span data-stu-id="95ae3-233">If the original values - those values that were last loaded into the GridView (or DetailsView or FormView) - differ from the values in the database when the user clicks the Delete button the `WHERE` clause won't match up with any database record and no records will be affected.</span></span> <span data-ttu-id="95ae3-234">Dzięki temu TableAdapter `Delete` metoda zwróci `0` i LOGIKI `DeleteProduct` metoda zwróci `false`.</span><span class="sxs-lookup"><span data-stu-id="95ae3-234">Hence, the TableAdapter's `Delete` method will return `0` and the BLL's `DeleteProduct` method will return `false`.</span></span>

## <a name="updating-a-product-using-the-batch-update-pattern-with-optimistic-concurrency"></a><span data-ttu-id="95ae3-235">Aktualizowanie produktu przy użyciu wzorca aktualizacji usługi Batch za pomocą optymistycznej współbieżności</span><span class="sxs-lookup"><span data-stu-id="95ae3-235">Updating a Product Using the Batch Update Pattern with Optimistic Concurrency</span></span>

<span data-ttu-id="95ae3-236">Jak wspomniano wcześniej, TableAdapter `Update` metody wzorca aktualizacji usługi batch ma taki sam podpis metody, niezależnie od tego, czy jest zatrudniony optymistycznej współbieżności.</span><span class="sxs-lookup"><span data-stu-id="95ae3-236">As noted earlier, the TableAdapter's `Update` method for the batch update pattern has the same method signature regardless of whether or not optimistic concurrency is employed.</span></span> <span data-ttu-id="95ae3-237">To znaczy `Update` metoda oczekuje elementu DataRow, tablica dotyczy to również utworzeń, DataTable lub DataSet z kontrolą typów.</span><span class="sxs-lookup"><span data-stu-id="95ae3-237">Namely, the `Update` method expects a DataRow, an array of DataRows, a DataTable, or a Typed DataSet.</span></span> <span data-ttu-id="95ae3-238">Nie istnieją żadne dodatkowe parametry wejściowe do określania oryginalnych wartości.</span><span class="sxs-lookup"><span data-stu-id="95ae3-238">There are no additional input parameters for specifying the original values.</span></span> <span data-ttu-id="95ae3-239">Jest to możliwe, ponieważ DataTable śledzi informacje o wartości oryginalnego i modyfikacji dla jego DataRow(s).</span><span class="sxs-lookup"><span data-stu-id="95ae3-239">This is possible because the DataTable keeps track of the original and modified values for its DataRow(s).</span></span> <span data-ttu-id="95ae3-240">Jeśli problemy z warstwy DAL jego `UPDATE` instrukcji, `@original_ColumnName` parametry są wypełniane przy użyciu oryginalnych wartości DataRow, natomiast `@ColumnName` parametry są wypełniane przy użyciu zmodyfikowane wartości DataRow.</span><span class="sxs-lookup"><span data-stu-id="95ae3-240">When the DAL issues its `UPDATE` statement, the `@original_ColumnName` parameters are populated with the DataRow's original values, whereas the `@ColumnName` parameters are populated with the DataRow's modified values.</span></span>

<span data-ttu-id="95ae3-241">W `ProductsBLL` klasy (używający naszych oryginalny, optymistycznej współbieżności DAL), korzystając z wzorca aktualizacji usługi batch można zaktualizować informacji o produkcie, nasz kod wykonuje następująca sekwencja zdarzeń:</span><span class="sxs-lookup"><span data-stu-id="95ae3-241">In the `ProductsBLL` class (which uses our original, non-optimistic concurrency DAL), when using the batch update pattern to update product information our code performs the following sequence of events:</span></span>

1. <span data-ttu-id="95ae3-242">Bieżące informacje o produkcie bazy danych do odczytu `ProductRow` przy użyciu TableAdapter `GetProductByProductID(productID)` — metoda</span><span class="sxs-lookup"><span data-stu-id="95ae3-242">Read the current database product information into a `ProductRow` instance using the TableAdapter's `GetProductByProductID(productID)` method</span></span>
2. <span data-ttu-id="95ae3-243">Przypisz nowe wartości do `ProductRow` wystąpienia z kroku 1</span><span class="sxs-lookup"><span data-stu-id="95ae3-243">Assign the new values to the `ProductRow` instance from Step 1</span></span>
3. <span data-ttu-id="95ae3-244">Wywołaj TableAdapter `Update` metody, przekazując `ProductRow` wystąpienia</span><span class="sxs-lookup"><span data-stu-id="95ae3-244">Call the TableAdapter's `Update` method, passing in the `ProductRow` instance</span></span>

<span data-ttu-id="95ae3-245">Tej sekwencji kroki, jednak nie będzie poprawnie obsługują optymistyczną współbieżność, ponieważ `ProductRow` wypełnione w kroku 1 jest wypełniana bezpośrednio z bazy danych, co oznacza, że oryginalne wartości, które są używane przez klasy DataRow te, które obecnie istnieje w bazy danych, a nie te, które były powiązane z GridView na początku procesu edycji.</span><span class="sxs-lookup"><span data-stu-id="95ae3-245">This sequence of steps, however, won't correctly support optimistic concurrency because the `ProductRow` populated in Step 1 is populated directly from the database, meaning that the original values used by the DataRow are those that currently exist in the database, and not those that were bound to the GridView at the start of the editing process.</span></span> <span data-ttu-id="95ae3-246">Zamiast tego po użyciu optymistycznej współbieżności obsługą warstwy DAL, musimy alter `UpdateProduct` przeciążeń metody, wykonaj następujące kroki:</span><span class="sxs-lookup"><span data-stu-id="95ae3-246">Instead, when using an optimistic concurrency-enabled DAL, we need to alter the `UpdateProduct` method overloads to use the following steps:</span></span>

1. <span data-ttu-id="95ae3-247">Bieżące informacje o produkcie bazy danych do odczytu `ProductsOptimisticConcurrencyRow` przy użyciu TableAdapter `GetProductByProductID(productID)` — metoda</span><span class="sxs-lookup"><span data-stu-id="95ae3-247">Read the current database product information into a `ProductsOptimisticConcurrencyRow` instance using the TableAdapter's `GetProductByProductID(productID)` method</span></span>
2. <span data-ttu-id="95ae3-248">Przypisz *oryginalnego* wartości `ProductsOptimisticConcurrencyRow` wystąpienia z kroku 1</span><span class="sxs-lookup"><span data-stu-id="95ae3-248">Assign the *original* values to the `ProductsOptimisticConcurrencyRow` instance from Step 1</span></span>
3. <span data-ttu-id="95ae3-249">Wywołaj `ProductsOptimisticConcurrencyRow` wystąpienia `AcceptChanges()` metody, która instruuje klasy DataRow, czy jego bieżące wartości są tymi, które "oryginalne"</span><span class="sxs-lookup"><span data-stu-id="95ae3-249">Call the `ProductsOptimisticConcurrencyRow` instance's `AcceptChanges()` method, which instructs the DataRow that its current values are the "original" ones</span></span>
4. <span data-ttu-id="95ae3-250">Przypisz *nowe* wartości `ProductsOptimisticConcurrencyRow` wystąpienia</span><span class="sxs-lookup"><span data-stu-id="95ae3-250">Assign the *new* values to the `ProductsOptimisticConcurrencyRow` instance</span></span>
5. <span data-ttu-id="95ae3-251">Wywołaj TableAdapter `Update` metody, przekazując `ProductsOptimisticConcurrencyRow` wystąpienia</span><span class="sxs-lookup"><span data-stu-id="95ae3-251">Call the TableAdapter's `Update` method, passing in the `ProductsOptimisticConcurrencyRow` instance</span></span>

<span data-ttu-id="95ae3-252">Krok 1 odczyty we wszystkich wartości bieżącej bazy danych dla rekordu określony produkt.</span><span class="sxs-lookup"><span data-stu-id="95ae3-252">Step 1 reads in all of the current database values for the specified product record.</span></span> <span data-ttu-id="95ae3-253">Ten krok jest zbędny w `UpdateProduct` przeciążenia, które aktualizuje *wszystkich* kolumn produktu (jako wartości te zostaną zastąpione w kroku 2), ale ma zasadnicze znaczenie dla tych przeciążeń, gdzie podzbiorem wartości w kolumnach są przekazywane w jako Parametry wejściowe.</span><span class="sxs-lookup"><span data-stu-id="95ae3-253">This step is superfluous in the `UpdateProduct` overload that updates *all* of the product columns (as these values are overwritten in Step 2), but is essential for those overloads where only a subset of the column values are passed in as input parameters.</span></span> <span data-ttu-id="95ae3-254">Gdy oryginalne wartości zostały przypisane do `ProductsOptimisticConcurrencyRow` wypadku `AcceptChanges()` wywoływana jest metoda, która oznacza bieżące wartości DataRow jako oryginalnych wartości, które zostaną użyte w `@original_ColumnName` parametrów w `UPDATE` instrukcji.</span><span class="sxs-lookup"><span data-stu-id="95ae3-254">Once the original values have been assigned to the `ProductsOptimisticConcurrencyRow` instance, the `AcceptChanges()` method is called, which marks the current DataRow values as the original values to be used in the `@original_ColumnName` parameters in the `UPDATE` statement.</span></span> <span data-ttu-id="95ae3-255">Następnie nowe wartości parametrów są przypisane do `ProductsOptimisticConcurrencyRow` i na koniec `Update` metoda jest wywoływana, przekazując klasy DataRow.</span><span class="sxs-lookup"><span data-stu-id="95ae3-255">Next, the new parameter values are assigned to the `ProductsOptimisticConcurrencyRow` and, finally, the `Update` method is invoked, passing in the DataRow.</span></span>

<span data-ttu-id="95ae3-256">Poniższy kod przedstawia `UpdateProduct` przeciążenie, które akceptuje wszystkie dane produktu pól parametrów jako danych wejściowych.</span><span class="sxs-lookup"><span data-stu-id="95ae3-256">The following code shows the `UpdateProduct` overload that accepts all product data fields as input parameters.</span></span> <span data-ttu-id="95ae3-257">Gdy nie są wyświetlane w tym miejscu `ProductsOptimisticConcurrencyBLL` oferowanego w pakiecie do pobrania dla ten samouczek zawiera również klasy `UpdateProduct` przeciążenia, które akceptuje tylko w produkcie nazwa i cena jako parametry wejściowe.</span><span class="sxs-lookup"><span data-stu-id="95ae3-257">While not shown here, the `ProductsOptimisticConcurrencyBLL` class included in the download for this tutorial also contains an `UpdateProduct` overload that accepts just the product's name and price as input parameters.</span></span>


[!code-vb[Main](implementing-optimistic-concurrency-vb/samples/sample7.vb)]

## <a name="step-4-passing-the-original-and-new-values-from-the-aspnet-page-to-the-bll-methods"></a><span data-ttu-id="95ae3-258">Krok 4. Przekazywanie oryginalnego i nowych wartości ze strony programu ASP.NET do metod LOGIKI</span><span class="sxs-lookup"><span data-stu-id="95ae3-258">Step 4: Passing the Original and New Values From the ASP.NET Page to the BLL Methods</span></span>

<span data-ttu-id="95ae3-259">DAL i LOGIKI pełną pozostaje tylko do tworzenia strony ASP.NET, która może korzystać z logiką optymistycznej współbieżności wbudowanej w system.</span><span class="sxs-lookup"><span data-stu-id="95ae3-259">With the DAL and BLL complete, all that remains is to create an ASP.NET page that can utilize the optimistic concurrency logic built in to the system.</span></span> <span data-ttu-id="95ae3-260">W szczególności danych formantu sieci Web (GridView, DetailsView lub FormView) musi Pamiętaj, że jego oryginalnej wartości i kontrolki ObjectDataSource musi przekazać oba zestawy wartości do warstwy logiki biznesowej.</span><span class="sxs-lookup"><span data-stu-id="95ae3-260">Specifically, the data Web control (the GridView, DetailsView, or FormView) must remember its original values and the ObjectDataSource must pass both sets of values to the Business Logic Layer.</span></span> <span data-ttu-id="95ae3-261">Ponadto strona ASP.NET musi być skonfigurowany do poprawnego działania obsługi naruszeń współbieżności.</span><span class="sxs-lookup"><span data-stu-id="95ae3-261">Furthermore, the ASP.NET page must be configured to gracefully handle concurrency violations.</span></span>

<span data-ttu-id="95ae3-262">Zacznij od otwarcia `OptimisticConcurrency.aspx` strony w `EditInsertDelete` folderu i dodaniu GridView do projektanta, ustawiając jego `ID` właściwość `ProductsGrid`.</span><span class="sxs-lookup"><span data-stu-id="95ae3-262">Start by opening the `OptimisticConcurrency.aspx` page in the `EditInsertDelete` folder and adding a GridView to the Designer, setting its `ID` property to `ProductsGrid`.</span></span> <span data-ttu-id="95ae3-263">Z GridView tagu inteligentnego, wybrać opcję utworzenia nowego elementu ObjectDataSource, o nazwie `ProductsOptimisticConcurrencyDataSource`.</span><span class="sxs-lookup"><span data-stu-id="95ae3-263">From the GridView's smart tag, opt to create a new ObjectDataSource named `ProductsOptimisticConcurrencyDataSource`.</span></span> <span data-ttu-id="95ae3-264">Ponieważ chcemy, aby ta ObjectDataSource używać warstwy DAL, która obsługuje optymistycznej współbieżności, należy skonfigurować tak, aby użyć `ProductsOptimisticConcurrencyBLL` obiektu.</span><span class="sxs-lookup"><span data-stu-id="95ae3-264">Since we want this ObjectDataSource to use the DAL that supports optimistic concurrency, configure it to use the `ProductsOptimisticConcurrencyBLL` object.</span></span>


<span data-ttu-id="95ae3-265">[![Mogą używać kontrolki ObjectDataSource obiektu ProductsOptimisticConcurrencyBLL](implementing-optimistic-concurrency-vb/_static/image36.png)](implementing-optimistic-concurrency-vb/_static/image35.png)</span><span class="sxs-lookup"><span data-stu-id="95ae3-265">[![Have the ObjectDataSource Use the ProductsOptimisticConcurrencyBLL Object](implementing-optimistic-concurrency-vb/_static/image36.png)](implementing-optimistic-concurrency-vb/_static/image35.png)</span></span>

<span data-ttu-id="95ae3-266">**Rysunek 13**: Mogą używać kontrolki ObjectDataSource `ProductsOptimisticConcurrencyBLL` obiektu ([kliknij, aby wyświetlić obraz w pełnym rozmiarze](implementing-optimistic-concurrency-vb/_static/image37.png))</span><span class="sxs-lookup"><span data-stu-id="95ae3-266">**Figure 13**: Have the ObjectDataSource Use the `ProductsOptimisticConcurrencyBLL` Object ([Click to view full-size image](implementing-optimistic-concurrency-vb/_static/image37.png))</span></span>


<span data-ttu-id="95ae3-267">Wybierz `GetProducts`, `UpdateProduct`, i `DeleteProduct` metody z listy rozwijanej w kreatorze.</span><span class="sxs-lookup"><span data-stu-id="95ae3-267">Choose the `GetProducts`, `UpdateProduct`, and `DeleteProduct` methods from drop-down lists in the wizard.</span></span> <span data-ttu-id="95ae3-268">W przypadku metody UpdateProduct Użyj przeciążenia, które akceptuje wszystkie pola danych produktu.</span><span class="sxs-lookup"><span data-stu-id="95ae3-268">For the UpdateProduct method, use the overload that accepts all of the product's data fields.</span></span>

## <a name="configuring-the-objectdatasource-controls-properties"></a><span data-ttu-id="95ae3-269">Konfigurowanie właściwości formantu ObjectDataSource</span><span class="sxs-lookup"><span data-stu-id="95ae3-269">Configuring the ObjectDataSource Control's Properties</span></span>

<span data-ttu-id="95ae3-270">Po zakończeniu działania kreatora ObjectDataSource oznaczeniu deklaracyjnym powinien wyglądać następująco:</span><span class="sxs-lookup"><span data-stu-id="95ae3-270">After completing the wizard, the ObjectDataSource's declarative markup should look like the following:</span></span>


[!code-aspx[Main](implementing-optimistic-concurrency-vb/samples/sample8.aspx)]

<span data-ttu-id="95ae3-271">Jak widać, `DeleteParameters` kolekcja zawiera `Parameter` wystąpienia dla każdej z dziesięciu parametrów wejściowych w `ProductsOptimisticConcurrencyBLL` klasy `DeleteProduct` metody.</span><span class="sxs-lookup"><span data-stu-id="95ae3-271">As you can see, the `DeleteParameters` collection contains a `Parameter` instance for each of the ten input parameters in the `ProductsOptimisticConcurrencyBLL` class's `DeleteProduct` method.</span></span> <span data-ttu-id="95ae3-272">Podobnie `UpdateParameters` kolekcja zawiera `Parameter` wystąpienia dla każdego z parametrów wejściowych w `UpdateProduct`.</span><span class="sxs-lookup"><span data-stu-id="95ae3-272">Likewise, the `UpdateParameters` collection contains a `Parameter` instance for each of the input parameters in `UpdateProduct`.</span></span>

<span data-ttu-id="95ae3-273">Dla tych, które zaangażowane modyfikacji danych poprzednich samouczkach usuniemy ObjectDataSource `OldValuesParameterFormatString` właściwość na tym etapie, ponieważ ta właściwość wskazuje, że metoda LOGIKI oczekuje wartości starego (lub oryginalnego) przekazać, a także nowe wartości.</span><span class="sxs-lookup"><span data-stu-id="95ae3-273">For those previous tutorials that involved data modification, we'd remove the ObjectDataSource's `OldValuesParameterFormatString` property at this point, since this property indicates that the BLL method expects the old (or original) values to be passed in as well as the new values.</span></span> <span data-ttu-id="95ae3-274">Ponadto wartość tej właściwości oznacza nazwy parametru wejściowego oryginalnych wartości.</span><span class="sxs-lookup"><span data-stu-id="95ae3-274">Furthermore, this property value indicates the input parameter names for the original values.</span></span> <span data-ttu-id="95ae3-275">Ponieważ firma Microsoft przekazywania w oryginalnych wartości do LOGIKI tak *nie* Usuń tę właściwość.</span><span class="sxs-lookup"><span data-stu-id="95ae3-275">Since we are passing in the original values into the BLL, do *not* remove this property.</span></span>

> [!NOTE]
> <span data-ttu-id="95ae3-276">Wartość `OldValuesParameterFormatString` właściwość musi być mapowane na nazwy parametru wejściowego w LOGIKI, które oczekują oryginalnych wartości.</span><span class="sxs-lookup"><span data-stu-id="95ae3-276">The value of the `OldValuesParameterFormatString` property must map to the input parameter names in the BLL that expect the original values.</span></span> <span data-ttu-id="95ae3-277">Ponieważ firma Microsoft o nazwie te parametry `original_productName`, `original_supplierID`i tak dalej, można pozostawić `OldValuesParameterFormatString` wartości właściwości jako `original_{0}`.</span><span class="sxs-lookup"><span data-stu-id="95ae3-277">Since we named these parameters `original_productName`, `original_supplierID`, and so on, you can leave the `OldValuesParameterFormatString` property value as `original_{0}`.</span></span> <span data-ttu-id="95ae3-278">Jeśli jednak z metodami LOGIKI wejściowych parametrów miały nazwy, jak `old_productName`, `old_supplierID`i tak dalej konieczne zaktualizowanie `OldValuesParameterFormatString` właściwość `old_{0}`.</span><span class="sxs-lookup"><span data-stu-id="95ae3-278">If, however, the BLL methods' input parameters had names like `old_productName`, `old_supplierID`, and so on, you'd need to update the `OldValuesParameterFormatString` property to `old_{0}`.</span></span>


<span data-ttu-id="95ae3-279">Istnieje jeden ustawienie właściwości końcowego musi być dokonywane w kolejności dla elementu ObjectDataSource poprawnie przekazywane oryginalnych wartości do metod LOGIKI.</span><span class="sxs-lookup"><span data-stu-id="95ae3-279">There's one final property setting that needs to be made in order for the ObjectDataSource to correctly pass the original values to the BLL methods.</span></span> <span data-ttu-id="95ae3-280">Zawiera kontrolki ObjectDataSource [właściwość ConflictDetection](https://msdn.microsoft.com/library/system.web.ui.webcontrols.objectdatasource.conflictdetection.aspx) mogą być przypisane do [jedną z dwóch wartości](https://msdn.microsoft.com/library/system.web.ui.conflictoptions.aspx):</span><span class="sxs-lookup"><span data-stu-id="95ae3-280">The ObjectDataSource has a [ConflictDetection property](https://msdn.microsoft.com/library/system.web.ui.webcontrols.objectdatasource.conflictdetection.aspx) that can be assigned to [one of two values](https://msdn.microsoft.com/library/system.web.ui.conflictoptions.aspx):</span></span>

- <span data-ttu-id="95ae3-281">`OverwriteChanges` — wartość domyślną; nie będzie przesyłał oryginalnych wartości do metody LOGIKI oryginalnego parametry wejściowe</span><span class="sxs-lookup"><span data-stu-id="95ae3-281">`OverwriteChanges` - the default value; does not send the original values to the BLL methods' original input parameters</span></span>
- <span data-ttu-id="95ae3-282">`CompareAllValues` — wysłać oryginalnych wartości do metod LOGIKI; Wybierz tę opcję, gdy optymistycznej współbieżności</span><span class="sxs-lookup"><span data-stu-id="95ae3-282">`CompareAllValues` - does send the original values to the BLL methods; choose this option when using optimistic concurrency</span></span>

<span data-ttu-id="95ae3-283">Poświęć chwilę, aby ustawić `ConflictDetection` właściwość `CompareAllValues`.</span><span class="sxs-lookup"><span data-stu-id="95ae3-283">Take a moment to set the `ConflictDetection` property to `CompareAllValues`.</span></span>

## <a name="configuring-the-gridviews-properties-and-fields"></a><span data-ttu-id="95ae3-284">Konfigurowanie właściwości i pola w widoku GridView</span><span class="sxs-lookup"><span data-stu-id="95ae3-284">Configuring the GridView's Properties and Fields</span></span>

<span data-ttu-id="95ae3-285">Za pomocą właściwości ObjectDataSource prawidłowo skonfigurowane skupimy z konfigurowaniem widoku GridView.</span><span class="sxs-lookup"><span data-stu-id="95ae3-285">With the ObjectDataSource's properties properly configured, let's turn our attention to setting up the GridView.</span></span> <span data-ttu-id="95ae3-286">Najpierw ponieważ chcemy, aby GridView do obsługi, edytowania i usuwania, kliknij pozycję Włącz edytowanie i Włącz usuwanie pól wyboru z GridView tagu inteligentnego.</span><span class="sxs-lookup"><span data-stu-id="95ae3-286">First, since we want the GridView to support editing and deleting, click the Enable Editing and Enable Deleting checkboxes from the GridView's smart tag.</span></span> <span data-ttu-id="95ae3-287">Spowoduje to dodanie CommandField którego `ShowEditButton` i `ShowDeleteButton` są ustawione na `true`.</span><span class="sxs-lookup"><span data-stu-id="95ae3-287">This will add a CommandField whose `ShowEditButton` and `ShowDeleteButton` are both set to `true`.</span></span>

<span data-ttu-id="95ae3-288">Podczas wiązania z `ProductsOptimisticConcurrencyDataSource` ObjectDataSource, widoku GridView zawiera pole dla każdego pola danych produktu.</span><span class="sxs-lookup"><span data-stu-id="95ae3-288">When bound to the `ProductsOptimisticConcurrencyDataSource` ObjectDataSource, the GridView contains a field for each of the product's data fields.</span></span> <span data-ttu-id="95ae3-289">Podczas edycji kontrolki GridView wszystko, ale dopuszczalne jest środowisko użytkownika.</span><span class="sxs-lookup"><span data-stu-id="95ae3-289">While such a GridView can be edited, the user experience is anything but acceptable.</span></span> <span data-ttu-id="95ae3-290">`CategoryID` i `SupplierID` BoundFields będą renderowane jako pola tekstowe, użytkownik musi wprowadzić odpowiednią kategorię i dostawcy, jako numery identyfikatorów.</span><span class="sxs-lookup"><span data-stu-id="95ae3-290">The `CategoryID` and `SupplierID` BoundFields will render as TextBoxes, requiring the user to enter the appropriate category and supplier as ID numbers.</span></span> <span data-ttu-id="95ae3-291">Nie będzie żadnych formatowania pól liczbowych i nie kontrolek weryfikacji, aby upewnić się, podano nazwę produktu i cenę jednostkową jednostek w magazynie, jednostki w kolejności, a której kolejność chcesz zmienić wartości poziomu obu odpowiednie wartości numeryczne i są większe niż lub równe od zera.</span><span class="sxs-lookup"><span data-stu-id="95ae3-291">There will be no formatting for the numeric fields and no validation controls to ensure that the product's name has been supplied and that the unit price, units in stock, units on order, and reorder level values are both proper numeric values and are greater than or equal to zero.</span></span>

<span data-ttu-id="95ae3-292">Tak jak Omówiliśmy to w *Dodawanie kontrolek weryfikacji do edycji i wstawiania interfejsy* i *Dostosowywanie interfejsu modyfikacji danych* samouczki i interfejsu użytkownika mogą być dostosowywane przez zastępując BoundFields kontrolek TemplateField.</span><span class="sxs-lookup"><span data-stu-id="95ae3-292">As we discussed in the *Adding Validation Controls to the Editing and Inserting Interfaces* and *Customizing the Data Modification Interface* tutorials, the user interface can be customized by replacing the BoundFields with TemplateFields.</span></span> <span data-ttu-id="95ae3-293">Po modyfikacji tego widoku GridView i jego edycji interfejs w następujący sposób:</span><span class="sxs-lookup"><span data-stu-id="95ae3-293">I've modified this GridView and its editing interface in the following ways:</span></span>

- <span data-ttu-id="95ae3-294">Usunięte `ProductID`, `SupplierName`, i `CategoryName` BoundFields</span><span class="sxs-lookup"><span data-stu-id="95ae3-294">Removed the `ProductID`, `SupplierName`, and `CategoryName` BoundFields</span></span>
- <span data-ttu-id="95ae3-295">Przekonwertowany `ProductName` elementu BoundField do TemplateField i dodana kontrolka RequiredFieldValidation.</span><span class="sxs-lookup"><span data-stu-id="95ae3-295">Converted the `ProductName` BoundField to a TemplateField and added a RequiredFieldValidation control.</span></span>
- <span data-ttu-id="95ae3-296">Przekonwertowany `CategoryID` i `SupplierID` BoundFields do kontrolek TemplateField i dostosowana interfejsu edycji, aby kontrolek DropDownList, a nie pola tekstowe.</span><span class="sxs-lookup"><span data-stu-id="95ae3-296">Converted the `CategoryID` and `SupplierID` BoundFields to TemplateFields, and adjusted the editing interface to use DropDownLists rather than TextBoxes.</span></span> <span data-ttu-id="95ae3-297">W tych kontrolek TemplateField `ItemTemplates`, `CategoryName` i `SupplierName` wyświetlania pól danych.</span><span class="sxs-lookup"><span data-stu-id="95ae3-297">In these TemplateFields' `ItemTemplates`, the `CategoryName` and `SupplierName` data fields are displayed.</span></span>
- <span data-ttu-id="95ae3-298">Przekonwertowany `UnitPrice`, `UnitsInStock`, `UnitsOnOrder`, i `ReorderLevel` BoundFields kontrolek TemplateField i dodano CompareValidator kontrolki.</span><span class="sxs-lookup"><span data-stu-id="95ae3-298">Converted the `UnitPrice`, `UnitsInStock`, `UnitsOnOrder`, and `ReorderLevel` BoundFields to TemplateFields and added CompareValidator controls.</span></span>

<span data-ttu-id="95ae3-299">Ponieważ sposobu wykonywania tych zadań w poprzednich samouczkach mamy już sprawdzane I będzie tylko listy w tym miejscu ostatecznego składni deklaratywnej i pozostaw implementacji rozwiązaniem.</span><span class="sxs-lookup"><span data-stu-id="95ae3-299">Since we've already examined how to accomplish these tasks in previous tutorials, I'll just list the final declarative syntax here and leave the implementation as practice.</span></span>


[!code-aspx[Main](implementing-optimistic-concurrency-vb/samples/sample9.aspx)]

<span data-ttu-id="95ae3-300">Jesteśmy bardzo blisko o w pełni praktyczny przykład.</span><span class="sxs-lookup"><span data-stu-id="95ae3-300">We're very close to having a fully-working example.</span></span> <span data-ttu-id="95ae3-301">Istnieje jednak kilka precyzyjnie, które będą pełzanie się i spowodować, że nas problemów.</span><span class="sxs-lookup"><span data-stu-id="95ae3-301">However, there are a few subtleties that will creep up and cause us problems.</span></span> <span data-ttu-id="95ae3-302">Ponadto wciąż potrzebujemy niektórych interfejs, który powiadamia użytkownika, gdy wystąpiło naruszenie współbieżności.</span><span class="sxs-lookup"><span data-stu-id="95ae3-302">Additionally, we still need some interface that alerts the user when a concurrency violation has occurred.</span></span>

> [!NOTE]
> <span data-ttu-id="95ae3-303">Aby dane formantu sieci Web poprawnie przekazywane oryginalnych wartości do kontrolki ObjectDataSource (które są następnie przekazywane do LOGIKI), koniecznie, GridView `EnableViewState` właściwość jest ustawiona na `true` (ustawienie domyślne).</span><span class="sxs-lookup"><span data-stu-id="95ae3-303">In order for a data Web control to correctly pass the original values to the ObjectDataSource (which are then passed to the BLL), it's vital that the GridView's `EnableViewState` property is set to `true` (the default).</span></span> <span data-ttu-id="95ae3-304">Jeśli wyłączysz stan widoku, oryginalne wartości zostaną utracone na zwrot.</span><span class="sxs-lookup"><span data-stu-id="95ae3-304">If you disable view state, the original values are lost on postback.</span></span>


## <a name="passing-the-correct-original-values-to-the-objectdatasource"></a><span data-ttu-id="95ae3-305">Przekazywanie poprawne oryginalnych wartości do kontrolki ObjectDataSource</span><span class="sxs-lookup"><span data-stu-id="95ae3-305">Passing the Correct Original Values to the ObjectDataSource</span></span>

<span data-ttu-id="95ae3-306">Istnieje kilka problemów ze sposobem, w widoku GridView zostały skonfigurowane.</span><span class="sxs-lookup"><span data-stu-id="95ae3-306">There are a couple of problems with the way the GridView has been configured.</span></span> <span data-ttu-id="95ae3-307">Jeśli ObjectDataSource `ConflictDetection` właściwość jest ustawiona na `CompareAllValues` (podobnie jak nasza jest), gdy ObjectDataSource `Update()` lub `Delete()` metody są wywoływane przez kontrolki GridView (lub DetailsView lub FormView), kontrolki ObjectDataSource próbuje skopiować GridView oryginalnych wartości w jego odpowiedniego `Parameter` wystąpień.</span><span class="sxs-lookup"><span data-stu-id="95ae3-307">If the ObjectDataSource's `ConflictDetection` property is set to `CompareAllValues` (as is ours), when the ObjectDataSource's `Update()` or `Delete()` methods are invoked by the GridView (or DetailsView or FormView), the ObjectDataSource attempts to copy the GridView's original values into its appropriate `Parameter` instances.</span></span> <span data-ttu-id="95ae3-308">Odwołaj się do rysunku 2 dla graficzną reprezentację tego procesu.</span><span class="sxs-lookup"><span data-stu-id="95ae3-308">Refer back to Figure 2 for a graphical representation of this process.</span></span>

<span data-ttu-id="95ae3-309">W szczególności GridView oryginalne wartości są przypisane wartości w instrukcjach dwukierunkowego wiązania danych, w każdym danych jest powiązany z kontrolki GridView.</span><span class="sxs-lookup"><span data-stu-id="95ae3-309">Specifically, the GridView's original values are assigned the values in the two-way databinding statements each time the data is bound to the GridView.</span></span> <span data-ttu-id="95ae3-310">Dlatego jest istotne, że wymagane oryginalnych wartości wszystkich są przechwytywane za pośrednictwem dwukierunkowego wiązania danych i że są one udostępniane w postaci konwertowany.</span><span class="sxs-lookup"><span data-stu-id="95ae3-310">Therefore, it's essential that the required original values all are captured via two-way databinding and that they are provided in a convertible format.</span></span>

<span data-ttu-id="95ae3-311">Aby zobaczyć, dlaczego jest to ważne, Poświęć chwilę, aby odwiedzić naszą stronę w przeglądarce.</span><span class="sxs-lookup"><span data-stu-id="95ae3-311">To see why this is important, take a moment to visit our page in a browser.</span></span> <span data-ttu-id="95ae3-312">Zgodnie z oczekiwaniami, w widoku GridView zawiera listę każdego produktu z przyciskiem edytowania i usuwania w skrajnej lewej kolumnie.</span><span class="sxs-lookup"><span data-stu-id="95ae3-312">As expected, the GridView lists each product with an Edit and Delete button in the leftmost column.</span></span>


<span data-ttu-id="95ae3-313">[![Produkty są wymienione w widoku GridView](implementing-optimistic-concurrency-vb/_static/image39.png)](implementing-optimistic-concurrency-vb/_static/image38.png)</span><span class="sxs-lookup"><span data-stu-id="95ae3-313">[![The Products are Listed in a GridView](implementing-optimistic-concurrency-vb/_static/image39.png)](implementing-optimistic-concurrency-vb/_static/image38.png)</span></span>

<span data-ttu-id="95ae3-314">**Rysunek 14**: Produkty są wymienione w kontrolce GridView ([kliknij, aby wyświetlić obraz w pełnym rozmiarze](implementing-optimistic-concurrency-vb/_static/image40.png))</span><span class="sxs-lookup"><span data-stu-id="95ae3-314">**Figure 14**: The Products are Listed in a GridView ([Click to view full-size image](implementing-optimistic-concurrency-vb/_static/image40.png))</span></span>


<span data-ttu-id="95ae3-315">Jeśli klikniesz przycisk usuwania dla wszystkich produktów `FormatException` zgłaszany.</span><span class="sxs-lookup"><span data-stu-id="95ae3-315">If you click the Delete button for any product, a `FormatException` is thrown.</span></span>


<span data-ttu-id="95ae3-316">[![Podjęto próbę usunięcia wyniki dla dowolnego produktu w wyjątek FormatException](implementing-optimistic-concurrency-vb/_static/image42.png)](implementing-optimistic-concurrency-vb/_static/image41.png)</span><span class="sxs-lookup"><span data-stu-id="95ae3-316">[![Attempting to Delete Any Product Results in a FormatException](implementing-optimistic-concurrency-vb/_static/image42.png)](implementing-optimistic-concurrency-vb/_static/image41.png)</span></span>

<span data-ttu-id="95ae3-317">**Rysunek 15**: Podjęto próbę usunięcia wszystkie wyniki dla produktu w `FormatException` ([kliknij, aby wyświetlić obraz w pełnym rozmiarze](implementing-optimistic-concurrency-vb/_static/image43.png))</span><span class="sxs-lookup"><span data-stu-id="95ae3-317">**Figure 15**: Attempting to Delete Any Product Results in a `FormatException` ([Click to view full-size image](implementing-optimistic-concurrency-vb/_static/image43.png))</span></span>


<span data-ttu-id="95ae3-318">`FormatException` Jest zgłaszane w przypadku kontrolki ObjectDataSource podejmuje próbę odczytu w oryginalnym `UnitPrice` wartość.</span><span class="sxs-lookup"><span data-stu-id="95ae3-318">The `FormatException` is raised when the ObjectDataSource attempts to read in the original `UnitPrice` value.</span></span> <span data-ttu-id="95ae3-319">Ponieważ `ItemTemplate` ma `UnitPrice` w formacie waluty (`<%# Bind("UnitPrice", "{0:C}") %>`), zawiera symbol waluty, takich jak cenie od 19,95 USD.</span><span class="sxs-lookup"><span data-stu-id="95ae3-319">Since the `ItemTemplate` has the `UnitPrice` formatted as a currency (`<%# Bind("UnitPrice", "{0:C}") %>`), it includes a currency symbol, like $19.95.</span></span> <span data-ttu-id="95ae3-320">`FormatException` Wypada kontrolki ObjectDataSource stara się przekonwertować tego ciągu w `decimal`.</span><span class="sxs-lookup"><span data-stu-id="95ae3-320">The `FormatException` occurs as the ObjectDataSource attempts to convert this string into a `decimal`.</span></span> <span data-ttu-id="95ae3-321">Aby obejść ten problem, mamy kilka opcji:</span><span class="sxs-lookup"><span data-stu-id="95ae3-321">To circumvent this problem, we have a number of options:</span></span>

- <span data-ttu-id="95ae3-322">Usuń formatowanie z waluty `ItemTemplate`.</span><span class="sxs-lookup"><span data-stu-id="95ae3-322">Remove the currency formatting from the `ItemTemplate`.</span></span> <span data-ttu-id="95ae3-323">Oznacza to, że zamiast `<%# Bind("UnitPrice", "{0:C}") %>`, po prostu użyć `<%# Bind("UnitPrice") %>`.</span><span class="sxs-lookup"><span data-stu-id="95ae3-323">That is, instead of using `<%# Bind("UnitPrice", "{0:C}") %>`, simply use `<%# Bind("UnitPrice") %>`.</span></span> <span data-ttu-id="95ae3-324">Wadą tego jest, że cena jest już sformatowany.</span><span class="sxs-lookup"><span data-stu-id="95ae3-324">The downside of this is that the price is no longer formatted.</span></span>
- <span data-ttu-id="95ae3-325">Wyświetlanie `UnitPrice` w formacie waluty w `ItemTemplate`, ale `Eval` — słowo kluczowe, w tym celu.</span><span class="sxs-lookup"><span data-stu-id="95ae3-325">Display the `UnitPrice` formatted as a currency in the `ItemTemplate`, but use the `Eval` keyword to accomplish this.</span></span> <span data-ttu-id="95ae3-326">Pamiętamy `Eval` wykonuje jednokierunkowe wiązania danych.</span><span class="sxs-lookup"><span data-stu-id="95ae3-326">Recall that `Eval` performs one-way databinding.</span></span> <span data-ttu-id="95ae3-327">Nadal należy podać `UnitPrice` wartość oryginalne wartości, dlatego nadal należy do instrukcji dwukierunkowego wiązania z danymi w `ItemTemplate`, ale to można umieścić w kontrolce etykiety Web którego `Visible` właściwość jest ustawiona na `false`.</span><span class="sxs-lookup"><span data-stu-id="95ae3-327">We still need to provide the `UnitPrice` value for the original values, so we'll still need a two-way databinding statement in the `ItemTemplate`, but this can be placed in a Label Web control whose `Visible` property is set to `false`.</span></span> <span data-ttu-id="95ae3-328">Moglibyśmy użyć następujące znaczniki ItemTemplate:</span><span class="sxs-lookup"><span data-stu-id="95ae3-328">We could use the following markup in the ItemTemplate:</span></span>


[!code-aspx[Main](implementing-optimistic-concurrency-vb/samples/sample10.aspx)]

- <span data-ttu-id="95ae3-329">Usuń formatowanie z waluty `ItemTemplate`przy użyciu `<%# Bind("UnitPrice") %>`.</span><span class="sxs-lookup"><span data-stu-id="95ae3-329">Remove the currency formatting from the `ItemTemplate`, using `<%# Bind("UnitPrice") %>`.</span></span> <span data-ttu-id="95ae3-330">W widoku GridView `RowDataBound` programu obsługi zdarzeń, programowo dostęp Web etykiety kontroli w ramach którego `UnitPrice` wartość jest wyświetlana i ustaw jego `Text` właściwości do wersji sformatowany.</span><span class="sxs-lookup"><span data-stu-id="95ae3-330">In the GridView's `RowDataBound` event handler, programmatically access the Label Web control within which the `UnitPrice` value is displayed and set its `Text` property to the formatted version.</span></span>
- <span data-ttu-id="95ae3-331">Pozostaw `UnitPrice` sformatowane jako walutę.</span><span class="sxs-lookup"><span data-stu-id="95ae3-331">Leave the `UnitPrice` formatted as a currency.</span></span> <span data-ttu-id="95ae3-332">W widoku GridView `RowDeleting` procedura obsługi zdarzeń, zastąpić nim pierwotny istniejących `UnitPrice` wartość (cenie od 19,95 USD) z usługi za pomocą rzeczywistych wartości dziesiętnej `Decimal.Parse`.</span><span class="sxs-lookup"><span data-stu-id="95ae3-332">In the GridView's `RowDeleting` event handler, replace the existing original `UnitPrice` value ($19.95) with an actual decimal value using `Decimal.Parse`.</span></span> <span data-ttu-id="95ae3-333">Widzieliśmy sposób wykonania coś podobnego na elemencie `RowUpdating` programu obsługi zdarzeń w [ *obsługi LOGIKI i wyjątki DAL na poziomie strony ASP.NET* ](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs.md) samouczka.</span><span class="sxs-lookup"><span data-stu-id="95ae3-333">We saw how to accomplish something similar in the `RowUpdating` event handler in the [*Handling BLL- and DAL-Level Exceptions in an ASP.NET Page*](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs.md) tutorial.</span></span>

<span data-ttu-id="95ae3-334">Mój przykład został wybrany do korzystania z drugiego podejścia formant dodanie ukrytego Web etykiety, którego `Text` właściwość jest dwukierunkowe danymi powiązanymi niesformatowany `UnitPrice` wartość.</span><span class="sxs-lookup"><span data-stu-id="95ae3-334">For my example I chose to go with the second approach, adding a hidden Label Web control whose `Text` property is two-way data bound to the unformatted `UnitPrice` value.</span></span>

<span data-ttu-id="95ae3-335">Po rozwiązaniu tego problemu, spróbuj ponowne kliknięcie przycisku usuwania dla każdego produktu.</span><span class="sxs-lookup"><span data-stu-id="95ae3-335">After solving this problem, try clicking the Delete button for any product again.</span></span> <span data-ttu-id="95ae3-336">Teraz otrzymasz `InvalidOperationException` podczas próby wywołania LOGIKI kontrolki ObjectDataSource `UpdateProduct` metody.</span><span class="sxs-lookup"><span data-stu-id="95ae3-336">This time you'll get an `InvalidOperationException` when the ObjectDataSource attempts to invoke the BLL's `UpdateProduct` method.</span></span>


<span data-ttu-id="95ae3-337">[![Kontrolki ObjectDataSource nie można odnaleźć metody o parametry wejściowe chce wysyłania](implementing-optimistic-concurrency-vb/_static/image45.png)](implementing-optimistic-concurrency-vb/_static/image44.png)</span><span class="sxs-lookup"><span data-stu-id="95ae3-337">[![The ObjectDataSource Cannot Find a Method with the Input Parameters it Wants to Send](implementing-optimistic-concurrency-vb/_static/image45.png)](implementing-optimistic-concurrency-vb/_static/image44.png)</span></span>

<span data-ttu-id="95ae3-338">**Rysunek 16**: Kontrolki ObjectDataSource nie można odnaleźć metody o parametry wejściowe chce wysyłania ([kliknij, aby wyświetlić obraz w pełnym rozmiarze](implementing-optimistic-concurrency-vb/_static/image46.png))</span><span class="sxs-lookup"><span data-stu-id="95ae3-338">**Figure 16**: The ObjectDataSource Cannot Find a Method with the Input Parameters it Wants to Send ([Click to view full-size image](implementing-optimistic-concurrency-vb/_static/image46.png))</span></span>


<span data-ttu-id="95ae3-339">Patrząc komunikat o wyjątku, to oczywiste, że kontrolki ObjectDataSource chce do wywołania LOGIKI `DeleteProduct` metodę, która obejmuje `original_CategoryName` i `original_SupplierName` parametrów wejściowych.</span><span class="sxs-lookup"><span data-stu-id="95ae3-339">Looking at the exception's message, it's clear that the ObjectDataSource wants to invoke a BLL `DeleteProduct` method that includes `original_CategoryName` and `original_SupplierName` input parameters.</span></span> <span data-ttu-id="95ae3-340">Jest to spowodowane `ItemTemplate` pod kątem `CategoryID` i `SupplierID` kontrolek TemplateField aktualnie zawierają instrukcje powiązanie dwukierunkowe `CategoryName` i `SupplierName` pola danych.</span><span class="sxs-lookup"><span data-stu-id="95ae3-340">This is because the `ItemTemplate` s for the `CategoryID` and `SupplierID` TemplateFields currently contain two-way Bind statements with the `CategoryName` and `SupplierName` data fields.</span></span> <span data-ttu-id="95ae3-341">Zamiast tego należy dołączyć `Bind` instrukcje `CategoryID` i `SupplierID` pola danych.</span><span class="sxs-lookup"><span data-stu-id="95ae3-341">Instead, we need to include `Bind` statements with the `CategoryID` and `SupplierID` data fields.</span></span> <span data-ttu-id="95ae3-342">W tym celu Zastąp istniejące instrukcje powiązania z `Eval` instrukcji, a następnie dodaj ukryta etykieta kontrolki, których `Text` właściwości są powiązane z `CategoryID` i `SupplierID` pola danych za pomocą dwukierunkowego wiązania danych, jak pokazano poniżej:</span><span class="sxs-lookup"><span data-stu-id="95ae3-342">To accomplish this, replace the existing Bind statements with `Eval` statements, and then add hidden Label controls whose `Text` properties are bound to the `CategoryID` and `SupplierID` data fields using two-way databinding, as shown below:</span></span>


[!code-aspx[Main](implementing-optimistic-concurrency-vb/samples/sample11.aspx)]

<span data-ttu-id="95ae3-343">Za pomocą tych zmian możemy teraz pomyślnie usuwać i edytować informacje o produkcie!</span><span class="sxs-lookup"><span data-stu-id="95ae3-343">With these changes, we are now able to successfully delete and edit product information!</span></span> <span data-ttu-id="95ae3-344">W kroku 5 omówimy sposób weryfikacji wykrycia naruszenia współbieżności.</span><span class="sxs-lookup"><span data-stu-id="95ae3-344">In Step 5 we'll look at how to verify that concurrency violations are being detected.</span></span> <span data-ttu-id="95ae3-345">Ale teraz, po kilku minutach aktualizacji i usuwania rekordów kilka, aby upewnić się, że aktualizowanie i usuwanie dla pojedynczego użytkownika działa zgodnie z oczekiwaniami.</span><span class="sxs-lookup"><span data-stu-id="95ae3-345">But for now, take a few minutes to try updating and deleting a few records to ensure that updating and deleting for a single user works as expected.</span></span>

## <a name="step-5-testing-the-optimistic-concurrency-support"></a><span data-ttu-id="95ae3-346">Krok 5. Obsługa optymistycznej współbieżności testów</span><span class="sxs-lookup"><span data-stu-id="95ae3-346">Step 5: Testing the Optimistic Concurrency Support</span></span>

<span data-ttu-id="95ae3-347">Aby sprawdzić, czy ich naruszenia współbieżności wykryte (zamiast wynikowe dane skutkować nieświadomym zastąpieniem), należy otworzyć dwa okna przeglądarki do tej strony.</span><span class="sxs-lookup"><span data-stu-id="95ae3-347">In order to verify that concurrency violations are being detected (rather than resulting in data being blindly overwritten), we need to open two browser windows to this page.</span></span> <span data-ttu-id="95ae3-348">W obu przypadkach przeglądarki kliknij przycisk Edytuj, aby Chai.</span><span class="sxs-lookup"><span data-stu-id="95ae3-348">In both browser instances, click on the Edit button for Chai.</span></span> <span data-ttu-id="95ae3-349">Następnie tylko w jednej z przeglądarki, Zmień nazwę na "Chai herbaty" i kliknij przycisk Aktualizuj.</span><span class="sxs-lookup"><span data-stu-id="95ae3-349">Then, in just one of the browsers, change the name to "Chai Tea" and click Update.</span></span> <span data-ttu-id="95ae3-350">Aktualizacja powinna powiedzie się i przywrócić stan wstępnie edycji, za pomocą "Chai herbaty" nową nazwę produktu widoku GridView.</span><span class="sxs-lookup"><span data-stu-id="95ae3-350">The update should succeed and return the GridView to its pre-editing state, with "Chai Tea" as the new product name.</span></span>

<span data-ttu-id="95ae3-351">W innych okien wystąpieniu przeglądarki jednak nazwa produktu TextBox nadal będzie widoczny "Chai".</span><span class="sxs-lookup"><span data-stu-id="95ae3-351">In the other browser window instance, however, the product name TextBox still shows "Chai".</span></span> <span data-ttu-id="95ae3-352">W tym drugim okno przeglądarki, należy zaktualizować `UnitPrice` do `25.00`.</span><span class="sxs-lookup"><span data-stu-id="95ae3-352">In this second browser window, update the `UnitPrice` to `25.00`.</span></span> <span data-ttu-id="95ae3-353">Bez obsługi optymistycznej współbieżności klikając polecenie update w drugim wystąpieniu przeglądarki zmieniłby się nazwa produktu do "Chai", a tym samym zastępowanie zmian wprowadzonych przez pierwsze wystąpienie przeglądarki.</span><span class="sxs-lookup"><span data-stu-id="95ae3-353">Without optimistic concurrency support, clicking update in the second browser instance would change the product name back to "Chai", thereby overwriting the changes made by the first browser instance.</span></span> <span data-ttu-id="95ae3-354">Za pomocą zatrudnionych optymistycznej współbieżności, jednak, klikając przycisk Aktualizuj w drugim wystąpieniu przeglądarki skutkuje [DBConcurrencyException](https://msdn.microsoft.com/library/system.data.dbconcurrencyexception.aspx).</span><span class="sxs-lookup"><span data-stu-id="95ae3-354">With optimistic concurrency employed, however, clicking the Update button in the second browser instance results in a [DBConcurrencyException](https://msdn.microsoft.com/library/system.data.dbconcurrencyexception.aspx).</span></span>


<span data-ttu-id="95ae3-355">[![Po wykryciu naruszenia współbieżności zgłaszany DBConcurrencyException](implementing-optimistic-concurrency-vb/_static/image48.png)](implementing-optimistic-concurrency-vb/_static/image47.png)</span><span class="sxs-lookup"><span data-stu-id="95ae3-355">[![When a Concurrency Violation is Detected, a DBConcurrencyException is Thrown](implementing-optimistic-concurrency-vb/_static/image48.png)](implementing-optimistic-concurrency-vb/_static/image47.png)</span></span>

<span data-ttu-id="95ae3-356">**Rysunek 17**: Po wykryciu naruszenia współbieżności `DBConcurrencyException` zgłaszany ([kliknij, aby wyświetlić obraz w pełnym rozmiarze](implementing-optimistic-concurrency-vb/_static/image49.png))</span><span class="sxs-lookup"><span data-stu-id="95ae3-356">**Figure 17**: When a Concurrency Violation is Detected, a `DBConcurrencyException` is Thrown ([Click to view full-size image](implementing-optimistic-concurrency-vb/_static/image49.png))</span></span>


<span data-ttu-id="95ae3-357">`DBConcurrencyException` Tylko jest generowany, gdy wzorzec aktualizacji wsadowych DAL jest wykorzystywany.</span><span class="sxs-lookup"><span data-stu-id="95ae3-357">The `DBConcurrencyException` is only thrown when the DAL's batch update pattern is utilized.</span></span> <span data-ttu-id="95ae3-358">Wzorzec bezpośrednie bazy danych nie zgłaszała wyjątek, tylko wskazuje, że żadne wiersze nie zostały zainfekowane.</span><span class="sxs-lookup"><span data-stu-id="95ae3-358">The DB direct pattern does not raise an exception, it merely indicates that no rows were affected.</span></span> <span data-ttu-id="95ae3-359">Na przykład zwraca GridView oba wystąpienia przeglądarki do stanu wstępnie edycji.</span><span class="sxs-lookup"><span data-stu-id="95ae3-359">To illustrate this, return both browser instances' GridView to their pre-editing state.</span></span> <span data-ttu-id="95ae3-360">Następnie w pierwszym wystąpieniu przeglądarki, kliknij przycisk Edytuj i zmienić nazwę produktu z "Chai herbaty" do "Chai" i kliknij przycisk Aktualizuj.</span><span class="sxs-lookup"><span data-stu-id="95ae3-360">Next, in the first browser instance, click the Edit button and change the product name from "Chai Tea" back to "Chai" and click Update.</span></span> <span data-ttu-id="95ae3-361">W drugim oknie przeglądarki kliknij przycisk Usuń, aby Chai.</span><span class="sxs-lookup"><span data-stu-id="95ae3-361">In the second browser window, click the Delete button for Chai.</span></span>

<span data-ttu-id="95ae3-362">Po kliknięciu Delete, strony publikuje Wstecz, widoku GridView wywołuje ObjectDataSource `Delete()` metoda i kontrolki ObjectDataSource wywoła `ProductsOptimisticConcurrencyBLL` klasy `DeleteProduct` jest metoda wzdłuż oryginalnych wartości.</span><span class="sxs-lookup"><span data-stu-id="95ae3-362">Upon clicking Delete, the page posts back, the GridView invokes the ObjectDataSource's `Delete()` method, and the ObjectDataSource calls down into the `ProductsOptimisticConcurrencyBLL` class's `DeleteProduct` method, passing along the original values.</span></span> <span data-ttu-id="95ae3-363">Oryginalny `ProductName` wartość dla drugiego wystąpienia przeglądarki jest "Herbaty Chai", który jest niezgodny z bieżącym `ProductName` wartość w bazie danych.</span><span class="sxs-lookup"><span data-stu-id="95ae3-363">The original `ProductName` value for the second browser instance is "Chai Tea", which doesn't match up with the current `ProductName` value in the database.</span></span> <span data-ttu-id="95ae3-364">W związku z tym `DELETE` oświadczenie wydane w bazie danych wpływa na zero wierszy, ponieważ nie ma rekordów w bazie danych, `WHERE` spełnia klauzuli.</span><span class="sxs-lookup"><span data-stu-id="95ae3-364">Therefore the `DELETE` statement issued to the database affects zero rows since there's no record in the database that the `WHERE` clause satisfies.</span></span> <span data-ttu-id="95ae3-365">`DeleteProduct` Metoda zwraca `false` i ObjectDataSource danych jest odbitych do kontrolki GridView.</span><span class="sxs-lookup"><span data-stu-id="95ae3-365">The `DeleteProduct` method returns `false` and the ObjectDataSource's data is rebound to the GridView.</span></span>

<span data-ttu-id="95ae3-366">Z perspektywy użytkownika końcowego kliknięcie na przycisk usuwania dla herbaty Chai w drugim oknie przeglądarki spowodowane ekranu, aby flash oraz od powracające, produkt jest nadal istnieje, mimo że teraz jest ona wyświetlana jako "Chai" (zmiana nazwy produktu przez pierwsze przeglądarki wystąpienie).</span><span class="sxs-lookup"><span data-stu-id="95ae3-366">From the end user's perspective, clicking on the Delete button for Chai Tea in the second browser window caused the screen to flash and, upon coming back, the product is still there, although now it's listed as "Chai" (the product name change made by the first browser instance).</span></span> <span data-ttu-id="95ae3-367">Jeśli użytkownik kliknie przycisk Usuń ponownie, usuwania powiedzie się, jak oryginalny widoku GridView `ProductName` wartość ("Chai") teraz dopasowania z wartością w bazie danych.</span><span class="sxs-lookup"><span data-stu-id="95ae3-367">If the user clicks the Delete button again, the Delete will succeed, as the GridView's original `ProductName` value ("Chai") now matches up with the value in the database.</span></span>

<span data-ttu-id="95ae3-368">W obu przypadkach środowisko użytkownika jest idealne rozwiązanie.</span><span class="sxs-lookup"><span data-stu-id="95ae3-368">In both of these cases, the user experience is far from ideal.</span></span> <span data-ttu-id="95ae3-369">Wyraźnie nie chcemy pokazać użytkownikowi szczegóły nitty-gritty `DBConcurrencyException` wyjątek podczas używania wzorca aktualizacji usługi batch.</span><span class="sxs-lookup"><span data-stu-id="95ae3-369">We clearly don't want to show the user the nitty-gritty details of the `DBConcurrencyException` exception when using the batch update pattern.</span></span> <span data-ttu-id="95ae3-370">I zachowanie, gdy za pomocą wzorca bezpośrednie bazy danych jest nieco mylące jako polecenie użytkowników nie powiodło się, ale nie było żadnych dokładnie określić dlaczego.</span><span class="sxs-lookup"><span data-stu-id="95ae3-370">And the behavior when using the DB direct pattern is somewhat confusing as the users command failed, but there was no precise indication of why.</span></span>

<span data-ttu-id="95ae3-371">Aby rozwiązać te dwa problemy, możemy utworzyć formantów etykiet w sieci Web, na stronie, zapewniające wyjaśnienie, dlaczego aktualizacji lub usuwania nie powiodła się.</span><span class="sxs-lookup"><span data-stu-id="95ae3-371">To remedy these two issues, we can create Label Web controls on the page that provide an explanation to why an update or delete failed.</span></span> <span data-ttu-id="95ae3-372">Wzorzec aktualizacji usługi batch, określimy, czy `DBConcurrencyException` Wystąpił wyjątek w obsłudze zdarzeń po poziom GridView wyświetlania etykiety ostrzeżenie, zgodnie z potrzebami.</span><span class="sxs-lookup"><span data-stu-id="95ae3-372">For the batch update pattern, we can determine whether or not a `DBConcurrencyException` exception occurred in the GridView's post-level event handler, displaying the warning label as needed.</span></span> <span data-ttu-id="95ae3-373">Metody bezpośredniej bazy danych, firma Microsoft można sprawdzić wartość zwracaną metody LOGIKI (czyli `true` Jeśli miała wpływu na jeden wiersz, `false` inaczej) i wyświetlić komunikat informacyjny, zgodnie z potrzebami.</span><span class="sxs-lookup"><span data-stu-id="95ae3-373">For the DB direct method, we can examine the return value of the BLL method (which is `true` if one row was affected, `false` otherwise) and display an informational message as needed.</span></span>

## <a name="step-6-adding-informational-messages-and-displaying-them-in-the-face-of-a-concurrency-violation"></a><span data-ttu-id="95ae3-374">Krok 6. Dodawanie komunikatów informacyjnych i wyświetlania ich w przypadku naruszenia współbieżności</span><span class="sxs-lookup"><span data-stu-id="95ae3-374">Step 6: Adding Informational Messages and Displaying Them in the Face of a Concurrency Violation</span></span>

<span data-ttu-id="95ae3-375">W przypadku naruszenia współbieżności działanie, wystawiane jest zależna od czy DAL aktualizacji usługi batch lub wzorzec bezpośrednie DB użyto.</span><span class="sxs-lookup"><span data-stu-id="95ae3-375">When a concurrency violation occurs, the behavior exhibited depends on whether the DAL's batch update or DB direct pattern was used.</span></span> <span data-ttu-id="95ae3-376">Nasz samouczek korzysta z obu wzorców, za pomocą wzorca aktualizacji usługi batch używanych na potrzeby wzorzec bezpośrednie bazy danych używane do usuwania i aktualizowania.</span><span class="sxs-lookup"><span data-stu-id="95ae3-376">Our tutorial uses both patterns, with the batch update pattern being used for updating and the DB direct pattern used for deleting.</span></span> <span data-ttu-id="95ae3-377">Aby rozpocząć pracę, możemy dodać dwie kontrolki etykiety w sieci Web do strony, która wyjaśnia, czy naruszenie współbieżności podczas próby usunięcia lub aktualizacji danych.</span><span class="sxs-lookup"><span data-stu-id="95ae3-377">To get started, let's add two Label Web controls to our page that explain that a concurrency violation occurred when attempting to delete or update data.</span></span> <span data-ttu-id="95ae3-378">Ustaw formant etykiety `Visible` i `EnableViewState` właściwości w celu `false`; spowoduje ich ukryte na każdym odwiedź stronę z wyjątkiem tych określonej strony odwiedza miejsce ich `Visible` programowo ustawiono właściwość `true`.</span><span class="sxs-lookup"><span data-stu-id="95ae3-378">Set the Label control's `Visible` and `EnableViewState` properties to `false`; this will cause them to be hidden on each page visit except for those particular page visits where their `Visible` property is programmatically set to `true`.</span></span>


[!code-aspx[Main](implementing-optimistic-concurrency-vb/samples/sample12.aspx)]

<span data-ttu-id="95ae3-379">Oprócz ustawienia ich `Visible`, `EnabledViewState`, i `Text` właściwości, czy też ustawiono `CssClass` właściwości `Warning`, co powoduje, że etykieta użytkownika będzie wyświetlana w dużych, czerwony, kursywy, pogrubioną czcionką.</span><span class="sxs-lookup"><span data-stu-id="95ae3-379">In addition to setting their `Visible`, `EnabledViewState`, and `Text` properties, I've also set the `CssClass` property to `Warning`, which causes the Label's to be displayed in a large, red, italic, bold font.</span></span> <span data-ttu-id="95ae3-380">Ta CSS `Warning` klasy została zdefiniowana i dodane do Styles.css w *badanie zdarzeń skojarzonych z Wstawianie, aktualizowanie i usuwanie* samouczka.</span><span class="sxs-lookup"><span data-stu-id="95ae3-380">This CSS `Warning` class was defined and added to Styles.css back in the *Examining the Events Associated with Inserting, Updating, and Deleting* tutorial.</span></span>

<span data-ttu-id="95ae3-381">Po dodaniu tych etykiet, Projektant w programie Visual Studio powinien wyglądać podobnie jak rysunek 18.</span><span class="sxs-lookup"><span data-stu-id="95ae3-381">After adding these Labels, the Designer in Visual Studio should look similar to Figure 18.</span></span>


<span data-ttu-id="95ae3-382">[![Dwie kontrolki etykiety zostały dodane do strony](implementing-optimistic-concurrency-vb/_static/image51.png)](implementing-optimistic-concurrency-vb/_static/image50.png)</span><span class="sxs-lookup"><span data-stu-id="95ae3-382">[![Two Label Controls Have Been Added to the Page](implementing-optimistic-concurrency-vb/_static/image51.png)](implementing-optimistic-concurrency-vb/_static/image50.png)</span></span>

<span data-ttu-id="95ae3-383">**Rysunek 18**: Dwie etykiety formantów zostały dodane do strony ([kliknij, aby wyświetlić obraz w pełnym rozmiarze](implementing-optimistic-concurrency-vb/_static/image52.png))</span><span class="sxs-lookup"><span data-stu-id="95ae3-383">**Figure 18**: Two Label Controls Have Been Added to the Page ([Click to view full-size image](implementing-optimistic-concurrency-vb/_static/image52.png))</span></span>


<span data-ttu-id="95ae3-384">Z tych formantów etykiet w sieci Web w miejscu, jesteśmy gotowi do sprawdzenia, jak ustalić, kiedy współbieżności nastąpiło naruszenie, jaką punktu odpowiednią etykietę `Visible` właściwość może być ustawiona na `true`, wyświetlając komunikat informacyjny.</span><span class="sxs-lookup"><span data-stu-id="95ae3-384">With these Label Web controls in place, we're ready to examine how to determine when a concurrency violation has occurred, at which point the appropriate Label's `Visible` property can be set to `true`, displaying the informational message.</span></span>

## <a name="handling-concurrency-violations-when-updating"></a><span data-ttu-id="95ae3-385">Obsługa współbieżności naruszeń podczas aktualizacji</span><span class="sxs-lookup"><span data-stu-id="95ae3-385">Handling Concurrency Violations When Updating</span></span>

<span data-ttu-id="95ae3-386">Najpierw Spójrzmy na sposób obsługi naruszeń współbieżności, korzystając z wzorca aktualizacji usługi batch.</span><span class="sxs-lookup"><span data-stu-id="95ae3-386">Let's first look at how to handle concurrency violations when using the batch update pattern.</span></span> <span data-ttu-id="95ae3-387">Od czasu takiego naruszenia, za pomocą usługi batch aktualizacji Przyczyna wzorzec `DBConcurrencyException` zgłoszenie wyjątku, należy dodać kod do strony ASP.NET, aby określić, czy `DBConcurrencyException` Wystąpił wyjątek podczas procesu aktualizacji.</span><span class="sxs-lookup"><span data-stu-id="95ae3-387">Since such violations with the batch update pattern cause a `DBConcurrencyException` exception to be thrown, we need to add code to our ASP.NET page to determine whether a `DBConcurrencyException` exception occurred during the update process.</span></span> <span data-ttu-id="95ae3-388">Jeśli tak, powinien zostać wyświetlony komunikat wyjaśniający użytkownika, ich zmiany nie zostały zapisane, ponieważ ma zmodyfikowany przez innego użytkownika te same dane między podczas ich uruchamiania, edytowania rekordu i kliknięcie przycisku aktualizacji.</span><span class="sxs-lookup"><span data-stu-id="95ae3-388">If so, we should display a message to the user explaining that their changes were not saved because another user had modified the same data between when they started editing the record and when they clicked the Update button.</span></span>

<span data-ttu-id="95ae3-389">Jak widzieliśmy w *obsługi LOGIKI i wyjątki DAL na poziomie strony ASP.NET* samouczek takie wyjątki mogą być wykryte i pomijane w procedurze obsługi zdarzeń po poziomu danych kontrolki sieci Web.</span><span class="sxs-lookup"><span data-stu-id="95ae3-389">As we saw in the *Handling BLL- and DAL-Level Exceptions in an ASP.NET Page* tutorial, such exceptions can be detected and suppressed in the data Web control's post-level event handlers.</span></span> <span data-ttu-id="95ae3-390">W związku z tym, należy utworzyć procedurę obsługi zdarzeń dla GridView `RowUpdated` zdarzenia, które sprawdza, czy `DBConcurrencyException` został zgłoszony wyjątek.</span><span class="sxs-lookup"><span data-stu-id="95ae3-390">Therefore, we need to create an event handler for the GridView's `RowUpdated` event that checks if a `DBConcurrencyException` exception has been thrown.</span></span> <span data-ttu-id="95ae3-391">Ta procedura obsługi zdarzeń jest przekazywany odwołanie do każdego wyjątku, który został zgłoszony podczas procesu aktualizacji, jak pokazano w poniższym kodzie procedury obsługi zdarzeń:</span><span class="sxs-lookup"><span data-stu-id="95ae3-391">This event handler is passed a reference to any exception that was raised during the updating process, as shown in the event handler code below:</span></span>


[!code-vb[Main](implementing-optimistic-concurrency-vb/samples/sample13.vb)]

<span data-ttu-id="95ae3-392">Face z `DBConcurrencyException` wyjątku, ta procedura obsługi zdarzeń wyświetla `UpdateConflictMessage` kontrolka etykiety i wskazuje, czy wyjątek został obsłużony.</span><span class="sxs-lookup"><span data-stu-id="95ae3-392">In the face of a `DBConcurrencyException` exception, this event handler displays the `UpdateConflictMessage` Label control and indicates that the exception has been handled.</span></span> <span data-ttu-id="95ae3-393">Przy użyciu tego kodu w miejscu po Naruszenie współbieżności występuje podczas aktualizowania rekordu, zmiany wprowadzone przez użytkownika zostaną utracone, ponieważ będzie zastąpione modyfikacji przez innego użytkownika w tym samym czasie.</span><span class="sxs-lookup"><span data-stu-id="95ae3-393">With this code in place, when a concurrency violation occurs when updating a record, the user's changes are lost, since they would have overwritten another user's modifications at the same time.</span></span> <span data-ttu-id="95ae3-394">W szczególności widoku GridView jest zwracany stan wstępnie edycji i powiązane z bieżącym danych w bazie danych.</span><span class="sxs-lookup"><span data-stu-id="95ae3-394">In particular, the GridView is returned to its pre-editing state and bound to the current database data.</span></span> <span data-ttu-id="95ae3-395">Spowoduje to zaktualizowanie wiersza w widoku GridView zmian przez innych użytkowników, które były wcześniej nie są widoczne.</span><span class="sxs-lookup"><span data-stu-id="95ae3-395">This will update the GridView row with the other user's changes, which were previously not visible.</span></span> <span data-ttu-id="95ae3-396">Ponadto `UpdateConflictMessage` formant etykiety wyjaśnią użytkownikowi, co stało.</span><span class="sxs-lookup"><span data-stu-id="95ae3-396">Additionally, the `UpdateConflictMessage` Label control will explain to the user what just happened.</span></span> <span data-ttu-id="95ae3-397">Następująca sekwencja zdarzeń została szczegółowo opisana w rysunek 19.</span><span class="sxs-lookup"><span data-stu-id="95ae3-397">This sequence of events is detailed in Figure 19.</span></span>


<span data-ttu-id="95ae3-398">[![Użytkownik s aktualizacje zostaną utracone w twarz Naruszenie współbieżności](implementing-optimistic-concurrency-vb/_static/image54.png)](implementing-optimistic-concurrency-vb/_static/image53.png)</span><span class="sxs-lookup"><span data-stu-id="95ae3-398">[![A User s Updates are Lost in the Face of a Concurrency Violation](implementing-optimistic-concurrency-vb/_static/image54.png)](implementing-optimistic-concurrency-vb/_static/image53.png)</span></span>

<span data-ttu-id="95ae3-399">**Rysunek 19**: Użytkownik s aktualizacje zostaną utracone w twarz Naruszenie współbieżności ([kliknij, aby wyświetlić obraz w pełnym rozmiarze](implementing-optimistic-concurrency-vb/_static/image55.png))</span><span class="sxs-lookup"><span data-stu-id="95ae3-399">**Figure 19**: A User s Updates are Lost in the Face of a Concurrency Violation ([Click to view full-size image](implementing-optimistic-concurrency-vb/_static/image55.png))</span></span>


> [!NOTE]
> <span data-ttu-id="95ae3-400">Alternatywnie zamiast zwracać widoku GridView wstępnie edycji stanu, można pozostawimy widoku GridView w stanie edycji, ustawiając `KeepInEditMode` właściwość przekazany do `GridViewUpdatedEventArgs` obiektu na wartość true.</span><span class="sxs-lookup"><span data-stu-id="95ae3-400">Alternatively, rather than returning the GridView to the pre-editing state, we could leave the GridView in its editing state by setting the `KeepInEditMode` property of the passed-in `GridViewUpdatedEventArgs` object to true.</span></span> <span data-ttu-id="95ae3-401">W przypadku zastosowania tego podejścia jednak mieć pewność ponownie powiązać dane do kontrolki GridView (przez wywołanie jego `DataBind()` metoda) tak, aby wartości przez innego użytkownika są ładowane do interfejsu edycji.</span><span class="sxs-lookup"><span data-stu-id="95ae3-401">If you take this approach, however, be certain to rebind the data to the GridView (by invoking its `DataBind()` method) so that the other user's values are loaded into the editing interface.</span></span> <span data-ttu-id="95ae3-402">Kod można pobrać za pomocą tego samouczka ma następujące dwa wiersze kodu w `RowUpdated` komentarzami programu obsługi zdarzeń; po prostu Usuń komentarz następujące wiersze kodu, widoku GridView po Naruszenie współbieżności pozostać w trybie edycji.</span><span class="sxs-lookup"><span data-stu-id="95ae3-402">The code available for download with this tutorial has these two lines of code in the `RowUpdated` event handler commented out; simply uncomment these lines of code to have the GridView remain in edit mode after a concurrency violation.</span></span>


## <a name="responding-to-concurrency-violations-when-deleting"></a><span data-ttu-id="95ae3-403">Reagowanie na naruszenie współbieżności, podczas usuwania</span><span class="sxs-lookup"><span data-stu-id="95ae3-403">Responding to Concurrency Violations When Deleting</span></span>

<span data-ttu-id="95ae3-404">Za pomocą wzorca bezpośrednie bazy danych nie istnieje żaden wyjątek zgłaszany w przypadku naruszenia współbieżności.</span><span class="sxs-lookup"><span data-stu-id="95ae3-404">With the DB direct pattern, there is no exception raised in the face of a concurrency violation.</span></span> <span data-ttu-id="95ae3-405">Zamiast tego instrukcja bazy danych po prostu ma wpływ na żadne rekordy, jako klauzuli WHERE nie jest zgodny z dowolnego rekordu.</span><span class="sxs-lookup"><span data-stu-id="95ae3-405">Instead, the database statement simply affects no records, as the WHERE clause does not match with any record.</span></span> <span data-ttu-id="95ae3-406">Wszystkie metody modyfikacji danych utworzonych w LOGIKI zostały zaprojektowane tak, aby zwracają wartość logiczną wskazującą, czy problem dotyczy dokładnie jeden rekord.</span><span class="sxs-lookup"><span data-stu-id="95ae3-406">All of the data modification methods created in the BLL have been designed such that they return a Boolean value indicating whether or not they affected precisely one record.</span></span> <span data-ttu-id="95ae3-407">W związku z tym, aby ustalić, czy naruszenie współbieżności wystąpił podczas usuwania rekordu, firma Microsoft można sprawdzić wartość zwracaną LOGIKI `DeleteProduct` metody.</span><span class="sxs-lookup"><span data-stu-id="95ae3-407">Therefore, to determine if a concurrency violation occurred when deleting a record, we can examine the return value of the BLL's `DeleteProduct` method.</span></span>

<span data-ttu-id="95ae3-408">Wartość zwracana dla metody LOGIKI można zbadać w obsłudze zdarzeń po poziomu ObjectDataSource za pośrednictwem `ReturnValue` właściwość `ObjectDataSourceStatusEventArgs` obiekt przekazany do procedury obsługi zdarzeń.</span><span class="sxs-lookup"><span data-stu-id="95ae3-408">The return value for a BLL method can be examined in the ObjectDataSource's post-level event handlers through the `ReturnValue` property of the `ObjectDataSourceStatusEventArgs` object passed into the event handler.</span></span> <span data-ttu-id="95ae3-409">Ponieważ jesteśmy zainteresowani określająca wartość zwrotną z elementu `DeleteProduct` metody, należy utworzyć procedurę obsługi zdarzeń dla elementu ObjectDataSource `Deleted` zdarzeń.</span><span class="sxs-lookup"><span data-stu-id="95ae3-409">Since we are interested in determining the return value from the `DeleteProduct` method, we need to create an event handler for the ObjectDataSource's `Deleted` event.</span></span> <span data-ttu-id="95ae3-410">`ReturnValue` Właściwość jest typu `object` i może być `null` Jeśli wystąpił wyjątek i metoda zostało przerwane przed jego może zwracać wartości.</span><span class="sxs-lookup"><span data-stu-id="95ae3-410">The `ReturnValue` property is of type `object` and can be `null` if an exception was raised and the method was interrupted before it could return a value.</span></span> <span data-ttu-id="95ae3-411">W związku z tym, możemy najpierw upewnij się, że `ReturnValue` właściwość nie jest `null` i jest wartością logiczną.</span><span class="sxs-lookup"><span data-stu-id="95ae3-411">Therefore, we should first ensure that the `ReturnValue` property is not `null` and is a Boolean value.</span></span> <span data-ttu-id="95ae3-412">Zakładając, że przekazuje ten test, pokazujemy `DeleteConflictMessage` kontrolka etykiety, jeśli `ReturnValue` jest `false`.</span><span class="sxs-lookup"><span data-stu-id="95ae3-412">Assuming this check passes, we show the `DeleteConflictMessage` Label control if the `ReturnValue` is `false`.</span></span> <span data-ttu-id="95ae3-413">Można to osiągnąć, używając następującego kodu:</span><span class="sxs-lookup"><span data-stu-id="95ae3-413">This can be accomplished by using the following code:</span></span>


[!code-vb[Main](implementing-optimistic-concurrency-vb/samples/sample14.vb)]

<span data-ttu-id="95ae3-414">W przypadku naruszenia współbieżności żądanie usunięcia użytkownika zostało anulowane.</span><span class="sxs-lookup"><span data-stu-id="95ae3-414">In the face of a concurrency violation, the user's delete request is canceled.</span></span> <span data-ttu-id="95ae3-415">Są odświeżane widoku GridView wskazuje, że zmiany, które wystąpiły dla tego rekordu w czasie między użytkownika załadować stronę i po jego kliknięciu przycisk Usuń.</span><span class="sxs-lookup"><span data-stu-id="95ae3-415">The GridView is refreshed, showing the changes that occurred for that record between the time the user loaded the page and when he clicked the Delete button.</span></span> <span data-ttu-id="95ae3-416">Jeśli takie naruszenie wynika, `DeleteConflictMessage` jest wyświetlana etykieta wyjaśniający, co właśnie wydarzyło się (zobacz rysunek 20).</span><span class="sxs-lookup"><span data-stu-id="95ae3-416">When such a violation transpires, the `DeleteConflictMessage` Label is shown, explaining what just happened (see Figure 20).</span></span>


<span data-ttu-id="95ae3-417">[![S usuwania użytkownika zostało anulowane w przypadku naruszenia współbieżności](implementing-optimistic-concurrency-vb/_static/image57.png)](implementing-optimistic-concurrency-vb/_static/image56.png)</span><span class="sxs-lookup"><span data-stu-id="95ae3-417">[![A User s Delete is Canceled in the Face of a Concurrency Violation](implementing-optimistic-concurrency-vb/_static/image57.png)](implementing-optimistic-concurrency-vb/_static/image56.png)</span></span>

<span data-ttu-id="95ae3-418">**Rysunek 20**: S usuwania użytkownika zostało anulowane w przypadku naruszenia współbieżności ([kliknij, aby wyświetlić obraz w pełnym rozmiarze](implementing-optimistic-concurrency-vb/_static/image58.png))</span><span class="sxs-lookup"><span data-stu-id="95ae3-418">**Figure 20**: A User s Delete is Canceled in the Face of a Concurrency Violation ([Click to view full-size image](implementing-optimistic-concurrency-vb/_static/image58.png))</span></span>


## <a name="summary"></a><span data-ttu-id="95ae3-419">Podsumowanie</span><span class="sxs-lookup"><span data-stu-id="95ae3-419">Summary</span></span>

<span data-ttu-id="95ae3-420">Możliwości naruszeń współbieżności istnieje w każdej aplikacji, która zezwala na wiele równoczesnych użytkowników, aby aktualizować lub usuwać dane.</span><span class="sxs-lookup"><span data-stu-id="95ae3-420">Opportunities for concurrency violations exist in every application that allows multiple, concurrent users to update or delete data.</span></span> <span data-ttu-id="95ae3-421">Jeśli takie naruszenie nie uwzględnia dla dwóch użytkowników jednocześnie aktualizacji tych samych danych, kto pobiera ostatniego zapisu "wins", zastępując to drugi użytkownik zmieni się zmiany.</span><span class="sxs-lookup"><span data-stu-id="95ae3-421">If such violations are not accounted for, when two users simultaneously update the same data whoever gets in the last write "wins," overwriting the other user's changes changes.</span></span> <span data-ttu-id="95ae3-422">Alternatywnie deweloperzy mogą zaimplementować albo kontroli współbieżności optymistycznego lub pesymistycznego.</span><span class="sxs-lookup"><span data-stu-id="95ae3-422">Alternatively, developers can implement either optimistic or pessimistic concurrency control.</span></span> <span data-ttu-id="95ae3-423">Mechanizmu kontroli optymistycznej współbieżności przyjęto założenie, że współbieżności naruszeń są rzadkie i po prostu nie zezwala na aktualizację lub usunąć polecenie, które będzie stanowić naruszenie współbieżności.</span><span class="sxs-lookup"><span data-stu-id="95ae3-423">Optimistic concurrency control assumes that concurrency violations are infrequent and simply disallows an update or delete command that would constitute a concurrency violation.</span></span> <span data-ttu-id="95ae3-424">Mechanizm kontroli pesymistycznej współbieżności przyjęto założenie, że ten współbieżności naruszeń są często i po prostu odrzuca jednego użytkownika. Zaktualizuj lub Usuń polecenie nie jest akceptowane.</span><span class="sxs-lookup"><span data-stu-id="95ae3-424">Pessimistic concurrency control assumes that concurrency violations are frequent and simply rejecting one user's update or delete command is not acceptable.</span></span> <span data-ttu-id="95ae3-425">Za pomocą kontroli pesymistycznej współbieżności aktualizowania rekordu obejmuje blokowania, zapobiegając w ten sposób inni użytkownicy, zmodyfikowanie lub usunięcie rekordu, gdy jest on zablokowany.</span><span class="sxs-lookup"><span data-stu-id="95ae3-425">With pessimistic concurrency control, updating a record involves locking it, thereby preventing any other users from modifying or deleting the record while it is locked.</span></span>

<span data-ttu-id="95ae3-426">Wpisany zestaw danych na platformie .NET zapewnia funkcję obsługi mechanizmu kontroli optymistycznej współbieżności.</span><span class="sxs-lookup"><span data-stu-id="95ae3-426">The Typed DataSet in .NET provides functionality for supporting optimistic concurrency control.</span></span> <span data-ttu-id="95ae3-427">W szczególności `UPDATE` i `DELETE` instrukcji wystawiony dla bazy danych obejmuje wszystkie kolumny tabeli, zapewniając, że update lub delete tylko wówczas, gdy dane bieżącego rekordu jest zgodna z oryginalnymi danymi użytkownik miał kiedy wykonywanie ich update lub delete.</span><span class="sxs-lookup"><span data-stu-id="95ae3-427">In particular, the `UPDATE` and `DELETE` statements issued to the database include all of the table's columns, thereby ensuring that the update or delete will only occur if the record's current data matches with the original data the user had when performing their update or delete.</span></span> <span data-ttu-id="95ae3-428">Gdy warstwy DAL została skonfigurowana obsługa optymistycznej współbieżności, należy zaktualizować metody LOGIKI.</span><span class="sxs-lookup"><span data-stu-id="95ae3-428">Once the DAL has been configured to support optimistic concurrency, the BLL methods need to be updated.</span></span> <span data-ttu-id="95ae3-429">Ponadto strony ASP.NET, która wywołuje w dół do LOGIKI musi być skonfigurowany w taki sposób, że kontrolki ObjectDataSource pobiera oryginalnych wartości z formantu sieci Web swoje dane i przekazuje je w dół do LOGIKI.</span><span class="sxs-lookup"><span data-stu-id="95ae3-429">Additionally, the ASP.NET page that calls down into the BLL must be configured such that the ObjectDataSource retrieves the original values from its data Web control and passes them down into the BLL.</span></span>

<span data-ttu-id="95ae3-430">Jak widzieliśmy w ramach tego samouczka, implementacja mechanizmu kontroli optymistycznej współbieżności w aplikacji sieci web ASP.NET obejmuje aktualizację DAL i logiki warstwy Biznesowej i dodanie obsługi na stronie ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="95ae3-430">As we saw in this tutorial, implementing optimistic concurrency control in an ASP.NET web application involves updating the DAL and BLL and adding support in the ASP.NET page.</span></span> <span data-ttu-id="95ae3-431">Określa, czy dodano prac jest poddanie inwestycji, czas i nakład pracy, zależy od aplikacji.</span><span class="sxs-lookup"><span data-stu-id="95ae3-431">Whether or not this added work is a wise investment of your time and effort depends on your application.</span></span> <span data-ttu-id="95ae3-432">Jeśli masz rzadko równoczesnych użytkowników, aktualizowanie danych lub dane, które aktualizują różni się od siebie nawzajem, następnie kontrola współbieżności nie jest kluczową kwestią.</span><span class="sxs-lookup"><span data-stu-id="95ae3-432">If you infrequently have concurrent users updating data, or the data they are updating is different from one another, then concurrency control is not a key issue.</span></span> <span data-ttu-id="95ae3-433">Jeśli jednak rutynowo masz wielu użytkowników w swojej witrynie stosowaniu tych samych danych, kontroli współbieżności może zapobiec jednego użytkownika, aktualizacji lub usuwania wirus zastępowaniu kogoś innego.</span><span class="sxs-lookup"><span data-stu-id="95ae3-433">If, however, you routinely have multiple users on your site working with the same data, concurrency control can help prevent one user's updates or deletes from unwittingly overwriting another's.</span></span>

<span data-ttu-id="95ae3-434">Wszystkiego najlepszego programowania!</span><span class="sxs-lookup"><span data-stu-id="95ae3-434">Happy Programming!</span></span>

## <a name="about-the-author"></a><span data-ttu-id="95ae3-435">Informacje o autorze</span><span class="sxs-lookup"><span data-stu-id="95ae3-435">About the Author</span></span>

<span data-ttu-id="95ae3-436">[Scott Bento](http://www.4guysfromrolla.com/ScottMitchell.shtml), autor siedem ASP/ASP.NET książek i założycielem [4GuysFromRolla.com](http://www.4guysfromrolla.com), pracował nad przy użyciu technologii Microsoft Web od 1998 r.</span><span class="sxs-lookup"><span data-stu-id="95ae3-436">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml), author of seven ASP/ASP.NET books and founder of [4GuysFromRolla.com](http://www.4guysfromrolla.com), has been working with Microsoft Web technologies since 1998.</span></span> <span data-ttu-id="95ae3-437">Scott działa jako niezależny Konsultant, trainer i składnika zapisywania.</span><span class="sxs-lookup"><span data-stu-id="95ae3-437">Scott works as an independent consultant, trainer, and writer.</span></span> <span data-ttu-id="95ae3-438">Jego najnowszą książkę Stephena [ *Sams uczyć się ASP.NET 2.0 w ciągu 24 godzin*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span><span class="sxs-lookup"><span data-stu-id="95ae3-438">His latest book is [*Sams Teach Yourself ASP.NET 2.0 in 24 Hours*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span></span> <span data-ttu-id="95ae3-439">ADAM można z Tobą skontaktować w [ mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="95ae3-439">He can be reached at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span> <span data-ttu-id="95ae3-440">lub za pośrednictwem jego blogu, który znajduje się w temacie [ http://ScottOnWriting.NET ](http://ScottOnWriting.NET).</span><span class="sxs-lookup"><span data-stu-id="95ae3-440">or via his blog, which can be found at [http://ScottOnWriting.NET](http://ScottOnWriting.NET).</span></span>

> [!div class="step-by-step"]
> <span data-ttu-id="95ae3-441">[Poprzednie](customizing-the-data-modification-interface-vb.md)
> [dalej](adding-client-side-confirmation-when-deleting-vb.md)</span><span class="sxs-lookup"><span data-stu-id="95ae3-441">[Previous](customizing-the-data-modification-interface-vb.md)
[Next](adding-client-side-confirmation-when-deleting-vb.md)</span></span>
