---
uid: web-forms/overview/data-access/working-with-binary-files/including-a-file-upload-option-when-adding-a-new-record-cs
title: Dołączanie opcji przekazywania pliku podczas dodawania nowego rekordu (C#) | Microsoft Docs
author: rick-anderson
description: W tym samouczku pokazano, jak utworzyć interfejs sieci Web, który umożliwia użytkownikowi wprowadzanie danych tekstowych i przekazywanie plików binarnych. Aby zilustrować dostępne opcje t...
ms.author: riande
ms.date: 03/27/2007
ms.assetid: 362ade25-3965-4fb2-88d2-835c4786244f
msc.legacyurl: /web-forms/overview/data-access/working-with-binary-files/including-a-file-upload-option-when-adding-a-new-record-cs
msc.type: authoredcontent
ms.openlocfilehash: f1287e180151b3034a7b90ef4b3f1fbe68354a09
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: pl-PL
ms.lasthandoff: 03/06/2020
ms.locfileid: "78588285"
---
# <a name="including-a-file-upload-option-when-adding-a-new-record-c"></a><span data-ttu-id="71d7e-104">Dołączanie opcji przekazywania pliku podczas dodawania nowego rekordu (C#)</span><span class="sxs-lookup"><span data-stu-id="71d7e-104">Including a File Upload Option When Adding a New Record (C#)</span></span>

<span data-ttu-id="71d7e-105">przez [Scott Mitchell](https://twitter.com/ScottOnWriting)</span><span class="sxs-lookup"><span data-stu-id="71d7e-105">by [Scott Mitchell](https://twitter.com/ScottOnWriting)</span></span>

<span data-ttu-id="71d7e-106">[Pobierz przykładową aplikację](https://download.microsoft.com/download/4/a/7/4a7a3b18-d80e-4014-8e53-a6a2427f0d93/ASPNET_Data_Tutorial_56_CS.exe) lub [Pobierz plik PDF](including-a-file-upload-option-when-adding-a-new-record-cs/_static/datatutorial56cs1.pdf)</span><span class="sxs-lookup"><span data-stu-id="71d7e-106">[Download Sample App](https://download.microsoft.com/download/4/a/7/4a7a3b18-d80e-4014-8e53-a6a2427f0d93/ASPNET_Data_Tutorial_56_CS.exe) or [Download PDF](including-a-file-upload-option-when-adding-a-new-record-cs/_static/datatutorial56cs1.pdf)</span></span>

> <span data-ttu-id="71d7e-107">W tym samouczku pokazano, jak utworzyć interfejs sieci Web, który umożliwia użytkownikowi wprowadzanie danych tekstowych i przekazywanie plików binarnych.</span><span class="sxs-lookup"><span data-stu-id="71d7e-107">This tutorial shows how to create a Web interface that allows the user to both enter text data and upload binary files.</span></span> <span data-ttu-id="71d7e-108">Aby zilustrować opcje dostępne do przechowywania danych binarnych, jeden plik zostanie zapisany w bazie danych, podczas gdy drugi zostanie zapisany w systemie plików.</span><span class="sxs-lookup"><span data-stu-id="71d7e-108">To illustrate the options available to store binary data, one file will be saved in the database while the other is stored in the file system.</span></span>

## <a name="introduction"></a><span data-ttu-id="71d7e-109">Wprowadzenie</span><span class="sxs-lookup"><span data-stu-id="71d7e-109">Introduction</span></span>

<span data-ttu-id="71d7e-110">W poprzednich dwóch samouczkach zostały omówione metody przechowywania danych binarnych, które są skojarzone z modelem danych aplikacji, w jaki sposób używać kontrolki FileUpload do wysyłania plików z klienta do serwera sieci Web i dowiedzieć się, jak przedstawić te dane binarne w danych w formant EB.</span><span class="sxs-lookup"><span data-stu-id="71d7e-110">In the previous two tutorials we explored techniques for storing binary data that is associated with the application s data model, looked at how to use the FileUpload control to send files from the client to the web server, and saw how to present this binary data in a data Web control.</span></span> <span data-ttu-id="71d7e-111">Jeszcze tu będziemy wiedzieć, jak skojarzyć przekazane dane z modelem danych.</span><span class="sxs-lookup"><span data-stu-id="71d7e-111">We ve yet to talk about how to associate uploaded data with the data model, though.</span></span>

<span data-ttu-id="71d7e-112">W tym samouczku utworzymy stronę sieci Web, aby dodać nową kategorię.</span><span class="sxs-lookup"><span data-stu-id="71d7e-112">In this tutorial we will create a web page to add a new category.</span></span> <span data-ttu-id="71d7e-113">Oprócz pól tekstowych dla nazwy i opisu kategorii, ta strona będzie musiała zawierać dwie FileUpload kontrolki, jeden dla nowej ilustracji kategorii i jeden dla broszury.</span><span class="sxs-lookup"><span data-stu-id="71d7e-113">In addition to TextBoxes for the category s name and description, this page will need to include two FileUpload controls one for the new category s picture and one for the brochure.</span></span> <span data-ttu-id="71d7e-114">Przekazany obraz zostanie zapisany bezpośrednio w kolumnie nowy rekord `Picture`, podczas gdy Broszura zostanie zapisana w folderze `~/Brochures` z ścieżką do pliku zapisanego w kolumnie nowy rekord `BrochurePath`.</span><span class="sxs-lookup"><span data-stu-id="71d7e-114">The uploaded picture will be stored directly in the new record s `Picture` column, whereas the brochure will be saved to the `~/Brochures` folder with the path to the file saved in the new record s `BrochurePath` column.</span></span>

<span data-ttu-id="71d7e-115">Przed utworzeniem nowej strony sieci Web należy zaktualizować architekturę.</span><span class="sxs-lookup"><span data-stu-id="71d7e-115">Before creating this new web page, we'll need to update the architecture.</span></span> <span data-ttu-id="71d7e-116">Zapytanie główne `CategoriesTableAdapter` s nie pobiera kolumny `Picture`.</span><span class="sxs-lookup"><span data-stu-id="71d7e-116">The `CategoriesTableAdapter` s main query does not retrieve the `Picture` column.</span></span> <span data-ttu-id="71d7e-117">W związku z tym automatycznie generowana Metoda `Insert` ma tylko dane wejściowe dla pól `CategoryName`, `Description`i `BrochurePath`.</span><span class="sxs-lookup"><span data-stu-id="71d7e-117">Consequently, the auto-generated `Insert` method only has inputs for the `CategoryName`, `Description`, and `BrochurePath` fields.</span></span> <span data-ttu-id="71d7e-118">W związku z tym musimy utworzyć dodatkową metodę w TableAdapter, która będzie monitował o wszystkie cztery `Categories` pól.</span><span class="sxs-lookup"><span data-stu-id="71d7e-118">Therefore, we need to create an additional method in the TableAdapter that prompts for all four `Categories` fields.</span></span> <span data-ttu-id="71d7e-119">Należy również zaktualizować klasę `CategoriesBLL` w warstwie logiki biznesowej.</span><span class="sxs-lookup"><span data-stu-id="71d7e-119">The `CategoriesBLL` class in the Business Logic Layer will also need to be updated.</span></span>

## <a name="step-1-adding-aninsertwithpicturemethod-to-thecategoriestableadapter"></a><span data-ttu-id="71d7e-120">Krok 1: dodanie metody`InsertWithPicture`do`CategoriesTableAdapter`</span><span class="sxs-lookup"><span data-stu-id="71d7e-120">Step 1: Adding an`InsertWithPicture`Method to the`CategoriesTableAdapter`</span></span>

<span data-ttu-id="71d7e-121">Po utworzeniu `CategoriesTableAdapter` z powrotem w samouczku [Tworzenie warstwy dostępu do danych](../introduction/creating-a-data-access-layer-cs.md) został on skonfigurowany do automatycznego generowania instrukcji `INSERT`, `UPDATE`i `DELETE` na podstawie zapytania głównego.</span><span class="sxs-lookup"><span data-stu-id="71d7e-121">When we created the `CategoriesTableAdapter` back in the [Creating a Data Access Layer](../introduction/creating-a-data-access-layer-cs.md) tutorial, we configured it to automatically generate `INSERT`, `UPDATE`, and `DELETE` statements based on the main query.</span></span> <span data-ttu-id="71d7e-122">Ponadto firma Microsoft zaleca, aby TableAdapter wykorzystać podejście bezpośrednie DB, które spowodowało utworzenie metod `Insert`, `Update`i `Delete`.</span><span class="sxs-lookup"><span data-stu-id="71d7e-122">Moreover, we instructed the TableAdapter to employ the DB Direct approach, which created the methods `Insert`, `Update`, and `Delete`.</span></span> <span data-ttu-id="71d7e-123">Te metody wykonują automatycznie generowane instrukcje `INSERT`, `UPDATE`i `DELETE` i w związku z tym akceptują parametry wejściowe na podstawie kolumn zwracanych przez zapytanie główne.</span><span class="sxs-lookup"><span data-stu-id="71d7e-123">These methods execute the auto-generated `INSERT`, `UPDATE`, and `DELETE` statements and, consequently, accept input parameters based on the columns returned by the main query.</span></span> <span data-ttu-id="71d7e-124">W samouczku [przekazywania plików](uploading-files-cs.md) został rozszerzony zapytanie główne `CategoriesTableAdapter` s, aby użyć kolumny `BrochurePath`.</span><span class="sxs-lookup"><span data-stu-id="71d7e-124">In the [Uploading Files](uploading-files-cs.md) tutorial we augmented the `CategoriesTableAdapter` s main query to use the `BrochurePath` column.</span></span>

<span data-ttu-id="71d7e-125">Ponieważ zapytanie główne `CategoriesTableAdapter` s nie odwołuje się do kolumny `Picture`, nie można dodać nowego rekordu ani zaktualizować istniejącego rekordu wartością dla kolumny `Picture`.</span><span class="sxs-lookup"><span data-stu-id="71d7e-125">Since the `CategoriesTableAdapter` s main query does not reference the `Picture` column, we can neither add a new record nor update an existing record with a value for the `Picture` column.</span></span> <span data-ttu-id="71d7e-126">Aby przechwycić te informacje, możemy utworzyć nową metodę w TableAdapter, która jest używana w celu wstawienia rekordu z danymi binarnymi, lub dostosować automatycznie wygenerowaną instrukcję `INSERT`.</span><span class="sxs-lookup"><span data-stu-id="71d7e-126">In order to capture this information, we can either create a new method in the TableAdapter that is used specifically to insert a record with binary data or we can customize the auto-generated `INSERT` statement.</span></span> <span data-ttu-id="71d7e-127">Problem z dostosowywaniem automatycznie generowanej instrukcji `INSERT` polega na tym, że istnieje ryzyko, że dostosowania zostały zastąpione przez kreatora.</span><span class="sxs-lookup"><span data-stu-id="71d7e-127">The problem with customizing the auto-generated `INSERT` statement is that we risk having our customizations overwritten by the wizard.</span></span> <span data-ttu-id="71d7e-128">Załóżmy na przykład, że dostosowano instrukcję `INSERT`, aby uwzględnić użycie kolumny `Picture`.</span><span class="sxs-lookup"><span data-stu-id="71d7e-128">For example, imagine that we customized the `INSERT` statement to include use of the `Picture` column.</span></span> <span data-ttu-id="71d7e-129">Spowoduje to zaktualizowanie metody TableAdapter `Insert` w celu uwzględnienia dodatkowego parametru wejściowego danych binarnych kategorii s.</span><span class="sxs-lookup"><span data-stu-id="71d7e-129">This would update the TableAdapter s `Insert` method to include an additional input parameter for the category s picture s binary data.</span></span> <span data-ttu-id="71d7e-130">Następnie możemy utworzyć metodę w warstwie logiki biznesowej, aby użyć tej metody DAL i wywołać tę metodę LOGIKI biznesowej za pomocą warstwy prezentacji, a wszystko to bardzo wspaniałe.</span><span class="sxs-lookup"><span data-stu-id="71d7e-130">We could then create a method in the Business Logic Layer to use this DAL method and invoke this BLL method through the Presentation Layer, and everything would work wonderfully.</span></span> <span data-ttu-id="71d7e-131">Oznacza to, że do czasu następnego skonfigurowania TableAdapter za pomocą Kreatora konfiguracji TableAdapter.</span><span class="sxs-lookup"><span data-stu-id="71d7e-131">That is, until the next time we configured the TableAdapter through the TableAdapter Configuration wizard.</span></span> <span data-ttu-id="71d7e-132">Po zakończeniu pracy Kreatora nasze dostosowania instrukcji `INSERT` zostaną nadpisywane, `Insert` Metoda zostanie przywrócona do starego formularza i nasz kod nie będzie już kompilować!</span><span class="sxs-lookup"><span data-stu-id="71d7e-132">As soon as the wizard completed, our customizations to the `INSERT` statement would be overwritten, the `Insert` method would revert to its old form, and our code would no longer compile!</span></span>

> [!NOTE]
> <span data-ttu-id="71d7e-133">Ten Annoyance nie jest problemem podczas korzystania z procedur składowanych zamiast instrukcji SQL ad hoc.</span><span class="sxs-lookup"><span data-stu-id="71d7e-133">This annoyance is a non-issue when using stored procedures instead of ad-hoc SQL statements.</span></span> <span data-ttu-id="71d7e-134">W przyszłości zapoznaj się z użyciem procedur składowanych zamiast instrukcji SQL ad hoc w warstwie dostępu do danych.</span><span class="sxs-lookup"><span data-stu-id="71d7e-134">A future tutorial will explore using stored procedures in lieu of ad-hoc SQL statements in the Data Access Layer.</span></span>

<span data-ttu-id="71d7e-135">Aby uniknąć tego potencjalnego kłopotliwej, zamiast dopasowywania automatycznie generowanych instrukcji SQL, zamiast tego należy utworzyć nową metodę dla TableAdapter.</span><span class="sxs-lookup"><span data-stu-id="71d7e-135">To avoid this potential headache, rather than customizing the auto-generated SQL statements let s instead create a new method for the TableAdapter.</span></span> <span data-ttu-id="71d7e-136">Ta metoda o nazwie `InsertWithPicture`akceptuje wartości kolumn `CategoryName`, `Description`, `BrochurePath`i `Picture`, a następnie wykonuje instrukcję `INSERT`, która przechowuje wszystkie cztery wartości w nowym rekordzie.</span><span class="sxs-lookup"><span data-stu-id="71d7e-136">This method, named `InsertWithPicture`, will accept values for the `CategoryName`, `Description`, `BrochurePath`, and `Picture` columns and execute an `INSERT` statement that stores all four values in a new record.</span></span>

<span data-ttu-id="71d7e-137">Otwórz wybrany zestaw danych i, w projektancie, kliknij prawym przyciskiem myszy nagłówek `CategoriesTableAdapter` s i wybierz polecenie Dodaj zapytanie z menu kontekstowego.</span><span class="sxs-lookup"><span data-stu-id="71d7e-137">Open the Typed DataSet and, from the Designer, right-click on the `CategoriesTableAdapter` s header and choose Add Query from the context menu.</span></span> <span data-ttu-id="71d7e-138">Spowoduje to uruchomienie Kreatora konfiguracji zapytania TableAdapter, który rozpoczyna się od prośby do nas o to, jak zapytanie TableAdapter powinno uzyskać dostęp do bazy danych.</span><span class="sxs-lookup"><span data-stu-id="71d7e-138">This launches the TableAdapter Query Configuration Wizard, which begins by asking us how the TableAdapter query should access the database.</span></span> <span data-ttu-id="71d7e-139">Wybierz opcję Użyj instrukcji SQL i kliknij przycisk Dalej.</span><span class="sxs-lookup"><span data-stu-id="71d7e-139">Choose Use SQL statements and click Next.</span></span> <span data-ttu-id="71d7e-140">W następnym kroku są wyświetlane monity o typ zapytania, które ma zostać wygenerowane.</span><span class="sxs-lookup"><span data-stu-id="71d7e-140">The next step prompts for the type of query to be generated.</span></span> <span data-ttu-id="71d7e-141">Ponieważ ponownie utworzysz zapytanie w celu dodania nowego rekordu do tabeli `Categories`, wybierz Wstaw i kliknij przycisk Dalej.</span><span class="sxs-lookup"><span data-stu-id="71d7e-141">Since we re creating a query to add a new record to the `Categories` table, choose INSERT and click Next.</span></span>

<span data-ttu-id="71d7e-142">[![wybrać opcję wstawiania](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image1.gif)](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="71d7e-142">[![Select the INSERT Option](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image1.gif)](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image1.png)</span></span>

<span data-ttu-id="71d7e-143">**Rysunek 1**. Wybierz opcję wstawiania ([kliknij, aby wyświetlić obraz o pełnym rozmiarze](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image2.png))</span><span class="sxs-lookup"><span data-stu-id="71d7e-143">**Figure 1**: Select the INSERT Option ([Click to view full-size image](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image2.png))</span></span>

<span data-ttu-id="71d7e-144">Teraz należy określić `INSERT` instrukcji SQL.</span><span class="sxs-lookup"><span data-stu-id="71d7e-144">We now need to specify the `INSERT` SQL statement.</span></span> <span data-ttu-id="71d7e-145">Kreator automatycznie sugeruje instrukcję `INSERT` odpowiadającą TableAdapter s głównej kwerendy.</span><span class="sxs-lookup"><span data-stu-id="71d7e-145">The wizard automatically suggests an `INSERT` statement corresponding to the TableAdapter s main query.</span></span> <span data-ttu-id="71d7e-146">W tym przypadku jest to instrukcja `INSERT`, która wstawia `CategoryName`, `Description`i `BrochurePath` wartości.</span><span class="sxs-lookup"><span data-stu-id="71d7e-146">In this case, it s an `INSERT` statement that inserts the `CategoryName`, `Description`, and `BrochurePath` values.</span></span> <span data-ttu-id="71d7e-147">Zaktualizuj instrukcję, tak aby kolumna `Picture` była dołączona wraz z parametrem `@Picture`, na przykład:</span><span class="sxs-lookup"><span data-stu-id="71d7e-147">Update the statement so that the `Picture` column is included along with a `@Picture` parameter, like so:</span></span>

[!code-sql[Main](including-a-file-upload-option-when-adding-a-new-record-cs/samples/sample1.sql)]

<span data-ttu-id="71d7e-148">Na ostatnim ekranie kreatora zostanie wyświetlony monit o podanie nazwy nowej metody TableAdapter.</span><span class="sxs-lookup"><span data-stu-id="71d7e-148">The final screen of the wizard asks us to name the new TableAdapter method.</span></span> <span data-ttu-id="71d7e-149">Wprowadź `InsertWithPicture` i kliknij przycisk Zakończ.</span><span class="sxs-lookup"><span data-stu-id="71d7e-149">Enter `InsertWithPicture` and click Finish.</span></span>

<span data-ttu-id="71d7e-150">[![nazwę nowej metody TableAdapter InsertWithPicture](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image2.gif)](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image3.png)</span><span class="sxs-lookup"><span data-stu-id="71d7e-150">[![Name the New TableAdapter Method InsertWithPicture](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image2.gif)](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image3.png)</span></span>

<span data-ttu-id="71d7e-151">**Rysunek 2**. Nazwa nowej metody TableAdapter `InsertWithPicture` ([kliknij, aby wyświetlić obraz w pełnym rozmiarze](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image4.png))</span><span class="sxs-lookup"><span data-stu-id="71d7e-151">**Figure 2**: Name the New TableAdapter Method `InsertWithPicture` ([Click to view full-size image](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image4.png))</span></span>

## <a name="step-2-updating-the-business-logic-layer"></a><span data-ttu-id="71d7e-152">Krok 2. aktualizowanie warstwy logiki biznesowej</span><span class="sxs-lookup"><span data-stu-id="71d7e-152">Step 2: Updating the Business Logic Layer</span></span>

<span data-ttu-id="71d7e-153">Ponieważ warstwa prezentacji powinna tylko korzystać z warstwy logiki biznesowej, a nie pomijać jej do bezpośredniego przejścia do warstwy dostępu do danych, musimy utworzyć metodę LOGIKI biznesowej, która wywołuje metodę DAL, która została właśnie utworzona (`InsertWithPicture`).</span><span class="sxs-lookup"><span data-stu-id="71d7e-153">Since the Presentation Layer should only interface with the Business Logic Layer rather than bypassing it to go directly to the Data Access Layer, we need to create a BLL method that invokes the DAL method we just created (`InsertWithPicture`).</span></span> <span data-ttu-id="71d7e-154">Na potrzeby tego samouczka Utwórz metodę w klasie `CategoriesBLL` o nazwie `InsertWithPicture`, która akceptuje jako dane wejściowe trzy `string` s i `byte` tablicę.</span><span class="sxs-lookup"><span data-stu-id="71d7e-154">For this tutorial, create a method in the `CategoriesBLL` class named `InsertWithPicture` that accepts as input three `string` s and a `byte` array.</span></span> <span data-ttu-id="71d7e-155">Parametry wejściowe `string` są dla nazwy kategorii, opisu i ścieżki pliku broszury, natomiast tablica `byte` jest dla zawartości binarnej obrazu kategorii s.</span><span class="sxs-lookup"><span data-stu-id="71d7e-155">The `string` input parameters are for the category s name, description, and brochure file path, while the `byte` array is for the binary contents of the category s picture.</span></span> <span data-ttu-id="71d7e-156">Jak przedstawiono w poniższym kodzie, Metoda LOGIKI biznesowej wywołuje odpowiednią metodę DAL:</span><span class="sxs-lookup"><span data-stu-id="71d7e-156">As the following code shows, this BLL method invokes the corresponding DAL method:</span></span>

[!code-csharp[Main](including-a-file-upload-option-when-adding-a-new-record-cs/samples/sample2.cs)]

> [!NOTE]
> <span data-ttu-id="71d7e-157">Przed dodaniem metody `InsertWithPicture` do LOGIKI biznesowej upewnij się, że Zapisano określony zestaw danych.</span><span class="sxs-lookup"><span data-stu-id="71d7e-157">Make sure that you have saved the Typed DataSet before adding the `InsertWithPicture` method to the BLL.</span></span> <span data-ttu-id="71d7e-158">Ponieważ kod klasy `CategoriesTableAdapter` jest generowany automatycznie na podstawie określonego zestawu danych, jeśli nie zapiszesz zmian w określonym zestawie danych, właściwość `Adapter` nie będzie wiedzieć o metodzie `InsertWithPicture`.</span><span class="sxs-lookup"><span data-stu-id="71d7e-158">Since the `CategoriesTableAdapter` class code is auto-generated based on the Typed DataSet, if you don t first save your changes to the Typed DataSet the `Adapter` property won't know about the `InsertWithPicture` method.</span></span>

## <a name="step-3-listing-the-existing-categories-and-their-binary-data"></a><span data-ttu-id="71d7e-159">Krok 3. Wyświetlanie istniejących kategorii i ich danych binarnych</span><span class="sxs-lookup"><span data-stu-id="71d7e-159">Step 3: Listing the Existing Categories and their Binary Data</span></span>

<span data-ttu-id="71d7e-160">W tym samouczku utworzymy stronę, która umożliwia użytkownikowi końcowemu dodanie nowej kategorii do systemu, dostarczając zdjęcie i broszurę dla nowej kategorii.</span><span class="sxs-lookup"><span data-stu-id="71d7e-160">In this tutorial we will create a page that allows an end user to add a new category to the system, providing a picture and brochure for the new category.</span></span> <span data-ttu-id="71d7e-161">W [poprzednim samouczku](displaying-binary-data-in-the-data-web-controls-cs.md) użyto widoku GridView z TemplateField i ImageField w celu wyświetlenia każdej kategorii, opisu, zdjęcia i linku, aby pobrać jego broszurę.</span><span class="sxs-lookup"><span data-stu-id="71d7e-161">In the [preceding tutorial](displaying-binary-data-in-the-data-web-controls-cs.md) we used a GridView with a TemplateField and ImageField to display each category s name, description, picture, and a link to download its brochure.</span></span> <span data-ttu-id="71d7e-162">Zezwól na replikację tej funkcji dla tego samouczka, tworząc stronę, która wyświetla listę wszystkich istniejących kategorii i umożliwia tworzenie nowych.</span><span class="sxs-lookup"><span data-stu-id="71d7e-162">Let s replicate that functionality for this tutorial, creating a page that both lists all existing categories and allows for new ones to be created.</span></span>

<span data-ttu-id="71d7e-163">Zacznij od otwarcia strony `DisplayOrDownload.aspx` z folderu `BinaryData`.</span><span class="sxs-lookup"><span data-stu-id="71d7e-163">Start by opening the `DisplayOrDownload.aspx` page from the `BinaryData` folder.</span></span> <span data-ttu-id="71d7e-164">Przejdź do widoku źródła i skopiuj składnię "GridView" i "ObjectDataSource s", wklejając ją w elemencie `<asp:Content>` w `UploadInDetailsView.aspx`.</span><span class="sxs-lookup"><span data-stu-id="71d7e-164">Go to the Source view and copy the GridView and ObjectDataSource s declarative syntax, pasting it within the `<asp:Content>` element in `UploadInDetailsView.aspx`.</span></span> <span data-ttu-id="71d7e-165">Ponadto nie zapomnimy skopiować metody `GenerateBrochureLink` z klasy `DisplayOrDownload.aspx` do `UploadInDetailsView.aspx`.</span><span class="sxs-lookup"><span data-stu-id="71d7e-165">Also, don t forget to copy over the `GenerateBrochureLink` method from the code-behind class of `DisplayOrDownload.aspx` to `UploadInDetailsView.aspx`.</span></span>

<span data-ttu-id="71d7e-166">[![skopiować i wkleić składnię deklaratywną z DisplayOrDownload. aspx do UploadInDetailsView. aspx](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image3.gif)](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image5.png)</span><span class="sxs-lookup"><span data-stu-id="71d7e-166">[![Copy and Paste the Declarative Syntax from DisplayOrDownload.aspx to UploadInDetailsView.aspx](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image3.gif)](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image5.png)</span></span>

<span data-ttu-id="71d7e-167">**Rysunek 3**. Skopiuj i wklej składnię deklaratywną z `DisplayOrDownload.aspx` do `UploadInDetailsView.aspx` ([kliknij, aby wyświetlić obraz o pełnym rozmiarze](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image6.png))</span><span class="sxs-lookup"><span data-stu-id="71d7e-167">**Figure 3**: Copy and Paste the Declarative Syntax from `DisplayOrDownload.aspx` to `UploadInDetailsView.aspx` ([Click to view full-size image](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image6.png))</span></span>

<span data-ttu-id="71d7e-168">Po skopiowaniu składni deklaratywnej i metodzie `GenerateBrochureLink` do strony `UploadInDetailsView.aspx` Wyświetl stronę za pośrednictwem przeglądarki, aby upewnić się, że wszystkie elementy zostały skopiowane pomyślnie.</span><span class="sxs-lookup"><span data-stu-id="71d7e-168">After copying the declarative syntax and `GenerateBrochureLink` method over to the `UploadInDetailsView.aspx` page, view the page through a browser to ensure that everything was copied over correctly.</span></span> <span data-ttu-id="71d7e-169">Powinien zostać wyświetlony widok GridView zawierający osiem kategorii, które zawierają link umożliwiający pobranie broszury oraz Zdjęcia kategorii.</span><span class="sxs-lookup"><span data-stu-id="71d7e-169">You should see a GridView listing the eight categories that includes a link to download the brochure as well as the category s picture.</span></span>

<span data-ttu-id="71d7e-170">[![powinna być teraz widoczna każda kategoria wraz z danymi binarnymi](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image4.gif)](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="71d7e-170">[![You Should Now See Each Category Along with Its Binary Data](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image4.gif)](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image7.png)</span></span>

<span data-ttu-id="71d7e-171">**Rysunek 4**. teraz powinna być widoczna każda kategoria wraz z danymi binarnymi ([kliknij, aby wyświetlić obraz o pełnym rozmiarze](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image8.png))</span><span class="sxs-lookup"><span data-stu-id="71d7e-171">**Figure 4**: You Should Now See Each Category Along with Its Binary Data ([Click to view full-size image](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image8.png))</span></span>

## <a name="step-4-configuring-thecategoriesdatasourceto-support-inserting"></a><span data-ttu-id="71d7e-172">Krok 4. Konfigurowanie`CategoriesDataSource`do obsługi wstawiania</span><span class="sxs-lookup"><span data-stu-id="71d7e-172">Step 4: Configuring the`CategoriesDataSource`to Support Inserting</span></span>

<span data-ttu-id="71d7e-173">Element ObjectDataSource `CategoriesDataSource` używany przez `Categories` GridView obecnie nie zapewnia możliwości wstawiania danych.</span><span class="sxs-lookup"><span data-stu-id="71d7e-173">The `CategoriesDataSource` ObjectDataSource used by the `Categories` GridView currently does not provide the ability to insert data.</span></span> <span data-ttu-id="71d7e-174">Aby można było obsługiwać Wstawianie przez tę kontrolkę źródła danych, musimy zmapować metodę `Insert` na metodę w obiekcie źródłowym, `CategoriesBLL`.</span><span class="sxs-lookup"><span data-stu-id="71d7e-174">In order to support inserting through this data source control, we need to map its `Insert` method to a method in its underlying object, `CategoriesBLL`.</span></span> <span data-ttu-id="71d7e-175">W szczególności chcemy zmapować ją na metodę `CategoriesBLL`, która została dodana z powrotem w kroku 2, `InsertWithPicture`.</span><span class="sxs-lookup"><span data-stu-id="71d7e-175">In particular, we want to map it to the `CategoriesBLL` method we added back in Step 2, `InsertWithPicture`.</span></span>

<span data-ttu-id="71d7e-176">Zacznij od kliknięcia linku Konfiguruj źródło danych z tagu inteligentnego ObjectDataSource s.</span><span class="sxs-lookup"><span data-stu-id="71d7e-176">Start by clicking the Configure Data Source link from the ObjectDataSource s smart tag.</span></span> <span data-ttu-id="71d7e-177">Pierwszy ekran pokazuje obiekt, z którym jest skonfigurowane źródło danych, `CategoriesBLL`.</span><span class="sxs-lookup"><span data-stu-id="71d7e-177">The first screen shows the object the data source is configured to work with, `CategoriesBLL`.</span></span> <span data-ttu-id="71d7e-178">Pozostaw to ustawienie jako-is i kliknij przycisk Dalej, aby przejść do ekranu Definiowanie metod danych.</span><span class="sxs-lookup"><span data-stu-id="71d7e-178">Leave this setting as-is and click Next to advance to the Define Data Methods screen.</span></span> <span data-ttu-id="71d7e-179">Przejdź na kartę Wstawianie i wybierz metodę `InsertWithPicture` z listy rozwijanej.</span><span class="sxs-lookup"><span data-stu-id="71d7e-179">Move to the INSERT tab and pick the `InsertWithPicture` method from the drop-down list.</span></span> <span data-ttu-id="71d7e-180">Kliknij przycisk Zakończ, aby zakończyć pracę kreatora.</span><span class="sxs-lookup"><span data-stu-id="71d7e-180">Click Finish to complete the wizard.</span></span>

<span data-ttu-id="71d7e-181">[![skonfigurować element ObjectDataSource do korzystania z metody InsertWithPicture](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image5.gif)](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image9.png)</span><span class="sxs-lookup"><span data-stu-id="71d7e-181">[![Configure the ObjectDataSource to use the InsertWithPicture Method](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image5.gif)](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image9.png)</span></span>

<span data-ttu-id="71d7e-182">**Rysunek 5**. Konfigurowanie elementu ObjectDataSource do używania metody `InsertWithPicture` ([kliknij, aby wyświetlić obraz o pełnym rozmiarze](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image10.png))</span><span class="sxs-lookup"><span data-stu-id="71d7e-182">**Figure 5**: Configure the ObjectDataSource to use the `InsertWithPicture` Method ([Click to view full-size image](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image10.png))</span></span>

> [!NOTE]
> <span data-ttu-id="71d7e-183">Po zakończeniu działania kreatora program Visual Studio może zażądać odświeżenia pól i kluczy, co spowoduje ponowne wygenerowanie pól formantów sieci Web danych.</span><span class="sxs-lookup"><span data-stu-id="71d7e-183">Upon completing the wizard, Visual Studio may ask if you want to Refresh Fields and Keys, which will regenerate the data Web controls fields.</span></span> <span data-ttu-id="71d7e-184">Wybierz pozycję nie, ponieważ wybranie opcji Tak spowoduje zastąpienie wszelkich dostosowanych dostosowań pól.</span><span class="sxs-lookup"><span data-stu-id="71d7e-184">Choose No, because choosing Yes will overwrite any field customizations you may have made.</span></span>

<span data-ttu-id="71d7e-185">Po zakończeniu działania kreatora element ObjectDataSource będzie teraz zawierał wartość właściwości `InsertMethod`, a także `InsertParameters` dla czterech kolumn kategorii, jak ilustruje to następujące deklaratywne znaczniki:</span><span class="sxs-lookup"><span data-stu-id="71d7e-185">After completing the wizard, the ObjectDataSource will now include a value for its `InsertMethod` property as well as `InsertParameters` for the four category columns, as the following declarative markup illustrates:</span></span>

[!code-aspx[Main](including-a-file-upload-option-when-adding-a-new-record-cs/samples/sample3.aspx)]

## <a name="step-5-creating-the-inserting-interface"></a><span data-ttu-id="71d7e-186">Krok 5. Tworzenie interfejsu wstawiania</span><span class="sxs-lookup"><span data-stu-id="71d7e-186">Step 5: Creating the Inserting Interface</span></span>

<span data-ttu-id="71d7e-187">Jak pierwszy podano w [przeglądzie wstawiania, aktualizowania i usuwania danych](../editing-inserting-and-deleting-data/an-overview-of-inserting-updating-and-deleting-data-cs.md), formant DetailsView udostępnia wbudowany interfejs wstawiania, który może być używany podczas pracy z formantem źródła danych, który obsługuje wstawianie.</span><span class="sxs-lookup"><span data-stu-id="71d7e-187">As first covered in the [An Overview of Inserting, Updating, and Deleting Data](../editing-inserting-and-deleting-data/an-overview-of-inserting-updating-and-deleting-data-cs.md), the DetailsView control provides a built-in inserting interface that can be utilized when working with a data source control that supports inserting.</span></span> <span data-ttu-id="71d7e-188">Zezwól na dodanie kontrolki DetailsView do tej strony powyżej widoku GridView, która trwale renderuje swój interfejs wstawiania, umożliwiając użytkownikowi szybkie dodanie nowej kategorii.</span><span class="sxs-lookup"><span data-stu-id="71d7e-188">Let s add a DetailsView control to this page above the GridView that will permanently render its inserting interface, allowing a user to quickly add a new category.</span></span> <span data-ttu-id="71d7e-189">Po dodaniu nowej kategorii w widoku DetailsView zobaczysz automatycznie odświeżanie i wyświetlenie nowej kategorii.</span><span class="sxs-lookup"><span data-stu-id="71d7e-189">Upon adding a new category in the DetailsView, the GridView beneath it will automatically refresh and display the new category.</span></span>

<span data-ttu-id="71d7e-190">Zacznij od przeciągnięcia widoku DetailsView z przybornika na projektanta nad GridView, ustawiając jego właściwość `ID` na `NewCategory` i czyszcząc wartości właściwości `Height` i `Width`.</span><span class="sxs-lookup"><span data-stu-id="71d7e-190">Start by dragging a DetailsView from the Toolbox onto the Designer above the GridView, setting its `ID` property to `NewCategory` and clearing out the `Height` and `Width` property values.</span></span> <span data-ttu-id="71d7e-191">Z tagu inteligentnego DetailsView s powiąż go z istniejącym `CategoriesDataSource` a następnie zaznacz pole wyboru Włącz wstawianie.</span><span class="sxs-lookup"><span data-stu-id="71d7e-191">From the DetailsView s smart tag, bind it to the existing `CategoriesDataSource` and then check the Enable Inserting checkbox.</span></span>

<span data-ttu-id="71d7e-192">[![powiązać widoku DetailsView z CategoriesDataSource i Włącz wstawianie](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image6.gif)](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image11.png)</span><span class="sxs-lookup"><span data-stu-id="71d7e-192">[![Bind the DetailsView to the CategoriesDataSource and Enable Inserting](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image6.gif)](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image11.png)</span></span>

<span data-ttu-id="71d7e-193">**Ilustracja 6**. powiązanie widoku DetailsView z `CategoriesDataSource` i włączanie wstawiania ([kliknij, aby wyświetlić obraz w pełnym rozmiarze](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image12.png))</span><span class="sxs-lookup"><span data-stu-id="71d7e-193">**Figure 6**: Bind the DetailsView to the `CategoriesDataSource` and Enable Inserting ([Click to view full-size image](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image12.png))</span></span>

<span data-ttu-id="71d7e-194">Aby trwale renderować DetailsView w interfejsie wstawiania, ustaw jej Właściwość `DefaultMode` na `Insert`.</span><span class="sxs-lookup"><span data-stu-id="71d7e-194">To permanently render the DetailsView in its inserting interface, set its `DefaultMode` property to `Insert`.</span></span>

<span data-ttu-id="71d7e-195">Należy pamiętać, że element DetailsView ma pięć BoundFields `CategoryID`, `CategoryName`, `Description`, `NumberOfProducts`i `BrochurePath`, chociaż `CategoryID` BoundField nie jest renderowany w interfejsie wstawiania, ponieważ jego właściwość `InsertVisible` jest ustawiona na `false`.</span><span class="sxs-lookup"><span data-stu-id="71d7e-195">Note that the DetailsView has five BoundFields `CategoryID`, `CategoryName`, `Description`, `NumberOfProducts`, and `BrochurePath` although the `CategoryID` BoundField is not rendered in the inserting interface because its `InsertVisible` property is set to `false`.</span></span> <span data-ttu-id="71d7e-196">Te BoundFields istnieje, ponieważ są kolumnami zwracanymi przez metodę `GetCategories()`, która jest wywołaniem elementu ObjectDataSource w celu pobrania jego danych.</span><span class="sxs-lookup"><span data-stu-id="71d7e-196">These BoundFields exists because they are the columns returned by the `GetCategories()` method, which is what the ObjectDataSource invokes to retrieve its data.</span></span> <span data-ttu-id="71d7e-197">Jednak w przypadku wstawiania nie chcemy pozwolić użytkownikowi na określenie wartości `NumberOfProducts`.</span><span class="sxs-lookup"><span data-stu-id="71d7e-197">For inserting, however, we don t want to let the user specify a value for `NumberOfProducts`.</span></span> <span data-ttu-id="71d7e-198">Ponadto musimy zezwolić na przekazanie Zdjęcia dla nowej kategorii oraz przekazanie pliku PDF dla broszury.</span><span class="sxs-lookup"><span data-stu-id="71d7e-198">Moreover, we need to allow them to upload a picture for the new category as well as upload a PDF for the brochure.</span></span>

<span data-ttu-id="71d7e-199">Usuń `NumberOfProducts` BoundField z widoku DetailsView całkowicie, a następnie zaktualizuj odpowiednio właściwości `HeaderText` `CategoryName` i `BrochurePath` z kategorii i broszury.</span><span class="sxs-lookup"><span data-stu-id="71d7e-199">Remove the `NumberOfProducts` BoundField from the DetailsView altogether and then update the `HeaderText` properties of the `CategoryName` and `BrochurePath` BoundFields to Category and Brochure, respectively.</span></span> <span data-ttu-id="71d7e-200">Następnie przekonwertuj `BrochurePath` BoundField na TemplateField i Dodaj nowy TemplateField dla obrazu, dając ten nowy TemplateField `HeaderText` wartość obrazu.</span><span class="sxs-lookup"><span data-stu-id="71d7e-200">Next, convert the `BrochurePath` BoundField into a TemplateField and add a new TemplateField for the picture, giving this new TemplateField a `HeaderText` value of Picture.</span></span> <span data-ttu-id="71d7e-201">Przenieś `Picture` TemplateField tak, aby był on między `BrochurePath` TemplateField i CommandField.</span><span class="sxs-lookup"><span data-stu-id="71d7e-201">Move the `Picture` TemplateField so that it is between the `BrochurePath` TemplateField and CommandField.</span></span>

![Powiąż element DetailsView z CategoriesDataSource i Włącz wstawianie](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image7.gif)

<span data-ttu-id="71d7e-203">**Rysunek 7**. powiązanie widoku DetailsView z `CategoriesDataSource` i włączanie wstawiania</span><span class="sxs-lookup"><span data-stu-id="71d7e-203">**Figure 7**: Bind the DetailsView to the `CategoriesDataSource` and Enable Inserting</span></span>

<span data-ttu-id="71d7e-204">W przypadku przekonwertowania `BrochurePath` BoundField do TemplateField za pomocą okna dialogowego Edycja pól TemplateField zawiera `ItemTemplate`, `EditItemTemplate`i `InsertItemTemplate`.</span><span class="sxs-lookup"><span data-stu-id="71d7e-204">If you converted the `BrochurePath` BoundField into a TemplateField through the Edit Fields dialog box, the TemplateField includes an `ItemTemplate`, `EditItemTemplate`, and `InsertItemTemplate`.</span></span> <span data-ttu-id="71d7e-205">Niemniej jednak tylko `InsertItemTemplate` jest to konieczne, aby usunąć pozostałe dwa szablony.</span><span class="sxs-lookup"><span data-stu-id="71d7e-205">Only the `InsertItemTemplate` is needed, however, so feel free to remove the other two templates.</span></span> <span data-ttu-id="71d7e-206">W tym momencie składnia deklaratywna widoku DetailsView powinna wyglądać następująco:</span><span class="sxs-lookup"><span data-stu-id="71d7e-206">At this point your DetailsView s declarative syntax should look like the following:</span></span>

[!code-aspx[Main](including-a-file-upload-option-when-adding-a-new-record-cs/samples/sample4.aspx)]

## <a name="adding-fileupload-controls-for-the-brochure-and-picture-fields"></a><span data-ttu-id="71d7e-207">Dodawanie kontrolek FileUpload do pól broszur i Picture</span><span class="sxs-lookup"><span data-stu-id="71d7e-207">Adding FileUpload Controls for the Brochure and Picture Fields</span></span>

<span data-ttu-id="71d7e-208">Obecnie `BrochurePath` TemplateField s `InsertItemTemplate` zawiera pole tekstowe, podczas gdy `Picture` TemplateField nie zawiera żadnych szablonów.</span><span class="sxs-lookup"><span data-stu-id="71d7e-208">Presently, the `BrochurePath` TemplateField s `InsertItemTemplate` contains a TextBox, while the `Picture` TemplateField does not contain any templates.</span></span> <span data-ttu-id="71d7e-209">Musimy zaktualizować te dwie TemplateField s `InsertItemTemplate` s, aby użyć formantów FileUpload.</span><span class="sxs-lookup"><span data-stu-id="71d7e-209">We need to update these two TemplateField s `InsertItemTemplate` s to use FileUpload controls.</span></span>

<span data-ttu-id="71d7e-210">Z tagu inteligentnego DetailsView s wybierz opcję Edytuj szablony, a następnie wybierz `BrochurePath` TemplateField s `InsertItemTemplate` z listy rozwijanej.</span><span class="sxs-lookup"><span data-stu-id="71d7e-210">From the DetailsView s smart tag, choose the Edit Templates option and then select the `BrochurePath` TemplateField s `InsertItemTemplate` from the drop-down list.</span></span> <span data-ttu-id="71d7e-211">Usuń pole tekstowe, a następnie przeciągnij kontrolkę FileUpload z przybornika do szablonu.</span><span class="sxs-lookup"><span data-stu-id="71d7e-211">Remove the TextBox and then drag a FileUpload control from the Toolbox into the template.</span></span> <span data-ttu-id="71d7e-212">Ustaw `ID` formantu FileUpload, aby `BrochureUpload`.</span><span class="sxs-lookup"><span data-stu-id="71d7e-212">Set the FileUpload control s `ID` to `BrochureUpload`.</span></span> <span data-ttu-id="71d7e-213">Podobnie należy dodać formant FileUpload do `InsertItemTemplate``Picture` TemplateField.</span><span class="sxs-lookup"><span data-stu-id="71d7e-213">Similarly, add a FileUpload control to the `Picture` TemplateField s `InsertItemTemplate`.</span></span> <span data-ttu-id="71d7e-214">Ustaw ten FileUpload kontrolkę s `ID`, aby `PictureUpload`.</span><span class="sxs-lookup"><span data-stu-id="71d7e-214">Set this FileUpload control s `ID` to `PictureUpload`.</span></span>

<span data-ttu-id="71d7e-215">[![dodać kontrolkę FileUpload do InsertItemTemplate](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image8.gif)](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="71d7e-215">[![Add a FileUpload Control to the InsertItemTemplate](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image8.gif)](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image13.png)</span></span>

<span data-ttu-id="71d7e-216">**Ilustracja 8**. Dodawanie kontrolki FileUpload do `InsertItemTemplate` ([kliknij, aby wyświetlić obraz w pełnym rozmiarze](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image14.png))</span><span class="sxs-lookup"><span data-stu-id="71d7e-216">**Figure 8**: Add a FileUpload Control to the `InsertItemTemplate` ([Click to view full-size image](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image14.png))</span></span>

<span data-ttu-id="71d7e-217">Po wprowadzeniu tych dodatków dwie TemplateFielda składnia deklaracyjne będzie:</span><span class="sxs-lookup"><span data-stu-id="71d7e-217">After making these additions, the two TemplateField s declarative syntax will be:</span></span>

[!code-aspx[Main](including-a-file-upload-option-when-adding-a-new-record-cs/samples/sample5.aspx)]

<span data-ttu-id="71d7e-218">Gdy użytkownik doda nową kategorię, chcemy upewnić się, że Broszura i zdjęcie mają prawidłowy typ pliku.</span><span class="sxs-lookup"><span data-stu-id="71d7e-218">When a user adds a new category, we want to ensure that the brochure and picture are of the correct file type.</span></span> <span data-ttu-id="71d7e-219">Dla broszury użytkownik musi podać plik PDF.</span><span class="sxs-lookup"><span data-stu-id="71d7e-219">For the brochure, the user must supply a PDF.</span></span> <span data-ttu-id="71d7e-220">W przypadku obrazu musimy przekazać użytkownikowi plik obrazu, ale zezwolimy na *każdy* plik obrazu lub tylko pliki obrazów określonego typu, takie jak GIF czy JPGs?</span><span class="sxs-lookup"><span data-stu-id="71d7e-220">For the picture, we need the user to upload an image file, but do we allow *any* image file or only image files of a particular type, such as GIFs or JPGs?</span></span> <span data-ttu-id="71d7e-221">Aby można było zezwolić na różne typy plików, musimy zwiększyć schemat `Categories`, aby uwzględnić kolumnę, która przechwytuje typ pliku, aby ten typ mógł zostać wysłany do klienta za pomocą `Response.ContentType` w `DisplayCategoryPicture.aspx`.</span><span class="sxs-lookup"><span data-stu-id="71d7e-221">In order to allow for different file types, we d need to extend the `Categories` schema to include a column that captures the file type so that this type can be sent to the client through `Response.ContentType` in `DisplayCategoryPicture.aspx`.</span></span> <span data-ttu-id="71d7e-222">Ze względu na to, że nie mamy takiej kolumny, warto zastanowić się, że użytkownicy będą mogli tylko dostarczać określony typ pliku obrazu.</span><span class="sxs-lookup"><span data-stu-id="71d7e-222">Since we don t have such a column, it would be prudent to restrict users to only providing a specific image file type.</span></span> <span data-ttu-id="71d7e-223">Istniejące obrazy `Categories` tabeli s są mapami bitowymi, ale JPGs są bardziej odpowiednim formatem pliku dla obrazów obsługiwanych przez sieć Web.</span><span class="sxs-lookup"><span data-stu-id="71d7e-223">The `Categories` table s existing images are bitmaps, but JPGs are a more appropriate file format for images served over the web.</span></span>

<span data-ttu-id="71d7e-224">Jeśli użytkownik przekaże nieprawidłowy typ pliku, musi anulować Wstawianie i wyświetlić komunikat informujący o tym problemie.</span><span class="sxs-lookup"><span data-stu-id="71d7e-224">If a user uploads an incorrect file type, we need to cancel the insert and display a message indicating the problem.</span></span> <span data-ttu-id="71d7e-225">Dodaj kontrolkę sieci Web etykieta poniżej widoku DetailsView.</span><span class="sxs-lookup"><span data-stu-id="71d7e-225">Add a Label Web control beneath the DetailsView.</span></span> <span data-ttu-id="71d7e-226">Ustaw jej Właściwość `ID` na `UploadWarning`, wyczyść Właściwość `Text`, ustaw właściwość `CssClass` na Warning, a `Visible` i `EnableViewState` właściwości, aby `false`.</span><span class="sxs-lookup"><span data-stu-id="71d7e-226">Set its `ID` property to `UploadWarning`, clear out its `Text` property, set the `CssClass` property to Warning, and the `Visible` and `EnableViewState` properties to `false`.</span></span> <span data-ttu-id="71d7e-227">Klasa `Warning` CSS jest definiowana w `Styles.css` i renderuje tekst w postaci długiej, czerwonej, kursywy, pogrubionej czcionki.</span><span class="sxs-lookup"><span data-stu-id="71d7e-227">The `Warning` CSS class is defined in `Styles.css` and renders the text in a large, red, italicized, bold font.</span></span>

> [!NOTE]
> <span data-ttu-id="71d7e-228">W idealnym przypadku `CategoryName` i `Description` BoundFields zostałyby przekonwertowane na używanie TemplateField i ich Wstawianie dostosowanych interfejsów.</span><span class="sxs-lookup"><span data-stu-id="71d7e-228">Ideally, the `CategoryName` and `Description` BoundFields would be converted to TemplateFields and their inserting interfaces customized.</span></span> <span data-ttu-id="71d7e-229">`Description` Wstawianie interfejsu, na przykład, prawdopodobnie będzie lepiej dopasowane przez wielowierszowe pole tekstowe.</span><span class="sxs-lookup"><span data-stu-id="71d7e-229">The `Description` inserting interface, for example, would likely be better suited through a multi-line textbox.</span></span> <span data-ttu-id="71d7e-230">A ponieważ kolumna `CategoryName` nie akceptuje wartości `NULL`, należy dodać RequiredFieldValidator, aby upewnić się, że użytkownik poda wartość nowej nazwy kategorii.</span><span class="sxs-lookup"><span data-stu-id="71d7e-230">And since the `CategoryName` column does not accept `NULL` values, a RequiredFieldValidator should be added to ensure the user provides a value for the new category s name.</span></span> <span data-ttu-id="71d7e-231">Te kroki są pozostawione jako ćwiczenia dla czytnika.</span><span class="sxs-lookup"><span data-stu-id="71d7e-231">These steps are left as an exercise to the reader.</span></span> <span data-ttu-id="71d7e-232">Zapoznaj się z powrotem [, aby dostosować interfejs modyfikacji danych](../editing-inserting-and-deleting-data/customizing-the-data-modification-interface-cs.md) , aby uzyskać szczegółowe informacje na temat rozszerzania interfejsów modyfikacji danych.</span><span class="sxs-lookup"><span data-stu-id="71d7e-232">Refer back to [Customizing the Data Modification Interface](../editing-inserting-and-deleting-data/customizing-the-data-modification-interface-cs.md) for an in-depth look at augmenting the data modification interfaces.</span></span>

## <a name="step-6-saving-the-uploaded-brochure-to-the-web-server-s-file-system"></a><span data-ttu-id="71d7e-233">Krok 6. zapisywanie przekazanej broszury w systemie plików serwera sieci Web</span><span class="sxs-lookup"><span data-stu-id="71d7e-233">Step 6: Saving the Uploaded Brochure to the Web Server s File System</span></span>

<span data-ttu-id="71d7e-234">Gdy użytkownik wprowadzi wartości dla nowej kategorii i kliknie przycisk Wstaw, następuje ogłaszanie zwrotne i wstawianie przepływu pracy.</span><span class="sxs-lookup"><span data-stu-id="71d7e-234">When the user enters the values for a new category and clicks the Insert button, a postback occurs and the inserting workflow unfolds.</span></span> <span data-ttu-id="71d7e-235">Najpierw zostanie wyzwolone zdarzenie DetailsView s [`ItemInserting`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.detailsview.iteminserting.aspx) .</span><span class="sxs-lookup"><span data-stu-id="71d7e-235">First, the DetailsView s [`ItemInserting` event](https://msdn.microsoft.com/library/system.web.ui.webcontrols.detailsview.iteminserting.aspx) fires.</span></span> <span data-ttu-id="71d7e-236">Następnie zostanie wywołana metoda `Insert()` ObjectDataSource s, co spowoduje dodanie nowego rekordu do tabeli `Categories`.</span><span class="sxs-lookup"><span data-stu-id="71d7e-236">Next, the ObjectDataSource s `Insert()` method is invoked, which results in a new record being added to the `Categories` table.</span></span> <span data-ttu-id="71d7e-237">Następnie zostanie wyzwolone zdarzenie DetailsView s [`ItemInserted`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.detailsview.iteminserted.aspx) .</span><span class="sxs-lookup"><span data-stu-id="71d7e-237">After that, the DetailsView s [`ItemInserted` event](https://msdn.microsoft.com/library/system.web.ui.webcontrols.detailsview.iteminserted.aspx) fires.</span></span>

<span data-ttu-id="71d7e-238">Przed wywołaniem metody `Insert()` ObjectDataSource s należy najpierw upewnić się, że odpowiednie typy plików zostały przekazane przez użytkownika, a następnie zapisać plik PDF broszury w systemie plików serwera sieci Web.</span><span class="sxs-lookup"><span data-stu-id="71d7e-238">Before the ObjectDataSource s `Insert()` method is invoked, we must first ensure that the appropriate file types were uploaded by the user and then save the brochure PDF to the web server s file system.</span></span> <span data-ttu-id="71d7e-239">Utwórz procedurę obsługi zdarzeń dla zdarzenia `ItemInserting` DetailsView s i Dodaj następujący kod:</span><span class="sxs-lookup"><span data-stu-id="71d7e-239">Create an event handler for the DetailsView s `ItemInserting` event and add the following code:</span></span>

[!code-csharp[Main](including-a-file-upload-option-when-adding-a-new-record-cs/samples/sample6.cs)]

<span data-ttu-id="71d7e-240">Program obsługi zdarzeń uruchamia się, odwołując się do kontrolki FileUpload `BrochureUpload` z szablonów DetailsView s.</span><span class="sxs-lookup"><span data-stu-id="71d7e-240">The event handler starts by referencing the `BrochureUpload` FileUpload control from the DetailsView s templates.</span></span> <span data-ttu-id="71d7e-241">Następnie, jeśli broszura została przekazana, zostanie zbadane przekazane rozszerzenie pliku s.</span><span class="sxs-lookup"><span data-stu-id="71d7e-241">Then, if a brochure has been uploaded, the uploaded file s extension is examined.</span></span> <span data-ttu-id="71d7e-242">Jeśli rozszerzenie nie jest. Plik PDF, to ostrzeżenie jest wyświetlane, wstawianie zostało anulowane, a wykonywanie procedury obsługi zdarzeń zostanie zakończone.</span><span class="sxs-lookup"><span data-stu-id="71d7e-242">If the extension is not .PDF, then a warning is displayed, the insert is cancelled, and the execution of the event handler ends.</span></span>

> [!NOTE]
> <span data-ttu-id="71d7e-243">Poleganie na przekazanym rozszerzeniu pliku s nie jest techniką "Uruchom jako", aby upewnić się, że przekazany plik jest dokumentem PDF.</span><span class="sxs-lookup"><span data-stu-id="71d7e-243">Relying on the uploaded file s extension is not a sure-fire technique for ensuring that the uploaded file is a PDF document.</span></span> <span data-ttu-id="71d7e-244">Użytkownik może mieć prawidłowy dokument PDF z rozszerzeniem `.Brochure`lub mógł zostać przeniesiony do dokumentu innego niż PDF i mieć rozszerzenie `.pdf`.</span><span class="sxs-lookup"><span data-stu-id="71d7e-244">The user could have a valid PDF document with the extension `.Brochure`, or could have taken a non-PDF document and given it a `.pdf` extension.</span></span> <span data-ttu-id="71d7e-245">Zawartość binarna pliku powinna być sprawdzana programowo w celu dokładniejszego zweryfikowania typu pliku.</span><span class="sxs-lookup"><span data-stu-id="71d7e-245">The file s binary content would need to be programmatically examined in order to more conclusively verify the file type.</span></span> <span data-ttu-id="71d7e-246">Takie dokładne podejście, chociaż często są zbyt obszerne; Sprawdzanie, czy rozszerzenie jest wystarczające dla większości scenariuszy.</span><span class="sxs-lookup"><span data-stu-id="71d7e-246">Such thorough approaches, though, are often overkill; checking the extension is sufficient for most scenarios.</span></span>

<span data-ttu-id="71d7e-247">Zgodnie z opisem w samouczku [przekazywanie plików](uploading-files-cs.md) należy zachować ostrożność podczas zapisywania plików w systemie plików, tak aby jedna z nich nie zastąpiła inna wartość.</span><span class="sxs-lookup"><span data-stu-id="71d7e-247">As discussed in the [Uploading Files](uploading-files-cs.md) tutorial, care must be taken when saving files to the file system so that one user s upload does not overwrite another s.</span></span> <span data-ttu-id="71d7e-248">Na potrzeby tego samouczka Podejmiemy próbę użycia takiej samej nazwy jak przekazanego pliku.</span><span class="sxs-lookup"><span data-stu-id="71d7e-248">For this tutorial we will attempt to use the same name as the uploaded file.</span></span> <span data-ttu-id="71d7e-249">Jeśli istnieje już plik w katalogu `~/Brochures` o tej samej nazwie pliku, dołączymy numer na końcu do momentu znalezienia unikatowej nazwy.</span><span class="sxs-lookup"><span data-stu-id="71d7e-249">If there already exists a file in the `~/Brochures` directory with that same file name, however, we'll append a number at the end until a unique name is found.</span></span> <span data-ttu-id="71d7e-250">Na przykład, jeśli użytkownik przekazuje plik broszury o nazwie `Meats.pdf`, ale w folderze `~/Brochures` istnieje już plik o nazwie `Meats.pdf`, zmienimy nazwę zapisanego pliku na `Meats-1.pdf`.</span><span class="sxs-lookup"><span data-stu-id="71d7e-250">For example, if the user uploads a brochure file named `Meats.pdf`, but there is already a file named `Meats.pdf` in the `~/Brochures` folder, we'll change the saved file name to `Meats-1.pdf`.</span></span> <span data-ttu-id="71d7e-251">Jeśli tak się stanie, spróbujemy `Meats-2.pdf`i tak dalej, aż zostanie znaleziona unikatowa nazwa pliku.</span><span class="sxs-lookup"><span data-stu-id="71d7e-251">If that exists, we'll try `Meats-2.pdf`, and so on, until a unique file name is found.</span></span>

<span data-ttu-id="71d7e-252">Poniższy kod używa [metody`File.Exists(path)`](https://msdn.microsoft.com/library/system.io.file.exists.aspx) , aby określić, czy plik już istnieje z określoną nazwą pliku.</span><span class="sxs-lookup"><span data-stu-id="71d7e-252">The following code uses the [`File.Exists(path)` method](https://msdn.microsoft.com/library/system.io.file.exists.aspx) to determine if a file already exists with the specified file name.</span></span> <span data-ttu-id="71d7e-253">W takim przypadku kontynuuje wypróbowanie nowych nazw plików dla broszury, dopóki nie zostanie znaleziony żaden konflikt.</span><span class="sxs-lookup"><span data-stu-id="71d7e-253">If so, it continues to try new file names for the brochure until no conflict is found.</span></span>

[!code-csharp[Main](including-a-file-upload-option-when-adding-a-new-record-cs/samples/sample7.cs)]

<span data-ttu-id="71d7e-254">Po znalezieniu prawidłowej nazwy pliku należy ją zapisać w systemie plików, a wartość elementu ObjectDataSource s `brochurePath``InsertParameter` należy zaktualizować, tak aby ta nazwa pliku była zapisywana w bazie danych.</span><span class="sxs-lookup"><span data-stu-id="71d7e-254">Once a valid file name has been found, the file needs to be saved to the file system and the ObjectDataSource s `brochurePath``InsertParameter` value needs to be updated so that this file name is written to the database.</span></span> <span data-ttu-id="71d7e-255">Po powrocie do samouczka *przekazywania plików* plik można zapisać przy użyciu metody FileUpload Control `SaveAs(path)`.</span><span class="sxs-lookup"><span data-stu-id="71d7e-255">As we saw back in the *Uploading Files* tutorial, the file can be saved using the FileUpload control s `SaveAs(path)` method.</span></span> <span data-ttu-id="71d7e-256">Aby zaktualizować parametr `brochurePath` ObjectDataSource, Użyj kolekcji `e.Values`.</span><span class="sxs-lookup"><span data-stu-id="71d7e-256">To update the ObjectDataSource s `brochurePath` parameter, use the `e.Values` collection.</span></span>

[!code-csharp[Main](including-a-file-upload-option-when-adding-a-new-record-cs/samples/sample8.cs)]

## <a name="step-7-saving-the-uploaded-picture-to-the-database"></a><span data-ttu-id="71d7e-257">Krok 7. zapisywanie przekazanego obrazu do bazy danych</span><span class="sxs-lookup"><span data-stu-id="71d7e-257">Step 7: Saving the Uploaded Picture to the Database</span></span>

<span data-ttu-id="71d7e-258">Aby zapisać przekazany obraz w nowym rekordzie `Categories`, musimy przypisać przekazaną zawartość binarną do parametru `picture` ObjectDataSource s w zdarzeniu `ItemInserting` DetailsView.</span><span class="sxs-lookup"><span data-stu-id="71d7e-258">To store the uploaded picture in the new `Categories` record, we need to assign the uploaded binary content to the ObjectDataSource s `picture` parameter in the DetailsView s `ItemInserting` event.</span></span> <span data-ttu-id="71d7e-259">Przed przystąpieniem do tego przydziału musimy najpierw upewnić się, że przekazany obraz jest w formacie JPG, a nie innym typem obrazu.</span><span class="sxs-lookup"><span data-stu-id="71d7e-259">Before we make this assignment, however, we need to first make sure that the uploaded picture is a JPG and not some other image type.</span></span> <span data-ttu-id="71d7e-260">Jak w kroku 6, użyj do tego celu, aby upewnić się, że jest używany przekazany rozszerzenie pliku obrazu s.</span><span class="sxs-lookup"><span data-stu-id="71d7e-260">As in Step 6, let s use the uploaded picture s file extension to ascertain its type.</span></span>

<span data-ttu-id="71d7e-261">Gdy tabela `Categories` umożliwia `NULL` wartości dla kolumny `Picture`, wszystkie kategorie mają obecnie obraz.</span><span class="sxs-lookup"><span data-stu-id="71d7e-261">While the `Categories` table allows `NULL` values for the `Picture` column, all categories currently have a picture.</span></span> <span data-ttu-id="71d7e-262">Pozwól, aby użytkownicy mogli dostarczyć zdjęcie podczas dodawania nowej kategorii za pomocą tej strony.</span><span class="sxs-lookup"><span data-stu-id="71d7e-262">Let s force the user to provide a picture when adding a new category through this page.</span></span> <span data-ttu-id="71d7e-263">Poniższy kod sprawdza, czy zdjęcie zostało przekazane i ma odpowiednie rozszerzenie.</span><span class="sxs-lookup"><span data-stu-id="71d7e-263">The following code checks to ensure that a picture has been uploaded and that it has an appropriate extension.</span></span>

[!code-csharp[Main](including-a-file-upload-option-when-adding-a-new-record-cs/samples/sample9.cs)]

<span data-ttu-id="71d7e-264">Ten kod powinien zostać umieszczony *przed* kodem z kroku 6, aby w przypadku wystąpienia problemu z przekazywaniem obrazu program obsługi zdarzeń zakończy działanie przed zapisaniem pliku broszury w systemie plików.</span><span class="sxs-lookup"><span data-stu-id="71d7e-264">This code should be placed *before* the code from Step 6 so that if there is a problem with the picture upload, the event handler will terminate before the brochure file is saved to the file system.</span></span>

<span data-ttu-id="71d7e-265">Przy założeniu, że został przekazany odpowiedni plik, przypisz przekazaną zawartość binarną do wartości parametru obrazu s następującym wierszem kodu:</span><span class="sxs-lookup"><span data-stu-id="71d7e-265">Assuming that an appropriate file has been uploaded, assign the uploaded binary content to the picture parameter s value with the following line of code:</span></span>

[!code-csharp[Main](including-a-file-upload-option-when-adding-a-new-record-cs/samples/sample10.cs)]

## <a name="the-completeiteminsertingevent-handler"></a><span data-ttu-id="71d7e-266">Kompletna procedura obsługi zdarzeń`ItemInserting`</span><span class="sxs-lookup"><span data-stu-id="71d7e-266">The Complete`ItemInserting`Event Handler</span></span>

<span data-ttu-id="71d7e-267">W pełni zamieszczono tutaj program obsługi zdarzeń `ItemInserting` w całości:</span><span class="sxs-lookup"><span data-stu-id="71d7e-267">For completeness, here is the `ItemInserting` event handler in its entirety:</span></span>

[!code-csharp[Main](including-a-file-upload-option-when-adding-a-new-record-cs/samples/sample11.cs)]

## <a name="step-8-fixing-thedisplaycategorypictureaspxpage"></a><span data-ttu-id="71d7e-268">Krok 8. naprawianie strony`DisplayCategoryPicture.aspx`</span><span class="sxs-lookup"><span data-stu-id="71d7e-268">Step 8: Fixing the`DisplayCategoryPicture.aspx`Page</span></span>

<span data-ttu-id="71d7e-269">Poświęć chwilę na przetestowanie procedury obsługi zdarzeń wstawiania interfejsu i `ItemInserting`, która została utworzona w ciągu ostatnich kilku kroków.</span><span class="sxs-lookup"><span data-stu-id="71d7e-269">Let s take a moment to test out the inserting interface and `ItemInserting` event handler that was created over the last few steps.</span></span> <span data-ttu-id="71d7e-270">Odwiedź stronę `UploadInDetailsView.aspx` za pomocą przeglądarki, a następnie spróbuj dodać kategorię, ale pominąć obraz lub określić obraz inny niż JPG lub broszurę bez formatu PDF.</span><span class="sxs-lookup"><span data-stu-id="71d7e-270">Visit the `UploadInDetailsView.aspx` page through a browser and attempt to add a category, but omit the picture, or specify a non-JPG picture or a non-PDF brochure.</span></span> <span data-ttu-id="71d7e-271">W każdym z tych przypadków zostanie wyświetlony komunikat o błędzie i anulowano przepływ pracy wstawiania.</span><span class="sxs-lookup"><span data-stu-id="71d7e-271">In any of these cases, an error message will be displayed and the insert workflow cancelled.</span></span>

<span data-ttu-id="71d7e-272">[![komunikat ostrzegawczy jest wyświetlany w przypadku przekazania nieprawidłowego typu pliku](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image9.gif)](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image15.png)</span><span class="sxs-lookup"><span data-stu-id="71d7e-272">[![A Warning Message is Displayed If an Invalid File Type is Uploaded](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image9.gif)](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image15.png)</span></span>

<span data-ttu-id="71d7e-273">**Rysunek 9**. po przekazaniu nieprawidłowego typu pliku jest wyświetlany komunikat ostrzegawczy ([kliknij, aby wyświetlić obraz o pełnym rozmiarze](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image16.png))</span><span class="sxs-lookup"><span data-stu-id="71d7e-273">**Figure 9**: A Warning Message is Displayed If an Invalid File Type is Uploaded ([Click to view full-size image](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image16.png))</span></span>

<span data-ttu-id="71d7e-274">Po sprawdzeniu, czy strona wymaga przekazanie obrazu i nie akceptuje plików innych niż pliki PDF lub innych niż JPG, Dodaj nową kategorię z prawidłowym obrazem JPG, pozostawiając pole Broszura puste.</span><span class="sxs-lookup"><span data-stu-id="71d7e-274">Once you have verified that the page requires a picture to be uploaded and won't accept non-PDF or non-JPG files, add a new category with a valid JPG picture, leaving the Brochure field empty.</span></span> <span data-ttu-id="71d7e-275">Po kliknięciu przycisku Wstaw strona zostanie odpisana ponownie i zostanie dodany nowy rekord do tabeli `Categories` z przekazaną zawartością binarną obrazu s przechowywaną bezpośrednio w bazie danych.</span><span class="sxs-lookup"><span data-stu-id="71d7e-275">After clicking the Insert button, the page will postback and a new record will be added to the `Categories` table with the uploaded image s binary contents stored directly in the database.</span></span> <span data-ttu-id="71d7e-276">Widok GridView jest aktualizowany i zawiera wiersz dla nowo dodanej kategorii, ale, jak rysunek 10 pokazuje, nowy obraz kategorii nie jest poprawnie renderowany.</span><span class="sxs-lookup"><span data-stu-id="71d7e-276">The GridView is updated and shows a row for the newly added category, but, as Figure 10 shows, the new category s picture is not rendered correctly.</span></span>

<span data-ttu-id="71d7e-277">[![nowy obraz kategorii s nie jest wyświetlany](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image10.gif)](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image17.png)</span><span class="sxs-lookup"><span data-stu-id="71d7e-277">[![The New Category s Picture is not Displayed](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image10.gif)](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image17.png)</span></span>

<span data-ttu-id="71d7e-278">**Ilustracja 10**. nowy obraz kategorii s nie jest wyświetlany ([kliknij, aby wyświetlić obraz o pełnym rozmiarze](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image18.png))</span><span class="sxs-lookup"><span data-stu-id="71d7e-278">**Figure 10**: The New Category s Picture is not Displayed ([Click to view full-size image](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image18.png))</span></span>

<span data-ttu-id="71d7e-279">Nie jest wyświetlany nowy obraz, ponieważ strona `DisplayCategoryPicture.aspx`, która zwraca określony obraz kategorii s, jest skonfigurowana do przetwarzania map bitowych, które mają nagłówek OLE.</span><span class="sxs-lookup"><span data-stu-id="71d7e-279">The reason the new picture is not displayed is because the `DisplayCategoryPicture.aspx` page that returns a specified category s picture is configured to process bitmaps that have an OLE header.</span></span> <span data-ttu-id="71d7e-280">Ten nagłówek bajtowy 78 jest usuwany z zawartości binarnej `Picture` kolumn przed wysłaniem ich z powrotem do klienta.</span><span class="sxs-lookup"><span data-stu-id="71d7e-280">This 78 byte header is stripped from the `Picture` column s binary contents before they are sent back to the client.</span></span> <span data-ttu-id="71d7e-281">Ale plik JPG, który został właśnie przekazany dla nowej kategorii nie ma tego nagłówka OLE; w związku z tym prawidłowe, niezbędne bajty są usuwane z danych binarnych obrazu.</span><span class="sxs-lookup"><span data-stu-id="71d7e-281">But the JPG file we just uploaded for the new category does not have this OLE header; therefore, valid, necessary bytes are being removed from the image s binary data.</span></span>

<span data-ttu-id="71d7e-282">Ponieważ istnieją teraz obie mapy bitowe z nagłówkami OLE i JPGs w tabeli `Categories`, należy zaktualizować `DisplayCategoryPicture.aspx` tak, aby oddzielać nagłówek OLE dla oryginalnych ośmiu kategorii i pomijał to odróżnienie w przypadku nowszych rekordów kategorii.</span><span class="sxs-lookup"><span data-stu-id="71d7e-282">Since there are now both bitmaps with OLE headers and JPGs in the `Categories` table, we need to update `DisplayCategoryPicture.aspx` so that it does the OLE header stripping for the original eight categories and bypasses this stripping for the newer category records.</span></span> <span data-ttu-id="71d7e-283">W naszym następnym samouczku sprawdzimy, jak zaktualizować istniejący obraz, i zaktualizujemy wszystkie stare obrazy kategorii, aby były JPGs.</span><span class="sxs-lookup"><span data-stu-id="71d7e-283">In our next tutorial we'll examine how to update an existing record s image, and we'll update all of the old category pictures so that they are JPGs.</span></span> <span data-ttu-id="71d7e-284">Na razie użyj poniższego kodu w `DisplayCategoryPicture.aspx`, aby rozdzielić nagłówki OLE tylko dla tych oryginalnych ośmiu kategorii:</span><span class="sxs-lookup"><span data-stu-id="71d7e-284">For now, though, use the following code in `DisplayCategoryPicture.aspx` to strip the OLE headers only for those original eight categories:</span></span>

[!code-csharp[Main](including-a-file-upload-option-when-adding-a-new-record-cs/samples/sample12.cs)]

<span data-ttu-id="71d7e-285">Po tej zmianie obraz JPG jest teraz renderowany prawidłowo w widoku GridView.</span><span class="sxs-lookup"><span data-stu-id="71d7e-285">With this change, the JPG image is now rendered correctly in the GridView.</span></span>

<span data-ttu-id="71d7e-286">[![obrazy JPG dla nowych kategorii są prawidłowo renderowane](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image11.gif)](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image19.png)</span><span class="sxs-lookup"><span data-stu-id="71d7e-286">[![The JPG Images for New Categories are Correctly Rendered](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image11.gif)](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image19.png)</span></span>

<span data-ttu-id="71d7e-287">**Ilustracja 11**. obrazy jpg dla nowych kategorii są poprawnie renderowane ([kliknij, aby wyświetlić obraz w pełnym rozmiarze](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image20.png))</span><span class="sxs-lookup"><span data-stu-id="71d7e-287">**Figure 11**: The JPG Images for New Categories are Correctly Rendered ([Click to view full-size image](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image20.png))</span></span>

## <a name="step-9-deleting-the-brochure-in-the-face-of-an-exception"></a><span data-ttu-id="71d7e-288">Krok 9. Usuwanie broszury na początku wyjątku</span><span class="sxs-lookup"><span data-stu-id="71d7e-288">Step 9: Deleting the Brochure in the Face of an Exception</span></span>

<span data-ttu-id="71d7e-289">Jednym z wyzwań związanych z przechowywaniem danych binarnych w systemie plików serwera sieci Web jest wprowadzenie rozłączenia między modelem danych i jego danymi binarnymi.</span><span class="sxs-lookup"><span data-stu-id="71d7e-289">One of the challenges of storing binary data on the web server s file system is that it introduces a disconnect between the data model and its binary data.</span></span> <span data-ttu-id="71d7e-290">W związku z tym, za każdym razem, gdy rekord zostanie usunięty, odpowiednie dane binarne w systemie plików również muszą zostać usunięte.</span><span class="sxs-lookup"><span data-stu-id="71d7e-290">Therefore, whenever a record is deleted, the corresponding binary data on the file system must also be removed.</span></span> <span data-ttu-id="71d7e-291">To może być również odtwarzany podczas wstawiania.</span><span class="sxs-lookup"><span data-stu-id="71d7e-291">This can come into play when inserting, as well.</span></span> <span data-ttu-id="71d7e-292">Rozważmy następujący scenariusz: użytkownik dodaje nową kategorię, określając prawidłowy obraz i broszurę.</span><span class="sxs-lookup"><span data-stu-id="71d7e-292">Consider the following scenario: a user adds a new category, specifying a valid picture and brochure.</span></span> <span data-ttu-id="71d7e-293">Po kliknięciu przycisku Wstaw następuje ogłaszanie zwrotne i wyzwalane jest zdarzenie `ItemInserting` DetailsView s, co umożliwia zapisanie broszury w systemie plików serwera sieci Web.</span><span class="sxs-lookup"><span data-stu-id="71d7e-293">Upon clicking the Insert button, a postback occurs and the DetailsView s `ItemInserting` event fires, saving the brochure to the web server s file system.</span></span> <span data-ttu-id="71d7e-294">Następnie wywoływana jest metoda `Insert()` ObjectDataSource s, która wywołuje metodę `InsertWithPicture` klasy `CategoriesBLL`, która wywołuje metodę `CategoriesTableAdapter` s `InsertWithPicture`.</span><span class="sxs-lookup"><span data-stu-id="71d7e-294">Next, the ObjectDataSource s `Insert()` method is invoked, which calls the `CategoriesBLL` class s `InsertWithPicture` method, which calls the `CategoriesTableAdapter` s `InsertWithPicture` method.</span></span>

<span data-ttu-id="71d7e-295">Co się stanie, jeśli baza danych jest w trybie offline lub wystąpi błąd w instrukcji `INSERT` SQL?</span><span class="sxs-lookup"><span data-stu-id="71d7e-295">Now, what happens if the database is offline, or if there is an error in the `INSERT` SQL statement?</span></span> <span data-ttu-id="71d7e-296">Wyraźnie Wstawianie zakończy się niepowodzeniem, dlatego do bazy danych nie zostanie dodany nowy wiersz kategorii.</span><span class="sxs-lookup"><span data-stu-id="71d7e-296">Clearly the INSERT will fail, so no new category row will be added to the database.</span></span> <span data-ttu-id="71d7e-297">Jednak nadal mamy załadowanego pliku broszury w systemie plików serwera sieci Web.</span><span class="sxs-lookup"><span data-stu-id="71d7e-297">But we still have the uploaded brochure file sitting on the web server s file system!</span></span> <span data-ttu-id="71d7e-298">Ten plik musi zostać usunięty z powodu wyjątku podczas wstawiania przepływu pracy.</span><span class="sxs-lookup"><span data-stu-id="71d7e-298">This file needs to be deleted in the face of an exception during the inserting workflow.</span></span>

<span data-ttu-id="71d7e-299">Jak opisano wcześniej w [obsłudze wyjątków logiki biznesowej i dal w samouczku dotyczącym strony ASP.NET](../editing-inserting-and-deleting-data/handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs.md) , gdy wyjątek jest zgłaszany z poziomu głębokości architektury, jest to możliwe za pośrednictwem różnych warstw.</span><span class="sxs-lookup"><span data-stu-id="71d7e-299">As discussed previously in the [Handling BLL- and DAL-Level Exceptions in an ASP.NET Page](../editing-inserting-and-deleting-data/handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs.md) tutorial, when an exception is thrown from within the depths of the architecture it is bubbled up through the various layers.</span></span> <span data-ttu-id="71d7e-300">W warstwie prezentacji możemy określić, czy wystąpił wyjątek ze zdarzenia `ItemInserted` DetailsView s.</span><span class="sxs-lookup"><span data-stu-id="71d7e-300">At the Presentation Layer, we can determine if an exception has occurred from the DetailsView s `ItemInserted` event.</span></span> <span data-ttu-id="71d7e-301">Ten program obsługi zdarzeń udostępnia również wartości `InsertParameters`ObjectDataSource.</span><span class="sxs-lookup"><span data-stu-id="71d7e-301">This event handler also provides the values of the ObjectDataSource s `InsertParameters`.</span></span> <span data-ttu-id="71d7e-302">W związku z tym możemy utworzyć procedurę obsługi zdarzeń dla zdarzenia `ItemInserted`, która sprawdza, czy wystąpił wyjątek i, jeśli tak, usuwa plik określony przez parametr `brochurePath` ObjectDataSource s:</span><span class="sxs-lookup"><span data-stu-id="71d7e-302">Therefore, we can create an event handler for the `ItemInserted` event that checks if there was an exception and, if so, deletes the file specified by the ObjectDataSource s `brochurePath` parameter:</span></span>

[!code-csharp[Main](including-a-file-upload-option-when-adding-a-new-record-cs/samples/sample13.cs)]

## <a name="summary"></a><span data-ttu-id="71d7e-303">Podsumowanie</span><span class="sxs-lookup"><span data-stu-id="71d7e-303">Summary</span></span>

<span data-ttu-id="71d7e-304">Istnieje kilka kroków, które należy wykonać, aby zapewnić interfejs oparty na sieci Web służący do dodawania rekordów zawierających dane binarne.</span><span class="sxs-lookup"><span data-stu-id="71d7e-304">There are a number of steps that must be performed in order to provide a web-based interface for adding records that include binary data.</span></span> <span data-ttu-id="71d7e-305">Jeśli dane binarne są przechowywane bezpośrednio w bazie danych programu, prawdopodobnie trzeba będzie zaktualizować architekturę, dodając konkretne metody do obsługi przypadku, w którym dane binarne są wstawiane.</span><span class="sxs-lookup"><span data-stu-id="71d7e-305">If the binary data is being stored directly into the database, chances are you'll need to update the architecture, adding specific methods to handle the case where binary data is being inserted.</span></span> <span data-ttu-id="71d7e-306">Po zaktualizowaniu architektury następnym krokiem jest utworzenie interfejsu wstawiania, który można wykonać przy użyciu widoku DetailsView, który został dostosowany do uwzględnienia kontrolki FileUpload dla każdego pola danych binarnych.</span><span class="sxs-lookup"><span data-stu-id="71d7e-306">Once the architecture has been updated, the next step is creating the inserting interface, which can be accomplished using a DetailsView that has been customized to include a FileUpload control for each binary data field.</span></span> <span data-ttu-id="71d7e-307">Przekazane dane można następnie zapisać w systemie plików serwera sieci Web lub przypisać do parametru źródła danych w programie obsługi zdarzeń w widoku DetailsView s `ItemInserting`.</span><span class="sxs-lookup"><span data-stu-id="71d7e-307">The uploaded data can then be saved to the web server s file system or assigned to a data source parameter in the DetailsView s `ItemInserting` event handler.</span></span>

<span data-ttu-id="71d7e-308">Zapisywanie danych binarnych w systemie plików wymaga większego planowania niż zapisywanie danych bezpośrednio w bazie danych.</span><span class="sxs-lookup"><span data-stu-id="71d7e-308">Saving binary data to the file system requires more planning than saving data directly into the database.</span></span> <span data-ttu-id="71d7e-309">Należy wybrać schemat nazewnictwa, aby uniknąć, że jeden użytkownik nie załaduje kolejnego elementu s.</span><span class="sxs-lookup"><span data-stu-id="71d7e-309">A naming scheme must be chosen in order to avoid one user s upload overwriting another s.</span></span> <span data-ttu-id="71d7e-310">Ponadto należy podjąć dodatkowe kroki w celu usunięcia przekazanego pliku, jeśli wstawienie bazy danych nie powiedzie się.</span><span class="sxs-lookup"><span data-stu-id="71d7e-310">Also, extra steps must be taken to delete the uploaded file if the database insert fails.</span></span>

<span data-ttu-id="71d7e-311">Mamy teraz możliwość dodawania nowych kategorii do systemu z broszurą i obrazem, ale jeszcze tu zawarto informacje na temat aktualizowania istniejących danych binarnych kategorii lub sposobu poprawnego usuwania danych binarnych dla usuniętej kategorii.</span><span class="sxs-lookup"><span data-stu-id="71d7e-311">We now have the ability to add new categories to the system with a brochure and picture, but we ve yet to look at how to update an existing category s binary data or how to correctly remove the binary data for a deleted category.</span></span> <span data-ttu-id="71d7e-312">Te dwa tematy zostaną omówione w następnym samouczku.</span><span class="sxs-lookup"><span data-stu-id="71d7e-312">We'll explore these two topics in the next tutorial.</span></span>

<span data-ttu-id="71d7e-313">Szczęśliwe programowanie!</span><span class="sxs-lookup"><span data-stu-id="71d7e-313">Happy Programming!</span></span>

## <a name="about-the-author"></a><span data-ttu-id="71d7e-314">Informacje o autorze</span><span class="sxs-lookup"><span data-stu-id="71d7e-314">About the Author</span></span>

<span data-ttu-id="71d7e-315">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml), autor siedmiu grup ASP/ASP. NET Books i założyciel of [4GuysFromRolla.com](http://www.4guysfromrolla.com), pracował z technologiami sieci Web firmy Microsoft od czasu 1998.</span><span class="sxs-lookup"><span data-stu-id="71d7e-315">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml), author of seven ASP/ASP.NET books and founder of [4GuysFromRolla.com](http://www.4guysfromrolla.com), has been working with Microsoft Web technologies since 1998.</span></span> <span data-ttu-id="71d7e-316">Scott działa jako niezależny konsultant, trainer i składnik zapisywania.</span><span class="sxs-lookup"><span data-stu-id="71d7e-316">Scott works as an independent consultant, trainer, and writer.</span></span> <span data-ttu-id="71d7e-317">Jego Najnowsza książka to [*Sams ASP.NET 2,0 w ciągu 24 godzin*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span><span class="sxs-lookup"><span data-stu-id="71d7e-317">His latest book is [*Sams Teach Yourself ASP.NET 2.0 in 24 Hours*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span></span> <span data-ttu-id="71d7e-318">Można go osiągnąć w [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="71d7e-318">He can be reached at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span> <span data-ttu-id="71d7e-319">lub za pośrednictwem swojego blogu, który można znaleźć w [http://ScottOnWriting.NET](http://ScottOnWriting.NET).</span><span class="sxs-lookup"><span data-stu-id="71d7e-319">or via his blog, which can be found at [http://ScottOnWriting.NET](http://ScottOnWriting.NET).</span></span>

## <a name="special-thanks-to"></a><span data-ttu-id="71d7e-320">Specjalne podziękowania</span><span class="sxs-lookup"><span data-stu-id="71d7e-320">Special Thanks To</span></span>

<span data-ttu-id="71d7e-321">Ta seria samouczków została sprawdzona przez wielu przydatnych recenzentów.</span><span class="sxs-lookup"><span data-stu-id="71d7e-321">This tutorial series was reviewed by many helpful reviewers.</span></span> <span data-ttu-id="71d7e-322">Recenzenci liderzy dla tego samouczka to Dave Gardner, Teresa Murphy i Bernadette Leigh.</span><span class="sxs-lookup"><span data-stu-id="71d7e-322">Lead reviewers for this tutorial were Dave Gardner, Teresa Murphy, and Bernadette Leigh.</span></span> <span data-ttu-id="71d7e-323">Chcesz przeglądać moje nadchodzące artykuły MSDN?</span><span class="sxs-lookup"><span data-stu-id="71d7e-323">Interested in reviewing my upcoming MSDN articles?</span></span> <span data-ttu-id="71d7e-324">Jeśli tak, upuść mi linię w [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="71d7e-324">If so, drop me a line at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span>

> [!div class="step-by-step"]
> <span data-ttu-id="71d7e-325">[Poprzednie](displaying-binary-data-in-the-data-web-controls-cs.md)
> [dalej](updating-and-deleting-existing-binary-data-cs.md)</span><span class="sxs-lookup"><span data-stu-id="71d7e-325">[Previous](displaying-binary-data-in-the-data-web-controls-cs.md)
[Next](updating-and-deleting-existing-binary-data-cs.md)</span></span>
