---
uid: web-forms/overview/data-access/accessing-the-database-directly-from-an-aspnet-page/implementing-optimistic-concurrency-with-the-sqldatasource-vb
title: Implementowanie optymistycznej współbieżności przy użyciu kontrolki SqlDataSource (VB) | Microsoft Docs
author: rick-anderson
description: W tym samouczku zapoznajemy podstawowe informacje o optymistycznej kontroli współbieżności, a następnie zapoznaj się z tematem, jak wdrożyć go przy użyciu formantu kontrolki SqlDataSource.
ms.author: riande
ms.date: 02/20/2007
ms.assetid: a8fa72ee-8328-4854-a419-c1b271772303
msc.legacyurl: /web-forms/overview/data-access/accessing-the-database-directly-from-an-aspnet-page/implementing-optimistic-concurrency-with-the-sqldatasource-vb
msc.type: authoredcontent
ms.openlocfilehash: 431734b5245c20ac840147cf0827fa7f8d1e4d17
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: pl-PL
ms.lasthandoff: 03/06/2020
ms.locfileid: "78553019"
---
# <a name="implementing-optimistic-concurrency-with-the-sqldatasource-vb"></a><span data-ttu-id="0157e-103">Implementowanie optymistycznej współbieżności przy użyciu kontrolki SqlDataSource (VB)</span><span class="sxs-lookup"><span data-stu-id="0157e-103">Implementing Optimistic Concurrency with the SqlDataSource (VB)</span></span>

<span data-ttu-id="0157e-104">przez [Scott Mitchell](https://twitter.com/ScottOnWriting)</span><span class="sxs-lookup"><span data-stu-id="0157e-104">by [Scott Mitchell](https://twitter.com/ScottOnWriting)</span></span>

<span data-ttu-id="0157e-105">[Pobierz przykładową aplikację](https://download.microsoft.com/download/4/a/7/4a7a3b18-d80e-4014-8e53-a6a2427f0d93/ASPNET_Data_Tutorial_50_VB.exe) lub [Pobierz plik PDF](implementing-optimistic-concurrency-with-the-sqldatasource-vb/_static/datatutorial50vb1.pdf)</span><span class="sxs-lookup"><span data-stu-id="0157e-105">[Download Sample App](https://download.microsoft.com/download/4/a/7/4a7a3b18-d80e-4014-8e53-a6a2427f0d93/ASPNET_Data_Tutorial_50_VB.exe) or [Download PDF](implementing-optimistic-concurrency-with-the-sqldatasource-vb/_static/datatutorial50vb1.pdf)</span></span>

> <span data-ttu-id="0157e-106">W tym samouczku zapoznajemy podstawowe informacje o optymistycznej kontroli współbieżności, a następnie zapoznaj się z tematem, jak wdrożyć go przy użyciu formantu kontrolki SqlDataSource.</span><span class="sxs-lookup"><span data-stu-id="0157e-106">In this tutorial we review the essentials of optimistic concurrency control and then explore how to implement it using the SqlDataSource control.</span></span>

## <a name="introduction"></a><span data-ttu-id="0157e-107">Wprowadzenie</span><span class="sxs-lookup"><span data-stu-id="0157e-107">Introduction</span></span>

<span data-ttu-id="0157e-108">W poprzednim samouczku sprawdzono, jak dodać funkcje wstawiania, aktualizowania i usuwania do kontrolki kontrolki SqlDataSource.</span><span class="sxs-lookup"><span data-stu-id="0157e-108">In the preceding tutorial we examined how to add inserting, updating, and deleting capabilities to the SqlDataSource control.</span></span> <span data-ttu-id="0157e-109">Krótko mówiąc, aby zapewnić te funkcje, które są potrzebne do określenia odpowiednich `INSERT`, `UPDATE`lub `DELETE` instrukcji SQL w obszarze Control s `InsertCommand`, `UpdateCommand`lub `DeleteCommand`, wraz z odpowiednimi parametrami w `InsertParameters`, `UpdateParameters`i `DeleteParameters` kolekcje.</span><span class="sxs-lookup"><span data-stu-id="0157e-109">In short, to provide these features we needed to specify the corresponding `INSERT`, `UPDATE`, or `DELETE` SQL statement in the control s `InsertCommand`, `UpdateCommand`, or `DeleteCommand` properties, along with the appropriate parameters in the `InsertParameters`, `UpdateParameters`, and `DeleteParameters` collections.</span></span> <span data-ttu-id="0157e-110">Mimo że te właściwości i Kolekcje można określić ręcznie, przycisk Zaawansowane Kreator konfigurowania źródła danych oferuje opcję Generuj `INSERT`, `UPDATE`i `DELETE` instrukcji, które będą automatycznie tworzyć te instrukcje na podstawie instrukcji `SELECT`.</span><span class="sxs-lookup"><span data-stu-id="0157e-110">While these properties and collections can be specified manually, the Configure Data Source wizard s Advanced button offers a Generate `INSERT`, `UPDATE`, and `DELETE` statements checkbox that will auto-create these statements based on the `SELECT` statement.</span></span>

<span data-ttu-id="0157e-111">Wraz z zaznaczeniem pola wyboru Generuj `INSERT`, `UPDATE`i `DELETE`, zaawansowane opcje generowania instrukcji SQL zawierają opcję Użyj optymistycznej współbieżności (patrz rysunek 1).</span><span class="sxs-lookup"><span data-stu-id="0157e-111">Along with the Generate `INSERT`, `UPDATE`, and `DELETE` statements checkbox, the Advanced SQL Generation Options dialog box includes a Use optimistic concurrency option (see Figure 1).</span></span> <span data-ttu-id="0157e-112">Po zaznaczeniu tej opcji klauzule `WHERE` w instrukcjach generowanych automatycznie `UPDATE` i `DELETE` są modyfikowane tak, aby wykonywały tylko aktualizację lub usuwanie, jeśli dane źródłowej bazy danych nie zostały zmodyfikowane od czasu ostatniego załadowania danych do siatki.</span><span class="sxs-lookup"><span data-stu-id="0157e-112">When checked, the `WHERE` clauses in the autogenerated `UPDATE` and `DELETE` statements are modified to only perform the update or delete if the underlying database data hasn't been modified since the user last loaded the data into the grid.</span></span>

![Możesz dodać optymistyczną obsługę współbieżności z okna dialogowego Zaawansowane opcje generowania kodu SQL](implementing-optimistic-concurrency-with-the-sqldatasource-vb/_static/image1.gif)

<span data-ttu-id="0157e-114">**Rysunek 1**: możesz dodać optymistyczną obsługę współbieżności z okna dialogowego Zaawansowane opcje generowania kodu SQL</span><span class="sxs-lookup"><span data-stu-id="0157e-114">**Figure 1**: You Can Add Optimistic Concurrency Support from the Advanced SQL Generation Options Dialog Box</span></span>

<span data-ttu-id="0157e-115">Z powrotem w samouczku [wdrażanie optymistycznej współbieżności](../editing-inserting-and-deleting-data/implementing-optimistic-concurrency-vb.md) zbadamy podstawy optymistycznej kontroli współbieżności i sposób dodawania jej do elementu ObjectDataSource.</span><span class="sxs-lookup"><span data-stu-id="0157e-115">Back in the [Implementing Optimistic Concurrency](../editing-inserting-and-deleting-data/implementing-optimistic-concurrency-vb.md) tutorial we examined the fundamentals of optimistic concurrency control and how to add it to the ObjectDataSource.</span></span> <span data-ttu-id="0157e-116">W tym samouczku powrócimy do podstawy optymistycznej kontroli współbieżności, a następnie Dowiedz się, jak zaimplementować ją przy użyciu kontrolki SqlDataSource.</span><span class="sxs-lookup"><span data-stu-id="0157e-116">In this tutorial we'll retouch on the essentials of optimistic concurrency control and then explore how to implement it using the SqlDataSource.</span></span>

## <a name="a-recap-of-optimistic-concurrency"></a><span data-ttu-id="0157e-117">Podsumowanie optymistycznej współbieżności</span><span class="sxs-lookup"><span data-stu-id="0157e-117">A Recap of Optimistic Concurrency</span></span>

<span data-ttu-id="0157e-118">W przypadku aplikacji sieci Web, które umożliwiają wielu użytkownikom jednoczesne edytowanie lub usuwanie tych samych danych, istnieje możliwość, że jeden użytkownik może przypadkowo zastąpić inne zmiany s.</span><span class="sxs-lookup"><span data-stu-id="0157e-118">For web applications that allow multiple, simultaneous users to edit or delete the same data, there exists a possibility that one user may accidentally overwrite another s changes.</span></span> <span data-ttu-id="0157e-119">W samouczku [wdrażanie optymistycznej współbieżności](../editing-inserting-and-deleting-data/implementing-optimistic-concurrency-vb.md) podano następujący przykład:</span><span class="sxs-lookup"><span data-stu-id="0157e-119">In the [Implementing Optimistic Concurrency](../editing-inserting-and-deleting-data/implementing-optimistic-concurrency-vb.md) tutorial I provided the following example:</span></span>

<span data-ttu-id="0157e-120">Załóżmy, że dwaj użytkownicy, Jisun i sam odwiedzają stronę w aplikacji, która umożliwia osobom odwiedzającym aktualizowanie i usuwanie produktów za pomocą kontrolki GridView.</span><span class="sxs-lookup"><span data-stu-id="0157e-120">Imagine that two users, Jisun and Sam, were both visiting a page in an application that allowed visitors to update and delete products through a GridView control.</span></span> <span data-ttu-id="0157e-121">W tym samym czasie kliknij przycisk Edytuj dla Chai.</span><span class="sxs-lookup"><span data-stu-id="0157e-121">Both click the Edit button for Chai around the same time.</span></span> <span data-ttu-id="0157e-122">Jisun zmienia nazwę produktu na Chai herbata i klika przycisk Aktualizuj.</span><span class="sxs-lookup"><span data-stu-id="0157e-122">Jisun changes the product name to Chai Tea and clicks the Update button.</span></span> <span data-ttu-id="0157e-123">Wynikiem sieci jest instrukcja `UPDATE`, która jest wysyłana do bazy danych, która ustawia *wszystkie* pola do zaktualizowania produktu (nawet jeśli Jisun tylko jedno pole, `ProductName`).</span><span class="sxs-lookup"><span data-stu-id="0157e-123">The net result is an `UPDATE` statement that is sent to the database, which sets *all* of the product s updateable fields (even though Jisun only updated one field, `ProductName`).</span></span> <span data-ttu-id="0157e-124">W tym momencie baza danych ma wartości Chai herbata, kategorie napoje, egzotyczne płyny i tak dalej dla tego konkretnego produktu.</span><span class="sxs-lookup"><span data-stu-id="0157e-124">At this point in time, the database has the values Chai Tea, the category Beverages, the supplier Exotic Liquids, and so on for this particular product.</span></span> <span data-ttu-id="0157e-125">Jednak widok GridView na ekranie sam s nadal pokazuje nazwę produktu w edytowalnym wierszu GridView jako Chai.</span><span class="sxs-lookup"><span data-stu-id="0157e-125">However, the GridView on Sam s screen still shows the product name in the editable GridView row as Chai.</span></span> <span data-ttu-id="0157e-126">Kilka sekund po zatwierdzeniu zmian Jisun s, sam aktualizuje kategorię do przypraw i klika przycisk Aktualizuj.</span><span class="sxs-lookup"><span data-stu-id="0157e-126">A few seconds after Jisun s changes have been committed, Sam updates the category to Condiments and clicks Update.</span></span> <span data-ttu-id="0157e-127">Spowoduje to wysłanie instrukcji `UPDATE` do bazy danych, która ustawia nazwę produktu na Chai, `CategoryID` do odpowiedniego identyfikatora kategorii przypraw i tak dalej.</span><span class="sxs-lookup"><span data-stu-id="0157e-127">This results in an `UPDATE` statement sent to the database that sets the product name to Chai, the `CategoryID` to the corresponding Condiments category ID, and so on.</span></span> <span data-ttu-id="0157e-128">Jisun s zmiany nazwy produktu zostały nadpisywane.</span><span class="sxs-lookup"><span data-stu-id="0157e-128">Jisun s changes to the product name have been overwritten.</span></span>

<span data-ttu-id="0157e-129">Na rysunku 2 przedstawiono tę interakcję.</span><span class="sxs-lookup"><span data-stu-id="0157e-129">Figure 2 illustrates this interaction.</span></span>

<span data-ttu-id="0157e-130">[![, gdy dwaj użytkownicy jednocześnie zaktualizują rekord, a potencjalne dla jednego użytkownika s zmienią się, aby zastąpić inne s](implementing-optimistic-concurrency-with-the-sqldatasource-vb/_static/image2.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-vb/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="0157e-130">[![When Two Users Simultaneously Update a Record There s Potential for One User s Changes to Overwrite the Other s](implementing-optimistic-concurrency-with-the-sqldatasource-vb/_static/image2.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-vb/_static/image1.png)</span></span>

<span data-ttu-id="0157e-131">**Rysunek 2**. gdy dwaj użytkownicy jednocześnie zaktualizują rekord, a potencjalne dla jednego użytkownika s zmienią się, aby zastąpić inne s ([kliknij, aby wyświetlić obraz w pełnym rozmiarze](implementing-optimistic-concurrency-with-the-sqldatasource-vb/_static/image2.png))</span><span class="sxs-lookup"><span data-stu-id="0157e-131">**Figure 2**: When Two Users Simultaneously Update a Record There s Potential for One User s Changes to Overwrite the Other s ([Click to view full-size image](implementing-optimistic-concurrency-with-the-sqldatasource-vb/_static/image2.png))</span></span>

<span data-ttu-id="0157e-132">Aby zapobiec niezgięciu tego scenariusza, należy zaimplementować formularz [kontroli współbieżności](http://en.wikipedia.org/wiki/Concurrency_control) .</span><span class="sxs-lookup"><span data-stu-id="0157e-132">To prevent this scenario from unfolding, a form of [concurrency control](http://en.wikipedia.org/wiki/Concurrency_control) must be implemented.</span></span> <span data-ttu-id="0157e-133">[Optymistyczne współbieżność](http://en.wikipedia.org/wiki/Optimistic_concurrency_control) ten samouczek działa w oparciu o założenie, że w tym czasie mogą wystąpić konflikty współbieżności co teraz, a następnie, większość czasu taka konfliktów nie będzie się powtarzać.</span><span class="sxs-lookup"><span data-stu-id="0157e-133">[Optimistic concurrency](http://en.wikipedia.org/wiki/Optimistic_concurrency_control) the focus of this tutorial works on the assumption that while there may be concurrency conflicts every now and then, the vast majority of the time such conflicts won't arise.</span></span> <span data-ttu-id="0157e-134">W związku z tym, jeśli wystąpi konflikt, optymistyczna kontrola współbieżności po prostu informuje użytkownika o tym, że zmiany mogą zostać zapisane, ponieważ inny użytkownik zmodyfikował te same dane.</span><span class="sxs-lookup"><span data-stu-id="0157e-134">Therefore, if a conflict does arise, optimistic concurrency control simply informs the user that their changes can t be saved because another user has modified the same data.</span></span>

> [!NOTE]
> <span data-ttu-id="0157e-135">W przypadku aplikacji, w których zakłada się, że wystąpią liczne konflikty współbieżności lub takie konflikty nie są dopuszczalne, zamiast tego można użyć metody pesymistycznej współbieżności.</span><span class="sxs-lookup"><span data-stu-id="0157e-135">For applications where it is assumed that there will be many concurrency conflicts or if such conflicts are not tolerable, then pessimistic concurrency control can be used instead.</span></span> <span data-ttu-id="0157e-136">Zapoznaj się z artykułem [wdrażanie optymistycznego samouczka współbieżności](../editing-inserting-and-deleting-data/implementing-optimistic-concurrency-vb.md) , aby zapoznać się z bardziej dokładną dyskusją na temat współbieżności na serwerze.</span><span class="sxs-lookup"><span data-stu-id="0157e-136">Refer back to the [Implementing Optimistic Concurrency](../editing-inserting-and-deleting-data/implementing-optimistic-concurrency-vb.md) tutorial for a more thorough discussion on pessimistic concurrency control.</span></span>

<span data-ttu-id="0157e-137">Optymistyczna kontrola współbieżności działa przez upewnienie się, że aktualizowany lub usuwany rekord ma takie same wartości jak w przypadku uruchomienia procesu aktualizowania lub usuwania.</span><span class="sxs-lookup"><span data-stu-id="0157e-137">Optimistic concurrency control works by ensuring that the record being updated or deleted has the same values as it did when the updating or deleting process started.</span></span> <span data-ttu-id="0157e-138">Na przykład po kliknięciu przycisku Edytuj w edytowalnym widoku GridView wartości rekordu s są odczytywane z bazy danych i wyświetlane w polach tekstowych i innych formantach sieci Web.</span><span class="sxs-lookup"><span data-stu-id="0157e-138">For example, when clicking the Edit button in an editable GridView, the record s values are read from the database and displayed in TextBoxes and other Web controls.</span></span> <span data-ttu-id="0157e-139">Te oryginalne wartości są zapisywane przez GridView.</span><span class="sxs-lookup"><span data-stu-id="0157e-139">These original values are saved by the GridView.</span></span> <span data-ttu-id="0157e-140">Później, po wprowadzeniu zmian przez użytkownika i kliknięciu przycisku Aktualizuj, użyta instrukcja `UPDATE` musi uwzględniać pierwotne wartości oraz nowe wartości i aktualizować rekord bazy danych tylko wtedy, gdy pierwotne wartości edytowane przez użytkownika są identyczne z wartościami nadal w bazie danych.</span><span class="sxs-lookup"><span data-stu-id="0157e-140">Later, after the user makes her changes and clicks the Update button, the `UPDATE` statement used must take into account the original values plus the new values and only update the underlying database record if the original values that the user started editing are identical to the values still in the database.</span></span> <span data-ttu-id="0157e-141">Rysunek 3 przedstawia tę sekwencję zdarzeń.</span><span class="sxs-lookup"><span data-stu-id="0157e-141">Figure 3 depicts this sequence of events.</span></span>

<span data-ttu-id="0157e-142">[Aby można było pomyślnie zaktualizować lub usunąć ![, oryginalne wartości muszą być równe bieżącym wartościom bazy danych](implementing-optimistic-concurrency-with-the-sqldatasource-vb/_static/image3.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-vb/_static/image3.png)</span><span class="sxs-lookup"><span data-stu-id="0157e-142">[![For the Update or Delete to Succeed, the Original Values Must Be Equal to the Current Database Values](implementing-optimistic-concurrency-with-the-sqldatasource-vb/_static/image3.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-vb/_static/image3.png)</span></span>

<span data-ttu-id="0157e-143">**Rysunek 3**. Aby pomyślnie zaktualizować lub usunąć, oryginalne wartości muszą być równe bieżącym wartościom bazy danych ([kliknij, aby wyświetlić obraz o pełnym rozmiarze](implementing-optimistic-concurrency-with-the-sqldatasource-vb/_static/image4.png))</span><span class="sxs-lookup"><span data-stu-id="0157e-143">**Figure 3**: For the Update or Delete to Succeed, the Original Values Must Be Equal to the Current Database Values ([Click to view full-size image](implementing-optimistic-concurrency-with-the-sqldatasource-vb/_static/image4.png))</span></span>

<span data-ttu-id="0157e-144">Istnieją różne podejścia do implementowania optymistycznej współbieżności (zobacz "Bromberg" [optymistycznej logiki aktualizacji współbieżności](http://www.eggheadcafe.com/articles/20050719.asp) [,](http://peterbromberg.net/)aby skrócić kilka opcji).</span><span class="sxs-lookup"><span data-stu-id="0157e-144">There are various approaches to implementing optimistic concurrency (see [Peter A. Bromberg](http://peterbromberg.net/)'s [Optimistic Concurrency Updating Logic](http://www.eggheadcafe.com/articles/20050719.asp) for a brief look at a number of options).</span></span> <span data-ttu-id="0157e-145">Technika używana przez kontrolki SqlDataSource (a także przez zestawy danych typu ADO.NET używany w naszej warstwie dostępu do danych) rozszerza klauzulę `WHERE` w celu uwzględnienia porównania wszystkich oryginalnych wartości.</span><span class="sxs-lookup"><span data-stu-id="0157e-145">The technique used by the SqlDataSource (as well as by the ADO.NET Typed DataSets used in our Data Access Layer) augments the `WHERE` clause to include a comparison of all of the original values.</span></span> <span data-ttu-id="0157e-146">Poniższa instrukcja `UPDATE`, na przykład aktualizuje nazwę i cenę produktu, tylko wtedy, gdy bieżące wartości bazy danych są równe wartościom, które zostały pierwotnie pobrane podczas aktualizowania rekordu w widoku GridView.</span><span class="sxs-lookup"><span data-stu-id="0157e-146">The following `UPDATE` statement, for example, updates the name and price of a product only if the current database values are equal to the values that were originally retrieved when updating the record in the GridView.</span></span> <span data-ttu-id="0157e-147">Parametry `@ProductName` i `@UnitPrice` zawierają nowe wartości wprowadzone przez użytkownika, natomiast `@original_ProductName` i `@original_UnitPrice` zawierają wartości, które zostały początkowo załadowane do widoku GridView po kliknięciu przycisku Edytuj:</span><span class="sxs-lookup"><span data-stu-id="0157e-147">The `@ProductName` and `@UnitPrice` parameters contain the new values entered by the user, whereas `@original_ProductName` and `@original_UnitPrice` contain the values that were originally loaded into the GridView when the Edit button was clicked:</span></span>

[!code-sql[Main](implementing-optimistic-concurrency-with-the-sqldatasource-vb/samples/sample1.sql)]

<span data-ttu-id="0157e-148">Jak zobaczymy w tym samouczku, włączenie optymistycznej kontroli współbieżności za pomocą kontrolki SqlDataSource jest tak proste jak zaznaczenie pola wyboru.</span><span class="sxs-lookup"><span data-stu-id="0157e-148">As we'll see in this tutorial, enabling optimistic concurrency control with the SqlDataSource is as simple as checking a checkbox.</span></span>

## <a name="step-1-creating-a-sqldatasource-that-supports-optimistic-concurrency"></a><span data-ttu-id="0157e-149">Krok 1. Tworzenie elementu kontrolki SqlDataSource z obsługą optymistycznej współbieżności</span><span class="sxs-lookup"><span data-stu-id="0157e-149">Step 1: Creating a SqlDataSource that Supports Optimistic Concurrency</span></span>

<span data-ttu-id="0157e-150">Zacznij od otwarcia strony `OptimisticConcurrency.aspx` z folderu `SqlDataSource`.</span><span class="sxs-lookup"><span data-stu-id="0157e-150">Start by opening the `OptimisticConcurrency.aspx` page from the `SqlDataSource` folder.</span></span> <span data-ttu-id="0157e-151">Przeciągnij formant kontrolki SqlDataSource z przybornika do projektanta, ustawienia jego właściwości `ID`, aby `ProductsDataSourceWithOptimisticConcurrency`.</span><span class="sxs-lookup"><span data-stu-id="0157e-151">Drag a SqlDataSource control from the Toolbox onto the Designer, settings its `ID` property to `ProductsDataSourceWithOptimisticConcurrency`.</span></span> <span data-ttu-id="0157e-152">Następnie kliknij link Konfiguruj źródło danych z tagu inteligentnego sterowanie s.</span><span class="sxs-lookup"><span data-stu-id="0157e-152">Next, click on the Configure Data Source link from the control s smart tag.</span></span> <span data-ttu-id="0157e-153">Na pierwszym ekranie kreatora wybierz opcję pracy z `NORTHWINDConnectionString` i kliknij przycisk Dalej.</span><span class="sxs-lookup"><span data-stu-id="0157e-153">From the first screen in the wizard, choose to work with the `NORTHWINDConnectionString` and click Next.</span></span>

<span data-ttu-id="0157e-154">[![wybrać NORTHWINDConnectionString](implementing-optimistic-concurrency-with-the-sqldatasource-vb/_static/image4.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-vb/_static/image5.png)</span><span class="sxs-lookup"><span data-stu-id="0157e-154">[![Choose to Work with the NORTHWINDConnectionString](implementing-optimistic-concurrency-with-the-sqldatasource-vb/_static/image4.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-vb/_static/image5.png)</span></span>

<span data-ttu-id="0157e-155">**Ilustracja 4**. Wybierz, aby współpracować z `NORTHWINDConnectionString` ([kliknij, aby wyświetlić obraz o pełnym rozmiarze](implementing-optimistic-concurrency-with-the-sqldatasource-vb/_static/image6.png))</span><span class="sxs-lookup"><span data-stu-id="0157e-155">**Figure 4**: Choose to Work with the `NORTHWINDConnectionString` ([Click to view full-size image](implementing-optimistic-concurrency-with-the-sqldatasource-vb/_static/image6.png))</span></span>

<span data-ttu-id="0157e-156">Na potrzeby tego przykładu dodamy widok GridView, który umożliwi użytkownikom edytowanie tabeli `Products`.</span><span class="sxs-lookup"><span data-stu-id="0157e-156">For this example we'll be adding a GridView that enables users to edit the `Products` table.</span></span> <span data-ttu-id="0157e-157">W związku z tym, na ekranie Konfigurowanie instrukcji SELECT wybierz tabelę `Products` z listy rozwijanej i wybierz kolumny `ProductID`, `ProductName`, `UnitPrice`i `Discontinued`, jak pokazano na rysunku 5.</span><span class="sxs-lookup"><span data-stu-id="0157e-157">Therefore, from the Configure the Select Statement screen, choose the `Products` table from the drop-down list and select the `ProductID`, `ProductName`, `UnitPrice`, and `Discontinued` columns, as shown in Figure 5.</span></span>

<span data-ttu-id="0157e-158">[![z tabeli Products (produkty) Zwróć kolumny IDProduktu, ProductName, CenaJednostkowa i uncontinued](implementing-optimistic-concurrency-with-the-sqldatasource-vb/_static/image5.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-vb/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="0157e-158">[![From the Products Table, Return the ProductID, ProductName, UnitPrice, and Discontinued Columns](implementing-optimistic-concurrency-with-the-sqldatasource-vb/_static/image5.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-vb/_static/image7.png)</span></span>

<span data-ttu-id="0157e-159">**Rysunek 5**. z tabeli `Products` zwróć kolumny `ProductID`, `ProductName`, `UnitPrice`i `Discontinued` ([kliknij, aby wyświetlić obraz o pełnym rozmiarze](implementing-optimistic-concurrency-with-the-sqldatasource-vb/_static/image8.png))</span><span class="sxs-lookup"><span data-stu-id="0157e-159">**Figure 5**: From the `Products` Table, Return the `ProductID`, `ProductName`, `UnitPrice`, and `Discontinued` Columns ([Click to view full-size image](implementing-optimistic-concurrency-with-the-sqldatasource-vb/_static/image8.png))</span></span>

<span data-ttu-id="0157e-160">Po wybraniu kolumn kliknij przycisk Zaawansowane, aby wyświetlić okno dialogowe Zaawansowane opcje generowania bazy danych SQL.</span><span class="sxs-lookup"><span data-stu-id="0157e-160">After picking the columns, click the Advanced button to bring up the Advanced SQL Generation Options dialog box.</span></span> <span data-ttu-id="0157e-161">Sprawdź instrukcje Generate `INSERT`, `UPDATE`i `DELETE` i użyj optymistycznych pól wyboru współbieżności, a następnie kliknij przycisk OK (zapoznaj się z powrotem do rysunku 1 w przypadku zrzutu ekranu).</span><span class="sxs-lookup"><span data-stu-id="0157e-161">Check the Generate `INSERT`, `UPDATE`, and `DELETE` statements and Use optimistic concurrency checkboxes and click OK (refer back to Figure 1 for a screenshot).</span></span> <span data-ttu-id="0157e-162">Ukończ pracę kreatora, klikając przycisk Dalej, a następnie przycisk Zakończ.</span><span class="sxs-lookup"><span data-stu-id="0157e-162">Complete the wizard by clicking Next, then Finish.</span></span>

<span data-ttu-id="0157e-163">Po zakończeniu działania Kreatora konfiguracji źródła danych Poświęć chwilę, aby przeanalizować wyniki `DeleteCommand` i `UpdateCommand`, a `DeleteParameters` i `UpdateParameters` kolekcje.</span><span class="sxs-lookup"><span data-stu-id="0157e-163">After completing the Configure Data Source wizard, take a moment to examine the resulting `DeleteCommand` and `UpdateCommand` properties and the `DeleteParameters` and `UpdateParameters` collections.</span></span> <span data-ttu-id="0157e-164">Najprostszym sposobem jest kliknięcie karty Źródło w lewym dolnym rogu, aby wyświetlić składnię deklaratywną strony.</span><span class="sxs-lookup"><span data-stu-id="0157e-164">The easiest way to do this is to click on the Source tab in the lower left corner to see the page s declarative syntax.</span></span> <span data-ttu-id="0157e-165">Znajdziesz `UpdateCommand` wartość:</span><span class="sxs-lookup"><span data-stu-id="0157e-165">There you will find an `UpdateCommand` value of:</span></span>

[!code-sql[Main](implementing-optimistic-concurrency-with-the-sqldatasource-vb/samples/sample2.sql)]

<span data-ttu-id="0157e-166">Z siedem parametrów w kolekcji `UpdateParameters`:</span><span class="sxs-lookup"><span data-stu-id="0157e-166">With seven parameters in the `UpdateParameters` collection:</span></span>

[!code-aspx[Main](implementing-optimistic-concurrency-with-the-sqldatasource-vb/samples/sample3.aspx)]

<span data-ttu-id="0157e-167">Podobnie Właściwość `DeleteCommand` i kolekcja `DeleteParameters` powinny wyglądać następująco:</span><span class="sxs-lookup"><span data-stu-id="0157e-167">Similarly, the `DeleteCommand` property and `DeleteParameters` collection should look like the following:</span></span>

[!code-sql[Main](implementing-optimistic-concurrency-with-the-sqldatasource-vb/samples/sample4.sql)]

[!code-aspx[Main](implementing-optimistic-concurrency-with-the-sqldatasource-vb/samples/sample5.aspx)]

<span data-ttu-id="0157e-168">Oprócz rozszerzania `WHERE` klauzule `UpdateCommand` i `DeleteCommand` właściwości (i dodawania dodatkowych parametrów do odpowiednich kolekcji parametrów), wybranie opcji Użyj optymistycznej współbieżności dostosowuje dwie inne właściwości:</span><span class="sxs-lookup"><span data-stu-id="0157e-168">In addition to augmenting the `WHERE` clauses of the `UpdateCommand` and `DeleteCommand` properties (and adding the additional parameters to the respective parameter collections), selecting the Use optimistic concurrency option adjusts two other properties:</span></span>

- <span data-ttu-id="0157e-169">Zmienia [właściwość`ConflictDetection`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.sqldatasource.conflictdetection.aspx) z `OverwriteChanges` (domyślnie) na `CompareAllValues`</span><span class="sxs-lookup"><span data-stu-id="0157e-169">Changes the [`ConflictDetection` property](https://msdn.microsoft.com/library/system.web.ui.webcontrols.sqldatasource.conflictdetection.aspx) from `OverwriteChanges` (the default) to `CompareAllValues`</span></span>
- <span data-ttu-id="0157e-170">Zmienia [właściwość`OldValuesParameterFormatString`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.sqldatasource.oldvaluesparameterformatstring.aspx) z {0} (domyślnie) na oryginalny\_{0}.</span><span class="sxs-lookup"><span data-stu-id="0157e-170">Changes the [`OldValuesParameterFormatString` property](https://msdn.microsoft.com/library/system.web.ui.webcontrols.sqldatasource.oldvaluesparameterformatstring.aspx) from {0} (the default) to original\_{0} .</span></span>

<span data-ttu-id="0157e-171">Gdy formant sieci Web danych wywołuje metodę kontrolki SqlDataSource `Update()` lub `Delete()`, zostanie ona przekazana do oryginalnych wartości.</span><span class="sxs-lookup"><span data-stu-id="0157e-171">When the data Web control invokes the SqlDataSource s `Update()` or `Delete()` method, it passes in the original values.</span></span> <span data-ttu-id="0157e-172">Jeśli właściwość kontrolki SqlDataSource s `ConflictDetection` jest ustawiona na `CompareAllValues`, te oryginalne wartości zostaną dodane do polecenia.</span><span class="sxs-lookup"><span data-stu-id="0157e-172">If the SqlDataSource s `ConflictDetection` property is set to `CompareAllValues`, these original values are added to the command.</span></span> <span data-ttu-id="0157e-173">Właściwość `OldValuesParameterFormatString` zapewnia wzorzec nazewnictwa używany dla tych oryginalnych parametrów wartości.</span><span class="sxs-lookup"><span data-stu-id="0157e-173">The `OldValuesParameterFormatString` property provides the naming pattern used for these original value parameters.</span></span> <span data-ttu-id="0157e-174">Kreator konfiguracji źródła danych używa oryginalnego\_{0} i nazwy każdego oryginalnego parametru w `UpdateCommand` i `DeleteCommand` właściwości oraz `UpdateParameters` i `DeleteParameters` kolekcje.</span><span class="sxs-lookup"><span data-stu-id="0157e-174">The Configure Data Source wizard uses original\_{0} and names each original parameter in the `UpdateCommand` and `DeleteCommand` properties and `UpdateParameters` and `DeleteParameters` collections accordingly.</span></span>

> [!NOTE]
> <span data-ttu-id="0157e-175">Ponieważ nie korzystamy z funkcji kontrolki SqlDataSource Control s, możesz usunąć Właściwość `InsertCommand` i jej kolekcję `InsertParameters`.</span><span class="sxs-lookup"><span data-stu-id="0157e-175">Since we re not using the SqlDataSource control s inserting capabilities, feel free to remove the `InsertCommand` property and its `InsertParameters` collection.</span></span>

## <a name="correctly-handlingnullvalues"></a><span data-ttu-id="0157e-176">Prawidłowe obsługiwanie wartości`NULL`</span><span class="sxs-lookup"><span data-stu-id="0157e-176">Correctly Handling`NULL`Values</span></span>

<span data-ttu-id="0157e-177">Niestety, rozszerzone `UPDATE` i `DELETE` są automatycznie generowane przez Kreatora konfiguracji źródła danych, gdy użycie optymistycznej współbieżności *nie* współdziała z rekordami zawierającymi wartości `NULL`.</span><span class="sxs-lookup"><span data-stu-id="0157e-177">Unfortunately, the augmented `UPDATE` and `DELETE` statements autogenerated by the Configure Data Source wizard when using optimistic concurrency do *not* work with records that contain `NULL` values.</span></span> <span data-ttu-id="0157e-178">Aby zobaczyć dlaczego, weź pod uwagę nasze kontrolki SqlDataSource `UpdateCommand`:</span><span class="sxs-lookup"><span data-stu-id="0157e-178">To see why, consider our SqlDataSource s `UpdateCommand`:</span></span>

[!code-sql[Main](implementing-optimistic-concurrency-with-the-sqldatasource-vb/samples/sample6.sql)]

<span data-ttu-id="0157e-179">Kolumna `UnitPrice` w tabeli `Products` może mieć wartości `NULL`.</span><span class="sxs-lookup"><span data-stu-id="0157e-179">The `UnitPrice` column in the `Products` table can have `NULL` values.</span></span> <span data-ttu-id="0157e-180">Jeśli konkretny rekord ma `NULL` wartość dla `UnitPrice`, `[UnitPrice] = @original_UnitPrice` klauzula `WHERE` jest *zawsze* Szacowana jako FAŁSZ, ponieważ `NULL = NULL` zawsze zwróci wartość false.</span><span class="sxs-lookup"><span data-stu-id="0157e-180">If a particular record has a `NULL` value for `UnitPrice`, the `WHERE` clause portion `[UnitPrice] = @original_UnitPrice` will *always* evaluate to False because `NULL = NULL` always returns False.</span></span> <span data-ttu-id="0157e-181">W związku z tym rekordy, które zawierają wartości `NULL` nie mogą być edytowane ani usuwane, ponieważ `WHERE` instrukcje `UPDATE` i `DELETE` nie zwracają żadnych wierszy do zaktualizowania lub usunięcia.</span><span class="sxs-lookup"><span data-stu-id="0157e-181">Therefore, records that contain `NULL` values cannot be edited or deleted, as the `UPDATE` and `DELETE` statements `WHERE` clauses won't return any rows to update or delete.</span></span>

> [!NOTE]
> <span data-ttu-id="0157e-182">Ta usterka została po raz pierwszy zgłoszona firmie Microsoft w czerwcu z 2004 w [kontrolki SqlDataSource generuje nieprawidłowe instrukcje SQL](https://connect.microsoft.com/VisualStudio/feedback/ViewFeedback.aspx?FeedbackID=93937) i reportedly zaplanowana w następnej wersji ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="0157e-182">This bug was first reported to Microsoft in June of 2004 in [SqlDataSource Generates Incorrect SQL Statements](https://connect.microsoft.com/VisualStudio/feedback/ViewFeedback.aspx?FeedbackID=93937) and is reportedly scheduled to be fixed in the next version of ASP.NET.</span></span>

<span data-ttu-id="0157e-183">Aby rozwiązać ten problem, należy ręcznie zaktualizować klauzule `WHERE` we właściwościach `UpdateCommand` i `DeleteCommand` dla **wszystkich** kolumn, które mogą mieć `NULL` wartości.</span><span class="sxs-lookup"><span data-stu-id="0157e-183">To fix this, we have to manually update the `WHERE` clauses in both the `UpdateCommand` and `DeleteCommand` properties for **all** columns that can have `NULL` values.</span></span> <span data-ttu-id="0157e-184">Ogólnie rzecz biorąc Zmień `[ColumnName] = @original_ColumnName` na:</span><span class="sxs-lookup"><span data-stu-id="0157e-184">In general, change `[ColumnName] = @original_ColumnName` to:</span></span>

[!code-sql[Main](implementing-optimistic-concurrency-with-the-sqldatasource-vb/samples/sample7.sql)]

<span data-ttu-id="0157e-185">Tę modyfikację można wykonać bezpośrednio za pośrednictwem znaczników deklaratywnych za pomocą opcji UpdateQuery lub DeleteQuery z okno Właściwości lub za pomocą kart UPDATE i DELETE w polu Określ niestandardową instrukcję SQL lub procedurę składowaną w obszarze Konfigurowanie danych Kreator źródła.</span><span class="sxs-lookup"><span data-stu-id="0157e-185">This modification can be made directly through the declarative markup, via the UpdateQuery or DeleteQuery options from the Properties window, or through the UPDATE and DELETE tabs in the Specify a custom SQL statement or stored procedure option in the Configure Data Source wizard.</span></span> <span data-ttu-id="0157e-186">Ponownie należy wprowadzić tę modyfikację dla *każdej* kolumny w `UpdateCommand` i `DeleteCommand` s `WHERE`, która może zawierać `NULL` wartości.</span><span class="sxs-lookup"><span data-stu-id="0157e-186">Again, this modification must be made for *every* column in the `UpdateCommand` and `DeleteCommand` s `WHERE` clause that can contain `NULL` values.</span></span>

<span data-ttu-id="0157e-187">Zastosowanie tego do naszego przykładu spowoduje zmodyfikowanie następujących wartości `UpdateCommand` i `DeleteCommand`:</span><span class="sxs-lookup"><span data-stu-id="0157e-187">Applying this to our example results in the following modified `UpdateCommand` and `DeleteCommand` values:</span></span>

[!code-sql[Main](implementing-optimistic-concurrency-with-the-sqldatasource-vb/samples/sample8.sql)]

## <a name="step-2-adding-a-gridview-with-edit-and-delete-options"></a><span data-ttu-id="0157e-188">Krok 2. Dodawanie widoku GridView z opcjami edycji i usuwania</span><span class="sxs-lookup"><span data-stu-id="0157e-188">Step 2: Adding a GridView with Edit and Delete Options</span></span>

<span data-ttu-id="0157e-189">Kontrolki SqlDataSource skonfigurowany do obsługi optymistycznej współbieżności, to wszystko, co ma na celu dodanie kontrolki sieci Web danych do strony, która korzysta z tej kontroli współbieżności.</span><span class="sxs-lookup"><span data-stu-id="0157e-189">With the SqlDataSource configured to support optimistic concurrency, all that remains is to add a data Web control to the page that utilizes this concurrency control.</span></span> <span data-ttu-id="0157e-190">Na potrzeby tego samouczka Dodaj widok GridView, który zapewnia funkcje edycji i usuwania.</span><span class="sxs-lookup"><span data-stu-id="0157e-190">For this tutorial, let s add a GridView that provides both edit and delete functionality.</span></span> <span data-ttu-id="0157e-191">Aby to osiągnąć, przeciągnij widok GridView z przybornika do projektanta i ustaw jego `ID` na `Products`.</span><span class="sxs-lookup"><span data-stu-id="0157e-191">To accomplish this, drag a GridView from the Toolbox onto the Designer and set its `ID` to `Products`.</span></span> <span data-ttu-id="0157e-192">W tagu inteligentnym GridView powiąż go z `ProductsDataSourceWithOptimisticConcurrency` kontrolką kontrolki SqlDataSource dodaną w kroku 1.</span><span class="sxs-lookup"><span data-stu-id="0157e-192">From the GridView s smart tag, bind it to the `ProductsDataSourceWithOptimisticConcurrency` SqlDataSource control added in Step 1.</span></span> <span data-ttu-id="0157e-193">Na koniec sprawdź opcje Włącz edytowanie i Włącz usuwanie z tagu inteligentnego.</span><span class="sxs-lookup"><span data-stu-id="0157e-193">Finally, check the Enable Editing and Enable Deleting options from the smart tag.</span></span>

<span data-ttu-id="0157e-194">[![powiązać widok GridView z kontrolki SqlDataSource i Włącz edytowanie i usuwanie](implementing-optimistic-concurrency-with-the-sqldatasource-vb/_static/image6.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-vb/_static/image9.png)</span><span class="sxs-lookup"><span data-stu-id="0157e-194">[![Bind the GridView to the SqlDataSource and Enable Editing and Deleting](implementing-optimistic-concurrency-with-the-sqldatasource-vb/_static/image6.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-vb/_static/image9.png)</span></span>

<span data-ttu-id="0157e-195">**Ilustracja 6**. powiązanie widoku GridView z kontrolki SqlDataSource i włączanie edytowania i usuwania ([kliknij, aby wyświetlić obraz w pełnym rozmiarze](implementing-optimistic-concurrency-with-the-sqldatasource-vb/_static/image10.png))</span><span class="sxs-lookup"><span data-stu-id="0157e-195">**Figure 6**: Bind the GridView to the SqlDataSource and Enable Editing and Deleting ([Click to view full-size image](implementing-optimistic-concurrency-with-the-sqldatasource-vb/_static/image10.png))</span></span>

<span data-ttu-id="0157e-196">Po dodaniu widoku GridView skonfiguruj jego wygląd, usuwając `ProductID` BoundField, zmieniając właściwość `ProductName` BoundField s `HeaderText` na produkt i aktualizując `UnitPrice` BoundField tak, aby jej Właściwość `HeaderText` była po prostu cena.</span><span class="sxs-lookup"><span data-stu-id="0157e-196">After adding the GridView, configure its appearance by removing the `ProductID` BoundField, changing the `ProductName` BoundField s `HeaderText` property to Product, and updating the `UnitPrice` BoundField so that its `HeaderText` property is simply Price.</span></span> <span data-ttu-id="0157e-197">W idealnym przypadku ulepszamy interfejs edycji tak, aby zawierał RequiredFieldValidator dla wartości `ProductName` i CompareValidator dla wartości `UnitPrice` (w celu zapewnienia, że s ma poprawnie sformatowaną wartość liczbową).</span><span class="sxs-lookup"><span data-stu-id="0157e-197">Ideally, we d enhance the editing interface to include a RequiredFieldValidator for the `ProductName` value and a CompareValidator for the `UnitPrice` value (to ensure it s a properly formatted numeric value).</span></span> <span data-ttu-id="0157e-198">Zapoznaj się z samouczkiem [Dostosowywanie interfejsu modyfikacji danych,](../editing-inserting-and-deleting-data/customizing-the-data-modification-interface-vb.md) aby zapoznać się z bardziej szczegółowymi krokami dostosowywania interfejsu edytowania GridView.</span><span class="sxs-lookup"><span data-stu-id="0157e-198">Refer to the [Customizing the Data Modification Interface](../editing-inserting-and-deleting-data/customizing-the-data-modification-interface-vb.md) tutorial for a more in-depth look at customizing the GridView s editing interface.</span></span>

> [!NOTE]
> <span data-ttu-id="0157e-199">Stan widoku GridView s musi być włączony, ponieważ oryginalne wartości przesłane z widoku GridView do kontrolki SqlDataSource są przechowywane w stanie widoku.</span><span class="sxs-lookup"><span data-stu-id="0157e-199">The GridView s view state must be enabled since the original values passed from the GridView to the SqlDataSource are stored in view state.</span></span>

<span data-ttu-id="0157e-200">Po wprowadzeniu tych zmian do widoku GridView, znaczniki deklaracyjne i kontrolki SqlDataSource, powinny wyglądać podobnie do następujących:</span><span class="sxs-lookup"><span data-stu-id="0157e-200">After making these modifications to the GridView, the GridView and SqlDataSource declarative markup should look similar to the following:</span></span>

[!code-aspx[Main](implementing-optimistic-concurrency-with-the-sqldatasource-vb/samples/sample9.aspx)]

<span data-ttu-id="0157e-201">Aby wyświetlić optymistyczną kontrolę współbieżności w akcji, Otwórz dwa okna przeglądarki i Załaduj stronę `OptimisticConcurrency.aspx` w obu.</span><span class="sxs-lookup"><span data-stu-id="0157e-201">To see the optimistic concurrency control in action, open two browser windows and load the `OptimisticConcurrency.aspx` page in both.</span></span> <span data-ttu-id="0157e-202">Kliknij przyciski edycji pierwszego produktu w obu przeglądarkach.</span><span class="sxs-lookup"><span data-stu-id="0157e-202">Click on the Edit buttons for the first product in both browsers.</span></span> <span data-ttu-id="0157e-203">W jednej przeglądarce Zmień nazwę produktu, a następnie kliknij przycisk Aktualizuj.</span><span class="sxs-lookup"><span data-stu-id="0157e-203">In one browser, change the product name and click Update.</span></span> <span data-ttu-id="0157e-204">Przeglądarka będzie ogłaszać zwrotnie, a widok GridView powróci do trybu sprzed edycji, pokazując nową nazwę produktu dla edytowanego właśnie rekordu.</span><span class="sxs-lookup"><span data-stu-id="0157e-204">The browser will postback and the GridView will return to its pre-editing mode, showing the new product name for the record just edited.</span></span>

<span data-ttu-id="0157e-205">W drugim oknie przeglądarki Zmień cenę (ale pozostaw nazwę produktu jako oryginalną), a następnie kliknij przycisk Aktualizuj.</span><span class="sxs-lookup"><span data-stu-id="0157e-205">In the second browser window, change the price (but leave the product name as its original value) and click Update.</span></span> <span data-ttu-id="0157e-206">Na stronie ogłaszania zwrotnego siatka powraca do trybu sprzed edycji, ale zmiana ceny nie jest zarejestrowana.</span><span class="sxs-lookup"><span data-stu-id="0157e-206">On postback, the grid returns to its pre-editing mode, but the change to the price is not recorded.</span></span> <span data-ttu-id="0157e-207">Druga przeglądarka pokazuje taką samą wartość jak pierwsza Nowa nazwa produktu ze starą ceną.</span><span class="sxs-lookup"><span data-stu-id="0157e-207">The second browser shows the same value as the first one the new product name with the old price.</span></span> <span data-ttu-id="0157e-208">Zmiany wprowadzone w drugim oknie przeglądarki zostały utracone.</span><span class="sxs-lookup"><span data-stu-id="0157e-208">The changes made in the second browser window were lost.</span></span> <span data-ttu-id="0157e-209">Ponadto zmiany zostały utracone w sposób cichy, ponieważ nie wystąpił wyjątek lub komunikat informujący o tym, że wystąpiło naruszenie współbieżności.</span><span class="sxs-lookup"><span data-stu-id="0157e-209">Moreover, the changes were lost rather quietly, as there was no exception or message indicating that a concurrency violation just occurred.</span></span>

<span data-ttu-id="0157e-210">[![zmiany w drugim oknie przeglądarki zostały utracone w trybie dyskretnym](implementing-optimistic-concurrency-with-the-sqldatasource-vb/_static/image7.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-vb/_static/image11.png)</span><span class="sxs-lookup"><span data-stu-id="0157e-210">[![The Changes in the Second Browser Window Were Silently Lost](implementing-optimistic-concurrency-with-the-sqldatasource-vb/_static/image7.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-vb/_static/image11.png)</span></span>

<span data-ttu-id="0157e-211">**Rysunek 7**. zmiany w drugim oknie przeglądarki zostały utracone w trybie dyskretnym ([kliknij, aby wyświetlić obraz o pełnym rozmiarze](implementing-optimistic-concurrency-with-the-sqldatasource-vb/_static/image12.png))</span><span class="sxs-lookup"><span data-stu-id="0157e-211">**Figure 7**: The Changes in the Second Browser Window Were Silently Lost ([Click to view full-size image](implementing-optimistic-concurrency-with-the-sqldatasource-vb/_static/image12.png))</span></span>

<span data-ttu-id="0157e-212">Powód, dla którego nie zostały zatwierdzone zmiany w przeglądarce s, jest to spowodowane tym, że klauzula `UPDATE` s `WHERE` odfiltrowana wszystkie rekordy i w związku z tym nie ma wpływu na żadne wiersze.</span><span class="sxs-lookup"><span data-stu-id="0157e-212">The reason why the second browser s changes were not committed was because the `UPDATE` statement s `WHERE` clause filtered out all records and therefore did not affect any rows.</span></span> <span data-ttu-id="0157e-213">Pozwól, aby ponownie przyjrzeć się instrukcji `UPDATE`:</span><span class="sxs-lookup"><span data-stu-id="0157e-213">Let s look at the `UPDATE` statement again:</span></span>

[!code-sql[Main](implementing-optimistic-concurrency-with-the-sqldatasource-vb/samples/sample10.sql)]

<span data-ttu-id="0157e-214">Gdy drugie okno przeglądarki aktualizuje rekord, oryginalna nazwa produktu określona w klauzuli `WHERE` nie pasuje do istniejącej nazwy produktu (ponieważ została zmieniona przez pierwszą przeglądarkę).</span><span class="sxs-lookup"><span data-stu-id="0157e-214">When the second browser window updates the record, the original product name specified in the `WHERE` clause doesn t match up with the existing product name (since it was changed by the first browser).</span></span> <span data-ttu-id="0157e-215">W związku z tym, instrukcja `[ProductName] = @original_ProductName` zwraca wartość false, a `UPDATE` nie ma wpływu na żadne rekordy.</span><span class="sxs-lookup"><span data-stu-id="0157e-215">Therefore, the statement `[ProductName] = @original_ProductName` returns False, and the `UPDATE` does not affect any records.</span></span>

> [!NOTE]
> <span data-ttu-id="0157e-216">Usuwanie działa w ten sam sposób.</span><span class="sxs-lookup"><span data-stu-id="0157e-216">Delete works in the same manner.</span></span> <span data-ttu-id="0157e-217">Po otwarciu dwóch okien przeglądarki Zacznij od edycji danego produktu z jednym, a następnie zapisując zmiany.</span><span class="sxs-lookup"><span data-stu-id="0157e-217">With two browser windows open, start by editing a given product with one, and then saving its changes.</span></span> <span data-ttu-id="0157e-218">Po zapisaniu zmian w jednej przeglądarce kliknij przycisk Usuń dla tego samego produktu w drugim.</span><span class="sxs-lookup"><span data-stu-id="0157e-218">After saving the changes in the one browser, click the Delete button for the same product in the other.</span></span> <span data-ttu-id="0157e-219">Ponieważ oryginalne wartości nie są zgodne z klauzulą `DELETE` instrukcji s `WHERE`, usuwanie dyskretne zakończy się niepowodzeniem.</span><span class="sxs-lookup"><span data-stu-id="0157e-219">Since the original values don t match up in the `DELETE` statement s `WHERE` clause, the delete silently fails.</span></span>

<span data-ttu-id="0157e-220">Z perspektywy użytkownika końcowego w drugim oknie przeglądarki po kliknięciu przycisku Aktualizuj siatka wraca do trybu sprzed edycji, ale ich zmiany zostały utracone.</span><span class="sxs-lookup"><span data-stu-id="0157e-220">From the end user s perspective in the second browser window, after clicking the Update button the grid returns to the pre-editing mode, but their changes were lost.</span></span> <span data-ttu-id="0157e-221">Nie ma jednak żadnych opinii wizualnych, że ich zmiany nie zostały nalepki.</span><span class="sxs-lookup"><span data-stu-id="0157e-221">However, there s no visual feedback that their changes didn't stick.</span></span> <span data-ttu-id="0157e-222">W idealnym przypadku, jeśli zmiany użytkownika s zostaną utracone do naruszenia współbieżności, powiadomemy o nich i, prawdopodobnie, Zachowaj siatkę w trybie edycji.</span><span class="sxs-lookup"><span data-stu-id="0157e-222">Ideally, if a user s changes are lost to a concurrency violation, we d notify them and, perhaps, keep the grid in edit mode.</span></span> <span data-ttu-id="0157e-223">Poinformuj o tym, jak to zrobić.</span><span class="sxs-lookup"><span data-stu-id="0157e-223">Let s look at how to accomplish this.</span></span>

## <a name="step-3-determining-when-a-concurrency-violation-has-occurred"></a><span data-ttu-id="0157e-224">Krok 3. Określanie, kiedy nastąpiło naruszenie współbieżności</span><span class="sxs-lookup"><span data-stu-id="0157e-224">Step 3: Determining When a Concurrency Violation Has Occurred</span></span>

<span data-ttu-id="0157e-225">Ponieważ naruszenie współbieżności odrzuci wprowadzone zmiany, warto ostrzec użytkownika o wystąpieniu naruszenia współbieżności.</span><span class="sxs-lookup"><span data-stu-id="0157e-225">Since a concurrency violation rejects the changes one has made, it would be nice to alert the user when a concurrency violation has occurred.</span></span> <span data-ttu-id="0157e-226">Aby ostrzec użytkownika, Dodaj kontrolkę sieci Web etykieta w górnej części strony o nazwie `ConcurrencyViolationMessage` której Właściwość `Text` wyświetla następujący komunikat: podjęto próbę zaktualizowania lub usunięcia rekordu, który został jednocześnie zaktualizowany przez innego użytkownika.</span><span class="sxs-lookup"><span data-stu-id="0157e-226">To alert the user, let s add a Label Web control to the top of the page named `ConcurrencyViolationMessage` whose `Text` property displays the following message: You have attempted to update or delete a record that was simultaneously updated by another user.</span></span> <span data-ttu-id="0157e-227">Przejrzyj zmiany wprowadzone przez innych użytkowników, a następnie ponów próbę aktualizacji lub usunięcia.</span><span class="sxs-lookup"><span data-stu-id="0157e-227">Please review the other user's changes and then redo your update or delete.</span></span> <span data-ttu-id="0157e-228">Ustaw właściwość kontrolki etykieta `CssClass` na ostrzeżenie, która jest klasą CSS zdefiniowaną w `Styles.css`, która wyświetla tekst w kolorze czerwonym, kursywą, pogrubioną i dużą czcionką.</span><span class="sxs-lookup"><span data-stu-id="0157e-228">Set the Label control s `CssClass` property to Warning, which is a CSS class defined in `Styles.css` that displays text in a red, italic, bold, and large font.</span></span> <span data-ttu-id="0157e-229">Na koniec ustaw właściwości label-`Visible` i `EnableViewState` na `False`.</span><span class="sxs-lookup"><span data-stu-id="0157e-229">Finally, set the Label s `Visible` and `EnableViewState` properties to `False`.</span></span> <span data-ttu-id="0157e-230">Spowoduje to ukrycie etykiety z wyjątkiem tych ogłaszania zwrotnego, w przypadku których jawnie ustawimy Właściwość `Visible` na `True`.</span><span class="sxs-lookup"><span data-stu-id="0157e-230">This will hide the Label except for only those postbacks where we explicitly set its `Visible` property to `True`.</span></span>

<span data-ttu-id="0157e-231">[![dodać kontrolkę etykieta do strony, aby wyświetlić ostrzeżenie](implementing-optimistic-concurrency-with-the-sqldatasource-vb/_static/image8.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-vb/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="0157e-231">[![Add a Label Control to the Page to Display the Warning](implementing-optimistic-concurrency-with-the-sqldatasource-vb/_static/image8.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-vb/_static/image13.png)</span></span>

<span data-ttu-id="0157e-232">**Ilustracja 8**. Dodawanie kontrolki etykieta do strony, aby wyświetlić ostrzeżenie ([kliknij, aby wyświetlić obraz o pełnym rozmiarze](implementing-optimistic-concurrency-with-the-sqldatasource-vb/_static/image14.png))</span><span class="sxs-lookup"><span data-stu-id="0157e-232">**Figure 8**: Add a Label Control to the Page to Display the Warning ([Click to view full-size image](implementing-optimistic-concurrency-with-the-sqldatasource-vb/_static/image14.png))</span></span>

<span data-ttu-id="0157e-233">Podczas przeprowadzania aktualizacji lub usuwania programy obsługi zdarzeń GridView `RowUpdated` i `RowDeleted` są uruchamiane po przeprowadzeniu przez kontrolę źródła danych żądanej aktualizacji lub usunięcia.</span><span class="sxs-lookup"><span data-stu-id="0157e-233">When performing an update or delete, the GridView s `RowUpdated` and `RowDeleted` event handlers fire after its data source control has performed the requested update or delete.</span></span> <span data-ttu-id="0157e-234">Możemy określić liczbę wierszy, na które miało wpływ operacja z tych programów obsługi zdarzeń.</span><span class="sxs-lookup"><span data-stu-id="0157e-234">We can determine how many rows were affected by the operation from these event handlers.</span></span> <span data-ttu-id="0157e-235">Jeśli miało to wartość zero, chcemy wyświetlić etykietę `ConcurrencyViolationMessage`.</span><span class="sxs-lookup"><span data-stu-id="0157e-235">If zero rows were affected, we want to display the `ConcurrencyViolationMessage` Label.</span></span>

<span data-ttu-id="0157e-236">Utwórz procedurę obsługi zdarzeń dla zdarzeń `RowUpdated` i `RowDeleted` i Dodaj następujący kod:</span><span class="sxs-lookup"><span data-stu-id="0157e-236">Create an event handler for both the `RowUpdated` and `RowDeleted` events and add the following code:</span></span>

[!code-vb[Main](implementing-optimistic-concurrency-with-the-sqldatasource-vb/samples/sample11.vb)]

<span data-ttu-id="0157e-237">W obu obsłudze zdarzeń sprawdzimy Właściwość `e.AffectedRows` i, jeśli jest równa 0, ustaw właściwość `ConcurrencyViolationMessage` etykieta s `Visible` na `True`.</span><span class="sxs-lookup"><span data-stu-id="0157e-237">In both event handlers we check the `e.AffectedRows` property and, if it equals 0, set the `ConcurrencyViolationMessage` Label s `Visible` property to `True`.</span></span> <span data-ttu-id="0157e-238">W obsłudze zdarzeń `RowUpdated` poinstruujmy również GridView, aby pozostały w trybie edycji, ustawiając właściwość `KeepInEditMode` na true.</span><span class="sxs-lookup"><span data-stu-id="0157e-238">In the `RowUpdated` event handler, we also instruct the GridView to stay in edit mode by setting the `KeepInEditMode` property to true.</span></span> <span data-ttu-id="0157e-239">W tym celu należy ponownie powiązać dane z siatką, tak aby inne dane użytkownika zostały załadowane do interfejsu edycji.</span><span class="sxs-lookup"><span data-stu-id="0157e-239">In doing so, we need to rebind the data to the grid so that the other user s data is loaded into the editing interface.</span></span> <span data-ttu-id="0157e-240">W tym celu należy wywołać metodę `DataBind()` GridView.</span><span class="sxs-lookup"><span data-stu-id="0157e-240">This is accomplished by calling the GridView s `DataBind()` method.</span></span>

<span data-ttu-id="0157e-241">Jak pokazano na rysunku 9, za każdym razem, gdy występuje naruszenie współbieżności, zostanie wyświetlony komunikat z tymi dwoma obsłudze zdarzeń.</span><span class="sxs-lookup"><span data-stu-id="0157e-241">As Figure 9 shows, with these two event handlers, a very noticeable message is displayed whenever a concurrency violation occurs.</span></span>

<span data-ttu-id="0157e-242">[![komunikat jest wyświetlany w przypadku naruszenia współbieżności](implementing-optimistic-concurrency-with-the-sqldatasource-vb/_static/image9.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-vb/_static/image15.png)</span><span class="sxs-lookup"><span data-stu-id="0157e-242">[![A Message is Displayed in the Face of a Concurrency Violation](implementing-optimistic-concurrency-with-the-sqldatasource-vb/_static/image9.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-vb/_static/image15.png)</span></span>

<span data-ttu-id="0157e-243">**Ilustracja 9**. komunikat jest wyświetlany w przypadku naruszenia współbieżności ([kliknij, aby wyświetlić obraz o pełnym rozmiarze](implementing-optimistic-concurrency-with-the-sqldatasource-vb/_static/image16.png))</span><span class="sxs-lookup"><span data-stu-id="0157e-243">**Figure 9**: A Message is Displayed in the Face of a Concurrency Violation ([Click to view full-size image](implementing-optimistic-concurrency-with-the-sqldatasource-vb/_static/image16.png))</span></span>

## <a name="summary"></a><span data-ttu-id="0157e-244">Podsumowanie</span><span class="sxs-lookup"><span data-stu-id="0157e-244">Summary</span></span>

<span data-ttu-id="0157e-245">Podczas tworzenia aplikacji sieci Web, w której wielu równoczesnych użytkowników może edytować te same dane, ważne jest, aby wziąć pod uwagę opcje kontroli współbieżności.</span><span class="sxs-lookup"><span data-stu-id="0157e-245">When creating a web application where multiple, concurrent users may be editing the same data, it is important to consider concurrency control options.</span></span> <span data-ttu-id="0157e-246">Domyślnie kontrolki sieci Web ASP.NET danych i kontrolki źródła danych nie używają żadnej kontroli współbieżności.</span><span class="sxs-lookup"><span data-stu-id="0157e-246">By default, the ASP.NET data Web controls and data source controls do not employ any concurrency control.</span></span> <span data-ttu-id="0157e-247">Jak zostało to opisane w tym samouczku, implementacja optymistycznej kontroli współbieżności za pomocą kontrolki SqlDataSource jest stosunkowo szybka i łatwa.</span><span class="sxs-lookup"><span data-stu-id="0157e-247">As we saw in this tutorial, implementing optimistic concurrency control with the SqlDataSource is relatively quick and easy.</span></span> <span data-ttu-id="0157e-248">Kontrolki SqlDataSource obsługuje większość żmudne zadania dla dodawania rozszerzonych klauzul `WHERE` do `UPDATE` automatycznie generowanych instrukcji i `DELETE`, ale istnieje kilka subtleties w obsłudze kolumn wartości `NULL`, zgodnie z opisem w sekcji prawidłowe obsługiwane wartości `NULL`.</span><span class="sxs-lookup"><span data-stu-id="0157e-248">The SqlDataSource handles most of the legwork for your adding augmented `WHERE` clauses to the autogenerated `UPDATE` and `DELETE` statements but there are a few subtleties in handling `NULL` value columns, as discussed in the Correctly Handling `NULL` Values section.</span></span>

<span data-ttu-id="0157e-249">W tym samouczku zakończymy nasze badanie kontrolki SqlDataSource.</span><span class="sxs-lookup"><span data-stu-id="0157e-249">This tutorial concludes our examination of the SqlDataSource.</span></span> <span data-ttu-id="0157e-250">Nasze pozostałe samouczki powracają do pracy z danymi przy użyciu warstwy ObjectDataSource i warstwowej.</span><span class="sxs-lookup"><span data-stu-id="0157e-250">Our remaining tutorials will return to working with data using the ObjectDataSource and tiered architecture.</span></span>

<span data-ttu-id="0157e-251">Szczęśliwe programowanie!</span><span class="sxs-lookup"><span data-stu-id="0157e-251">Happy Programming!</span></span>

## <a name="about-the-author"></a><span data-ttu-id="0157e-252">Informacje o autorze</span><span class="sxs-lookup"><span data-stu-id="0157e-252">About the Author</span></span>

<span data-ttu-id="0157e-253">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml), autor siedmiu grup ASP/ASP. NET Books i założyciel of [4GuysFromRolla.com](http://www.4guysfromrolla.com), pracował z technologiami sieci Web firmy Microsoft od czasu 1998.</span><span class="sxs-lookup"><span data-stu-id="0157e-253">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml), author of seven ASP/ASP.NET books and founder of [4GuysFromRolla.com](http://www.4guysfromrolla.com), has been working with Microsoft Web technologies since 1998.</span></span> <span data-ttu-id="0157e-254">Scott działa jako niezależny konsultant, trainer i składnik zapisywania.</span><span class="sxs-lookup"><span data-stu-id="0157e-254">Scott works as an independent consultant, trainer, and writer.</span></span> <span data-ttu-id="0157e-255">Jego Najnowsza książka to [*Sams ASP.NET 2,0 w ciągu 24 godzin*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span><span class="sxs-lookup"><span data-stu-id="0157e-255">His latest book is [*Sams Teach Yourself ASP.NET 2.0 in 24 Hours*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span></span> <span data-ttu-id="0157e-256">Można go osiągnąć w [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="0157e-256">He can be reached at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span> <span data-ttu-id="0157e-257">lub za pośrednictwem swojego blogu, który można znaleźć w [http://ScottOnWriting.NET](http://ScottOnWriting.NET).</span><span class="sxs-lookup"><span data-stu-id="0157e-257">or via his blog, which can be found at [http://ScottOnWriting.NET](http://ScottOnWriting.NET).</span></span>

> [!div class="step-by-step"]
> [<span data-ttu-id="0157e-258">Wstecz</span><span class="sxs-lookup"><span data-stu-id="0157e-258">Previous</span></span>](inserting-updating-and-deleting-data-with-the-sqldatasource-vb.md)
