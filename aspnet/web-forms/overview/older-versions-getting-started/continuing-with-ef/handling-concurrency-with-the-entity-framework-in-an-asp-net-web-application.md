---
uid: web-forms/overview/older-versions-getting-started/continuing-with-ef/handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application
title: Obsługa współbieżności z Entity Framework 4,0 w aplikacji sieci Web ASP.NET 4 | Microsoft Docs
author: tdykstra
description: Ta seria samouczków jest oparta na aplikacji sieci Web firmy Contoso University, utworzonej przez Wprowadzenie z serią samouczków Entity Framework 4,0. I...
ms.author: riande
ms.date: 01/26/2011
ms.assetid: a5aa22a6-fb7f-4f41-9c7f-addda151940b
msc.legacyurl: /web-forms/overview/older-versions-getting-started/continuing-with-ef/handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application
msc.type: authoredcontent
ms.openlocfilehash: 3df5f7d9c8fb22e1ea34fe16560bdb9a1309bb56
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: pl-PL
ms.lasthandoff: 03/06/2020
ms.locfileid: "78632588"
---
# <a name="handling-concurrency-with-the-entity-framework-40-in-an-aspnet-4-web-application"></a><span data-ttu-id="3c4ce-104">Obsługa współbieżności z Entity Framework 4,0 w aplikacji sieci Web ASP.NET 4</span><span class="sxs-lookup"><span data-stu-id="3c4ce-104">Handling Concurrency with the Entity Framework 4.0 in an ASP.NET 4 Web Application</span></span>

<span data-ttu-id="3c4ce-105">Autor [Dykstra](https://github.com/tdykstra)</span><span class="sxs-lookup"><span data-stu-id="3c4ce-105">by [Tom Dykstra](https://github.com/tdykstra)</span></span>

> <span data-ttu-id="3c4ce-106">Ta seria samouczków jest oparta na aplikacji sieci Web firmy Contoso University, utworzonej przez Wprowadzenie z serią samouczków [Entity Framework 4,0](https://asp.net/entity-framework/tutorials#Getting%20Started) .</span><span class="sxs-lookup"><span data-stu-id="3c4ce-106">This tutorial series builds on the Contoso University web application that is created by the [Getting Started with the Entity Framework 4.0](https://asp.net/entity-framework/tutorials#Getting%20Started) tutorial series.</span></span> <span data-ttu-id="3c4ce-107">Jeśli wcześniej samouczki nie zostały wykonane, jako punkt wyjścia dla tego samouczka możesz [pobrać utworzoną aplikację](https://code.msdn.microsoft.com/ASPNET-Web-Forms-97f8ee9a) .</span><span class="sxs-lookup"><span data-stu-id="3c4ce-107">If you didn't complete the earlier tutorials, as a starting point for this tutorial you can [download the application](https://code.msdn.microsoft.com/ASPNET-Web-Forms-97f8ee9a) that you would have created.</span></span> <span data-ttu-id="3c4ce-108">Możesz również [pobrać aplikację](https://code.msdn.microsoft.com/ASPNET-Web-Forms-6c7197aa) utworzoną przez kompletną serię samouczków.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-108">You can also [download the application](https://code.msdn.microsoft.com/ASPNET-Web-Forms-6c7197aa) that is created by the complete tutorial series.</span></span> <span data-ttu-id="3c4ce-109">Jeśli masz pytania dotyczące samouczków, możesz je ogłosić na [forum ASP.NET Entity Framework](https://forums.asp.net/1227.aspx).</span><span class="sxs-lookup"><span data-stu-id="3c4ce-109">If you have questions about the tutorials, you can post them to the [ASP.NET Entity Framework forum](https://forums.asp.net/1227.aspx).</span></span>

<span data-ttu-id="3c4ce-110">W poprzednim samouczku przedstawiono sposób sortowania i filtrowania danych przy użyciu kontrolki `ObjectDataSource` i Entity Framework.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-110">In the previous tutorial you learned how to sort and filter data using the `ObjectDataSource` control and the Entity Framework.</span></span> <span data-ttu-id="3c4ce-111">W tym samouczku przedstawiono opcje obsługi współbieżności w aplikacji sieci Web ASP.NET, która używa Entity Framework.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-111">This tutorial shows options for handling concurrency in an ASP.NET web application that uses the Entity Framework.</span></span> <span data-ttu-id="3c4ce-112">Zostanie utworzona nowa strona sieci Web, która jest przeznaczona do aktualizowania przypisań biurowych.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-112">You will create a new web page that's dedicated to updating instructor office assignments.</span></span> <span data-ttu-id="3c4ce-113">Na tej stronie można obsługiwać problemy współbieżności i na utworzonej wcześniej stronie działów.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-113">You'll handle concurrency issues in that page and in the Departments page that you created earlier.</span></span>

<span data-ttu-id="3c4ce-114">[![Image06](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image2.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="3c4ce-114">[![Image06](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image2.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image1.png)</span></span>

<span data-ttu-id="3c4ce-115">[![Image01](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image4.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image3.png)</span><span class="sxs-lookup"><span data-stu-id="3c4ce-115">[![Image01](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image4.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image3.png)</span></span>

## <a name="concurrency-conflicts"></a><span data-ttu-id="3c4ce-116">Konflikty współbieżności</span><span class="sxs-lookup"><span data-stu-id="3c4ce-116">Concurrency Conflicts</span></span>

<span data-ttu-id="3c4ce-117">Konflikt współbieżności występuje, gdy jeden użytkownik edytuje rekord, a inny użytkownik edytuje ten sam rekord przed zapisaniem zmiany pierwszego użytkownika w bazie danych.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-117">A concurrency conflict occurs when one user edits a record and another user edits the same record before the first user's change is written to the database.</span></span> <span data-ttu-id="3c4ce-118">Jeśli Entity Framework nie zostanie skonfigurowana w celu wykrywania takich konfliktów, osoba, która zaktualizuje bazę danych, zastępuje zmiany wprowadzone przez innych użytkowników.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-118">If you don't set up the Entity Framework to detect such conflicts, whoever updates the database last overwrites the other user's changes.</span></span> <span data-ttu-id="3c4ce-119">W wielu aplikacjach to ryzyko jest akceptowalne i nie trzeba konfigurować aplikacji tak, aby obsługiwała potencjalne konflikty współbieżności.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-119">In many applications, this risk is acceptable, and you don't have to configure the application to handle possible concurrency conflicts.</span></span> <span data-ttu-id="3c4ce-120">(Jeśli istnieje kilku użytkowników lub kilka aktualizacji lub jeśli nie jest to naprawdę krytyczne, jeśli niektóre zmiany zostaną nadpisywane, koszty programowania współbieżności mogą być większe.) Jeśli nie musisz martwić się o konflikty współbieżności, możesz pominąć ten samouczek. Pozostałe dwa samouczki w serii nie zależą od elementów, które są kompilowane w tym elemencie.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-120">(If there are few users, or few updates, or if isn't really critical if some changes are overwritten, the cost of programming for concurrency might outweigh the benefit.) If you don't need to worry about concurrency conflicts, you can skip this tutorial; the remaining two tutorials in the series don't depend on anything you build in this one.</span></span>

### <a name="pessimistic-concurrency-locking"></a><span data-ttu-id="3c4ce-121">Współbieżność pesymistyczna (blokowanie)</span><span class="sxs-lookup"><span data-stu-id="3c4ce-121">Pessimistic Concurrency (Locking)</span></span>

<span data-ttu-id="3c4ce-122">Jeśli aplikacja musi zapobiegać przypadkowej utracie danych w scenariuszach współbieżności, jeden ze sposobów jest używany do blokowania baz danych.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-122">If your application does need to prevent accidental data loss in concurrency scenarios, one way to do that is to use database locks.</span></span> <span data-ttu-id="3c4ce-123">Jest to nazywane *pesymistyczną współbieżnością*.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-123">This is called *pessimistic concurrency*.</span></span> <span data-ttu-id="3c4ce-124">Na przykład przed odczytaniem wiersza z bazy danych należy zażądać blokady dla dostępu tylko do odczytu lub do aktualizacji.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-124">For example, before you read a row from a database, you request a lock for read-only or for update access.</span></span> <span data-ttu-id="3c4ce-125">Jeśli zablokujesz wiersz na potrzeby dostępu do aktualizacji, żaden inny użytkownik nie będzie mógł zablokować wiersza dla dostępu tylko do odczytu lub aktualizacji, ponieważ spowodowałoby to skopiowanie danych w procesie.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-125">If you lock a row for update access, no other users are allowed to lock the row either for read-only or update access, because they would get a copy of data that's in the process of being changed.</span></span> <span data-ttu-id="3c4ce-126">Jeśli zablokujesz wiersz dla dostępu tylko do odczytu, inne osoby mogą także zablokować dostęp tylko do odczytu, ale nie dla aktualizacji.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-126">If you lock a row for read-only access, others can also lock it for read-only access but not for update.</span></span>

<span data-ttu-id="3c4ce-127">Zarządzanie blokadami ma pewne wady.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-127">Managing locks has some disadvantages.</span></span> <span data-ttu-id="3c4ce-128">Może być skomplikowany dla programu.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-128">It can be complex to program.</span></span> <span data-ttu-id="3c4ce-129">Wymaga to znaczących zasobów zarządzania bazami danych. może to spowodować problemy z wydajnością w miarę wzrostu liczby użytkowników aplikacji (oznacza to, że nie jest to dobrze skalowane).</span><span class="sxs-lookup"><span data-stu-id="3c4ce-129">It requires significant database management resources, and it can cause performance problems as the number of users of an application increases (that is, it doesn't scale well).</span></span> <span data-ttu-id="3c4ce-130">Z tego względu nie wszystkie systemy zarządzania bazami danych obsługują pesymistyczne współbieżności.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-130">For these reasons, not all database management systems support pessimistic concurrency.</span></span> <span data-ttu-id="3c4ce-131">Entity Framework nie zapewnia wbudowanej pomocy technicznej i ten samouczek nie pokazuje, jak go wdrożyć.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-131">The Entity Framework provides no built-in support for it, and this tutorial doesn't show you how to implement it.</span></span>

### <a name="optimistic-concurrency"></a><span data-ttu-id="3c4ce-132">Optymistyczna współbieżność</span><span class="sxs-lookup"><span data-stu-id="3c4ce-132">Optimistic Concurrency</span></span>

<span data-ttu-id="3c4ce-133">Alternatywą dla pesymistycznej współbieżności jest *Optymistyczna współbieżność*.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-133">The alternative to pessimistic concurrency is *optimistic concurrency*.</span></span> <span data-ttu-id="3c4ce-134">Współbieżność optymistyczna pozwala na wykonywanie konfliktów współbieżności, a następnie podejmowanie odpowiednich działań.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-134">Optimistic concurrency means allowing concurrency conflicts to happen, and then reacting appropriately if they do.</span></span> <span data-ttu-id="3c4ce-135">Na przykład Jan uruchamia stronę *działu. aspx* , klika link **Edytuj** dla działu historia i zmniejsza kwotę **budżetu** od $1 000 000,00 do $125 000,00.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-135">For example, John runs the *Department.aspx* page, clicks the **Edit** link for the History department, and reduces the **Budget** amount from $1,000,000.00 to $125,000.00.</span></span> <span data-ttu-id="3c4ce-136">(Jan administruje działem konkurencyjnym i chce zwolnić pieniądze za własny dział).</span><span class="sxs-lookup"><span data-stu-id="3c4ce-136">(John administers a competing department and wants to free up money for his own department.)</span></span>

<span data-ttu-id="3c4ce-137">[![Image07](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image6.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image5.png)</span><span class="sxs-lookup"><span data-stu-id="3c4ce-137">[![Image07](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image6.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image5.png)</span></span>

<span data-ttu-id="3c4ce-138">Przed kliknięciem przycisku **Aktualizuj**w witrynie Janina zostanie uruchomiona ta sama strona, kliknięcie linku **Edytuj** dla działu historia, a następnie zmiana pola **data rozpoczęcia** z 1/10/2011 na 1/1/1999.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-138">Before John clicks **Update**, Jane runs the same page, clicks the **Edit** link for the History department, and then changes the **Start Date** field from 1/10/2011 to 1/1/1999.</span></span> <span data-ttu-id="3c4ce-139">(Janina zarządza działem historii i chce nadać mu wyższy staż).</span><span class="sxs-lookup"><span data-stu-id="3c4ce-139">(Jane administers the History department and wants to give it more seniority.)</span></span>

<span data-ttu-id="3c4ce-140">[![Image08](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image8.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="3c4ce-140">[![Image08](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image8.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image7.png)</span></span>

<span data-ttu-id="3c4ce-141">Jan klika pozycję **Aktualizuj** najpierw, a następnie kliknij przycisk **Aktualizuj**.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-141">John clicks **Update** first, then Jane clicks **Update**.</span></span> <span data-ttu-id="3c4ce-142">Przeglądarka Janina wyświetla teraz kwotę **budżetu** jako $1 000 000,00, ale jest niepoprawna, ponieważ kwota została zmieniona przez jan na $125 000,00.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-142">Jane's browser now lists the **Budget** amount as $1,000,000.00, but this is incorrect because the amount has been changed by John to $125,000.00.</span></span>

<span data-ttu-id="3c4ce-143">Poniżej wymieniono niektóre akcje, które można wykonać w tym scenariuszu:</span><span class="sxs-lookup"><span data-stu-id="3c4ce-143">Some of the actions you can take in this scenario include the following:</span></span>

- <span data-ttu-id="3c4ce-144">Można śledzić, która właściwość została zmodyfikowana przez użytkownika i zaktualizować tylko odpowiednie kolumny w bazie danych.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-144">You can keep track of which property a user has modified and update only the corresponding columns in the database.</span></span> <span data-ttu-id="3c4ce-145">W przykładowym scenariuszu żadne dane nie zostaną utracone, ponieważ różne właściwości zostały zaktualizowane przez dwóch użytkowników.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-145">In the example scenario, no data would be lost, because different properties were updated by the two users.</span></span> <span data-ttu-id="3c4ce-146">Następnym razem, gdy ktoś przegląda dział historii, zobaczy 1/1/1999 i $125 000,00.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-146">The next time someone browses the History department, they will see 1/1/1999 and $125,000.00.</span></span> 

    <span data-ttu-id="3c4ce-147">Jest to domyślne zachowanie w Entity Framework i może znacznie zmniejszyć liczbę konfliktów, które mogłyby spowodować utratę danych.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-147">This is the default behavior in the Entity Framework, and it can substantially reduce the number of conflicts that could result in data loss.</span></span> <span data-ttu-id="3c4ce-148">Jednak takie zachowanie nie pozwala na utratę danych, jeśli konkurencyjne zmiany są wprowadzane do tej samej właściwości jednostki.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-148">However, this behavior doesn't avoid data loss if competing changes are made to the same property of an entity.</span></span> <span data-ttu-id="3c4ce-149">Ponadto takie zachowanie nie zawsze jest możliwe; podczas mapowania procedur składowanych na typ jednostki wszystkie właściwości jednostki są aktualizowane po wprowadzeniu zmian w jednostce w bazie danych.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-149">In addition, this behavior isn't always possible; when you map stored procedures to an entity type, all of an entity's properties are updated when any changes to the entity are made in the database.</span></span>
- <span data-ttu-id="3c4ce-150">Możesz pozwolić, aby zmiana została zastąpiona przez Jan.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-150">You can let Jane's change overwrite John's change.</span></span> <span data-ttu-id="3c4ce-151">Po kliknięciu przycisku **Aktualizuj**kwota **budżetu** wraca do $1 000 000,00.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-151">After Jane clicks **Update**, the **Budget** amount goes back to $1,000,000.00.</span></span> <span data-ttu-id="3c4ce-152">Jest to tzw. *klient WINS* lub *ostatni w scenariuszu usługi WINS* .</span><span class="sxs-lookup"><span data-stu-id="3c4ce-152">This is called a *Client Wins* or *Last in Wins* scenario.</span></span> <span data-ttu-id="3c4ce-153">(Wartości klienta mają pierwszeństwo przed tym, co znajduje się w magazynie danych).</span><span class="sxs-lookup"><span data-stu-id="3c4ce-153">(The client's values take precedence over what's in the data store.)</span></span>
- <span data-ttu-id="3c4ce-154">Można zapobiec aktualizacji firmy Janina ze zmian w bazie danych.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-154">You can prevent Jane's change from being updated in the database.</span></span> <span data-ttu-id="3c4ce-155">Zazwyczaj można wyświetlić komunikat o błędzie, wyświetlić jego bieżący stan i umożliwić jego ponowne wprowadzenie zmian, jeśli nadal chce je wprowadzić.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-155">Typically, you would display an error message, show her the current state of the data, and allow her to reenter her changes if she still wants to make them.</span></span> <span data-ttu-id="3c4ce-156">Proces ten można zautomatyzować przez zapisanie jego danych wejściowych i umożliwienie mu ponownego zastosowania, bez konieczności jego ponownie wprowadzania.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-156">You could further automate the process by saving her input and giving her an opportunity to reapply it without having to reenter it.</span></span> <span data-ttu-id="3c4ce-157">Jest to tzw. scenariusz *magazynu usługi WINS* .</span><span class="sxs-lookup"><span data-stu-id="3c4ce-157">This is called a *Store Wins* scenario.</span></span> <span data-ttu-id="3c4ce-158">(Wartości magazynu danych pierwszeństwo wartości przesłany przez klienta.)</span><span class="sxs-lookup"><span data-stu-id="3c4ce-158">(The data-store values take precedence over the values submitted by the client.)</span></span>

### <a name="detecting-concurrency-conflicts"></a><span data-ttu-id="3c4ce-159">Wykrywanie konfliktów współbieżności</span><span class="sxs-lookup"><span data-stu-id="3c4ce-159">Detecting Concurrency Conflicts</span></span>

<span data-ttu-id="3c4ce-160">W Entity Framework można rozwiązać konflikty przez obsługę `OptimisticConcurrencyException` wyjątków zgłaszanych przez Entity Framework.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-160">In the Entity Framework, you can resolve conflicts by handling `OptimisticConcurrencyException` exceptions that the Entity Framework throws.</span></span> <span data-ttu-id="3c4ce-161">Aby dowiedzieć się, kiedy należy zgłosić te wyjątki, Entity Framework musi mieć możliwość wykrywania konfliktów.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-161">In order to know when to throw these exceptions, the Entity Framework must be able to detect conflicts.</span></span> <span data-ttu-id="3c4ce-162">W związku z tym należy odpowiednio skonfigurować bazę danych i model danych.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-162">Therefore, you must configure the database and the data model appropriately.</span></span> <span data-ttu-id="3c4ce-163">Dostępne są następujące opcje włączania wykrywania konfliktów:</span><span class="sxs-lookup"><span data-stu-id="3c4ce-163">Some options for enabling conflict detection include the following:</span></span>

- <span data-ttu-id="3c4ce-164">W bazie danych programu Dołącz kolumnę tabeli, której można użyć do określenia, kiedy wiersz został zmieniony.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-164">In the database, include a table column that can be used to determine when a row has been changed.</span></span> <span data-ttu-id="3c4ce-165">Następnie można skonfigurować Entity Framework, aby uwzględnić tę kolumnę w klauzuli `Where` `Update` SQL lub `Delete` polecenia.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-165">You can then configure the Entity Framework to include that column in the `Where` clause of SQL `Update` or `Delete` commands.</span></span>

    <span data-ttu-id="3c4ce-166">Jest to cel kolumny `Timestamp` w tabeli `OfficeAssignment`.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-166">That's the purpose of the `Timestamp` column in the `OfficeAssignment` table.</span></span>

    <span data-ttu-id="3c4ce-167">[![Image09](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image10.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image9.png)</span><span class="sxs-lookup"><span data-stu-id="3c4ce-167">[![Image09](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image10.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image9.png)</span></span>

    <span data-ttu-id="3c4ce-168">Typ danych kolumny `Timestamp` jest również nazywany `Timestamp`.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-168">The data type of the `Timestamp` column is also called `Timestamp`.</span></span> <span data-ttu-id="3c4ce-169">Kolumna nie zawiera jednak wartości daty ani godziny.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-169">However, the column doesn't actually contain a date or time value.</span></span> <span data-ttu-id="3c4ce-170">Zamiast tego wartość jest numerem sekwencyjnym, który jest zwiększany za każdym razem, gdy wiersz zostanie zaktualizowany.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-170">Instead, the value is a sequential number that's incremented each time the row is updated.</span></span> <span data-ttu-id="3c4ce-171">W `Update` lub `Delete`, klauzula `Where` zawiera oryginalną `Timestamp` wartość.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-171">In an `Update` or `Delete` command, the `Where` clause includes the original `Timestamp` value.</span></span> <span data-ttu-id="3c4ce-172">Jeśli aktualizowany wiersz został zmieniony przez innego użytkownika, wartość w `Timestamp` jest różna od oryginalnej wartości, więc klauzula `Where` nie zwraca żadnego wiersza do zaktualizowania.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-172">If the row being updated has been changed by another user, the value in `Timestamp` is different than the original value, so the `Where` clause returns no row to update.</span></span> <span data-ttu-id="3c4ce-173">Gdy Entity Framework stwierdzi, że żadne wiersze nie zostały zaktualizowane przez bieżącą `Update` lub polecenie `Delete` (oznacza to, że gdy liczba odnośnych wierszy wynosi zero), interpretuje to jako konflikt współbieżności.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-173">When the Entity Framework finds that no rows have been updated by the current `Update` or `Delete` command (that is, when the number of affected rows is zero), it interprets that as a concurrency conflict.</span></span>
- <span data-ttu-id="3c4ce-174">Skonfiguruj Entity Framework, aby uwzględnić oryginalne wartości każdej kolumny w tabeli w klauzuli `Where` poleceń `Update` i `Delete`.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-174">Configure the Entity Framework to include the original values of every column in the table in the `Where` clause of `Update` and `Delete` commands.</span></span>

    <span data-ttu-id="3c4ce-175">Jak w pierwszej opcji, jeśli coś w wierszu uległo zmianie od momentu pierwszego odczytu wiersza, klauzula `Where` nie zwróci wiersza do zaktualizowania, który Entity Framework interpretuje jako konflikt współbieżności.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-175">As in the first option, if anything in the row has changed since the row was first read, the `Where` clause won't return a row to update, which the Entity Framework interprets as a concurrency conflict.</span></span> <span data-ttu-id="3c4ce-176">Ta metoda jest skuteczna jak użycie pola `Timestamp`, ale może być niewydajne.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-176">This method is as effective as using a `Timestamp` field, but can be inefficient.</span></span> <span data-ttu-id="3c4ce-177">W przypadku tabel bazy danych z wieloma kolumnami może wystąpić bardzo duże klauzule `Where`, a w aplikacji sieci Web może być wymagane zachowanie dużej ilości danych.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-177">For database tables that have many columns, it can result in very large `Where` clauses, and in a web application it can require that you maintain large amounts of state.</span></span> <span data-ttu-id="3c4ce-178">Utrzymywanie dużej ilości stanu może wpłynąć na wydajność aplikacji, ponieważ wymaga ona zasobów serwera (na przykład stanu sesji) lub musi być uwzględniona na stronie sieci Web (na przykład Wyświetl stan).</span><span class="sxs-lookup"><span data-stu-id="3c4ce-178">Maintaining large amounts of state can affect application performance because it either requires server resources (for example, session state) or must be included in the web page itself (for example, view state).</span></span>

<span data-ttu-id="3c4ce-179">W tym samouczku zostanie dodana obsługa błędów optymistycznych konfliktów współbieżności dla jednostki, która nie ma właściwości śledzenia (jednostka `Department`) i dla jednostki, która ma właściwość śledzenia (`OfficeAssignment` jednostki).</span><span class="sxs-lookup"><span data-stu-id="3c4ce-179">In this tutorial you will add error handling for optimistic concurrency conflicts for an entity that doesn't have a tracking property (the `Department` entity) and for an entity that does have a tracking property (the `OfficeAssignment` entity).</span></span>

## <a name="handling-optimistic-concurrency-without-a-tracking-property"></a><span data-ttu-id="3c4ce-180">Obsługa optymistycznej współbieżności bez właściwości śledzenia</span><span class="sxs-lookup"><span data-stu-id="3c4ce-180">Handling Optimistic Concurrency Without a Tracking Property</span></span>

<span data-ttu-id="3c4ce-181">Aby zaimplementować optymistyczną współbieżność dla jednostki `Department`, która nie ma właściwości śledzenia (`Timestamp`), należy wykonać następujące zadania:</span><span class="sxs-lookup"><span data-stu-id="3c4ce-181">To implement optimistic concurrency for the `Department` entity, which doesn't have a tracking (`Timestamp`) property, you will complete the following tasks:</span></span>

- <span data-ttu-id="3c4ce-182">Zmień model danych, aby włączyć śledzenie współbieżności dla jednostek `Department`.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-182">Change the data model to enable concurrency tracking for `Department` entities.</span></span>
- <span data-ttu-id="3c4ce-183">W klasie `SchoolRepository` obsługiwać wyjątki współbieżności w metodzie `SaveChanges`.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-183">In the `SchoolRepository` class, handle concurrency exceptions in the `SaveChanges` method.</span></span>
- <span data-ttu-id="3c4ce-184">Na stronie *działS. aspx* Obsługuj wyjątki współbieżności, wyświetlając komunikat ostrzegawczy informujący o niepomyślnych zmianach.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-184">In the *Departments.aspx* page, handle concurrency exceptions by displaying a message to the user warning that the attempted changes were unsuccessful.</span></span> <span data-ttu-id="3c4ce-185">Użytkownik może wyświetlić bieżące wartości i ponowić próbę zmiany, jeśli nadal są potrzebne.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-185">The user can then see the current values and retry the changes if they are still needed.</span></span>

### <a name="enabling-concurrency-tracking-in-the-data-model"></a><span data-ttu-id="3c4ce-186">Włączanie śledzenia współbieżności w modelu danych</span><span class="sxs-lookup"><span data-stu-id="3c4ce-186">Enabling Concurrency Tracking in the Data Model</span></span>

<span data-ttu-id="3c4ce-187">W programie Visual Studio Otwórz aplikację sieci Web Contoso University, z którą pracujesz w poprzednim samouczku w tej serii.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-187">In Visual Studio, open the Contoso University web application that you were working with in the previous tutorial in this series.</span></span>

<span data-ttu-id="3c4ce-188">Otwórz *SchoolModel. edmx*i w projektancie modeli danych kliknij prawym przyciskiem myszy Właściwość `Name` w jednostce `Department`, a następnie kliknij polecenie **Właściwości**.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-188">Open *SchoolModel.edmx*, and in the data model designer, right-click the `Name` property in the `Department` entity and then click **Properties**.</span></span> <span data-ttu-id="3c4ce-189">W oknie **Właściwości** zmień właściwość `ConcurrencyMode` na `Fixed`.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-189">In the **Properties** window, change the `ConcurrencyMode` property to `Fixed`.</span></span>

<span data-ttu-id="3c4ce-190">[![Image16](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image12.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image11.png)</span><span class="sxs-lookup"><span data-stu-id="3c4ce-190">[![Image16](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image12.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image11.png)</span></span>

<span data-ttu-id="3c4ce-191">Wykonaj te same czynności dla innych niż podstawowe właściwości skalarnych (`Budget`, `StartDate`i `Administrator`). (Nie można tego zrobić dla właściwości nawigacji). Oznacza to, że za każdym razem, gdy Entity Framework generuje polecenie SQL `Update` lub `Delete` w celu zaktualizowania jednostki `Department` w bazie danych, te kolumny (z oryginalnymi wartościami) muszą być uwzględnione w klauzuli `Where`.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-191">Do the same for the other non-primary-key scalar properties (`Budget`, `StartDate`, and `Administrator`.) (You can't do this for navigation properties.) This specifies that whenever the Entity Framework generates a `Update` or `Delete` SQL command to update the `Department` entity in the database, these columns (with original values) must be included in the `Where` clause.</span></span> <span data-ttu-id="3c4ce-192">Jeśli nie zostanie znaleziony żaden wiersz, gdy zostanie wykonane polecenie `Update` lub `Delete`, Entity Framework zgłosi wyjątek optymistycznej współbieżności.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-192">If no row is found when the `Update` or `Delete` command executes, the Entity Framework will throw an optimistic-concurrency exception.</span></span>

<span data-ttu-id="3c4ce-193">Zapisz i Zamknij model danych.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-193">Save and close the data model.</span></span>

### <a name="handling-concurrency-exceptions-in-the-dal"></a><span data-ttu-id="3c4ce-194">Obsługa wyjątków współbieżności w DAL</span><span class="sxs-lookup"><span data-stu-id="3c4ce-194">Handling Concurrency Exceptions in the DAL</span></span>

<span data-ttu-id="3c4ce-195">Otwórz *SchoolRepository.cs* i Dodaj następującą instrukcję `using` dla przestrzeni nazw `System.Data`:</span><span class="sxs-lookup"><span data-stu-id="3c4ce-195">Open *SchoolRepository.cs* and add the following `using` statement for the `System.Data` namespace:</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample1.cs)]

<span data-ttu-id="3c4ce-196">Dodaj następującą nową metodę `SaveChanges`, która obsługuje optymistyczne wyjątki współbieżności:</span><span class="sxs-lookup"><span data-stu-id="3c4ce-196">Add the following new `SaveChanges` method, which handles optimistic concurrency exceptions:</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample2.cs)]

<span data-ttu-id="3c4ce-197">Jeśli wystąpi błąd współbieżności, gdy ta metoda jest wywoływana, wartości właściwości jednostki w pamięci są zastępowane wartościami znajdującymi się obecnie w bazie danych.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-197">If a concurrency error occurs when this method is called, the property values of the entity in memory are replaced with the values currently in the database.</span></span> <span data-ttu-id="3c4ce-198">Wyjątek współbieżności jest ponownie zgłaszany, dzięki czemu Strona sieci Web może je obsłużyć.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-198">The concurrency exception is rethrown so that the web page can handle it.</span></span>

<span data-ttu-id="3c4ce-199">W metodach `DeleteDepartment` i `UpdateDepartment` Zastąp istniejące wywołanie `context.SaveChanges()` z wywołaniem `SaveChanges()`, aby wywołać nową metodę.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-199">In the `DeleteDepartment` and `UpdateDepartment` methods, replace the existing call to `context.SaveChanges()` with a call to `SaveChanges()` in order to invoke the new method.</span></span>

### <a name="handling-concurrency-exceptions-in-the-presentation-layer"></a><span data-ttu-id="3c4ce-200">Obsługa wyjątków współbieżności w warstwie prezentacji</span><span class="sxs-lookup"><span data-stu-id="3c4ce-200">Handling Concurrency Exceptions in the Presentation Layer</span></span>

<span data-ttu-id="3c4ce-201">Otwórz *działS. aspx* i dodaj atrybut `OnDeleted="DepartmentsObjectDataSource_Deleted"` do kontrolki `DepartmentsObjectDataSource`.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-201">Open *Departments.aspx* and add an `OnDeleted="DepartmentsObjectDataSource_Deleted"` attribute to the `DepartmentsObjectDataSource` control.</span></span> <span data-ttu-id="3c4ce-202">Tag otwierający dla kontrolki będzie teraz podobny do poniższego przykładu.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-202">The opening tag for the control will now resemble the following example.</span></span>

[!code-aspx[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample3.aspx)]

<span data-ttu-id="3c4ce-203">W kontrolce `DepartmentsGridView` Określ wszystkie kolumny tabeli w atrybucie `DataKeyNames`, jak pokazano w poniższym przykładzie.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-203">In the `DepartmentsGridView` control, specify all of the table columns in the `DataKeyNames` attribute, as shown in the following example.</span></span> <span data-ttu-id="3c4ce-204">Należy zauważyć, że spowoduje to utworzenie bardzo dużych pól stanu widoku, co jest jednym z powodów, dla których użycie pola śledzenia jest ogólnie preferowanym sposobem śledzenia konfliktów współbieżności.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-204">Note that this will create very large view state fields, which is one reason why using a tracking field is generally the preferred way to track concurrency conflicts.</span></span>

[!code-aspx[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample4.aspx)]

<span data-ttu-id="3c4ce-205">Otwórz *Departments.aspx.cs* i Dodaj następującą instrukcję `using` dla przestrzeni nazw `System.Data`:</span><span class="sxs-lookup"><span data-stu-id="3c4ce-205">Open *Departments.aspx.cs* and add the following `using` statement for the `System.Data` namespace:</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample5.cs)]

<span data-ttu-id="3c4ce-206">Dodaj następującą nową metodę, która będzie wywoływana ze `Updated` kontroli źródła danych i `Deleted` obsługi zdarzeń w celu obsługi wyjątków współbieżności:</span><span class="sxs-lookup"><span data-stu-id="3c4ce-206">Add the following new method, which you will call from the data source control's `Updated` and `Deleted` event handlers for handling concurrency exceptions:</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample6.cs)]

<span data-ttu-id="3c4ce-207">Ten kod sprawdza typ wyjątku i jeśli jest to wyjątek współbieżności, kod dynamicznie tworzy kontrolkę `CustomValidator`, która z kolei wyświetla komunikat w kontrolce `ValidationSummary`.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-207">This code checks the exception type, and if it's a concurrency exception, the code dynamically creates a `CustomValidator` control that in turn displays a message in the `ValidationSummary` control.</span></span>

<span data-ttu-id="3c4ce-208">Wywołaj nową metodę z procedury obsługi zdarzeń `Updated`, która została dodana wcześniej.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-208">Call the new method from the `Updated` event handler that you added earlier.</span></span> <span data-ttu-id="3c4ce-209">Ponadto Utwórz nową procedurę obsługi zdarzeń `Deleted`, która wywołuje tę samą metodę (ale nie wykonuje żadnych innych czynności):</span><span class="sxs-lookup"><span data-stu-id="3c4ce-209">In addition, create a new `Deleted` event handler that calls the same method (but doesn't do anything else):</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample7.cs)]

### <a name="testing-optimistic-concurrency-in-the-departments-page"></a><span data-ttu-id="3c4ce-210">Testowanie optymistycznej współbieżności na stronie działy</span><span class="sxs-lookup"><span data-stu-id="3c4ce-210">Testing Optimistic Concurrency in the Departments Page</span></span>

<span data-ttu-id="3c4ce-211">Uruchom stronę *działS. aspx* .</span><span class="sxs-lookup"><span data-stu-id="3c4ce-211">Run the *Departments.aspx* page.</span></span>

<span data-ttu-id="3c4ce-212">[![Image17](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image14.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="3c4ce-212">[![Image17](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image14.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image13.png)</span></span>

<span data-ttu-id="3c4ce-213">Kliknij przycisk **Edytuj** w wierszu i zmień wartość w kolumnie **budżet** .</span><span class="sxs-lookup"><span data-stu-id="3c4ce-213">Click **Edit** in a row and change the value in the **Budget** column.</span></span> <span data-ttu-id="3c4ce-214">(Pamiętaj, że można edytować tylko te rekordy, które zostały utworzone dla tego samouczka, ponieważ istniejące `School` rekordy bazy danych zawierają nieprawidłowe dane.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-214">(Remember that you can only edit records that you've created for this tutorial, because the existing `School` database records contain some invalid data.</span></span> <span data-ttu-id="3c4ce-215">Rekord działu ekonomii jest bezpiecznym jednym do eksperymentowania z.)</span><span class="sxs-lookup"><span data-stu-id="3c4ce-215">The record for the Economics department is a safe one to experiment with.)</span></span>

<span data-ttu-id="3c4ce-216">[![Image18](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image16.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image15.png)</span><span class="sxs-lookup"><span data-stu-id="3c4ce-216">[![Image18](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image16.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image15.png)</span></span>

<span data-ttu-id="3c4ce-217">Otwórz nowe okno przeglądarki i ponownie uruchom stronę (Skopiuj adres URL z pola Adres pierwszego okna przeglądarki do drugiego okna przeglądarki).</span><span class="sxs-lookup"><span data-stu-id="3c4ce-217">Open a new browser window and run the page again (copy the URL from the first browser window's address box to the second browser window).</span></span>

<span data-ttu-id="3c4ce-218">[![Image17](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image18.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image17.png)</span><span class="sxs-lookup"><span data-stu-id="3c4ce-218">[![Image17](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image18.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image17.png)</span></span>

<span data-ttu-id="3c4ce-219">Kliknij przycisk **Edytuj** w tym samym wierszu, który został wcześniej zmodyfikowany, a następnie zmień wartość **budżetu** na inną.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-219">Click **Edit** in the same row you edited earlier and change the **Budget** value to something different.</span></span>

<span data-ttu-id="3c4ce-220">[![Image19](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image20.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image19.png)</span><span class="sxs-lookup"><span data-stu-id="3c4ce-220">[![Image19](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image20.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image19.png)</span></span>

<span data-ttu-id="3c4ce-221">W drugim oknie przeglądarki kliknij pozycję **Aktualizuj**.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-221">In the second browser window, click **Update**.</span></span> <span data-ttu-id="3c4ce-222">Kwota **budżetu** została pomyślnie zmieniona na tę nową wartość.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-222">The **Budget** amount is successfully changed to this new value.</span></span>

<span data-ttu-id="3c4ce-223">[![Image20](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image22.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image21.png)</span><span class="sxs-lookup"><span data-stu-id="3c4ce-223">[![Image20](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image22.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image21.png)</span></span>

<span data-ttu-id="3c4ce-224">W pierwszym oknie przeglądarki kliknij pozycję **Aktualizuj**.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-224">In the first browser window, click **Update**.</span></span> <span data-ttu-id="3c4ce-225">Aktualizacja nie powiedzie się.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-225">The update fails.</span></span> <span data-ttu-id="3c4ce-226">Kwota **budżetu** jest ponownie wyświetlana przy użyciu wartości ustawionej w drugim oknie przeglądarki i zostanie wyświetlony komunikat o błędzie.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-226">The **Budget** amount is redisplayed using the value you set in the second browser window, and you see an error message.</span></span>

<span data-ttu-id="3c4ce-227">[![Image21](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image24.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image23.png)</span><span class="sxs-lookup"><span data-stu-id="3c4ce-227">[![Image21](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image24.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image23.png)</span></span>

## <a name="handling-optimistic-concurrency-using-a-tracking-property"></a><span data-ttu-id="3c4ce-228">Obsługa optymistycznej współbieżności przy użyciu właściwości śledzenia</span><span class="sxs-lookup"><span data-stu-id="3c4ce-228">Handling Optimistic Concurrency Using a Tracking Property</span></span>

<span data-ttu-id="3c4ce-229">Aby obsłużyć optymistyczną współbieżność dla jednostki, która ma właściwość śledzenia, należy wykonać następujące zadania:</span><span class="sxs-lookup"><span data-stu-id="3c4ce-229">To handle optimistic concurrency for an entity that has a tracking property, you will complete the following tasks:</span></span>

- <span data-ttu-id="3c4ce-230">Dodaj procedury składowane do modelu danych, aby zarządzać jednostkami `OfficeAssignment`.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-230">Add stored procedures to the data model to manage `OfficeAssignment` entities.</span></span> <span data-ttu-id="3c4ce-231">(Właściwości śledzenia i procedury składowane nie muszą być używane razem; są one po prostu pogrupowane w tym miejscu na potrzeby ilustracji).</span><span class="sxs-lookup"><span data-stu-id="3c4ce-231">(Tracking properties and stored procedures don't have to be used together; they're just grouped together here for illustration.)</span></span>
- <span data-ttu-id="3c4ce-232">Dodaj metody CRUD do DAL i LOGIKI biznesowej dla jednostek `OfficeAssignment`, w tym kodu do obsługi optymistycznych wyjątków współbieżności w DAL.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-232">Add CRUD methods to the DAL and the BLL for `OfficeAssignment` entities, including code to handle optimistic concurrency exceptions in the DAL.</span></span>
- <span data-ttu-id="3c4ce-233">Utwórz stronę sieci Web przypisania pakietu Office.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-233">Create an office-assignments web page.</span></span>
- <span data-ttu-id="3c4ce-234">Przetestuj optymistyczną współbieżność na nowej stronie sieci Web.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-234">Test optimistic concurrency in the new web page.</span></span>

### <a name="adding-officeassignment-stored-procedures-to-the-data-model"></a><span data-ttu-id="3c4ce-235">Dodawanie OfficeAssignment procedur składowanych do modelu danych</span><span class="sxs-lookup"><span data-stu-id="3c4ce-235">Adding OfficeAssignment Stored Procedures to the Data Model</span></span>

<span data-ttu-id="3c4ce-236">Otwórz plik *SchoolModel. edmx* w projektancie modeli, kliknij prawym przyciskiem myszy powierzchnię projektu, a następnie kliknij pozycję **Aktualizuj model z bazy danych**.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-236">Open the *SchoolModel.edmx* file in the model designer, right-click the design surface, and click **Update Model from Database**.</span></span> <span data-ttu-id="3c4ce-237">Na karcie **Dodaj** okna dialogowego **Wybierz obiekty bazy danych** rozwiń węzeł **procedury składowane** i wybierz trzy `OfficeAssignment` procedury składowane (zobacz poniższy zrzut ekranu), a następnie kliknij przycisk **Zakończ**.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-237">In the **Add** tab of the **Choose Your Database Objects** dialog box, expand **Stored Procedures** and select the three `OfficeAssignment` stored procedures (see the following screenshot), and then click **Finish**.</span></span> <span data-ttu-id="3c4ce-238">(Te procedury składowane znajdują się już w bazie danych podczas pobierania lub tworzenia przy użyciu skryptu).</span><span class="sxs-lookup"><span data-stu-id="3c4ce-238">(These stored procedures were already in the database when you downloaded or created it using a script.)</span></span>

<span data-ttu-id="3c4ce-239">[![Image02](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image26.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image25.png)</span><span class="sxs-lookup"><span data-stu-id="3c4ce-239">[![Image02](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image26.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image25.png)</span></span>

<span data-ttu-id="3c4ce-240">Kliknij prawym przyciskiem myszy jednostkę `OfficeAssignment` i wybierz pozycję **mapowanie procedury składowanej**.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-240">Right-click the `OfficeAssignment` entity and select **Stored Procedure Mapping**.</span></span>

<span data-ttu-id="3c4ce-241">[![Image03](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image28.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image27.png)</span><span class="sxs-lookup"><span data-stu-id="3c4ce-241">[![Image03](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image28.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image27.png)</span></span>

<span data-ttu-id="3c4ce-242">Ustaw funkcje **INSERT**, **Update**i **delete** w taki sposób, aby korzystały z odpowiednich procedur składowanych.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-242">Set the **Insert**, **Update**, and **Delete** functions to use their corresponding stored procedures.</span></span> <span data-ttu-id="3c4ce-243">Dla `OrigTimestamp` parametru funkcji `Update` Ustaw **Właściwość** na `Timestamp` i wybierz opcję **Użyj oryginalnej wartości** .</span><span class="sxs-lookup"><span data-stu-id="3c4ce-243">For the `OrigTimestamp` parameter of the `Update` function, set the **Property** to `Timestamp` and select the **Use Original Value** option.</span></span>

<span data-ttu-id="3c4ce-244">[![Image04](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image30.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image29.png)</span><span class="sxs-lookup"><span data-stu-id="3c4ce-244">[![Image04](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image30.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image29.png)</span></span>

<span data-ttu-id="3c4ce-245">Gdy Entity Framework wywoła procedurę składowaną `UpdateOfficeAssignment`, przekaże oryginalną wartość kolumny `Timestamp` w parametrze `OrigTimestamp`.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-245">When the Entity Framework calls the `UpdateOfficeAssignment` stored procedure, it will pass the original value of the `Timestamp` column in the `OrigTimestamp` parameter.</span></span> <span data-ttu-id="3c4ce-246">Procedura składowana używa tego parametru w jego `Where` klauzuli:</span><span class="sxs-lookup"><span data-stu-id="3c4ce-246">The stored procedure uses this parameter in its `Where` clause:</span></span>

[!code-sql[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample8.sql)]

<span data-ttu-id="3c4ce-247">Procedura składowana wybiera także nową wartość kolumny `Timestamp` po aktualizacji, dzięki czemu Entity Framework może utrzymywać `OfficeAssignment` jednostkę, która znajduje się w pamięci w synchronizacji z odpowiednim wierszem bazy danych.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-247">The stored procedure also selects the new value of the `Timestamp` column after the update so that the Entity Framework can keep the `OfficeAssignment` entity that's in memory in sync with the corresponding database row.</span></span>

<span data-ttu-id="3c4ce-248">(Należy zauważyć, że procedura składowana usuwania przypisania pakietu Office nie ma parametru `OrigTimestamp`.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-248">(Note that the stored procedure for deleting an office assignment doesn't have an `OrigTimestamp` parameter.</span></span> <span data-ttu-id="3c4ce-249">W związku z tym Entity Framework nie może zweryfikować, czy jednostka nie została zmieniona przed usunięciem.)</span><span class="sxs-lookup"><span data-stu-id="3c4ce-249">Because of this, the Entity Framework can't verify that an entity is unchanged before deleting it.)</span></span>

<span data-ttu-id="3c4ce-250">Zapisz i Zamknij model danych.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-250">Save and close the data model.</span></span>

### <a name="adding-officeassignment-methods-to-the-dal"></a><span data-ttu-id="3c4ce-251">Dodawanie metod OfficeAssignment do DAL</span><span class="sxs-lookup"><span data-stu-id="3c4ce-251">Adding OfficeAssignment Methods to the DAL</span></span>

<span data-ttu-id="3c4ce-252">Otwórz *ISchoolRepository.cs* i Dodaj następujące metody CRUD dla zestawu jednostek `OfficeAssignment`:</span><span class="sxs-lookup"><span data-stu-id="3c4ce-252">Open *ISchoolRepository.cs* and add the following CRUD methods for the `OfficeAssignment` entity set:</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample9.cs)]

<span data-ttu-id="3c4ce-253">Dodaj następujące nowe metody do *SchoolRepository.cs*.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-253">Add the following new methods to *SchoolRepository.cs*.</span></span> <span data-ttu-id="3c4ce-254">W metodzie `UpdateOfficeAssignment` należy wywołać metodę `SaveChanges` lokalnego zamiast `context.SaveChanges`.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-254">In the `UpdateOfficeAssignment` method, you call the local `SaveChanges` method instead of `context.SaveChanges`.</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample10.cs)]

<span data-ttu-id="3c4ce-255">W projekcie testowym Otwórz *MockSchoolRepository.cs* i Dodaj do niego następujące metody zbierania `OfficeAssignment` i CRUD.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-255">In the test project, open *MockSchoolRepository.cs* and add the following `OfficeAssignment` collection and CRUD methods to it.</span></span> <span data-ttu-id="3c4ce-256">(Repozytorium makiety musi implementować interfejs repozytorium lub rozwiązanie nie zostanie skompilowane).</span><span class="sxs-lookup"><span data-stu-id="3c4ce-256">(The mock repository must implement the repository interface, or the solution won't compile.)</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample11.cs)]

### <a name="adding-officeassignment-methods-to-the-bll"></a><span data-ttu-id="3c4ce-257">Dodawanie metod OfficeAssignment do LOGIKI biznesowej</span><span class="sxs-lookup"><span data-stu-id="3c4ce-257">Adding OfficeAssignment Methods to the BLL</span></span>

<span data-ttu-id="3c4ce-258">W głównym projekcie Otwórz *SchoolBL.cs* i Dodaj następujące metody CRUD dla zestawu jednostek `OfficeAssignment`:</span><span class="sxs-lookup"><span data-stu-id="3c4ce-258">In the main project, open *SchoolBL.cs* and add the following CRUD methods for the `OfficeAssignment` entity set to it:</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample12.cs)]

## <a name="creating-an-officeassignments-web-page"></a><span data-ttu-id="3c4ce-259">Tworzenie strony sieci Web OfficeAssignments</span><span class="sxs-lookup"><span data-stu-id="3c4ce-259">Creating an OfficeAssignments Web Page</span></span>

<span data-ttu-id="3c4ce-260">Utwórz nową stronę sieci Web, która korzysta z *witryny. Master* Master i nadaj jej nazwę *OfficeAssignments. aspx*.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-260">Create a new web page that uses the *Site.Master* master page and name it *OfficeAssignments.aspx*.</span></span> <span data-ttu-id="3c4ce-261">Dodaj następujący znacznik do kontrolki `Content` o nazwie `Content2`:</span><span class="sxs-lookup"><span data-stu-id="3c4ce-261">Add the following markup to the `Content` control named `Content2`:</span></span>

[!code-aspx[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample13.aspx)]

<span data-ttu-id="3c4ce-262">Zauważ, że w atrybucie `DataKeyNames` znacznik określa właściwość `Timestamp`, a także klucz rekordu (`InstructorID`).</span><span class="sxs-lookup"><span data-stu-id="3c4ce-262">Notice that in the `DataKeyNames` attribute, the markup specifies the `Timestamp` property as well as the record key (`InstructorID`).</span></span> <span data-ttu-id="3c4ce-263">Określanie właściwości w atrybucie `DataKeyNames` powoduje, że formant zapisuje je w stanie kontroli (co jest podobne do stanu widoku), dzięki czemu oryginalne wartości są dostępne podczas przetwarzania ogłaszania zwrotnego.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-263">Specifying properties in the `DataKeyNames` attribute causes the control to save them in control state (which is similar to view state) so that the original values are available during postback processing.</span></span>

<span data-ttu-id="3c4ce-264">Jeśli nie zapisano wartości `Timestamp`, Entity Framework nie będzie miała dla klauzuli `Where` polecenia SQL `Update`.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-264">If you didn't save the `Timestamp` value, the Entity Framework would not have it for the `Where` clause of the SQL `Update` command.</span></span> <span data-ttu-id="3c4ce-265">W związku z tym nic nie zostanie znalezione do zaktualizowania.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-265">Consequently nothing would be found to update.</span></span> <span data-ttu-id="3c4ce-266">W związku z tym Entity Framework może zgłosić wyjątek współbieżności optymistycznej za każdym razem, gdy jednostka `OfficeAssignment` zostanie zaktualizowana.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-266">As a result, the Entity Framework would throw an optimistic concurrency exception every time an `OfficeAssignment` entity is updated.</span></span>

<span data-ttu-id="3c4ce-267">Otwórz *OfficeAssignments.aspx.cs* i Dodaj następującą instrukcję `using` dla warstwy dostępu do danych:</span><span class="sxs-lookup"><span data-stu-id="3c4ce-267">Open *OfficeAssignments.aspx.cs* and add the following `using` statement for the data access layer:</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample14.cs)]

<span data-ttu-id="3c4ce-268">Dodaj następującą metodę `Page_Init`, która umożliwia dynamiczne działanie danych.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-268">Add the following `Page_Init` method, which enables Dynamic Data functionality.</span></span> <span data-ttu-id="3c4ce-269">Dodaj również następujące procedury obsługi dla zdarzenia `Updated` formantu `ObjectDataSource`, aby sprawdzić występowanie błędów współbieżności:</span><span class="sxs-lookup"><span data-stu-id="3c4ce-269">Also add the following handler for the `ObjectDataSource` control's `Updated` event in order to check for concurrency errors:</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample15.cs)]

### <a name="testing-optimistic-concurrency-in-the-officeassignments-page"></a><span data-ttu-id="3c4ce-270">Testowanie optymistycznej współbieżności na stronie OfficeAssignments</span><span class="sxs-lookup"><span data-stu-id="3c4ce-270">Testing Optimistic Concurrency in the OfficeAssignments Page</span></span>

<span data-ttu-id="3c4ce-271">Uruchom stronę *OfficeAssignments. aspx* .</span><span class="sxs-lookup"><span data-stu-id="3c4ce-271">Run the *OfficeAssignments.aspx* page.</span></span>

<span data-ttu-id="3c4ce-272">[![Image10](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image32.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image31.png)</span><span class="sxs-lookup"><span data-stu-id="3c4ce-272">[![Image10](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image32.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image31.png)</span></span>

<span data-ttu-id="3c4ce-273">Kliknij przycisk **Edytuj** w wierszu i zmień wartość w kolumnie **Lokalizacja** .</span><span class="sxs-lookup"><span data-stu-id="3c4ce-273">Click **Edit** in a row and change the value in the **Location** column.</span></span>

<span data-ttu-id="3c4ce-274">[![Image11](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image34.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image33.png)</span><span class="sxs-lookup"><span data-stu-id="3c4ce-274">[![Image11](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image34.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image33.png)</span></span>

<span data-ttu-id="3c4ce-275">Otwórz nowe okno przeglądarki i ponownie uruchom stronę (Skopiuj adres URL z pierwszego okna przeglądarki do drugiego okna przeglądarki).</span><span class="sxs-lookup"><span data-stu-id="3c4ce-275">Open a new browser window and run the page again (copy the URL from the first browser window to the second browser window).</span></span>

<span data-ttu-id="3c4ce-276">[![Image10](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image36.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image35.png)</span><span class="sxs-lookup"><span data-stu-id="3c4ce-276">[![Image10](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image36.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image35.png)</span></span>

<span data-ttu-id="3c4ce-277">Kliknij przycisk **Edytuj** w tym samym wierszu, który był wcześniej edytowany, i zmień wartość **lokalizacji** na inną.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-277">Click **Edit** in the same row you edited earlier and change the **Location** value to something different.</span></span>

<span data-ttu-id="3c4ce-278">[![Image12](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image38.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image37.png)</span><span class="sxs-lookup"><span data-stu-id="3c4ce-278">[![Image12](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image38.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image37.png)</span></span>

<span data-ttu-id="3c4ce-279">W drugim oknie przeglądarki kliknij pozycję **Aktualizuj**.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-279">In the second browser window, click **Update**.</span></span>

<span data-ttu-id="3c4ce-280">[![Image13](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image40.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image39.png)</span><span class="sxs-lookup"><span data-stu-id="3c4ce-280">[![Image13](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image40.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image39.png)</span></span>

<span data-ttu-id="3c4ce-281">Przejdź do pierwszego okna przeglądarki, a następnie kliknij przycisk **Aktualizuj**.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-281">Switch to the first browser window and click **Update**.</span></span>

<span data-ttu-id="3c4ce-282">[![Image15](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image42.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image41.png)</span><span class="sxs-lookup"><span data-stu-id="3c4ce-282">[![Image15](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image42.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image41.png)</span></span>

<span data-ttu-id="3c4ce-283">Zobaczysz komunikat o błędzie, a wartość **lokalizacji** została zaktualizowana, aby wyświetlić wartość, którą zmieniono w drugim oknie przeglądarki.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-283">You see an error message and the **Location** value has been updated to show the value you changed it to in the second browser window.</span></span>

## <a name="handling-concurrency-with-the-entitydatasource-control"></a><span data-ttu-id="3c4ce-284">Obsługa współbieżności przy użyciu kontrolki EntityDataSource</span><span class="sxs-lookup"><span data-stu-id="3c4ce-284">Handling Concurrency with the EntityDataSource Control</span></span>

<span data-ttu-id="3c4ce-285">Formant `EntityDataSource` zawiera wbudowaną logikę, która rozpoznaje ustawienia współbieżności w modelu danych i odpowiednio obsługuje operacje aktualizowania i usuwania.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-285">The `EntityDataSource` control includes built-in logic that recognizes the concurrency settings in the data model and handles update and delete operations accordingly.</span></span> <span data-ttu-id="3c4ce-286">Jednak podobnie jak w przypadku wszystkich wyjątków, należy samodzielnie obsłużyć `OptimisticConcurrencyException` wyjątków, aby zapewnić przyjazny dla użytkownika komunikat o błędzie.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-286">However, as with all exceptions, you must handle `OptimisticConcurrencyException` exceptions yourself in order to provide a user-friendly error message.</span></span>

<span data-ttu-id="3c4ce-287">Następnie skonfigurujesz stronę *kursy. aspx* (która używa kontrolki `EntityDataSource`) do zezwalania na operacje aktualizowania i usuwania oraz wyświetlania komunikatu o błędzie w przypadku wystąpienia konfliktu współbieżności.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-287">Next, you will configure the *Courses.aspx* page (which uses an `EntityDataSource` control) to allow update and delete operations and to display an error message if a concurrency conflict occurs.</span></span> <span data-ttu-id="3c4ce-288">Jednostka `Course` nie ma kolumny śledzenia współbieżności, dlatego należy użyć tej samej metody, która została użyta w jednostce `Department`: Śledź wartości wszystkich właściwości niebędących kluczami.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-288">The `Course` entity doesn't have a concurrency tracking column, so you will use the same method that you did with the `Department` entity: track the values of all non-key properties.</span></span>

<span data-ttu-id="3c4ce-289">Otwórz plik *SchoolModel. edmx* .</span><span class="sxs-lookup"><span data-stu-id="3c4ce-289">Open the *SchoolModel.edmx* file.</span></span> <span data-ttu-id="3c4ce-290">Dla właściwości niebędących kluczami jednostki `Course` (`Title`, `Credits`i `DepartmentID`) ustaw właściwość **tryb współbieżności** na `Fixed`.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-290">For the non-key properties of the `Course` entity (`Title`, `Credits`, and `DepartmentID`), set the **Concurrency Mode** property to `Fixed`.</span></span> <span data-ttu-id="3c4ce-291">Następnie Zapisz i Zamknij model danych.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-291">Then save and close the data model.</span></span>

<span data-ttu-id="3c4ce-292">Otwórz stronę *kursy. aspx* i wprowadź następujące zmiany:</span><span class="sxs-lookup"><span data-stu-id="3c4ce-292">Open the *Courses.aspx* page and make the following changes:</span></span>

- <span data-ttu-id="3c4ce-293">W kontrolce `CoursesEntityDataSource` Dodaj atrybuty `EnableUpdate="true"` i `EnableDelete="true"`.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-293">In the `CoursesEntityDataSource` control, add `EnableUpdate="true"` and `EnableDelete="true"` attributes.</span></span> <span data-ttu-id="3c4ce-294">Tag otwierający dla tej kontrolki jest teraz podobny do następującego:</span><span class="sxs-lookup"><span data-stu-id="3c4ce-294">The opening tag for that control now resembles the following example:</span></span>

    [!code-aspx[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample16.aspx)]
- <span data-ttu-id="3c4ce-295">W kontrolce `CoursesGridView` Zmień wartość atrybutu `DataKeyNames` na `"CourseID,Title,Credits,DepartmentID"`.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-295">In the `CoursesGridView` control, change the `DataKeyNames` attribute value to `"CourseID,Title,Credits,DepartmentID"`.</span></span> <span data-ttu-id="3c4ce-296">Następnie Dodaj element `CommandField` do elementu `Columns`, który zawiera przyciski **Edytuj** i **Usuń** (`<asp:CommandField ShowEditButton="True" ShowDeleteButton="True" />`).</span><span class="sxs-lookup"><span data-stu-id="3c4ce-296">Then add a `CommandField` element to the `Columns` element that shows **Edit** and **Delete** buttons (`<asp:CommandField ShowEditButton="True" ShowDeleteButton="True" />`).</span></span> <span data-ttu-id="3c4ce-297">Kontrolka `GridView` jest teraz podobna do poniższego przykładu:</span><span class="sxs-lookup"><span data-stu-id="3c4ce-297">The `GridView` control now resembles the following example:</span></span>

    [!code-aspx[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample17.aspx)]

<span data-ttu-id="3c4ce-298">Uruchom stronę i Utwórz sytuację powodującą konflikt tak jak wcześniej na stronie działy.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-298">Run the page and create a conflict situation as you did before in the Departments page.</span></span> <span data-ttu-id="3c4ce-299">Uruchom stronę w dwóch oknach przeglądarki, kliknij przycisk **Edytuj** w tym samym wierszu w każdym oknie i wprowadź inną zmianę w każdym z nich.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-299">Run the page in two browser windows, click **Edit** in the same line in each window, and make a different change in each one.</span></span> <span data-ttu-id="3c4ce-300">Kliknij przycisk **Aktualizuj** w jednym oknie, a następnie kliknij przycisk **Aktualizuj** w drugim oknie.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-300">Click **Update** in one window and then click **Update** in the other window.</span></span> <span data-ttu-id="3c4ce-301">Po dwukrotnym kliknięciu przycisku **Aktualizuj** zostanie wyświetlona strona błędu z wynikiem nieobsłużonego wyjątku współbieżności.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-301">When you click **Update** the second time, you see the error page that results from an unhandled concurrency exception.</span></span>

<span data-ttu-id="3c4ce-302">[![Image22](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image44.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image43.png)</span><span class="sxs-lookup"><span data-stu-id="3c4ce-302">[![Image22](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image44.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image43.png)</span></span>

<span data-ttu-id="3c4ce-303">Ten błąd jest obsługiwany w sposób podobny do tego, jak został obsłużony dla formantu `ObjectDataSource`.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-303">You handle this error in a manner very similar to how you handled it for the `ObjectDataSource` control.</span></span> <span data-ttu-id="3c4ce-304">Otwórz stronę *kursy. aspx* i w kontrolce `CoursesEntityDataSource` Określ programy obsługi dla zdarzeń `Deleted` i `Updated`.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-304">Open the *Courses.aspx* page, and in the `CoursesEntityDataSource` control, specify handlers for the `Deleted` and `Updated` events.</span></span> <span data-ttu-id="3c4ce-305">Tag otwierający kontrolki wygląda teraz podobnie jak w poniższym przykładzie:</span><span class="sxs-lookup"><span data-stu-id="3c4ce-305">The opening tag of the control now resembles the following example:</span></span>

[!code-aspx[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample18.aspx)]

<span data-ttu-id="3c4ce-306">Przed kontrolką `CoursesGridView` Dodaj następującą kontrolkę `ValidationSummary`:</span><span class="sxs-lookup"><span data-stu-id="3c4ce-306">Before the `CoursesGridView` control, add the following `ValidationSummary` control:</span></span>

[!code-aspx[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample19.aspx)]

<span data-ttu-id="3c4ce-307">W *courses.aspx.cs*dodaj instrukcję `using` dla przestrzeni nazw `System.Data`, Dodaj metodę, która sprawdza, czy są używane wyjątki współbieżności, i Dodaj programy obsługi dla `Updated` i `Deleted` formantów `EntityDataSource`.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-307">In *Courses.aspx.cs*, add a `using` statement for the `System.Data` namespace, add a method that checks for concurrency exceptions, and add handlers for the `EntityDataSource` control's `Updated` and `Deleted` handlers.</span></span> <span data-ttu-id="3c4ce-308">Kod będzie wyglądać następująco:</span><span class="sxs-lookup"><span data-stu-id="3c4ce-308">The code will look like the following:</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample20.cs)]

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample21.cs)]

<span data-ttu-id="3c4ce-309">Jedyną różnicą między tym kodem i przeznaczeniem dla kontrolki `ObjectDataSource` jest to, że w tym przypadku wyjątek współbieżności znajduje się we właściwości `Exception` obiektu argumenty zdarzenia, a nie w `InnerException` właściwości tego wyjątku.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-309">The only difference between this code and what you did for the `ObjectDataSource` control is that in this case the concurrency exception is in the `Exception` property of the event arguments object rather than in that exception's `InnerException` property.</span></span>

<span data-ttu-id="3c4ce-310">Uruchom stronę i ponownie utwórz konflikt współbieżności.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-310">Run the page and create a concurrency conflict again.</span></span> <span data-ttu-id="3c4ce-311">W tym momencie zostanie wyświetlony komunikat o błędzie:</span><span class="sxs-lookup"><span data-stu-id="3c4ce-311">This time you see an error message:</span></span>

<span data-ttu-id="3c4ce-312">[![Image23](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image46.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image45.png)</span><span class="sxs-lookup"><span data-stu-id="3c4ce-312">[![Image23](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image46.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image45.png)</span></span>

<span data-ttu-id="3c4ce-313">Kończy to wprowadzenie do obsługi konfliktów współbieżności.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-313">This completes the introduction to handling concurrency conflicts.</span></span> <span data-ttu-id="3c4ce-314">W następnym samouczku przedstawiono wskazówki dotyczące poprawy wydajności aplikacji sieci Web, która używa Entity Framework.</span><span class="sxs-lookup"><span data-stu-id="3c4ce-314">The next tutorial will provide guidance on how to improve performance in a web application that uses the Entity Framework.</span></span>

> [!div class="step-by-step"]
> <span data-ttu-id="3c4ce-315">[Poprzednie](using-the-entity-framework-and-the-objectdatasource-control-part-3-sorting-and-filtering.md)
> [dalej](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application.md)</span><span class="sxs-lookup"><span data-stu-id="3c4ce-315">[Previous](using-the-entity-framework-and-the-objectdatasource-control-part-3-sorting-and-filtering.md)
[Next](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application.md)</span></span>
