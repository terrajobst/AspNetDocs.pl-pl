---
uid: identity/overview/features-api/account-confirmation-and-password-recovery-with-aspnet-identity
title: Potwierdzenie konta & Odzyskiwanie hasła ASP.NET Identity (C#) — ASP.NET 4. x
author: HaoK
description: Przed wykonaniem tego samouczka należy najpierw zakończyć tworzenie aplikacji sieci Web Secure ASP.NET MVC 5 z logowaniem, potwierdzeniem i resetowaniem hasła wiadomości e-mail. Ten samouczek...
ms.author: riande
ms.date: 01/23/2019
ms.assetid: 8d54180d-f826-4df7-b503-7debf5ed9fb3
ms.custom: seoapril2019
msc.legacyurl: /identity/overview/features-api/account-confirmation-and-password-recovery-with-aspnet-identity
msc.type: authoredcontent
ms.openlocfilehash: 4b2c88280df39aa81d60f9508910e8fe5d6db6b8
ms.sourcegitcommit: 88fc80e3f65aebdf61ec9414810ddbc31c543f04
ms.translationtype: MT
ms.contentlocale: pl-PL
ms.lasthandoff: 01/22/2020
ms.locfileid: "76519118"
---
# <a name="account-confirmation-and-password-recovery-with-aspnet-identity-c"></a><span data-ttu-id="6e30e-104">Potwierdzenie konta i odzyskiwanie hasła przy użyciu ASP.NET IdentityC#()</span><span class="sxs-lookup"><span data-stu-id="6e30e-104">Account confirmation and password recovery with ASP.NET Identity (C#)</span></span>

> <span data-ttu-id="6e30e-105">Przed wykonaniem tego samouczka należy najpierw zakończyć [Tworzenie aplikacji sieci Web secure ASP.NET MVC 5 z logowaniem, potwierdzeniem i resetowaniem hasła wiadomości e-mail](../../../mvc/overview/security/create-an-aspnet-mvc-5-web-app-with-email-confirmation-and-password-reset.md).</span><span class="sxs-lookup"><span data-stu-id="6e30e-105">Before doing this tutorial you should first complete [Create a secure ASP.NET MVC 5 web app with log in, email confirmation and password reset](../../../mvc/overview/security/create-an-aspnet-mvc-5-web-app-with-email-confirmation-and-password-reset.md).</span></span> <span data-ttu-id="6e30e-106">Ten samouczek zawiera więcej szczegółów i pokazuje, jak skonfigurować adres e-mail dla potwierdzenia konta lokalnego i umożliwić użytkownikom resetowanie zapomnianego hasła w ASP.NET Identity.</span><span class="sxs-lookup"><span data-stu-id="6e30e-106">This tutorial contains more details and will show you how to set up email for local account confirmation and allow users to reset their forgotten password in ASP.NET Identity.</span></span>

<span data-ttu-id="6e30e-107">Konto użytkownika lokalnego wymaga, aby użytkownik utworzył hasło do konta, a to hasło jest przechowywane (bezpiecznie) w aplikacji sieci Web.</span><span class="sxs-lookup"><span data-stu-id="6e30e-107">A local user account requires the user to create a password for the account, and that password is stored (securely) in the web app.</span></span> <span data-ttu-id="6e30e-108">ASP.NET Identity również obsługuje konta społecznościowe, które nie wymagają od użytkownika utworzenia hasła dla aplikacji.</span><span class="sxs-lookup"><span data-stu-id="6e30e-108">ASP.NET Identity also supports social accounts, which don't require the user to create a password for the app.</span></span> <span data-ttu-id="6e30e-109">[Konta społecznościowe](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) korzystają z innych firm (np. Google, Twitter, Facebook lub Microsoft) w celu uwierzytelniania użytkowników.</span><span class="sxs-lookup"><span data-stu-id="6e30e-109">[Social accounts](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) use a third party (such as Google, Twitter, Facebook, or Microsoft) to authenticate users.</span></span> <span data-ttu-id="6e30e-110">W tym temacie omówiono następujące zagadnienia:</span><span class="sxs-lookup"><span data-stu-id="6e30e-110">This topic covers the following:</span></span>

- <span data-ttu-id="6e30e-111">[Utwórz aplikację ASP.NET MVC](#createMvc) i Eksploruj ASP.NET Identity funkcje.</span><span class="sxs-lookup"><span data-stu-id="6e30e-111">[Create an ASP.NET MVC app](#createMvc) and explore ASP.NET Identity features.</span></span>
- [<span data-ttu-id="6e30e-112">Kompiluj przykład tożsamości</span><span class="sxs-lookup"><span data-stu-id="6e30e-112">Build the Identity sample</span></span>](#build)
- [<span data-ttu-id="6e30e-113">Skonfiguruj potwierdzenie poczty e-mail</span><span class="sxs-lookup"><span data-stu-id="6e30e-113">Set up email confirmation</span></span>](#email)

<span data-ttu-id="6e30e-114">Nowi użytkownicy rejestrują swoje aliasy e-mail, co powoduje utworzenie konta lokalnego.</span><span class="sxs-lookup"><span data-stu-id="6e30e-114">New users register their email alias, which creates a local account.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image1.png)

<span data-ttu-id="6e30e-115">Wybranie przycisku Zarejestruj powoduje wysłanie wiadomości e-mail z potwierdzeniem z tokenem weryfikacji na adres e-mail.</span><span class="sxs-lookup"><span data-stu-id="6e30e-115">Selecting the Register button sends a confirmation email containing a validation token to their email address.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image2.png)

<span data-ttu-id="6e30e-116">Użytkownik wysyła wiadomość e-mail z tokenem potwierdzającym dla swojego konta.</span><span class="sxs-lookup"><span data-stu-id="6e30e-116">The user is sent an email with a confirmation token for their account.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image3.png)

<span data-ttu-id="6e30e-117">Wybranie linku umożliwia potwierdzenie konta.</span><span class="sxs-lookup"><span data-stu-id="6e30e-117">Selecting the link confirms the account.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image4.png)

<a id="passwordReset"></a>

## <a name="password-recoveryreset"></a><span data-ttu-id="6e30e-118">Odzyskiwanie/Resetowanie hasła</span><span class="sxs-lookup"><span data-stu-id="6e30e-118">Password recovery/reset</span></span>

<span data-ttu-id="6e30e-119">Użytkownicy lokalni, którzy zapomnili hasła, mogą mieć token zabezpieczający wysyłany do swojego konta e-mail, co umożliwia im Resetowanie hasła.</span><span class="sxs-lookup"><span data-stu-id="6e30e-119">Local users who forget their password can have a security token sent to their email account, enabling them to reset their password.</span></span>  
  
![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image5.png)  
  
<span data-ttu-id="6e30e-120">Użytkownik wkrótce otrzyma wiadomość e-mail z linkiem umożliwiającym zresetowanie hasła.</span><span class="sxs-lookup"><span data-stu-id="6e30e-120">The user will soon get an email with a link allowing them to reset their password.</span></span>  
  
![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image6.png)  
<span data-ttu-id="6e30e-121">Wybranie linku spowoduje przejście do strony Reset.</span><span class="sxs-lookup"><span data-stu-id="6e30e-121">Selecting the link will take them to the Reset page.</span></span>  
  
![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image7.png)  
  
<span data-ttu-id="6e30e-122">Wybranie przycisku **Resetuj** spowoduje potwierdzenie resetowania hasła.</span><span class="sxs-lookup"><span data-stu-id="6e30e-122">Selecting the **Reset** button will confirm the password has been reset.</span></span>  
  
![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image8.png)

<a id="createMvc"></a>

## <a name="create-an-aspnet-web-app"></a><span data-ttu-id="6e30e-123">Tworzenie aplikacji internetowej ASP.NET</span><span class="sxs-lookup"><span data-stu-id="6e30e-123">Create an ASP.NET web app</span></span>

<span data-ttu-id="6e30e-124">Zacznij od zainstalowania i uruchomienia [programu Visual Studio 2017](https://visualstudio.microsoft.com/).</span><span class="sxs-lookup"><span data-stu-id="6e30e-124">Start by installing and running [Visual Studio 2017](https://visualstudio.microsoft.com/).</span></span>

1. <span data-ttu-id="6e30e-125">Utwórz nowy projekt sieci Web ASP.NET i wybierz szablon MVC.</span><span class="sxs-lookup"><span data-stu-id="6e30e-125">Create a new ASP.NET Web project and select the MVC template.</span></span> <span data-ttu-id="6e30e-126">Formularze sieci Web obsługują również ASP.NET Identity, więc można wykonać podobne kroki w aplikacji formularzy sieci Web.</span><span class="sxs-lookup"><span data-stu-id="6e30e-126">Web Forms also support ASP.NET Identity, so you could follow similar steps in a web forms app.</span></span>
2. <span data-ttu-id="6e30e-127">Zmień uwierzytelnianie na **konta poszczególnych użytkowników**.</span><span class="sxs-lookup"><span data-stu-id="6e30e-127">Change the authentication to **Individual User Accounts**.</span></span>
3. <span data-ttu-id="6e30e-128">Uruchom aplikację, wybierz łącze **zarejestruj** i zarejestruj użytkownika.</span><span class="sxs-lookup"><span data-stu-id="6e30e-128">Run the app, select the **Register** link and register a user.</span></span> <span data-ttu-id="6e30e-129">W tym momencie jedynym sprawdzaniem poprawności w wiadomości e-mail jest atrybut [[EmailAddress]](https://msdn.microsoft.com/library/system.componentmodel.dataannotations.emailaddressattribute(v=vs.110).aspx) .</span><span class="sxs-lookup"><span data-stu-id="6e30e-129">At this point, the only validation on the email is with the [[EmailAddress]](https://msdn.microsoft.com/library/system.componentmodel.dataannotations.emailaddressattribute(v=vs.110).aspx) attribute.</span></span>
4. <span data-ttu-id="6e30e-130">W Eksplorator serwera przejdź do **Connections\DefaultConnection\Tables\AspNetUsers danych**, kliknij prawym przyciskiem myszy i wybierz polecenie **Otwórz definicję tabeli**.</span><span class="sxs-lookup"><span data-stu-id="6e30e-130">In Server Explorer, navigate to **Data Connections\DefaultConnection\Tables\AspNetUsers**, right-click and select **Open table definition**.</span></span>

    <span data-ttu-id="6e30e-131">Na poniższej ilustracji przedstawiono schemat `AspNetUsers`:</span><span class="sxs-lookup"><span data-stu-id="6e30e-131">The following image shows the `AspNetUsers` schema:</span></span>

    ![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image9.png)
5. <span data-ttu-id="6e30e-132">Kliknij prawym przyciskiem myszy tabelę **AspNetUsers** , a następnie wybierz polecenie **Pokaż dane tabeli**.</span><span class="sxs-lookup"><span data-stu-id="6e30e-132">Right-click on the **AspNetUsers** table and select **Show Table Data**.</span></span>  
  
    ![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image10.png)  
  
   <span data-ttu-id="6e30e-133">W tym momencie wiadomość e-mail nie została potwierdzona.</span><span class="sxs-lookup"><span data-stu-id="6e30e-133">At this point the email has not been confirmed.</span></span>

<span data-ttu-id="6e30e-134">Domyślny magazyn danych dla ASP.NET Identity jest Entity Framework, ale można go skonfigurować tak, aby korzystał z innych magazynów danych i dodać dodatkowe pola.</span><span class="sxs-lookup"><span data-stu-id="6e30e-134">The default data store for ASP.NET Identity is Entity Framework, but you can configure it to use other data stores and to add additional fields.</span></span> <span data-ttu-id="6e30e-135">Zobacz sekcję [dodatkowe zasoby](#addRes) na końcu tego samouczka.</span><span class="sxs-lookup"><span data-stu-id="6e30e-135">See [Additional Resources](#addRes) section at the end of this tutorial.</span></span>

<span data-ttu-id="6e30e-136">[Klasa startowa Owin](../../../aspnet/overview/owin-and-katana/owin-startup-class-detection.md) ( *Startup.cs* ) jest wywoływana, gdy aplikacja zostanie uruchomiona i wywoła metodę `ConfigureAuth` w *aplikacji\_Start\Startup.auth.cs*, która konfiguruje potok Owin i inicjuje ASP.NET Identity.</span><span class="sxs-lookup"><span data-stu-id="6e30e-136">The [OWIN startup class](../../../aspnet/overview/owin-and-katana/owin-startup-class-detection.md) ( *Startup.cs* ) is called when the app starts and invokes the `ConfigureAuth` method in *App\_Start\Startup.Auth.cs*, which configures the OWIN pipeline and initializes ASP.NET Identity.</span></span> <span data-ttu-id="6e30e-137">Sprawdź `ConfigureAuth` metody.</span><span class="sxs-lookup"><span data-stu-id="6e30e-137">Examine the `ConfigureAuth` method.</span></span> <span data-ttu-id="6e30e-138">Każde wywołanie `CreatePerOwinContext` rejestruje wywołanie zwrotne (zapisane w `OwinContext`), które zostanie wywołane raz na żądanie w celu utworzenia wystąpienia określonego typu.</span><span class="sxs-lookup"><span data-stu-id="6e30e-138">Each `CreatePerOwinContext` call registers a callback (saved in the `OwinContext`) that will be called once per request to create an instance of the specified type.</span></span> <span data-ttu-id="6e30e-139">Można ustawić punkt przerwania w konstruktorze i metodę `Create` każdego typu (`ApplicationDbContext, ApplicationUserManager`) i sprawdzić, czy są one wywoływane dla każdego żądania.</span><span class="sxs-lookup"><span data-stu-id="6e30e-139">You can set a break point in the constructor and `Create` method of each type (`ApplicationDbContext, ApplicationUserManager`) and verify they are called on each request.</span></span> <span data-ttu-id="6e30e-140">Wystąpienie `ApplicationDbContext` i `ApplicationUserManager` jest przechowywane w kontekście OWIN, do którego można uzyskać dostęp w całej aplikacji.</span><span class="sxs-lookup"><span data-stu-id="6e30e-140">A instance of `ApplicationDbContext` and `ApplicationUserManager` is stored in the OWIN context, which can be accessed throughout the application.</span></span> <span data-ttu-id="6e30e-141">ASP.NET Identity podłączane do potoku OWIN za pomocą oprogramowania pośredniczącego plików cookie.</span><span class="sxs-lookup"><span data-stu-id="6e30e-141">ASP.NET Identity hooks into the OWIN pipeline through cookie middleware.</span></span> <span data-ttu-id="6e30e-142">Aby uzyskać więcej informacji, zobacz [Zarządzanie okresem istnienia żądania dla klasy usermanager w ASP.NET Identity](https://blogs.msdn.com/b/webdev/archive/2014/02/12/per-request-lifetime-management-for-usermanager-class-in-asp-net-identity.aspx).</span><span class="sxs-lookup"><span data-stu-id="6e30e-142">For more information, see [Per request lifetime management for UserManager class in ASP.NET Identity](https://blogs.msdn.com/b/webdev/archive/2014/02/12/per-request-lifetime-management-for-usermanager-class-in-asp-net-identity.aspx).</span></span>

<span data-ttu-id="6e30e-143">Po zmianie profilu zabezpieczeń jest generowana nowa Sygnatura zabezpieczeń, która będzie przechowywana w polu `SecurityStamp` tabeli *AspNetUsers* .</span><span class="sxs-lookup"><span data-stu-id="6e30e-143">When you change your security profile, a new security stamp is generated and stored in the `SecurityStamp` field of the *AspNetUsers* table.</span></span> <span data-ttu-id="6e30e-144">Zwróć uwagę, że pole `SecurityStamp` różni się od pliku cookie zabezpieczeń.</span><span class="sxs-lookup"><span data-stu-id="6e30e-144">Note, the `SecurityStamp` field is different from the security cookie.</span></span> <span data-ttu-id="6e30e-145">Plik cookie zabezpieczeń nie jest przechowywany w tabeli `AspNetUsers` (lub w innym miejscu w bazie danych tożsamości).</span><span class="sxs-lookup"><span data-stu-id="6e30e-145">The security cookie is not stored in the `AspNetUsers` table (or anywhere else in the Identity DB).</span></span> <span data-ttu-id="6e30e-146">Token pliku cookie zabezpieczeń jest z podpisem własnym przy użyciu funkcji [DPAPI](https://msdn.microsoft.com/library/system.security.cryptography.protecteddata.aspx) i jest tworzony z informacjami o `UserId, SecurityStamp` i czasie wygaśnięcia.</span><span class="sxs-lookup"><span data-stu-id="6e30e-146">The security cookie token is self-signed using [DPAPI](https://msdn.microsoft.com/library/system.security.cryptography.protecteddata.aspx) and is created with the `UserId, SecurityStamp` and expiration time information.</span></span>

<span data-ttu-id="6e30e-147">Oprogramowanie pośredniczące cookie sprawdza plik cookie na każdym żądaniu.</span><span class="sxs-lookup"><span data-stu-id="6e30e-147">The cookie middleware checks the cookie on each request.</span></span> <span data-ttu-id="6e30e-148">Metoda `SecurityStampValidator` w klasie `Startup` trafi do bazy danych i okresowo sprawdza sygnaturę zabezpieczeń, jak określono w `validateInterval`.</span><span class="sxs-lookup"><span data-stu-id="6e30e-148">The `SecurityStampValidator` method in the `Startup` class hits the DB and checks security stamp periodically, as specified with the `validateInterval`.</span></span> <span data-ttu-id="6e30e-149">Dzieje się to co 30 minut (w naszym przykładzie), chyba że zmienisz profil zabezpieczeń.</span><span class="sxs-lookup"><span data-stu-id="6e30e-149">This only happens every 30 minutes (in our sample) unless you change your security profile.</span></span> <span data-ttu-id="6e30e-150">Wybrano 30-minutowy interwał minimalizowania podróży do bazy danych.</span><span class="sxs-lookup"><span data-stu-id="6e30e-150">The 30 minute interval was chosen to minimize trips to the database.</span></span> <span data-ttu-id="6e30e-151">Aby uzyskać więcej informacji, zobacz [Samouczek dotyczący usługi uwierzytelniania dwuskładnikowego](index.md) .</span><span class="sxs-lookup"><span data-stu-id="6e30e-151">See my [two-factor authentication tutorial](index.md) for more details.</span></span>

<span data-ttu-id="6e30e-152">Na komentarze w kodzie Metoda `UseCookieAuthentication` obsługuje uwierzytelnianie plików cookie.</span><span class="sxs-lookup"><span data-stu-id="6e30e-152">Per the comments in the code, the `UseCookieAuthentication` method supports cookie authentication.</span></span> <span data-ttu-id="6e30e-153">Pole `SecurityStamp` i skojarzony kod zapewniają dodatkową warstwę zabezpieczeń dla aplikacji, gdy zmienisz hasło, wylogujesz się z przeglądarki, w której się zarejestrowano.</span><span class="sxs-lookup"><span data-stu-id="6e30e-153">The `SecurityStamp` field and associated code provides an extra layer of security to your app, when you change your password, you will be logged out of the browser you logged in with.</span></span> <span data-ttu-id="6e30e-154">Metoda `SecurityStampValidator.OnValidateIdentity` umożliwia aplikacji Weryfikowanie tokenu zabezpieczającego, gdy użytkownik loguje się, który jest używany podczas zmiany hasła lub korzystania z logowania zewnętrznego.</span><span class="sxs-lookup"><span data-stu-id="6e30e-154">The `SecurityStampValidator.OnValidateIdentity` method enables the app to validate the security token when the user logs in, which is used when you change a password or use the external login.</span></span> <span data-ttu-id="6e30e-155">Jest to konieczne, aby upewnić się, że wszystkie tokeny (pliki cookie) wygenerowane przy użyciu starego hasła są unieważnione.</span><span class="sxs-lookup"><span data-stu-id="6e30e-155">This is needed to ensure that any tokens (cookies) generated with the old password are invalidated.</span></span> <span data-ttu-id="6e30e-156">W przykładowym projekcie, jeśli zmienisz hasło dla użytkowników, zostanie wygenerowany nowy token dla użytkownika, wszystkie poprzednie tokeny są unieważnione i pole `SecurityStamp` zostanie zaktualizowane.</span><span class="sxs-lookup"><span data-stu-id="6e30e-156">In the sample project, if you change the users password then a new token is generated for the user, any previous tokens are invalidated and the `SecurityStamp` field is updated.</span></span>

<span data-ttu-id="6e30e-157">System tożsamości umożliwia skonfigurowanie aplikacji w taki sposób, aby po zmianie profilu zabezpieczeń użytkowników (na przykład gdy użytkownik zmieni hasło lub zmiany skojarzone z logowaniem (na przykład z serwisu Facebook, Google, konto Microsoft itp.), użytkownik zostanie wylogowany ze wszystkich wystąpienia przeglądarki.</span><span class="sxs-lookup"><span data-stu-id="6e30e-157">The Identity system allow you to configure your app so when the users security profile changes (for example, when the user changes their password or changes associated login (such as from Facebook, Google, Microsoft account, etc.), the user is logged out of all browser instances.</span></span> <span data-ttu-id="6e30e-158">Na przykład poniższy obraz przedstawia [pojedynczą aplikację przykładową wylogowaniu](https://github.com/aspnet/samples/tree/master/samples/aspnet/Identity/SingleSignOutSample) , która umożliwia użytkownikowi wylogowanie się ze wszystkich wystąpień przeglądarki (w tym przypadku IE, Firefox i Chrome) przez wybranie jednego przycisku.</span><span class="sxs-lookup"><span data-stu-id="6e30e-158">For example, the image below shows the [Single signout sample](https://github.com/aspnet/samples/tree/master/samples/aspnet/Identity/SingleSignOutSample) app, which allows the user to sign out of all browser instances (in this case, IE, Firefox and Chrome) by selecting one button.</span></span> <span data-ttu-id="6e30e-159">Alternatywnie przykład umożliwia wylogowanie się tylko z określonego wystąpienia przeglądarki.</span><span class="sxs-lookup"><span data-stu-id="6e30e-159">Alternatively, the sample allows you to only log out of a specific browser instance.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image11.png)

<span data-ttu-id="6e30e-160">W ramach [pojedynczej przykładowej aplikacji wylogowaniu](https://github.com/aspnet/samples/tree/master/samples/aspnet/Identity/SingleSignOutSample) pokazano, jak ASP.NET Identity umożliwia ponowne wygenerowanie tokenu zabezpieczającego.</span><span class="sxs-lookup"><span data-stu-id="6e30e-160">The [Single signout sample](https://github.com/aspnet/samples/tree/master/samples/aspnet/Identity/SingleSignOutSample) app shows how ASP.NET Identity allows you to regenerate the security token.</span></span> <span data-ttu-id="6e30e-161">Jest to konieczne, aby upewnić się, że wszystkie tokeny (pliki cookie) wygenerowane przy użyciu starego hasła są unieważnione.</span><span class="sxs-lookup"><span data-stu-id="6e30e-161">This is needed to ensure that any tokens (cookies) generated with the old password are invalidated.</span></span> <span data-ttu-id="6e30e-162">Ta funkcja zapewnia dodatkową warstwę zabezpieczeń aplikacji. Gdy zmienisz hasło, nastąpi wylogowanie, gdzie zalogowano się do tej aplikacji.</span><span class="sxs-lookup"><span data-stu-id="6e30e-162">This feature provides an extra layer of security to your application; when you change your password, you will be logged out where you have logged into this application.</span></span>

<span data-ttu-id="6e30e-163">Plik *\_aplikacji Start\IdentityConfig.cs* zawiera klasy `ApplicationUserManager`, `EmailService` i `SmsService`.</span><span class="sxs-lookup"><span data-stu-id="6e30e-163">The *App\_Start\IdentityConfig.cs* file contains the `ApplicationUserManager`, `EmailService` and `SmsService` classes.</span></span> <span data-ttu-id="6e30e-164">Klasy `EmailService` i `SmsService` każdy implementuje interfejs `IIdentityMessageService`, dlatego w każdej klasie istnieją popularne metody konfigurowania poczty e-mail i wiadomości SMS.</span><span class="sxs-lookup"><span data-stu-id="6e30e-164">The `EmailService` and `SmsService` classes each implement the `IIdentityMessageService` interface, so you have common methods in each class to configure email and SMS.</span></span> <span data-ttu-id="6e30e-165">Chociaż w tym samouczku pokazano, jak dodać powiadomienie e-mail za pośrednictwem usługi [SendGrid](http://sendgrid.com/), możesz wysłać wiadomość e-mail przy użyciu protokołu SMTP i innych mechanizmów.</span><span class="sxs-lookup"><span data-stu-id="6e30e-165">Although this tutorial only shows how to add email notification through [SendGrid](http://sendgrid.com/), you can send email using SMTP and other mechanisms.</span></span>

<span data-ttu-id="6e30e-166">Klasa `Startup` zawiera również płytę kotłową, która umożliwia dodawanie nazw logowania do społeczności (Facebook, Twitter itp.), zobacz My samouczek [MVC 5 app with Facebook, Twitter, LinkedIn i Google OAuth2 Signing](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) , aby uzyskać więcej informacji.</span><span class="sxs-lookup"><span data-stu-id="6e30e-166">The `Startup` class also contains boiler plate to add social logins (Facebook, Twitter, etc.), see my tutorial [MVC 5 App with Facebook, Twitter, LinkedIn and Google OAuth2 Sign-on](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) for more info.</span></span>

<span data-ttu-id="6e30e-167">Zapoznaj się z klasą `ApplicationUserManager`, która zawiera informacje o tożsamości użytkowników i konfiguruje następujące funkcje:</span><span class="sxs-lookup"><span data-stu-id="6e30e-167">Examine the `ApplicationUserManager` class, which contains the users identity information and configures the following features:</span></span>

- <span data-ttu-id="6e30e-168">Wymagania dotyczące siły hasła.</span><span class="sxs-lookup"><span data-stu-id="6e30e-168">Password strength requirements.</span></span>
- <span data-ttu-id="6e30e-169">Zablokuj użytkownika (próby i godziny).</span><span class="sxs-lookup"><span data-stu-id="6e30e-169">User lock out (attempts and time).</span></span>
- <span data-ttu-id="6e30e-170">Uwierzytelnianie dwuskładnikowe (funkcji 2FA).</span><span class="sxs-lookup"><span data-stu-id="6e30e-170">Two-factor authentication (2FA).</span></span> <span data-ttu-id="6e30e-171">Będę pokryć funkcji 2FA i SMS w innym samouczku.</span><span class="sxs-lookup"><span data-stu-id="6e30e-171">I'll cover 2FA and SMS in another tutorial.</span></span>
- <span data-ttu-id="6e30e-172">Podłączanie usług poczty e-mail i SMS.</span><span class="sxs-lookup"><span data-stu-id="6e30e-172">Hooking up the email and SMS services.</span></span> <span data-ttu-id="6e30e-173">(Będę obejmować program SMS w innym samouczku).</span><span class="sxs-lookup"><span data-stu-id="6e30e-173">(I'll cover SMS in another tutorial).</span></span>

<span data-ttu-id="6e30e-174">Klasa `ApplicationUserManager` dziedziczy z klasy generycznej `UserManager<ApplicationUser>`.</span><span class="sxs-lookup"><span data-stu-id="6e30e-174">The `ApplicationUserManager` class derives from the generic `UserManager<ApplicationUser>` class.</span></span> <span data-ttu-id="6e30e-175">`ApplicationUser` pochodzi od [IdentityUser](https://msdn.microsoft.com/library/microsoft.aspnet.identity.entityframework.identityuser.aspx).</span><span class="sxs-lookup"><span data-stu-id="6e30e-175">`ApplicationUser` derives from [IdentityUser](https://msdn.microsoft.com/library/microsoft.aspnet.identity.entityframework.identityuser.aspx).</span></span> <span data-ttu-id="6e30e-176">`IdentityUser` pochodzi z klasy generycznej `IdentityUser`:</span><span class="sxs-lookup"><span data-stu-id="6e30e-176">`IdentityUser` derives from the generic `IdentityUser` class:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample1.cs)]

<span data-ttu-id="6e30e-177">Powyższe właściwości pokrywają się z właściwościami w tabeli `AspNetUsers`, jak pokazano powyżej.</span><span class="sxs-lookup"><span data-stu-id="6e30e-177">The properties above coincide with the properties in the `AspNetUsers` table, shown above.</span></span>

<span data-ttu-id="6e30e-178">Argumenty ogólne w `IUser` umożliwiają uzyskanie klasy przy użyciu różnych typów klucza podstawowego.</span><span class="sxs-lookup"><span data-stu-id="6e30e-178">Generic arguments on `IUser` enable you to derive a class using different types for the primary key.</span></span> <span data-ttu-id="6e30e-179">Zobacz przykład [ChangePK](https://github.com/aspnet/samples/tree/master/samples/aspnet/Identity/ChangePK) , który pokazuje, jak zmienić klucz podstawowy z ciągu na int lub GUID.</span><span class="sxs-lookup"><span data-stu-id="6e30e-179">See the [ChangePK](https://github.com/aspnet/samples/tree/master/samples/aspnet/Identity/ChangePK) sample which shows how to change the primary key from string to int or GUID.</span></span>

### <a name="applicationuser"></a><span data-ttu-id="6e30e-180">ApplicationUser</span><span class="sxs-lookup"><span data-stu-id="6e30e-180">ApplicationUser</span></span>

<span data-ttu-id="6e30e-181">`ApplicationUser` (`public class ApplicationUserManager : UserManager<ApplicationUser>`) jest zdefiniowany w *Models\IdentityModels.cs* jako:</span><span class="sxs-lookup"><span data-stu-id="6e30e-181">`ApplicationUser` (`public class ApplicationUserManager : UserManager<ApplicationUser>`) is defined in *Models\IdentityModels.cs* as:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample2.cs?highlight=8-9)]

<span data-ttu-id="6e30e-182">Wyróżniony powyżej kod generuje [Identyfikator oświadczenia](https://msdn.microsoft.com/library/system.security.claims.claimsidentity.aspx).</span><span class="sxs-lookup"><span data-stu-id="6e30e-182">The highlighted code above generates a [ClaimsIdentity](https://msdn.microsoft.com/library/system.security.claims.claimsidentity.aspx).</span></span> <span data-ttu-id="6e30e-183">Uwierzytelnianie plików cookie ASP.NET Identity i OWIN jest oparte na oświadczeniach, dlatego struktura wymaga, aby aplikacja generowała `ClaimsIdentity` dla użytkownika.</span><span class="sxs-lookup"><span data-stu-id="6e30e-183">ASP.NET Identity and OWIN Cookie Authentication are claims-based, therefore the framework requires the app to generate a `ClaimsIdentity` for the user.</span></span> <span data-ttu-id="6e30e-184">`ClaimsIdentity` zawiera informacje o wszystkich oświadczeniach dla użytkownika, takie jak nazwa użytkownika, wiek i role, do których należy użytkownik.</span><span class="sxs-lookup"><span data-stu-id="6e30e-184">`ClaimsIdentity` has information about all the claims for the user, such as the user's name, age and what roles the user belongs to.</span></span> <span data-ttu-id="6e30e-185">Możesz również dodać więcej oświadczeń dla użytkownika na tym etapie.</span><span class="sxs-lookup"><span data-stu-id="6e30e-185">You can also add more claims for the user at this stage.</span></span>

<span data-ttu-id="6e30e-186">Metoda `AuthenticationManager.SignIn` OWIN przekazuje `ClaimsIdentity` i oznakuje użytkownika:</span><span class="sxs-lookup"><span data-stu-id="6e30e-186">The OWIN `AuthenticationManager.SignIn` method passes in the `ClaimsIdentity` and signs in the user:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample3.cs?highlight=4-6)]

<span data-ttu-id="6e30e-187">[Aplikacja MVC 5 z logowaniem w serwisach Facebook, Twitter, LinkedIn i Google OAuth2](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) pokazuje, w jaki sposób można dodać dodatkowe właściwości do klasy `ApplicationUser`.</span><span class="sxs-lookup"><span data-stu-id="6e30e-187">[MVC 5 App with Facebook, Twitter, LinkedIn and Google OAuth2 Sign-on](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) shows how you can add additional properties to the `ApplicationUser` class.</span></span>

## <a name="email-confirmation"></a><span data-ttu-id="6e30e-188">Potwierdzenie wiadomości e-mail</span><span class="sxs-lookup"><span data-stu-id="6e30e-188">Email confirmation</span></span>

<span data-ttu-id="6e30e-189">Dobrym pomysłem jest potwierdzenie wysłania wiadomości e-mail przez nowego użytkownika w celu zweryfikowania, że nie są one personifikowane przez kogoś innego (oznacza to, że nie zostały zarejestrowane w wiadomości e-mail innej osoby).</span><span class="sxs-lookup"><span data-stu-id="6e30e-189">It's a good idea to confirm the email a new user register with to verify they are not impersonating someone else (that is, they haven't registered with someone else's email).</span></span> <span data-ttu-id="6e30e-190">Załóżmy, że masz forum dyskusyjne, aby zapobiec rejestrowaniu się `"bob@example.com"` w `"joe@contoso.com"`.</span><span class="sxs-lookup"><span data-stu-id="6e30e-190">Suppose you had a discussion forum, you would want to prevent `"bob@example.com"` from registering as `"joe@contoso.com"`.</span></span> <span data-ttu-id="6e30e-191">Bez potwierdzenia wiadomości e-mail `"joe@contoso.com"` może pobrać niechcianą wiadomość e-mail z aplikacji.</span><span class="sxs-lookup"><span data-stu-id="6e30e-191">Without email confirmation, `"joe@contoso.com"` could get unwanted email from your app.</span></span> <span data-ttu-id="6e30e-192">Załóżmy, że Robert przypadkowo zarejestrowany jako `"bib@example.com"` i nie go, nie będzie mógł korzystać z odzyskiwania hasła, ponieważ aplikacja nie ma poprawnego adresu e-mail.</span><span class="sxs-lookup"><span data-stu-id="6e30e-192">Suppose Bob accidentally registered as `"bib@example.com"` and hadn't noticed it, he wouldn't be able to use password recover because the app doesn't have his correct email.</span></span> <span data-ttu-id="6e30e-193">Potwierdzenie poczty e-mail zapewnia tylko ograniczoną ochronę z botów i nie zapewnia ochrony przed określonymi nadawców, którzy mają wiele roboczych aliasów poczty e-mail, których mogą używać do rejestracji. W poniższym przykładzie użytkownik nie będzie mógł zmienić swojego hasła, dopóki konto nie zostanie potwierdzone (przez wybranie linku potwierdzenia otrzymanego w ramach konta e-mail, które zarejestrowano). Ten przepływ pracy można zastosować do innych scenariuszy, na przykład wysyłając link do potwierdzenia i zresetowania hasła dla nowych kont utworzonych przez administratora, wysyłając użytkownikowi wiadomość e-mail po zmianie profilu i tak dalej.</span><span class="sxs-lookup"><span data-stu-id="6e30e-193">Email confirmation provides only limited protection from bots and doesn't provide protection from determined spammers, they have many working email aliases they can use to register.In the sample below, the user won't be able to change their password until their account has been confirmed (by them selecting a confirmation link received on the email account they registered with.) You can apply this work flow to other scenarios, for example sending a link to confirm and reset the password on new accounts created by the administrator, sending the user an email when they have changed their profile and so on.</span></span> <span data-ttu-id="6e30e-194">Zazwyczaj chcesz uniemożliwić nowym użytkownikom ogłaszanie danych w witrynie sieci Web przed ich potwierdzeniem za pośrednictwem poczty e-mail, wiadomości SMS lub innego mechanizmu.</span><span class="sxs-lookup"><span data-stu-id="6e30e-194">You generally want to prevent new users from posting any data to your web site before they have been confirmed by email, a SMS text message or another mechanism.</span></span> <a id="build"></a>

## <a name="build-a-more-complete-sample"></a><span data-ttu-id="6e30e-195">Kompiluj bardziej kompletny przykład</span><span class="sxs-lookup"><span data-stu-id="6e30e-195">Build a more complete sample</span></span>

<span data-ttu-id="6e30e-196">W tej sekcji użyjesz narzędzia NuGet do pobrania pełniejszego przykładu, z którym będziemy współpracować.</span><span class="sxs-lookup"><span data-stu-id="6e30e-196">In this section, you'll use NuGet to download a more complete sample we will work with.</span></span>

1. <span data-ttu-id="6e30e-197">Utwórz nowy ***pusty*** projekt sieci Web ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="6e30e-197">Create a new ***empty*** ASP.NET Web project.</span></span>
2. <span data-ttu-id="6e30e-198">W konsoli Menedżera pakietów wprowadź następujące polecenia:</span><span class="sxs-lookup"><span data-stu-id="6e30e-198">In the Package Manager Console, enter the following commands:</span></span> 

    [!code-console[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample4.cmd)]

   <span data-ttu-id="6e30e-199">W tym samouczku będziemy używać [SendGrid](http://sendgrid.com/) do wysyłania wiadomości e-mail.</span><span class="sxs-lookup"><span data-stu-id="6e30e-199">In this tutorial, we'll use [SendGrid](http://sendgrid.com/) to send email.</span></span> <span data-ttu-id="6e30e-200">Pakiet `Identity.Samples` instaluje kod, z którym będziemy pracować.</span><span class="sxs-lookup"><span data-stu-id="6e30e-200">The `Identity.Samples` package installs the code we will be working with.</span></span>
3. <span data-ttu-id="6e30e-201">Ustaw [dla projektu użycie protokołu SSL](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md).</span><span class="sxs-lookup"><span data-stu-id="6e30e-201">Set the [project to use SSL](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md).</span></span>
4. <span data-ttu-id="6e30e-202">Przetestuj Tworzenie konta lokalnego, uruchamiając aplikację, wybierając łącze **zarejestruj** i ogłaszając formularz rejestracji.</span><span class="sxs-lookup"><span data-stu-id="6e30e-202">Test local account creation by running the app, selecting the **Register** link, and posting the registration form.</span></span>
5. <span data-ttu-id="6e30e-203">Wybierz link e-mail z pokazem, który symuluje potwierdzenie wiadomości e-mail.</span><span class="sxs-lookup"><span data-stu-id="6e30e-203">Select the demo email link, which simulates email confirmation.</span></span>
6. <span data-ttu-id="6e30e-204">Usuń przykładowy kod potwierdzania linku do wiadomości e-mail z przykładu (kod `ViewBag.Link` na kontrolerze konta.</span><span class="sxs-lookup"><span data-stu-id="6e30e-204">Remove the demo email link confirmation code from the sample (The `ViewBag.Link` code in the account controller.</span></span> <span data-ttu-id="6e30e-205">Zobacz metody akcji `DisplayEmail` i `ForgotPasswordConfirmation` i widoki Razor).</span><span class="sxs-lookup"><span data-stu-id="6e30e-205">See the `DisplayEmail` and `ForgotPasswordConfirmation` action methods and razor views ).</span></span>

> [!WARNING]
> <span data-ttu-id="6e30e-206">Jeśli zmienisz dowolne z ustawień zabezpieczeń w tym przykładzie, aplikacje produkcji będą musiały zostać poddane inspekcji zabezpieczeń, która jawnie wywoła wprowadzone zmiany.</span><span class="sxs-lookup"><span data-stu-id="6e30e-206">If you change any of the security settings in this sample, productions apps will need to undergo a security audit that explicitly calls the changes made.</span></span>

## <a name="examine-the-code-in-app_startidentityconfigcs"></a><span data-ttu-id="6e30e-207">Sprawdzanie kodu w aplikacji\_Start\IdentityConfig.cs</span><span class="sxs-lookup"><span data-stu-id="6e30e-207">Examine the code in App\_Start\IdentityConfig.cs</span></span>

<span data-ttu-id="6e30e-208">Przykład pokazuje, jak utworzyć konto i dodać je do roli *administratora* .</span><span class="sxs-lookup"><span data-stu-id="6e30e-208">The sample shows how to create an account and add it to the *Admin* role.</span></span> <span data-ttu-id="6e30e-209">Wiadomość e-mail powinna zostać zamieniona na przykład za pomocą wiadomości e-mail, która będzie używana dla konta administratora.</span><span class="sxs-lookup"><span data-stu-id="6e30e-209">You should replace the email in the sample with the email you will be using for the admin account.</span></span> <span data-ttu-id="6e30e-210">Najprostszym sposobem na utworzenie konta administratora jest programowo w metodzie `Seed`.</span><span class="sxs-lookup"><span data-stu-id="6e30e-210">The easiest way right now to create an administrator account is programmatically in the `Seed` method.</span></span> <span data-ttu-id="6e30e-211">Mamy nadzieję, że w przyszłości znajdziesz narzędzie umożliwiające tworzenie i administrowanie użytkownikami i rolami.</span><span class="sxs-lookup"><span data-stu-id="6e30e-211">We hope to have a tool in the future that will allow you to create and administer users and roles.</span></span> <span data-ttu-id="6e30e-212">Przykładowy kod umożliwia tworzenie użytkowników i ról oraz zarządzanie nimi, ale musisz mieć konto administratora, aby uruchamiać role i strony administratora użytkowników.</span><span class="sxs-lookup"><span data-stu-id="6e30e-212">The sample code does let you create and manage users and roles, but you must first have an administrators account to run the roles and user admin pages.</span></span> <span data-ttu-id="6e30e-213">W tym przykładzie konto administratora jest tworzone, gdy baza danych jest wypełniania.</span><span class="sxs-lookup"><span data-stu-id="6e30e-213">In this sample, the admin account is created when the DB is seeded.</span></span>

<span data-ttu-id="6e30e-214">Zmień hasło i Zmień nazwę na konto, na którym można odbierać powiadomienia e-mail.</span><span class="sxs-lookup"><span data-stu-id="6e30e-214">Change the password and change the name to an account where you can receive email notifications.</span></span>

> [!WARNING]
> <span data-ttu-id="6e30e-215">Zabezpieczenia — nigdy nie należy przechowywać poufnych danych w kodzie źródłowym.</span><span class="sxs-lookup"><span data-stu-id="6e30e-215">Security - Never store sensitive data in your source code.</span></span>

<span data-ttu-id="6e30e-216">Jak wspomniano wcześniej, wywołanie `app.CreatePerOwinContext` w klasie startowej dodaje wywołania zwrotne do metody `Create` zawartości bazy danych aplikacji, Menedżera użytkowników i klas menedżerów ról.</span><span class="sxs-lookup"><span data-stu-id="6e30e-216">As mentioned previously, the `app.CreatePerOwinContext` call in the startup class adds callbacks to the `Create` method of the app DB content, user manager and role manger classes.</span></span> <span data-ttu-id="6e30e-217">Potok OWIN wywołuje metodę `Create` w tych klasach dla każdego żądania i przechowuje kontekst dla każdej klasy.</span><span class="sxs-lookup"><span data-stu-id="6e30e-217">The OWIN pipeline calls the `Create` method on these classes for each request and stores the context for each class.</span></span> <span data-ttu-id="6e30e-218">Kontroler konta uwidacznia Menedżera użytkowników z kontekstu HTTP (który zawiera kontekst OWIN):</span><span class="sxs-lookup"><span data-stu-id="6e30e-218">The account controller exposes the user manager from the HTTP context (which contains the OWIN context):</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample5.cs)]

<span data-ttu-id="6e30e-219">Gdy użytkownik rejestruje konto lokalne, Metoda `HTTP Post Register` jest wywoływana:</span><span class="sxs-lookup"><span data-stu-id="6e30e-219">When a user registers a local account, the `HTTP Post Register` method is called:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample6.cs)]

<span data-ttu-id="6e30e-220">W powyższym kodzie użyto danych modelu do utworzenia nowego konta użytkownika przy użyciu wprowadzonego adresu e-mail i hasła.</span><span class="sxs-lookup"><span data-stu-id="6e30e-220">The code above uses the model data to create a new user account using the email and password entered.</span></span> <span data-ttu-id="6e30e-221">Jeśli alias poczty e-mail znajduje się w magazynie danych, tworzenie konta kończy się niepowodzeniem, a formularz zostanie wyświetlony ponownie.</span><span class="sxs-lookup"><span data-stu-id="6e30e-221">If the email alias is in the data store, account creation fails and the form is displayed again.</span></span> <span data-ttu-id="6e30e-222">Metoda `GenerateEmailConfirmationTokenAsync` tworzy bezpieczny token potwierdzania i zapisuje ją w magazynie danych ASP.NET Identity.</span><span class="sxs-lookup"><span data-stu-id="6e30e-222">The `GenerateEmailConfirmationTokenAsync` method creates a secure confirmation token and stores it in the ASP.NET Identity data store.</span></span> <span data-ttu-id="6e30e-223">Metoda [URL. Action](https://msdn.microsoft.com/library/dd505232(v=vs.118).aspx) tworzy łącze zawierające `UserId` i Token potwierdzenia.</span><span class="sxs-lookup"><span data-stu-id="6e30e-223">The [Url.Action](https://msdn.microsoft.com/library/dd505232(v=vs.118).aspx) method creates a link containing the `UserId` and confirmation token.</span></span> <span data-ttu-id="6e30e-224">Po wysłaniu tego linku do użytkownika zostanie wysłana wiadomość e-mail z informacją, że użytkownik może wybrać link w aplikacji poczty e-mail, aby potwierdzić swoje konto.</span><span class="sxs-lookup"><span data-stu-id="6e30e-224">This link is then emailed to the user, the user can select on the link in their email app to confirm their account.</span></span>

<a id="email"></a>

## <a name="set-up-email-confirmation"></a><span data-ttu-id="6e30e-225">Skonfiguruj potwierdzenie poczty e-mail</span><span class="sxs-lookup"><span data-stu-id="6e30e-225">Set up email confirmation</span></span>

<span data-ttu-id="6e30e-226">Przejdź do [strony rejestracji w usłudze Azure SendGrid](https://azure.microsoft.com/gallery/store/sendgrid/sendgrid-azure/) i zarejestruj się w celu uzyskania bezpłatnego konta.</span><span class="sxs-lookup"><span data-stu-id="6e30e-226">Go to the [Azure SendGrid sign up page](https://azure.microsoft.com/gallery/store/sendgrid/sendgrid-azure/) and register for free account.</span></span> <span data-ttu-id="6e30e-227">Dodaj kod podobny do poniższego, aby skonfigurować SendGrid:</span><span class="sxs-lookup"><span data-stu-id="6e30e-227">Add code similar to the following to configure SendGrid:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample7.cs?highlight=5)]

> [!NOTE]
> <span data-ttu-id="6e30e-228">Klienci poczty e-mail często akceptują tylko wiadomości tekstowe (bez HTML).</span><span class="sxs-lookup"><span data-stu-id="6e30e-228">Email clients frequently accept only text messages (no HTML).</span></span> <span data-ttu-id="6e30e-229">Należy podać komunikat w postaci tekstowej i HTML.</span><span class="sxs-lookup"><span data-stu-id="6e30e-229">You should provide the message in text and HTML.</span></span> <span data-ttu-id="6e30e-230">W powyższym przykładzie SendGrid jest to realizowane przy użyciu `myMessage.Text` i `myMessage.Html` kodu pokazanego powyżej.</span><span class="sxs-lookup"><span data-stu-id="6e30e-230">In the SendGrid sample above, this is done with the `myMessage.Text` and `myMessage.Html` code shown above.</span></span>

<span data-ttu-id="6e30e-231">Poniższy kod przedstawia sposób wysyłania wiadomości e-mail przy użyciu klasy [MailMessage](https://msdn.microsoft.com/library/system.net.mail.mailmessage.aspx) , w której `message.Body` zwraca tylko link.</span><span class="sxs-lookup"><span data-stu-id="6e30e-231">The following code shows how to send email using the [MailMessage](https://msdn.microsoft.com/library/system.net.mail.mailmessage.aspx) class where `message.Body` returns only the link.</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample8.cs)]

> [!WARNING]
> <span data-ttu-id="6e30e-232">Zabezpieczenia — nigdy nie należy przechowywać poufnych danych w kodzie źródłowym.</span><span class="sxs-lookup"><span data-stu-id="6e30e-232">Security - Never store sensitive data in your source code.</span></span> <span data-ttu-id="6e30e-233">Konto i poświadczenia są przechowywane w element appSetting.</span><span class="sxs-lookup"><span data-stu-id="6e30e-233">The account and credentials are stored in the appSetting.</span></span> <span data-ttu-id="6e30e-234">Na platformie Azure możesz bezpiecznie przechowywać te wartości na karcie **[Konfiguracja](https://blogs.msdn.com/b/webdev/archive/2014/06/04/queuebackgroundworkitem-to-reliably-schedule-and-run-long-background-process-in-asp-net.aspx)** w Azure Portal.</span><span class="sxs-lookup"><span data-stu-id="6e30e-234">On Azure, you can securely store these values on the **[Configure](https://blogs.msdn.com/b/webdev/archive/2014/06/04/queuebackgroundworkitem-to-reliably-schedule-and-run-long-background-process-in-asp-net.aspx)** tab in the Azure portal.</span></span> <span data-ttu-id="6e30e-235">Zapoznaj [się z najlepszymi rozwiązaniami dotyczącymi wdrażania haseł i innych poufnych danych w ASP.NET i na platformie Azure](best-practices-for-deploying-passwords-and-other-sensitive-data-to-aspnet-and-azure.md).</span><span class="sxs-lookup"><span data-stu-id="6e30e-235">See [Best practices for deploying passwords and other sensitive data to ASP.NET and Azure](best-practices-for-deploying-passwords-and-other-sensitive-data-to-aspnet-and-azure.md).</span></span>

<span data-ttu-id="6e30e-236">Wprowadź swoje poświadczenia SendGrid, uruchom aplikację, zarejestruj się przy użyciu aliasu e-mail, aby wybrać link Potwierdź w wiadomości e-mail.</span><span class="sxs-lookup"><span data-stu-id="6e30e-236">Enter your SendGrid credentials, run the app, register with an email alias can select the confirm link in your email.</span></span> <span data-ttu-id="6e30e-237">Aby dowiedzieć się, jak to zrobić za pomocą konta e-mail [Outlook.com](http://outlook.com) , zobacz [ C# konfiguracja SMTP John ATTEN dla Outlook.com hosta SMTP](http://typecastexception.com/post/2013/12/20/C-SMTP-Configuration-for-OutlookCom-SMTP-Host.aspx) i jego[ASP.NET Identity 2,0: Konfigurowanie weryfikacji konta i wpisów autoryzacji dwuskładnikowej](http://typecastexception.com/post/2014/04/20/ASPNET-Identity-20-Setting-Up-Account-Validation-and-Two-Factor-Authorization.aspx) .</span><span class="sxs-lookup"><span data-stu-id="6e30e-237">To see how to do this with your [Outlook.com](http://outlook.com) email account, see John Atten's [C# SMTP Configuration for Outlook.Com SMTP Host](http://typecastexception.com/post/2013/12/20/C-SMTP-Configuration-for-OutlookCom-SMTP-Host.aspx) and his[ASP.NET Identity 2.0: Setting Up Account Validation and Two-Factor Authorization](http://typecastexception.com/post/2014/04/20/ASPNET-Identity-20-Setting-Up-Account-Validation-and-Two-Factor-Authorization.aspx) posts.</span></span>

<span data-ttu-id="6e30e-238">Gdy użytkownik wybierze przycisk **zarejestruj** , wiadomość e-mail z potwierdzeniem zawierającą token walidacji jest wysyłana na adres e-mail.</span><span class="sxs-lookup"><span data-stu-id="6e30e-238">Once a user selects the **Register** button a confirmation email containing a validation token is sent to their email address.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image12.png)

<span data-ttu-id="6e30e-239">Użytkownik wysyła wiadomość e-mail z tokenem potwierdzającym dla swojego konta.</span><span class="sxs-lookup"><span data-stu-id="6e30e-239">The user is sent an email with a confirmation token for their account.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image13.png)

## <a name="examine-the-code"></a><span data-ttu-id="6e30e-240">Analizowanie kodu</span><span class="sxs-lookup"><span data-stu-id="6e30e-240">Examine the code</span></span>

<span data-ttu-id="6e30e-241">Poniższy kod przedstawia metodę `POST ForgotPassword`.</span><span class="sxs-lookup"><span data-stu-id="6e30e-241">The following code shows the `POST ForgotPassword` method.</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample9.cs)]

<span data-ttu-id="6e30e-242">Metoda kończy się niepowodzeniem, jeśli adres e-mail użytkownika nie został potwierdzony.</span><span class="sxs-lookup"><span data-stu-id="6e30e-242">The method fails silently if the user email has not been confirmed.</span></span> <span data-ttu-id="6e30e-243">Jeśli błąd został ogłoszony dla nieprawidłowego adresu e-mail, złośliwi użytkownicy mogą użyć tych informacji w celu znalezienia prawidłowych userId (aliasów e-mail) do ataku.</span><span class="sxs-lookup"><span data-stu-id="6e30e-243">If an error was posted for an invalid email address, malicious users could use that information to find valid userId (email aliases) to attack.</span></span>

<span data-ttu-id="6e30e-244">Poniższy kod przedstawia metodę `ConfirmEmail` na kontrolerze konta, która jest wywoływana, gdy użytkownik wybierze link potwierdzenia w wysyłanej do nich wiadomości e-mail:</span><span class="sxs-lookup"><span data-stu-id="6e30e-244">The following code shows the `ConfirmEmail` method in the account controller that is called when the user selects the confirmation link in the email sent to them:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample10.cs)]

<span data-ttu-id="6e30e-245">Gdy użyto zapomnianego tokenu hasła, zostanie on unieważniony.</span><span class="sxs-lookup"><span data-stu-id="6e30e-245">Once a forgotten password token has been used, it's invalidated.</span></span> <span data-ttu-id="6e30e-246">Następująca zmiana kodu w metodzie `Create` (w pliku *\_aplikacji Start\IdentityConfig.cs* ) powoduje, że tokeny wygasną w ciągu 3 godzin.</span><span class="sxs-lookup"><span data-stu-id="6e30e-246">The following code change in the `Create` method (in the *App\_Start\IdentityConfig.cs* file) sets the tokens to expire in 3 hours.</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample11.cs?highlight=6-8)]

<span data-ttu-id="6e30e-247">Po powyższym kodzie, zapomniane hasło i tokeny potwierdzenia wiadomości e-mail wygasną za 3 godziny.</span><span class="sxs-lookup"><span data-stu-id="6e30e-247">With the code above, the forgotten password and the email confirmation tokens will expire in 3 hours.</span></span> <span data-ttu-id="6e30e-248">Domyślny `TokenLifespan` to jeden dzień.</span><span class="sxs-lookup"><span data-stu-id="6e30e-248">The default `TokenLifespan` is one day.</span></span>

<span data-ttu-id="6e30e-249">Poniższy kod przedstawia metodę potwierdzenia wiadomości e-mail:</span><span class="sxs-lookup"><span data-stu-id="6e30e-249">The following code shows the email confirmation method:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample12.cs)]

 <span data-ttu-id="6e30e-250">Aby zwiększyć bezpieczeństwo aplikacji, ASP.NET Identity obsługuje uwierzytelnianie dwuskładnikowe (funkcji 2FA).</span><span class="sxs-lookup"><span data-stu-id="6e30e-250">To make your app more secure, ASP.NET Identity supports Two-Factor authentication (2FA).</span></span> <span data-ttu-id="6e30e-251">Zobacz [ASP.NET Identity 2,0: Konfigurowanie weryfikacji konta i autoryzacji dwuskładnikowej](http://typecastexception.com/post/2014/04/20/ASPNET-Identity-20-Setting-Up-Account-Validation-and-Two-Factor-Authorization.aspx) przez Jan ATTEN.</span><span class="sxs-lookup"><span data-stu-id="6e30e-251">See [ASP.NET Identity 2.0: Setting Up Account Validation and Two-Factor Authorization](http://typecastexception.com/post/2014/04/20/ASPNET-Identity-20-Setting-Up-Account-Validation-and-Two-Factor-Authorization.aspx) by John Atten.</span></span> <span data-ttu-id="6e30e-252">Mimo że można ustawić blokadę konta dla nieudanych prób logowania, to podejście sprawia, że logowanie jest podatne na blokady [systemu DOS](http://en.wikipedia.org/wiki/Denial-of-service_attack) .</span><span class="sxs-lookup"><span data-stu-id="6e30e-252">Although you can set account lockout on login password attempt failures, that approach makes your login susceptible to [DOS](http://en.wikipedia.org/wiki/Denial-of-service_attack) lockouts.</span></span> <span data-ttu-id="6e30e-253">Zalecamy używanie blokady konta tylko z funkcji 2FA.</span><span class="sxs-lookup"><span data-stu-id="6e30e-253">We recommend you use account lockout only with 2FA.</span></span>  
<a id="addRes"></a>

## <a name="additional-resources"></a><span data-ttu-id="6e30e-254">Dodatkowe zasoby</span><span class="sxs-lookup"><span data-stu-id="6e30e-254">Additional resources</span></span>

- [<span data-ttu-id="6e30e-255">Omówienie niestandardowych dostawców magazynu dla produktu ASP.NET Identity</span><span class="sxs-lookup"><span data-stu-id="6e30e-255">Overview of Custom Storage Providers for ASP.NET Identity</span></span>](../extensibility/overview-of-custom-storage-providers-for-aspnet-identity.md)
- <span data-ttu-id="6e30e-256">[Aplikacja MVC 5 z logowaniem w serwisach Facebook, Twitter, LinkedIn i Google OAuth2](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) również pokazuje, jak dodać informacje o profilu do tabeli users.</span><span class="sxs-lookup"><span data-stu-id="6e30e-256">[MVC 5 App with Facebook, Twitter, LinkedIn and Google OAuth2 Sign-on](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) also shows how to add profile information to the users table.</span></span>
- <span data-ttu-id="6e30e-257">[ASP.NET MVC i Identity 2,0: zrozumienie podstaw](http://typecastexception.com/post/2014/04/20/ASPNET-MVC-and-Identity-20-Understanding-the-Basics.aspx) przez John ATTEN.</span><span class="sxs-lookup"><span data-stu-id="6e30e-257">[ASP.NET MVC and Identity 2.0: Understanding the Basics](http://typecastexception.com/post/2014/04/20/ASPNET-MVC-and-Identity-20-Understanding-the-Basics.aspx) by John Atten.</span></span>
- [<span data-ttu-id="6e30e-258">Wprowadzenie do produktu ASP.NET Identity</span><span class="sxs-lookup"><span data-stu-id="6e30e-258">Introduction to ASP.NET Identity</span></span>](../getting-started/introduction-to-aspnet-identity.md)
- <span data-ttu-id="6e30e-259">[Zapowiedź RTM ASP.NET Identity 2.0.0](https://blogs.msdn.com/b/webdev/archive/2014/03/20/test-announcing-rtm-of-asp-net-identity-2-0-0.aspx) przez Pranav Rastogi.</span><span class="sxs-lookup"><span data-stu-id="6e30e-259">[Announcing RTM of ASP.NET Identity 2.0.0](https://blogs.msdn.com/b/webdev/archive/2014/03/20/test-announcing-rtm-of-asp-net-identity-2-0-0.aspx) by Pranav Rastogi.</span></span>
