---
uid: identity/overview/migrations/migrating-an-existing-website-from-sql-membership-to-aspnet-identity
title: Migrowanie istniejącej witryny sieci Web z członkostwa SQL do ASP.NET Identity ASP.NET 4. x
author: Rick-Anderson
description: W tym samouczku przedstawiono procedurę migrowania istniejącej aplikacji sieci Web z danymi użytkownika i roli utworzonych przy użyciu członkostwa SQL do nowych ASP.NET Identity s...
ms.author: riande
ms.date: 12/19/2014
ms.custom: seoapril2019
ms.assetid: 220d3d75-16b2-4240-beae-a5b534f06419
msc.legacyurl: /identity/overview/migrations/migrating-an-existing-website-from-sql-membership-to-aspnet-identity
msc.type: authoredcontent
ms.openlocfilehash: 633229cc4311d151121bf6a91b9fa8aeecca1197
ms.sourcegitcommit: 7709c0a091b8d55b7b33bad8849f7b66b23c3d72
ms.translationtype: MT
ms.contentlocale: pl-PL
ms.lasthandoff: 02/19/2020
ms.locfileid: "77456156"
---
# <a name="migrating-an-existing-website-from-sql-membership-to-aspnet-identity"></a><span data-ttu-id="9ef6c-103">Migrowanie istniejącej witryny internetowej z członkostwa SQL do systemu ASP.NET Identity</span><span class="sxs-lookup"><span data-stu-id="9ef6c-103">Migrating an Existing Website from SQL Membership to ASP.NET Identity</span></span>

<span data-ttu-id="9ef6c-104">Autor [Rick Anderson](https://twitter.com/RickAndMSFT), [Suhas Joshi](https://github.com/suhasj)</span><span class="sxs-lookup"><span data-stu-id="9ef6c-104">by [Rick Anderson](https://twitter.com/RickAndMSFT), [Suhas Joshi](https://github.com/suhasj)</span></span>

> <span data-ttu-id="9ef6c-105">W tym samouczku przedstawiono procedurę migrowania istniejącej aplikacji sieci Web z danymi użytkownika i roli utworzonych przy użyciu członkostwa SQL w nowym systemie ASP.NET Identity.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-105">This tutorial illustrates the steps to migrate an existing web application with user and role data created using SQL Membership to the new ASP.NET Identity system.</span></span> <span data-ttu-id="9ef6c-106">To podejście obejmuje zmianę istniejącego schematu bazy danych na ten, który jest wymagany przez ASP.NET Identity i hak w stare/nowe klasy do niego.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-106">This approach involves changing the existing database schema to the one needed by the ASP.NET Identity and hook in the old/new classes to it.</span></span> <span data-ttu-id="9ef6c-107">Po zastosowaniu tej metody po migracji bazy danych przyszłe aktualizacje tożsamości będą obsługiwane bezproblemowo.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-107">After you adopt this approach, once your database is migrated, future updates to Identity will be handled effortlessly.</span></span>

<span data-ttu-id="9ef6c-108">W tym samouczku utworzymy szablon aplikacji sieci Web (Formularze sieci Web) utworzony za pomocą programu Visual Studio 2010 do tworzenia danych użytkownika i roli.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-108">For this tutorial, we will take a web application template (Web Forms) created using Visual Studio 2010 to create user and role data.</span></span> <span data-ttu-id="9ef6c-109">Następnie użyjemy skryptów SQL do przeprowadzenia migracji istniejącej bazy danych do tabel wymaganych przez system tożsamości.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-109">We will then use SQL scripts to migrate the existing database to tables needed by the Identity system.</span></span> <span data-ttu-id="9ef6c-110">Następnie zainstalujemy wymagane pakiety NuGet i dodamy nowe strony zarządzania kontami, które używają systemu tożsamości do zarządzania członkostwem.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-110">Next we'll install the necessary NuGet packages and add new account management pages which use the Identity system for membership management.</span></span> <span data-ttu-id="9ef6c-111">W ramach testu migracji użytkownicy utworzeni przy użyciu członkostwa SQL powinni mieć możliwość zalogowania się, a nowi użytkownicy powinni mieć możliwość zarejestrowania się.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-111">As a test of migration, users created using SQL membership should be able to log in and new users should be able to register.</span></span> <span data-ttu-id="9ef6c-112">Pełny przykład można znaleźć [tutaj](https://github.com/aspnet/samples/tree/master/samples/aspnet/Identity/SQLMembership-Identity-OWIN/).</span><span class="sxs-lookup"><span data-stu-id="9ef6c-112">You can find the complete sample [here](https://github.com/aspnet/samples/tree/master/samples/aspnet/Identity/SQLMembership-Identity-OWIN/).</span></span> <span data-ttu-id="9ef6c-113">Zobacz również [Migrowanie z członkostwa ASP.NET do ASP.NET Identity](http://travis.io/blog/2015/03/24/migrate-from-aspnet-membership-to-aspnet-identity.html).</span><span class="sxs-lookup"><span data-stu-id="9ef6c-113">See also [Migrating from ASP.NET Membership to ASP.NET Identity](http://travis.io/blog/2015/03/24/migrate-from-aspnet-membership-to-aspnet-identity.html).</span></span>

## <a name="getting-started"></a><span data-ttu-id="9ef6c-114">Wprowadzenie</span><span class="sxs-lookup"><span data-stu-id="9ef6c-114">Getting started</span></span>

### <a name="creating-an-application-with-sql-membership"></a><span data-ttu-id="9ef6c-115">Tworzenie aplikacji z członkostwem SQL</span><span class="sxs-lookup"><span data-stu-id="9ef6c-115">Creating an application with SQL Membership</span></span>

1. <span data-ttu-id="9ef6c-116">Musimy zacząć od istniejącej aplikacji, która korzysta z członkostwa SQL i ma dane dotyczące użytkowników i ról.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-116">We need to start with an existing application that uses SQL membership and has user and role data.</span></span> <span data-ttu-id="9ef6c-117">Na potrzeby tego artykułu utworzymy aplikację sieci Web w programie Visual Studio 2010.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-117">For the purpose of this article, let's create a web application in Visual Studio 2010.</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image1.jpg)
2. <span data-ttu-id="9ef6c-118">Za pomocą narzędzia do konfiguracji ASP.NET utwórz 2 użytkowników: **oldAdminUser** i **oldUser.**</span><span class="sxs-lookup"><span data-stu-id="9ef6c-118">Using the ASP.NET Configuration tool, create 2 users: **oldAdminUser** and **oldUser.**</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image1.png)

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image2.jpg)
3. <span data-ttu-id="9ef6c-119">Utwórz rolę o nazwie admin i Dodaj "oldAdminUser" jako użytkownika w tej roli.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-119">Create a role named Admin and add 'oldAdminUser' as a user in that role.</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image2.png)
4. <span data-ttu-id="9ef6c-120">Utwórz sekcję administratora witryny z wartością default. aspx.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-120">Create an Admin section of the site with a Default.aspx.</span></span> <span data-ttu-id="9ef6c-121">Ustaw tag autoryzacja w pliku Web. config, aby umożliwić dostęp tylko użytkownikom w rolach administratora.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-121">Set the authorization tag in the web.config file to enable access only to users in Admin roles.</span></span> <span data-ttu-id="9ef6c-122">Więcej informacji można znaleźć tutaj [https://www.asp.net/web-forms/tutorials/security/roles/role-based-authorization-cs](../../../web-forms/overview/older-versions-security/roles/role-based-authorization-cs.md)</span><span class="sxs-lookup"><span data-stu-id="9ef6c-122">More information can be found here [https://www.asp.net/web-forms/tutorials/security/roles/role-based-authorization-cs](../../../web-forms/overview/older-versions-security/roles/role-based-authorization-cs.md)</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image3.png)
5. <span data-ttu-id="9ef6c-123">Wyświetl bazę danych w Eksplorator serwera, aby zrozumieć tabele utworzone przez system członkostwa SQL.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-123">View the database in Server Explorer to understand the tables created by the SQL membership system.</span></span> <span data-ttu-id="9ef6c-124">Dane logowania użytkownika są przechowywane w tabelach\_ASPNET i ASPNET\_, podczas gdy dane roli są przechowywane w tabeli role\_ASPNET.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-124">The user login data is stored in the aspnet\_Users and aspnet\_Membership tables, while role data is stored in the aspnet\_Roles table.</span></span> <span data-ttu-id="9ef6c-125">Informacje o użytkownikach, w których role są przechowywane w tabeli ASPNET\_UsersInRoles.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-125">Information about which users are in which roles is stored in the aspnet\_UsersInRoles table.</span></span> <span data-ttu-id="9ef6c-126">Aby zarządzać członkostwem w warstwie Podstawowa, wystarczy przenieść informacje w powyższych tabelach do systemu ASP.NET Identity.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-126">For basic membership management it is sufficient to port the information in the above tables to the ASP.NET Identity system.</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image4.png)

### <a name="migrating-to-visual-studio-2013"></a><span data-ttu-id="9ef6c-127">Migrowanie do Visual Studio 2013</span><span class="sxs-lookup"><span data-stu-id="9ef6c-127">Migrating to Visual Studio 2013</span></span>

1. <span data-ttu-id="9ef6c-128">Zainstaluj Visual Studio Express 2013 dla sieci Web lub Visual Studio 2013 wraz z [najnowszymi aktualizacjami](https://www.microsoft.com/download/details.aspx?id=44921).</span><span class="sxs-lookup"><span data-stu-id="9ef6c-128">Install Visual Studio Express 2013 for Web or Visual Studio 2013 along with the [latest updates](https://www.microsoft.com/download/details.aspx?id=44921).</span></span>
2. <span data-ttu-id="9ef6c-129">Otwórz powyższy projekt w zainstalowanej wersji programu Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-129">Open the above project in your installed version of Visual Studio.</span></span> <span data-ttu-id="9ef6c-130">Jeśli na komputerze nie zainstalowano SQL Server Express, podczas otwierania projektu zostanie wyświetlony monit, ponieważ parametry połączenia korzystają z programu SQL Express.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-130">If SQL Server Express is not installed on the machine, a prompt is displayed when you open the project, since the connection string uses SQL Express.</span></span> <span data-ttu-id="9ef6c-131">Możesz wybrać opcję instalacji programu SQL Express lub obejść, aby zmienić parametry połączenia na LocalDb.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-131">You can either choose to install SQL Express or as work around change the connection string to LocalDb.</span></span> <span data-ttu-id="9ef6c-132">W tym artykule zmienimy ją na LocalDb.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-132">For this article we'll change it to LocalDb.</span></span>
3. <span data-ttu-id="9ef6c-133">Otwórz plik Web. config i Zmień parametry połączenia z. SQLExpress do (LocalDb) v 11.0.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-133">Open web.config and change the connection string from .SQLExpress to (LocalDb)v11.0.</span></span> <span data-ttu-id="9ef6c-134">Usuń "wystąpienie użytkownika = true" z parametrów połączenia.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-134">Remove 'User Instance=true' from the connection string.</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image3.jpg)
4. <span data-ttu-id="9ef6c-135">Otwórz Eksplorator serwera i sprawdź, czy można zaobserwować schemat i dane tabeli.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-135">Open Server Explorer and verify that the table schema and data can be observed.</span></span>
5. <span data-ttu-id="9ef6c-136">System ASP.NET Identity działa w wersji 4,5 lub nowszej.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-136">The ASP.NET Identity system works with version 4.5 or higher of the framework.</span></span> <span data-ttu-id="9ef6c-137">Przekieruj aplikację do wersji 4,5 lub nowszej.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-137">Retarget the application to 4.5 or higher.</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image5.png)

    <span data-ttu-id="9ef6c-138">Skompiluj projekt, aby sprawdzić, czy nie wystąpiły żadne błędy.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-138">Build the project to verify that there are no errors.</span></span>

### <a name="installing-the-nuget-packages"></a><span data-ttu-id="9ef6c-139">Instalowanie pakietów NuGet</span><span class="sxs-lookup"><span data-stu-id="9ef6c-139">Installing the Nuget packages</span></span>

1. <span data-ttu-id="9ef6c-140">W Eksplorator rozwiązań kliknij prawym przyciskiem myszy projekt &gt; **Zarządzaj pakietami NuGet**.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-140">In Solution Explorer, right-click the project &gt; **Manage NuGet Packages**.</span></span> <span data-ttu-id="9ef6c-141">W polu wyszukiwania wprowadź ciąg "Asp.net Identity" (tożsamość tożsamości).</span><span class="sxs-lookup"><span data-stu-id="9ef6c-141">In the search box, enter "Asp.net Identity".</span></span> <span data-ttu-id="9ef6c-142">Wybierz pakiet z listy wyników, a następnie kliknij przycisk Instaluj.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-142">Select the package in the list of results and click install.</span></span> <span data-ttu-id="9ef6c-143">Zaakceptuj umowę licencyjną, klikając przycisk "Akceptuję".</span><span class="sxs-lookup"><span data-stu-id="9ef6c-143">Accept the license agreement by clicking on "I Accept" button.</span></span> <span data-ttu-id="9ef6c-144">Należy pamiętać, że ten pakiet zainstaluje pakiety zależności: EntityFramework i Microsoft ASP.NET Identity Core.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-144">Note that this package will install the dependency packages: EntityFramework and Microsoft ASP.NET Identity Core.</span></span> <span data-ttu-id="9ef6c-145">Podobnie Zainstaluj następujące pakiety (Pomiń ostatnie 4 pakiety OWIN, jeśli nie chcesz włączyć logowania OAuth):</span><span class="sxs-lookup"><span data-stu-id="9ef6c-145">Similarly install the following packages (skip the last 4 OWIN packages if you don't want to enable OAuth log-in):</span></span>

   - <span data-ttu-id="9ef6c-146">Microsoft.AspNet.Identity.Owin</span><span class="sxs-lookup"><span data-stu-id="9ef6c-146">Microsoft.AspNet.Identity.Owin</span></span>
   - <span data-ttu-id="9ef6c-147">Microsoft.Owin.Host.SystemWeb</span><span class="sxs-lookup"><span data-stu-id="9ef6c-147">Microsoft.Owin.Host.SystemWeb</span></span>
   - <span data-ttu-id="9ef6c-148">Microsoft.Owin.Security.Facebook</span><span class="sxs-lookup"><span data-stu-id="9ef6c-148">Microsoft.Owin.Security.Facebook</span></span>
   - <span data-ttu-id="9ef6c-149">Microsoft.Owin.Security.Google</span><span class="sxs-lookup"><span data-stu-id="9ef6c-149">Microsoft.Owin.Security.Google</span></span>
   - <span data-ttu-id="9ef6c-150">Microsoft.Owin.Security.MicrosoftAccount</span><span class="sxs-lookup"><span data-stu-id="9ef6c-150">Microsoft.Owin.Security.MicrosoftAccount</span></span>
   - <span data-ttu-id="9ef6c-151">Microsoft.Owin.Security.Twitter</span><span class="sxs-lookup"><span data-stu-id="9ef6c-151">Microsoft.Owin.Security.Twitter</span></span>

     ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image6.png)

### <a name="migrate-database-to-the-new-identity-system"></a><span data-ttu-id="9ef6c-152">Migrowanie bazy danych do nowego systemu tożsamości</span><span class="sxs-lookup"><span data-stu-id="9ef6c-152">Migrate database to the new Identity system</span></span>

<span data-ttu-id="9ef6c-153">Następnym krokiem jest przeprowadzenie migracji istniejącej bazy danych do schematu wymaganego przez system ASP.NET Identity.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-153">The next step is to migrate the existing database to a schema required by the ASP.NET Identity system.</span></span> <span data-ttu-id="9ef6c-154">Aby to osiągnąć, należy uruchomić skrypt SQL, który zawiera zestaw poleceń umożliwiających tworzenie nowych tabel i Migrowanie istniejących informacji o użytkowniku do nowych tabel.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-154">To achieve this we run a SQL script which has a set of commands to create new tables and migrate existing user information to the new tables.</span></span> <span data-ttu-id="9ef6c-155">Plik skryptu można znaleźć [tutaj](https://github.com/aspnet/samples/blob/master/samples/aspnet/Identity/SQLMembership-Identity-OWIN/Migrations.sql).</span><span class="sxs-lookup"><span data-stu-id="9ef6c-155">The script file can be found [here](https://github.com/aspnet/samples/blob/master/samples/aspnet/Identity/SQLMembership-Identity-OWIN/Migrations.sql).</span></span>

<span data-ttu-id="9ef6c-156">Ten plik skryptu jest specyficzny dla tego przykładu.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-156">This script file is specific to this sample.</span></span> <span data-ttu-id="9ef6c-157">Jeśli schemat tabel utworzonych przy użyciu członkostwa SQL jest dostosowywany lub modyfikowany, należy odpowiednio zmienić skrypty.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-157">If the schema for the tables created using SQL membership is customized or modified the scripts need to be changed accordingly.</span></span>

### <a name="how-to-generate-the-sql-script-for-schema-migration"></a><span data-ttu-id="9ef6c-158">Jak wygenerować skrypt SQL na potrzeby migracji schematu</span><span class="sxs-lookup"><span data-stu-id="9ef6c-158">How to generate the SQL script for schema migration</span></span>

<span data-ttu-id="9ef6c-159">Aby ASP.NET Identity klasy do pracy z danymi istniejących użytkowników, musimy zmigrować schemat bazy danych do tego, co jest wymagane przez ASP.NET Identity.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-159">For ASP.NET Identity classes to work out of the box with the data of existing users, we need to migrate the database schema to the one needed by ASP.NET Identity.</span></span> <span data-ttu-id="9ef6c-160">Możemy to zrobić przez dodanie nowych tabel i skopiowanie istniejących informacji do tych tabel.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-160">We can do this by adding new tables and copying the existing information to those tables.</span></span> <span data-ttu-id="9ef6c-161">Domyślnie ASP.NET Identity używa EntityFramework do mapowania klas modelu tożsamości z powrotem do bazy danych w celu przechowywania/pobierania informacji.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-161">By default ASP.NET Identity uses EntityFramework to map the Identity model classes back to the database to store/retrieve information.</span></span> <span data-ttu-id="9ef6c-162">Te klasy modelu implementują podstawowe interfejsy tożsamości definiujące obiekty użytkowników i ról.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-162">These model classes implement the core Identity interfaces defining user and role objects.</span></span> <span data-ttu-id="9ef6c-163">Tabele i kolumny w bazie danych są oparte na tych klasach modelu.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-163">The tables and the columns in the database are based on these model classes.</span></span> <span data-ttu-id="9ef6c-164">Klasy modelu EntityFramework w 2.1.0 Identity v i ich właściwości są zgodne z definicją poniżej</span><span class="sxs-lookup"><span data-stu-id="9ef6c-164">The EntityFramework model classes in Identity v2.1.0 and their properties are as defined below</span></span>

| <span data-ttu-id="9ef6c-165">**IdentityUser**</span><span class="sxs-lookup"><span data-stu-id="9ef6c-165">**IdentityUser**</span></span> | <span data-ttu-id="9ef6c-166">**Typ**</span><span class="sxs-lookup"><span data-stu-id="9ef6c-166">**Type**</span></span> | <span data-ttu-id="9ef6c-167">**IdentityRole**</span><span class="sxs-lookup"><span data-stu-id="9ef6c-167">**IdentityRole**</span></span> | <span data-ttu-id="9ef6c-168">**IdentityUserRole**</span><span class="sxs-lookup"><span data-stu-id="9ef6c-168">**IdentityUserRole**</span></span> | <span data-ttu-id="9ef6c-169">**IdentityUserLogin**</span><span class="sxs-lookup"><span data-stu-id="9ef6c-169">**IdentityUserLogin**</span></span> | <span data-ttu-id="9ef6c-170">**IdentityUserClaim**</span><span class="sxs-lookup"><span data-stu-id="9ef6c-170">**IdentityUserClaim**</span></span> |
| --- | --- | --- | --- | --- | --- |
| <span data-ttu-id="9ef6c-171">Identyfikator</span><span class="sxs-lookup"><span data-stu-id="9ef6c-171">Id</span></span> | <span data-ttu-id="9ef6c-172">ciąg</span><span class="sxs-lookup"><span data-stu-id="9ef6c-172">string</span></span> | <span data-ttu-id="9ef6c-173">Identyfikator</span><span class="sxs-lookup"><span data-stu-id="9ef6c-173">Id</span></span> | <span data-ttu-id="9ef6c-174">RoleId</span><span class="sxs-lookup"><span data-stu-id="9ef6c-174">RoleId</span></span> | <span data-ttu-id="9ef6c-175">ProviderKey</span><span class="sxs-lookup"><span data-stu-id="9ef6c-175">ProviderKey</span></span> | <span data-ttu-id="9ef6c-176">Identyfikator</span><span class="sxs-lookup"><span data-stu-id="9ef6c-176">Id</span></span> |
| <span data-ttu-id="9ef6c-177">Nazwa użytkownika</span><span class="sxs-lookup"><span data-stu-id="9ef6c-177">Username</span></span> | <span data-ttu-id="9ef6c-178">ciąg</span><span class="sxs-lookup"><span data-stu-id="9ef6c-178">string</span></span> | <span data-ttu-id="9ef6c-179">Name (Nazwa)</span><span class="sxs-lookup"><span data-stu-id="9ef6c-179">Name</span></span> | <span data-ttu-id="9ef6c-180">UserId</span><span class="sxs-lookup"><span data-stu-id="9ef6c-180">UserId</span></span> | <span data-ttu-id="9ef6c-181">UserId</span><span class="sxs-lookup"><span data-stu-id="9ef6c-181">UserId</span></span> | <span data-ttu-id="9ef6c-182">Claim</span><span class="sxs-lookup"><span data-stu-id="9ef6c-182">ClaimType</span></span> |
| <span data-ttu-id="9ef6c-183">PasswordHash</span><span class="sxs-lookup"><span data-stu-id="9ef6c-183">PasswordHash</span></span> | <span data-ttu-id="9ef6c-184">ciąg</span><span class="sxs-lookup"><span data-stu-id="9ef6c-184">string</span></span> |  |  | <span data-ttu-id="9ef6c-185">LoginProvider</span><span class="sxs-lookup"><span data-stu-id="9ef6c-185">LoginProvider</span></span> | <span data-ttu-id="9ef6c-186">ClaimValue</span><span class="sxs-lookup"><span data-stu-id="9ef6c-186">ClaimValue</span></span> |
| <span data-ttu-id="9ef6c-187">SecurityStamp</span><span class="sxs-lookup"><span data-stu-id="9ef6c-187">SecurityStamp</span></span> | <span data-ttu-id="9ef6c-188">ciąg</span><span class="sxs-lookup"><span data-stu-id="9ef6c-188">string</span></span> |  |  |  | <span data-ttu-id="9ef6c-189">Identyfikator\_użytkownika</span><span class="sxs-lookup"><span data-stu-id="9ef6c-189">User\_Id</span></span> |
| <span data-ttu-id="9ef6c-190">Email</span><span class="sxs-lookup"><span data-stu-id="9ef6c-190">Email</span></span> | <span data-ttu-id="9ef6c-191">ciąg</span><span class="sxs-lookup"><span data-stu-id="9ef6c-191">string</span></span> |  |  |  |  |
| <span data-ttu-id="9ef6c-192">EmailConfirmed</span><span class="sxs-lookup"><span data-stu-id="9ef6c-192">EmailConfirmed</span></span> | <span data-ttu-id="9ef6c-193">bool</span><span class="sxs-lookup"><span data-stu-id="9ef6c-193">bool</span></span> |  |  |  |  |
| <span data-ttu-id="9ef6c-194">PhoneNumber</span><span class="sxs-lookup"><span data-stu-id="9ef6c-194">PhoneNumber</span></span> | <span data-ttu-id="9ef6c-195">ciąg</span><span class="sxs-lookup"><span data-stu-id="9ef6c-195">string</span></span> |  |  |  |  |
| <span data-ttu-id="9ef6c-196">PhoneNumberConfirmed</span><span class="sxs-lookup"><span data-stu-id="9ef6c-196">PhoneNumberConfirmed</span></span> | <span data-ttu-id="9ef6c-197">bool</span><span class="sxs-lookup"><span data-stu-id="9ef6c-197">bool</span></span> |  |  |  |  |
| <span data-ttu-id="9ef6c-198">LockoutEnabled</span><span class="sxs-lookup"><span data-stu-id="9ef6c-198">LockoutEnabled</span></span> | <span data-ttu-id="9ef6c-199">bool</span><span class="sxs-lookup"><span data-stu-id="9ef6c-199">bool</span></span> |  |  |  |  |
| <span data-ttu-id="9ef6c-200">LockoutEndDate</span><span class="sxs-lookup"><span data-stu-id="9ef6c-200">LockoutEndDate</span></span> | <span data-ttu-id="9ef6c-201">DateTime</span><span class="sxs-lookup"><span data-stu-id="9ef6c-201">DateTime</span></span> |  |  |  |  |
| <span data-ttu-id="9ef6c-202">AccessFailedCount</span><span class="sxs-lookup"><span data-stu-id="9ef6c-202">AccessFailedCount</span></span> | <span data-ttu-id="9ef6c-203">int</span><span class="sxs-lookup"><span data-stu-id="9ef6c-203">int</span></span> |  |  |  |  |

<span data-ttu-id="9ef6c-204">Musimy mieć tabele dla każdego z tych modeli z kolumnami odpowiadającymi właściwościom.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-204">We need to have tables for each of these models with columns corresponding to the properties.</span></span> <span data-ttu-id="9ef6c-205">Mapowanie między klasami i tabelami jest zdefiniowane w metodzie `OnModelCreating` `IdentityDBContext`.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-205">The mapping between classes and tables is defined in the `OnModelCreating` method of the `IdentityDBContext`.</span></span> <span data-ttu-id="9ef6c-206">Jest to tzw. Metoda konfiguracji interfejsu API Fluent i więcej informacji można znaleźć [tutaj](https://msdn.microsoft.com/data/jj591617.aspx).</span><span class="sxs-lookup"><span data-stu-id="9ef6c-206">This is known as the fluent API method of configuration and more information can be found [here](https://msdn.microsoft.com/data/jj591617.aspx).</span></span> <span data-ttu-id="9ef6c-207">Konfiguracja klas została opisana poniżej</span><span class="sxs-lookup"><span data-stu-id="9ef6c-207">The configuration for the classes is as mentioned below</span></span>

| <span data-ttu-id="9ef6c-208">**Określonej**</span><span class="sxs-lookup"><span data-stu-id="9ef6c-208">**Class**</span></span> | <span data-ttu-id="9ef6c-209">**Tabela**</span><span class="sxs-lookup"><span data-stu-id="9ef6c-209">**Table**</span></span> | <span data-ttu-id="9ef6c-210">**Klucz podstawowy**</span><span class="sxs-lookup"><span data-stu-id="9ef6c-210">**Primary key**</span></span> | <span data-ttu-id="9ef6c-211">**Klucz obcy**</span><span class="sxs-lookup"><span data-stu-id="9ef6c-211">**Foreign key**</span></span> |
| --- | --- | --- | --- |
| <span data-ttu-id="9ef6c-212">IdentityUser</span><span class="sxs-lookup"><span data-stu-id="9ef6c-212">IdentityUser</span></span> | <span data-ttu-id="9ef6c-213">AspnetUsers</span><span class="sxs-lookup"><span data-stu-id="9ef6c-213">AspnetUsers</span></span> | <span data-ttu-id="9ef6c-214">Identyfikator</span><span class="sxs-lookup"><span data-stu-id="9ef6c-214">Id</span></span> |  |
| <span data-ttu-id="9ef6c-215">IdentityRole</span><span class="sxs-lookup"><span data-stu-id="9ef6c-215">IdentityRole</span></span> | <span data-ttu-id="9ef6c-216">AspnetRoles</span><span class="sxs-lookup"><span data-stu-id="9ef6c-216">AspnetRoles</span></span> | <span data-ttu-id="9ef6c-217">Identyfikator</span><span class="sxs-lookup"><span data-stu-id="9ef6c-217">Id</span></span> |  |
| <span data-ttu-id="9ef6c-218">IdentityUserRole</span><span class="sxs-lookup"><span data-stu-id="9ef6c-218">IdentityUserRole</span></span> | <span data-ttu-id="9ef6c-219">AspnetUserRole</span><span class="sxs-lookup"><span data-stu-id="9ef6c-219">AspnetUserRole</span></span> | <span data-ttu-id="9ef6c-220">Identyfikator użytkownika i RoleId</span><span class="sxs-lookup"><span data-stu-id="9ef6c-220">UserId + RoleId</span></span> | <span data-ttu-id="9ef6c-221">Identyfikator\_użytkownika —&gt;AspnetUsers RoleId-&gt;AspnetRoles</span><span class="sxs-lookup"><span data-stu-id="9ef6c-221">User\_Id-&gt;AspnetUsers RoleId-&gt;AspnetRoles</span></span> |
| <span data-ttu-id="9ef6c-222">IdentityUserLogin</span><span class="sxs-lookup"><span data-stu-id="9ef6c-222">IdentityUserLogin</span></span> | <span data-ttu-id="9ef6c-223">AspnetUserLogins</span><span class="sxs-lookup"><span data-stu-id="9ef6c-223">AspnetUserLogins</span></span> | <span data-ttu-id="9ef6c-224">ProviderKey + UserId + LoginProvider</span><span class="sxs-lookup"><span data-stu-id="9ef6c-224">ProviderKey+UserId + LoginProvider</span></span> | <span data-ttu-id="9ef6c-225">Identyfikator użytkownika —&gt;AspnetUsers</span><span class="sxs-lookup"><span data-stu-id="9ef6c-225">UserId-&gt;AspnetUsers</span></span> |
| <span data-ttu-id="9ef6c-226">IdentityUserClaim</span><span class="sxs-lookup"><span data-stu-id="9ef6c-226">IdentityUserClaim</span></span> | <span data-ttu-id="9ef6c-227">AspnetUserClaims</span><span class="sxs-lookup"><span data-stu-id="9ef6c-227">AspnetUserClaims</span></span> | <span data-ttu-id="9ef6c-228">Identyfikator</span><span class="sxs-lookup"><span data-stu-id="9ef6c-228">Id</span></span> | <span data-ttu-id="9ef6c-229">Identyfikator\_użytkownika —&gt;AspnetUsers</span><span class="sxs-lookup"><span data-stu-id="9ef6c-229">User\_Id-&gt;AspnetUsers</span></span> |

<span data-ttu-id="9ef6c-230">Za pomocą tych informacji możemy utworzyć instrukcje SQL, aby utworzyć nowe tabele.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-230">With this information we can create SQL statements to create new tables.</span></span> <span data-ttu-id="9ef6c-231">Możemy ręcznie napisać każdą instrukcję lub wygenerować cały skrypt za pomocą poleceń programu PowerShell EntityFramework, które możemy edytować zgodnie z potrzebami.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-231">We can either write each statement individually or generate the entire script using EntityFramework PowerShell commands which we can then edit as required.</span></span> <span data-ttu-id="9ef6c-232">W tym celu w programie VS Otwórz **konsolę Menedżera pakietów** z menu Widok lub **Narzędzia** **.**</span><span class="sxs-lookup"><span data-stu-id="9ef6c-232">To do this, in VS open the **Package Manager Console** from the **View** or **Tools** menu</span></span>

- <span data-ttu-id="9ef6c-233">Uruchom polecenie "Enable-migrations", aby włączyć migracje EntityFramework.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-233">Run command "Enable-Migrations" to enable EntityFramework migrations.</span></span>
- <span data-ttu-id="9ef6c-234">Uruchom polecenie "Add-Migration Initial", które tworzy początkowy kod instalatora w celu utworzenia bazy danych C#w/VB.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-234">Run command "Add-migration initial" which creates the initial setup code to create the database in C#/VB.</span></span>
- <span data-ttu-id="9ef6c-235">Ostatnim krokiem jest uruchomienie polecenia "Update-Database-Script", które generuje skrypt SQL na podstawie klas modelu.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-235">The final step is to run "Update-Database –Script" command that generates the SQL script based on the model classes.</span></span>

[!INCLUDE[](../../../includes/identity/alter-command-exception.md)]

<span data-ttu-id="9ef6c-236">Ten skrypt generowania bazy danych może służyć jako początek, w którym będziemy wprowadzać dodatkowe zmiany w celu dodawania nowych kolumn i kopiowania danych.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-236">This database generation script can be used as a start where we'll be making additional changes to add new columns and copy data.</span></span> <span data-ttu-id="9ef6c-237">Zaletą tego jest generowanie `_MigrationHistory` tabeli, która jest używana przez EntityFramework do modyfikowania schematu bazy danych, gdy klasy modelu zmieniają się w przyszłych wersjach tożsamości.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-237">The advantage of this is that we generate the `_MigrationHistory` table which is used by EntityFramework to modify the database schema when the model classes change for future versions of Identity releases.</span></span>

<span data-ttu-id="9ef6c-238">Informacje o użytkowniku członkostwa w programie SQL mają inne właściwości oprócz tych, które są używane w klasie modelu użytkownika tożsamości, w tym adres e-mail, próby hasła, Data ostatniego logowania, Data ostatniego zablokowania itd. Jest to przydatne informacje, które chcemy przenieść do systemu tożsamości.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-238">The SQL membership user information had other properties in addition to the ones in the Identity user model class namely email, password attempts, last login date, last lock-out date etc. This is useful information and we would like it to be carried over to the Identity system.</span></span> <span data-ttu-id="9ef6c-239">Można to zrobić, dodając dodatkowe właściwości do modelu użytkownika i mapując je z powrotem do kolumn tabeli w bazie danych.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-239">This can be done by adding additional properties to the user model and mapping them back to the table columns in the database.</span></span> <span data-ttu-id="9ef6c-240">Możemy to zrobić przez dodanie klasy, która jest podklasą modelu `IdentityUser`.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-240">We can do this by adding a class that subclasses the `IdentityUser` model.</span></span> <span data-ttu-id="9ef6c-241">Można dodać właściwości do tej klasy niestandardowej i edytować skrypt SQL, aby dodać odpowiednie kolumny podczas tworzenia tabeli.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-241">We can add the properties to this custom class and edit the SQL script to add the corresponding columns when creating the table.</span></span> <span data-ttu-id="9ef6c-242">Kod dla tej klasy został szczegółowo opisany w artykule.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-242">The code for this class is described further in the article.</span></span> <span data-ttu-id="9ef6c-243">Skrypt SQL służący do tworzenia tabeli `AspnetUsers` po dodaniu nowych właściwości zostałby</span><span class="sxs-lookup"><span data-stu-id="9ef6c-243">The SQL script for creating the `AspnetUsers` table after adding the new properties would be</span></span>

[!code-sql[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample1.sql)]

<span data-ttu-id="9ef6c-244">Następnie musimy skopiować istniejące informacje z bazy danych członkostwa SQL do nowo dodanych tabel dla tożsamości.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-244">Next we need to copy the existing information from the SQL membership database to the newly added tables for Identity.</span></span> <span data-ttu-id="9ef6c-245">Można to zrobić za pomocą języka SQL, kopiując dane bezpośrednio z jednej tabeli do drugiej.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-245">This can be done through SQL by copying data directly from one table to another.</span></span> <span data-ttu-id="9ef6c-246">Aby dodać dane do wierszy tabeli, używamy konstrukcji `INSERT INTO [Table]`.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-246">To add data into the rows of table, we use the `INSERT INTO [Table]` construct.</span></span> <span data-ttu-id="9ef6c-247">Aby skopiować z innej tabeli, możemy użyć instrukcji `INSERT INTO` wraz z instrukcją `SELECT`.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-247">To copy from another table we can use the `INSERT INTO` statement along with the `SELECT` statement.</span></span> <span data-ttu-id="9ef6c-248">Aby uzyskać wszystkie informacje o użytkowniku, których potrzebujemy, aby wykonać zapytanie dotyczące *\_użytkowników* i *ASPNET\_tabele członkostwa* i skopiować dane do tabeli *AspNetUsers* .</span><span class="sxs-lookup"><span data-stu-id="9ef6c-248">To get all the user information we need to query the *aspnet\_Users* and *aspnet\_Membership* tables and copy the data to the *AspNetUsers* table.</span></span> <span data-ttu-id="9ef6c-249">Używamy `INSERT INTO` i `SELECT` razem z instrukcjami `JOIN` i `LEFT OUTER JOIN`.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-249">We use the `INSERT INTO` and `SELECT` along with `JOIN` and `LEFT OUTER JOIN` statements.</span></span> <span data-ttu-id="9ef6c-250">Aby uzyskać więcej informacji na temat wykonywania zapytań i kopiowania danych między tabelami, Skorzystaj z [tego](https://technet.microsoft.com/library/ms190750%28v=sql.105%29.aspx) linku.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-250">For more information about querying and copying data between tables, refer to [this](https://technet.microsoft.com/library/ms190750%28v=sql.105%29.aspx) link.</span></span> <span data-ttu-id="9ef6c-251">Ponadto tabele AspnetUserLogins i AspnetUserClaims są puste, aby zacząć od, ponieważ nie ma żadnych informacji w członkostwie SQL, które są domyślnie mapowane na ten program.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-251">Additionally the AspnetUserLogins and AspnetUserClaims tables are empty to begin with since there is no information in SQL membership that maps to this by default.</span></span> <span data-ttu-id="9ef6c-252">Jedyne skopiowane informacje dotyczą użytkowników i ról.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-252">The only information copied is for users and roles.</span></span> <span data-ttu-id="9ef6c-253">W przypadku projektu utworzonego w poprzednich krokach zapytanie SQL do kopiowania informacji do tabeli użytkownicy byłyby</span><span class="sxs-lookup"><span data-stu-id="9ef6c-253">For the project created in the previous steps, the SQL query to copy information to the users table would be</span></span>

[!code-sql[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample2.sql)]

<span data-ttu-id="9ef6c-254">W powyższej instrukcji języka SQL informacje dotyczące każdego użytkownika z tabel *aspnet\_users* i *ASPNET\_Membership* są kopiowane do kolumn tabeli *AspnetUsers* .</span><span class="sxs-lookup"><span data-stu-id="9ef6c-254">In the above SQL statement, information about each user from the *aspnet\_Users* and *aspnet\_Membership* tables is copied into the columns of the *AspnetUsers* table.</span></span> <span data-ttu-id="9ef6c-255">Jedyną modyfikacją wykonywaną w tym miejscu jest skopiowanie hasła.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-255">The only modification done here is when we copy the password.</span></span> <span data-ttu-id="9ef6c-256">Ponieważ algorytm szyfrowania dla haseł w członkostwie w programie SQL Server użył "PasswordSalt" i "PasswordFormat", jest on kopiowany również przy użyciu hasła skrótu, aby można było go użyć do odszyfrowania hasła przez tożsamość.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-256">Since the encryption algorithm for passwords in SQL membership used 'PasswordSalt' and 'PasswordFormat', we copy that too along with the hashed password so that it can be used to decrypt the password by Identity.</span></span> <span data-ttu-id="9ef6c-257">Jest to wyjaśnione dalej w artykule podczas podłączania niestandardowego skrótu hasła.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-257">This is explained further in the article when hooking up a custom password hasher.</span></span>

<span data-ttu-id="9ef6c-258">Ten plik skryptu jest specyficzny dla tego przykładu.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-258">This script file is specific to this sample.</span></span> <span data-ttu-id="9ef6c-259">W przypadku aplikacji, które mają dodatkowe tabele, deweloperzy mogą postępować zgodnie z podobnym podejściem do dodawania dodatkowych właściwości klasy modelu użytkownika i mapowania ich do kolumn w tabeli AspnetUsers.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-259">For applications which have additional tables, developers can follow a similar approach to add additional properties on the user model class and map them to columns in the AspnetUsers table.</span></span> <span data-ttu-id="9ef6c-260">Aby uruchomić skrypt,</span><span class="sxs-lookup"><span data-stu-id="9ef6c-260">To run the script,</span></span>

1. <span data-ttu-id="9ef6c-261">Otwórz Eksplorator serwera.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-261">Open Server Explorer.</span></span> <span data-ttu-id="9ef6c-262">Rozwiń połączenie "ApplicationServices", aby wyświetlić tabele.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-262">Expand the 'ApplicationServices' connection to display the tables.</span></span> <span data-ttu-id="9ef6c-263">Kliknij prawym przyciskiem myszy węzeł tabele i wybierz opcję "nowe zapytanie"</span><span class="sxs-lookup"><span data-stu-id="9ef6c-263">Right click on the Tables node and select the 'New Query' option</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image7.png)
2. <span data-ttu-id="9ef6c-264">W oknie zapytania skopiuj i wklej cały skrypt SQL z pliku migrations. SQL.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-264">In the query window, copy and paste the entire SQL script from the Migrations.sql file.</span></span> <span data-ttu-id="9ef6c-265">Uruchom plik skryptu, naciskając przycisk strzałki "wykonaj".</span><span class="sxs-lookup"><span data-stu-id="9ef6c-265">Run the script file by hitting the 'Execute' arrow button.</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image4.jpg)

    <span data-ttu-id="9ef6c-266">Odśwież okno Eksplorator serwera.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-266">Refresh the Server Explorer window.</span></span> <span data-ttu-id="9ef6c-267">W bazie danych są tworzone pięć nowych tabel.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-267">Five new tables are created in the database.</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image8.png)

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image9.png)

    <span data-ttu-id="9ef6c-268">Poniżej przedstawiono sposób mapowania informacji w tabelach członkostwa SQL do nowego systemu tożsamości.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-268">Below is how the information in the SQL membership tables are mapped to the new Identity system.</span></span>

    <span data-ttu-id="9ef6c-269">Role\_ASPNET —&gt; AspNetRoles</span><span class="sxs-lookup"><span data-stu-id="9ef6c-269">aspnet\_Roles --&gt; AspNetRoles</span></span>

    <span data-ttu-id="9ef6c-270">środowisko ASP\_użytkowników i ASP\_w&gt; AspNetUsers</span><span class="sxs-lookup"><span data-stu-id="9ef6c-270">asp\_netUsers and asp\_netMembership --&gt; AspNetUsers</span></span>

    <span data-ttu-id="9ef6c-271">ASPNET\_UserInRoles--&gt; AspNetUserRoles</span><span class="sxs-lookup"><span data-stu-id="9ef6c-271">aspnet\_UserInRoles --&gt; AspNetUserRoles</span></span>

    <span data-ttu-id="9ef6c-272">Zgodnie z opisem w powyższej sekcji tabele AspNetUserClaims i AspNetUserLogins są puste.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-272">As explained in the above section, the AspNetUserClaims and AspNetUserLogins tables are empty.</span></span> <span data-ttu-id="9ef6c-273">Pole "rozróżniacz" w tabeli AspNetUser powinno być zgodne z nazwą klasy modelu, która jest zdefiniowana w następnym kroku.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-273">The 'Discriminator' field in the AspNetUser table should match the model class name which is defined as a next step.</span></span> <span data-ttu-id="9ef6c-274">Ponadto kolumna PasswordHash ma postać "szyfrowanego hasła | sól hasła | format hasła".</span><span class="sxs-lookup"><span data-stu-id="9ef6c-274">Also the PasswordHash column is in the form 'encrypted password |password salt|password format'.</span></span> <span data-ttu-id="9ef6c-275">Pozwala to na użycie specjalnej logiki kryptograficznej członkostwa w programie SQL, aby można było ponownie używać starych haseł.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-275">This enables you to use special SQL membership crypto logic so that you can reuse old passwords.</span></span> <span data-ttu-id="9ef6c-276">Wyjaśniono w dalszej części artykułu.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-276">That is explained in later in the article.</span></span>

### <a name="creating-models-and-membership-pages"></a><span data-ttu-id="9ef6c-277">Tworzenie modeli i stron członkostwa</span><span class="sxs-lookup"><span data-stu-id="9ef6c-277">Creating models and membership pages</span></span>

<span data-ttu-id="9ef6c-278">Jak wspomniano wcześniej, funkcja Identity używa Entity Framework, aby komunikować się z bazą danych w celu zapisywanych domyślnie informacji o koncie.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-278">As mentioned earlier, the Identity feature uses Entity Framework to talk to the database for storing account information by default.</span></span> <span data-ttu-id="9ef6c-279">Aby można było korzystać z istniejących danych w tabeli, należy utworzyć klasy modeli, które mapują z powrotem do tabel i podłączają je do systemu tożsamości.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-279">To work with existing data in the table, we need to create model classes which map back to the tables and hook them up in the Identity system.</span></span> <span data-ttu-id="9ef6c-280">W ramach kontraktu tożsamości klasy modelu powinny implementować interfejsy zdefiniowane w bibliotece DLL Identity. Core lub można zwiększyć istniejącą implementację tych interfejsów dostępnych w pliku Microsoft. AspNet. Identity. EntityFramework.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-280">As part of the Identity contract, the model classes should either implement the interfaces defined in the Identity.Core dll or can extend the existing implementation of these interfaces available in Microsoft.AspNet.Identity.EntityFramework.</span></span>

<span data-ttu-id="9ef6c-281">W naszym przykładzie tabele AspNetRoles, AspNetUserClaims, AspNetLogins i AspNetUserRole mają kolumny podobne do istniejącej implementacji systemu tożsamości.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-281">In our sample, the AspNetRoles, AspNetUserClaims, AspNetLogins and AspNetUserRole tables have columns that are similar to the existing implementation of the Identity system.</span></span> <span data-ttu-id="9ef6c-282">W związku z tym można ponownie użyć istniejących klas do mapowania na te tabele.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-282">Hence we can reuse the existing classes to map to these tables.</span></span> <span data-ttu-id="9ef6c-283">Tabela AspNetUser zawiera dodatkowe kolumny, które są używane do przechowywania dodatkowych informacji z tabel członkostwa SQL.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-283">The AspNetUser table has some additional columns which are used to store additional information from the SQL membership tables.</span></span> <span data-ttu-id="9ef6c-284">Można to zamapować przez utworzenie klasy modelu rozszerzającej istniejącą implementację elementu "IdentityUser" i dodanie dodatkowych właściwości.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-284">This can be mapped by creating a model class that extend the existing implementation of 'IdentityUser' and add the additional properties.</span></span>

1. <span data-ttu-id="9ef6c-285">Utwórz folder models w projekcie i Dodaj użytkownika klasy.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-285">Create a Models folder in the project and add a class User.</span></span> <span data-ttu-id="9ef6c-286">Nazwa klasy powinna być zgodna z danymi dodanymi w kolumnie "rozróżniacz" tabeli "AspnetUsers".</span><span class="sxs-lookup"><span data-stu-id="9ef6c-286">The name of the class should match the data added in the 'Discriminator' column of 'AspnetUsers' table.</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image10.png)

    <span data-ttu-id="9ef6c-287">Klasa User powinna mieć rozszerzoną klasę IdentityUser, która znajduje się w bibliotece DLL *Microsoft. ASPNET. Identity. EntityFramework* .</span><span class="sxs-lookup"><span data-stu-id="9ef6c-287">The User class should extend the IdentityUser class found in the *Microsoft.AspNet.Identity.EntityFramework* dll.</span></span> <span data-ttu-id="9ef6c-288">Zadeklaruj właściwości w klasie, która mapuje z powrotem do kolumn AspNetUser.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-288">Declare the properties in class that map back to the AspNetUser columns.</span></span> <span data-ttu-id="9ef6c-289">Właściwości ID, username, PasswordHash i SecurityStamp są zdefiniowane w IdentityUser i dlatego są pomijane.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-289">The properties ID, Username, PasswordHash and SecurityStamp are defined in the IdentityUser and so are omitted.</span></span> <span data-ttu-id="9ef6c-290">Poniżej znajduje się kod klasy użytkownika, która ma wszystkie właściwości</span><span class="sxs-lookup"><span data-stu-id="9ef6c-290">Below is the code for the User class that has all the properties</span></span>

    [!code-csharp[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample3.cs)]
2. <span data-ttu-id="9ef6c-291">Entity Framework DbContext Class jest wymagana w celu utrwalania danych w modelach z powrotem do tabel i pobierania danych z tabel w celu wypełnienia modeli.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-291">An Entity Framework DbContext class is required in order to persist data in models back to tables and retrieve data from tables to populate the models.</span></span> <span data-ttu-id="9ef6c-292">Plik *Microsoft. ASPNET. Identity. EntityFramework* DLL definiuje klasę IdentityDbContext, która współdziała z tabelami tożsamości w celu pobierania i przechowywania informacji.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-292">*Microsoft.AspNet.Identity.EntityFramework* dll defines the IdentityDbContext class which interacts with the Identity tables to retrieve and store information.</span></span> <span data-ttu-id="9ef6c-293">IdentityDbContext&lt;Tuser&gt; przyjmuje klasę "TUser", która może być dowolną klasą, która rozszerza klasę IdentityUser.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-293">The IdentityDbContext&lt;tuser&gt; takes a 'TUser' class which can be any class that extends the IdentityUser class.</span></span>

    <span data-ttu-id="9ef6c-294">Utwórz nową klasę ApplicationDBContext, która rozszerza IdentityDbContext w folderze "models", przekazując w klasie "User" utworzonej w kroku 1</span><span class="sxs-lookup"><span data-stu-id="9ef6c-294">Create a new class ApplicationDBContext that extends IdentityDbContext under the 'Models' folder, passing in the 'User' class created in step 1</span></span>

    [!code-csharp[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample4.cs)]
3. <span data-ttu-id="9ef6c-295">Zarządzanie użytkownikami w nowym systemie tożsamości odbywa się przy użyciu klasy Usermanager&lt;Tuser&gt; zdefiniowanej w bibliotece DLL *Microsoft. ASPNET. Identity. EntityFramework* .</span><span class="sxs-lookup"><span data-stu-id="9ef6c-295">User management in the new Identity system is done using the UserManager&lt;tuser&gt; class defined in the *Microsoft.AspNet.Identity.EntityFramework* dll.</span></span> <span data-ttu-id="9ef6c-296">Musimy utworzyć klasę niestandardową, która rozszerza element Usermanager, przekazując w klasie "User" utworzonej w kroku 1.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-296">We need to create a custom class that extends UserManager, passing in the 'User' class created in step 1.</span></span>

    <span data-ttu-id="9ef6c-297">W folderze modele Utwórz nową klasę Usermanager, która rozszerza użytkownika&lt;użytkownika&gt;</span><span class="sxs-lookup"><span data-stu-id="9ef6c-297">In the Models folder create a new class UserManager that extends UserManager&lt;user&gt;</span></span>

    [!code-csharp[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample5.cs)]
4. <span data-ttu-id="9ef6c-298">Hasła użytkowników aplikacji są szyfrowane i przechowywane w bazie danych programu.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-298">The passwords of the users of the application are encrypted and stored in the database.</span></span> <span data-ttu-id="9ef6c-299">Algorytm kryptograficzny używany w członkostwie SQL jest inny niż w nowym systemie tożsamości.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-299">The crypto algorithm used in SQL membership is different from the one in the new Identity system.</span></span> <span data-ttu-id="9ef6c-300">Aby ponownie użyć starych haseł, należy selektywnie odszyfrowywać hasła podczas logowania starych użytkowników przy użyciu algorytmu członkostwa SQL przy użyciu algorytmu kryptograficznego w tożsamości dla nowych użytkowników.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-300">To reuse old passwords we need to selectively decrypt passwords when old users log in using the SQL memberships algorithm while using the crypto algorithm in Identity for the new users.</span></span>

    <span data-ttu-id="9ef6c-301">Klasa Usermanager ma właściwość "PasswordHasher", która przechowuje wystąpienie klasy implementującej interfejs "IPasswordHasher".</span><span class="sxs-lookup"><span data-stu-id="9ef6c-301">The UserManager class has a property 'PasswordHasher' which stores an instance of a class that implements the 'IPasswordHasher' interface.</span></span> <span data-ttu-id="9ef6c-302">Służy do szyfrowania/odszyfrowywania haseł podczas transakcji uwierzytelniania użytkownika.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-302">This is used to encrypt/decrypt passwords during user authentication transactions.</span></span> <span data-ttu-id="9ef6c-303">W klasie Usermanager zdefiniowanej w kroku 3 Utwórz nową klasę SQLPasswordHasher i Skopiuj poniższy kod.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-303">In the UserManager class defined in step 3, create a new class SQLPasswordHasher and copy the below code.</span></span>

    [!code-csharp[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample6.cs)]

    <span data-ttu-id="9ef6c-304">Usuń błędy kompilacji, importując przestrzenie nazw System. Text i system. Security. Cryptography.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-304">Resolve the compilation errors by importing the System.Text and System.Security.Cryptography namespaces.</span></span>

    <span data-ttu-id="9ef6c-305">Metoda EncodePassword szyfruje hasło zgodnie z domyślną implementacją kryptograficzną członkostwa w programie SQL.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-305">The EncodePassword method encrypts the password according to the default SQL membership crypto implementation.</span></span> <span data-ttu-id="9ef6c-306">Jest to pobierane z biblioteki DLL systemu system. Web.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-306">This is taken from the System.Web dll.</span></span> <span data-ttu-id="9ef6c-307">Jeśli stara aplikacja użyła niestandardowej implementacji, powinna zostać odzwierciedlona tutaj.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-307">If the old app used a custom implementation then it should be reflected here.</span></span> <span data-ttu-id="9ef6c-308">Musimy zdefiniować dwie inne metody *HashPassword* i *VerifyHashedPassword* , które używają metody *EncodePassword* do mieszania danego hasła lub weryfikowania hasła w postaci zwykłego tekstu przy użyciu jednego z istniejących w bazie danych.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-308">We need to define two other methods *HashPassword* and *VerifyHashedPassword* that use the *EncodePassword* method to hash a given password or verify a plain text password with the one existing in the database.</span></span>

    <span data-ttu-id="9ef6c-309">System członkostwa SQL używa PasswordHash, PasswordSalt i PasswordFormat do mieszania hasła wprowadzonego przez użytkowników podczas rejestrowania lub zmiany hasła.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-309">The SQL membership system used PasswordHash, PasswordSalt and PasswordFormat to hash the password entered by users when they register or change their password.</span></span> <span data-ttu-id="9ef6c-310">Podczas migracji wszystkie trzy pola są przechowywane w kolumnie PasswordHash w tabeli AspNetUser oddzielonej znakiem "|".</span><span class="sxs-lookup"><span data-stu-id="9ef6c-310">During the migration all the three fields are stored in the PasswordHash column in the AspNetUser table separated by the '|' character.</span></span> <span data-ttu-id="9ef6c-311">Gdy użytkownik loguje się, a hasło zawiera te pola, do sprawdzenia hasła używane są Kryptografia członkostwa SQL. w przeciwnym razie użyjemy domyślnego kryptografii systemu tożsamości do zweryfikowania hasła.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-311">When a user logs in and the password has these fields, we use the SQL membership crypto to check the password; otherwise we use the Identity system's default crypto to verify the password.</span></span> <span data-ttu-id="9ef6c-312">W ten sposób stara użytkownicy nie będą musieli zmieniać haseł po migracji aplikacji.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-312">This way old users would not have to change their passwords once the app is migrated.</span></span>
5. <span data-ttu-id="9ef6c-313">Zadeklaruj konstruktora dla klasy Usermanager i przekaż go jako SQLPasswordHasher do właściwości w konstruktorze.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-313">Declare the constructor for the UserManager class and pass this as the SQLPasswordHasher to the property in the constructor.</span></span>

    [!code-csharp[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample7.cs)]

### <a name="create-new-account-management-pages"></a><span data-ttu-id="9ef6c-314">Tworzenie nowych stron zarządzania kontami</span><span class="sxs-lookup"><span data-stu-id="9ef6c-314">Create new account management pages</span></span>

<span data-ttu-id="9ef6c-315">Następny krok migracji polega na dodaniu stron zarządzania kontami, które pozwolą na rejestrację i zalogowanie użytkownika.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-315">The next step in the migration is to add account management pages that will let a user register and log in.</span></span> <span data-ttu-id="9ef6c-316">Stare strony kont z członkostwa SQL używają kontroli, które nie współpracują z nowym systemem tożsamości.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-316">The old account pages from SQL membership use controls that don't work with the new Identity system.</span></span> <span data-ttu-id="9ef6c-317">Aby dodać nowe strony zarządzania użytkownikami, postępuj zgodnie z samouczkiem z tego linku [https://www.asp.net/identity/overview/getting-started/adding-aspnet-identity-to-an-empty-or-existing-web-forms-project](../getting-started/adding-aspnet-identity-to-an-empty-or-existing-web-forms-project.md) rozpoczynając od kroku "Dodawanie formularzy sieci Web do rejestracji użytkowników w aplikacji", ponieważ został już utworzony projekt i dodaliśmy pakiety NuGet.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-317">To add the new user management pages follow the tutorial at this link [https://www.asp.net/identity/overview/getting-started/adding-aspnet-identity-to-an-empty-or-existing-web-forms-project](../getting-started/adding-aspnet-identity-to-an-empty-or-existing-web-forms-project.md) starting from the step 'Adding Web Forms for registering users to your application' since we have already created the project and added the NuGet packages.</span></span>

<span data-ttu-id="9ef6c-318">Musimy wprowadzić pewne zmiany, aby przykład mógł współpracować z projektem.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-318">We need to make some changes for the sample to work with the project we have here.</span></span>

- <span data-ttu-id="9ef6c-319">W przypadku klas Register.aspx.cs i Login.aspx.cs za pomocą `UserManager` z pakietów tożsamości można utworzyć użytkownika.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-319">The Register.aspx.cs and Login.aspx.cs code behind classes use the `UserManager` from the Identity packages to create a User.</span></span> <span data-ttu-id="9ef6c-320">W tym przykładzie Użyj elementu Usermanager dodanego w folderze models, wykonując kroki wymienione wcześniej.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-320">For this example use the UserManager added in the Models folder by following the steps mentioned earlier.</span></span>
- <span data-ttu-id="9ef6c-321">Użyj klasy utworzonej zamiast IdentityUser w kodzie Register.aspx.cs i Login.aspx.cs.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-321">Use the User class created instead of the IdentityUser in Register.aspx.cs and Login.aspx.cs code behind classes.</span></span> <span data-ttu-id="9ef6c-322">Ten punkt zaczepienia w naszej niestandardowej klasie użytkownika do systemu tożsamości.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-322">This hooks in our custom user class into the Identity system.</span></span>
- <span data-ttu-id="9ef6c-323">Część do utworzenia bazy danych może zostać pominięta.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-323">The part to create the database can be skipped.</span></span>
- <span data-ttu-id="9ef6c-324">Deweloper musi ustawić nowy użytkownik, aby pasował do bieżącego identyfikatora aplikacji.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-324">The developer needs to set the ApplicationId for the new user to match the current application ID.</span></span> <span data-ttu-id="9ef6c-325">Można to zrobić, wykonując zapytania dotyczące tej aplikacji, zanim obiekt użytkownika zostanie utworzony w klasie Register.aspx.cs i ustawiając przed utworzeniem użytkownika.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-325">This can be done by querying the ApplicationId for this application before a user object is created in the Register.aspx.cs class and setting it before creating user.</span></span>

    <span data-ttu-id="9ef6c-326">Przykład:</span><span class="sxs-lookup"><span data-stu-id="9ef6c-326">Example:</span></span>

    <span data-ttu-id="9ef6c-327">Zdefiniuj metodę na stronie Register.aspx.cs, aby wykonać zapytanie dotyczące tabeli aplikacji ASPNET\_i uzyskać identyfikator aplikacji zgodnie z nazwą aplikacji</span><span class="sxs-lookup"><span data-stu-id="9ef6c-327">Define a method in Register.aspx.cs page to query the aspnet\_Applications table and get the application Id according to application name</span></span>

    [!code-csharp[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample8.cs)]

    <span data-ttu-id="9ef6c-328">Teraz ustaw tę wartość dla obiektu User</span><span class="sxs-lookup"><span data-stu-id="9ef6c-328">Now get set this on the user object</span></span>

    [!code-csharp[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample9.cs)]

<span data-ttu-id="9ef6c-329">Użyj starej nazwy użytkownika i hasła, aby zalogować istniejącego użytkownika.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-329">Use the old username and password to login an existing user.</span></span> <span data-ttu-id="9ef6c-330">Na stronie Rejestracja Utwórz nowego użytkownika.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-330">Use the Register page to create a new user.</span></span> <span data-ttu-id="9ef6c-331">Sprawdź również, czy użytkownicy znajdują się w rolach zgodnie z oczekiwaniami.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-331">Also verify that the users are in roles as expected.</span></span>

<span data-ttu-id="9ef6c-332">Przenoszenie do systemu tożsamości ułatwia użytkownikowi dodawanie uwierzytelniania Open Authentication (OAuth) do aplikacji.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-332">Porting to the Identity system helps the user add Open Authentication (OAuth) to the application.</span></span> <span data-ttu-id="9ef6c-333">Zapoznaj się [z przykładem](https://github.com/aspnet/samples/tree/master/samples/aspnet/Identity/SQLMembership-Identity-OWIN/) z włączonym uwierzytelnianiem OAuth.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-333">Please refer to the sample [here](https://github.com/aspnet/samples/tree/master/samples/aspnet/Identity/SQLMembership-Identity-OWIN/) which has OAuth enabled.</span></span>

## <a name="next-steps"></a><span data-ttu-id="9ef6c-334">Następne kroki</span><span class="sxs-lookup"><span data-stu-id="9ef6c-334">Next Steps</span></span>

<span data-ttu-id="9ef6c-335">W tym samouczku pokazano, jak przenieść użytkowników z członkostwa SQL do ASP.NET Identity, ale nie portem danych profilu.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-335">In this tutorial we showed how to port users from SQL membership to ASP.NET Identity, but we didn't port Profile data.</span></span> <span data-ttu-id="9ef6c-336">W następnym samouczku przejdziemy do przenoszenia danych profilu z członkostwa SQL do nowego systemu tożsamości.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-336">In the next tutorial we'll look into porting Profile data from SQL membership to the new Identity system.</span></span>

<span data-ttu-id="9ef6c-337">Możesz opuścić opinię w dolnej części tego artykułu.</span><span class="sxs-lookup"><span data-stu-id="9ef6c-337">You can leave feedback at the bottom of this article.</span></span>

<span data-ttu-id="9ef6c-338">*Dziękujemy za Dykstra i Rick Anderson w celu przejrzenia artykułu.*</span><span class="sxs-lookup"><span data-stu-id="9ef6c-338">*Thanks to Tom Dykstra and Rick Anderson for reviewing the article.*</span></span>
