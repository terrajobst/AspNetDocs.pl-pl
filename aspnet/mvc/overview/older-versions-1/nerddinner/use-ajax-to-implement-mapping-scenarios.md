---
uid: mvc/overview/older-versions-1/nerddinner/use-ajax-to-implement-mapping-scenarios
title: Implementowanie scenariuszy mapowania przy użyciu technologii AJAX | Microsoft Docs
author: microsoft
description: Krok 11 pokazuje, jak zintegrować obsługę mapowania AJAX z naszą aplikacją NerdDinner, umożliwiając użytkownikom, którzy tworzą, edytują lub wyświetlają obiady, aby zobaczyć l...
ms.author: riande
ms.date: 07/27/2010
ms.assetid: f731990a-0a81-4d62-81df-87d676cdedd6
msc.legacyurl: /mvc/overview/older-versions-1/nerddinner/use-ajax-to-implement-mapping-scenarios
msc.type: authoredcontent
ms.openlocfilehash: 7fc90f978b9f9eca511feca70a3c0d02ec69b940
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: pl-PL
ms.lasthandoff: 03/06/2020
ms.locfileid: "78580116"
---
# <a name="use-ajax-to-implement-mapping-scenarios"></a><span data-ttu-id="7b720-103">Korzystanie z technologii AJAX w celu implementacji scenariuszy mapowania</span><span class="sxs-lookup"><span data-stu-id="7b720-103">Use AJAX to Implement Mapping Scenarios</span></span>

<span data-ttu-id="7b720-104">przez [firmę Microsoft](https://github.com/microsoft)</span><span class="sxs-lookup"><span data-stu-id="7b720-104">by [Microsoft](https://github.com/microsoft)</span></span>

[<span data-ttu-id="7b720-105">Pobierz plik PDF</span><span class="sxs-lookup"><span data-stu-id="7b720-105">Download PDF</span></span>](http://aspnetmvcbook.s3.amazonaws.com/aspnetmvc-nerdinner_v1.pdf)

> <span data-ttu-id="7b720-106">Ten krok 11 zawiera bezpłatny [Samouczek dotyczący aplikacji "NerdDinner"](introducing-the-nerddinner-tutorial.md) , który zawiera informacje na temat tworzenia niewielkiej, ale kompletnej aplikacji sieci Web przy użyciu ASP.NET MVC 1.</span><span class="sxs-lookup"><span data-stu-id="7b720-106">This is step 11 of a free ["NerdDinner" application tutorial](introducing-the-nerddinner-tutorial.md) that walks-through how to build a small, but complete, web application using ASP.NET MVC 1.</span></span>
> 
> <span data-ttu-id="7b720-107">Krok 11 pokazuje, jak zintegrować obsługę mapowania AJAX z naszą aplikacją NerdDinner, umożliwiając użytkownikom, którzy tworzą, edytują lub wyświetlają obiady, aby zobaczyć swoją uroczystą lokalizację.</span><span class="sxs-lookup"><span data-stu-id="7b720-107">Step 11 shows how to integrate AJAX mapping support into our NerdDinner application, enabling users who are creating, editing or viewing dinners to see the location of the dinner graphically.</span></span>
> 
> <span data-ttu-id="7b720-108">Jeśli używasz ASP.NET MVC 3, zalecamy użycie [wprowadzenie ze samouczkami ze sklepu MVC 3](../../older-versions/getting-started-with-aspnet-mvc3/cs/intro-to-aspnet-mvc-3.md) lub [MVC](../../older-versions/mvc-music-store/mvc-music-store-part-1.md) .</span><span class="sxs-lookup"><span data-stu-id="7b720-108">If you are using ASP.NET MVC 3, we recommend you follow the [Getting Started With MVC 3](../../older-versions/getting-started-with-aspnet-mvc3/cs/intro-to-aspnet-mvc-3.md) or [MVC Music Store](../../older-versions/mvc-music-store/mvc-music-store-part-1.md) tutorials.</span></span>

## <a name="nerddinner-step-11-integrating-an-ajax-map"></a><span data-ttu-id="7b720-109">NerdDinner krok 11: Integrowanie mapy AJAX</span><span class="sxs-lookup"><span data-stu-id="7b720-109">NerdDinner Step 11: Integrating an AJAX Map</span></span>

<span data-ttu-id="7b720-110">Teraz nasza aplikacja jest nieco bardziej atrakcyjna, dzięki integracji z obsługą mapowania AJAX.</span><span class="sxs-lookup"><span data-stu-id="7b720-110">We'll now make our application a little more visually exciting by integrating AJAX mapping support.</span></span> <span data-ttu-id="7b720-111">Spowoduje to umożliwienie użytkownikom, którzy tworzą, edytują lub wyświetlają obiady, aby zobaczyć swoją lokalizację w formie graficznej.</span><span class="sxs-lookup"><span data-stu-id="7b720-111">This will enable users who are creating, editing or viewing dinners to see the location of the dinner graphically.</span></span>

### <a name="creating-a-map-partial-view"></a><span data-ttu-id="7b720-112">Tworzenie widoku częściowego mapy</span><span class="sxs-lookup"><span data-stu-id="7b720-112">Creating a Map Partial View</span></span>

<span data-ttu-id="7b720-113">Będziemy używać funkcji mapowania w kilku miejscach w naszej aplikacji.</span><span class="sxs-lookup"><span data-stu-id="7b720-113">We are going to use mapping functionality in several places within our application.</span></span> <span data-ttu-id="7b720-114">Aby zachować nasz kod, będziemy hermetyzować typowe funkcje mapy w ramach jednego szablonu częściowego, który można wykorzystać w wielu akcjach i widokach kontrolera.</span><span class="sxs-lookup"><span data-stu-id="7b720-114">To keep our code DRY we'll encapsulate the common map functionality within a single partial template that we can re-use across multiple controller actions and views.</span></span> <span data-ttu-id="7b720-115">Zmienimy nazwę tego widoku częściowego "map. ascx" i utworzysz go w katalogu \Views\Dinners.</span><span class="sxs-lookup"><span data-stu-id="7b720-115">We'll name this partial view "map.ascx" and create it within the \Views\Dinners directory.</span></span>

<span data-ttu-id="7b720-116">Możemy utworzyć mapę. ascx częściowo, klikając prawym przyciskiem myszy katalog \Views\Dinners i wybierając polecenie menu Dodaj-&gt;widok.</span><span class="sxs-lookup"><span data-stu-id="7b720-116">We can create the map.ascx partial by right-clicking on the \Views\Dinners directory and choosing the Add-&gt;View menu command.</span></span> <span data-ttu-id="7b720-117">Zmienimy nazwę widoku "map. ascx", Sprawdzamy go jako widok częściowy i wskazują, że będziemy przekazywać do niego silnie wpisaną klasę modelu "obiad":</span><span class="sxs-lookup"><span data-stu-id="7b720-117">We'll name the view "Map.ascx", check it as a partial view, and indicate that we are going to pass it a strongly-typed "Dinner" model class:</span></span>

![](use-ajax-to-implement-mapping-scenarios/_static/image1.png)

<span data-ttu-id="7b720-118">Po kliknięciu przycisku "Dodaj" zostanie utworzony nasz częściowy szablon.</span><span class="sxs-lookup"><span data-stu-id="7b720-118">When we click the "Add" button our partial template will be created.</span></span> <span data-ttu-id="7b720-119">Następnie zaktualizujemy plik map. ascx do następującej zawartości:</span><span class="sxs-lookup"><span data-stu-id="7b720-119">We'll then update the Map.ascx file to have the following content:</span></span>

[!code-aspx[Main](use-ajax-to-implement-mapping-scenarios/samples/sample1.aspx)]

<span data-ttu-id="7b720-120">Pierwszy &lt;skryptu&gt; odwołanie do biblioteki mapowania Microsoft Virtual Earth 6,2.</span><span class="sxs-lookup"><span data-stu-id="7b720-120">The first &lt;script&gt; reference points to the Microsoft Virtual Earth 6.2 mapping library.</span></span> <span data-ttu-id="7b720-121">Drugi &lt;skrypt&gt; odwołania do pliku map. js, który wkrótce utworzymy, który będzie hermetyzował wspólną logikę mapowania języka JavaScript.</span><span class="sxs-lookup"><span data-stu-id="7b720-121">The second &lt;script&gt; reference points to a map.js file that we will shortly create which will encapsulate our common Javascript mapping logic.</span></span> <span data-ttu-id="7b720-122">&lt;DIV ID = "theMap"&gt; element jest kontenerem HTML używanym przez program Virtual Earth do hostowania mapy.</span><span class="sxs-lookup"><span data-stu-id="7b720-122">The &lt;div id="theMap"&gt; element is the HTML container that Virtual Earth will use to host the map.</span></span>

<span data-ttu-id="7b720-123">Następnie mamy osadzony blok &lt;skryptu&gt; zawierający dwie funkcje języka JavaScript specyficzne dla tego widoku.</span><span class="sxs-lookup"><span data-stu-id="7b720-123">We then have an embedded &lt;script&gt; block that contains two JavaScript functions specific to this view.</span></span> <span data-ttu-id="7b720-124">Pierwsza funkcja korzysta z technologii jQuery do utworzenia szkieletu funkcji, która jest wykonywana, gdy strona jest gotowa do uruchomienia skryptu po stronie klienta.</span><span class="sxs-lookup"><span data-stu-id="7b720-124">The first function uses jQuery to wire-up a function that executes when the page is ready to run client-side script.</span></span> <span data-ttu-id="7b720-125">Wywołuje funkcję pomocnika LoadMap (), którą zdefiniujemy w naszym pliku skryptu mapy. js w celu załadowania kontrolki mapy platformy Virtual Earth.</span><span class="sxs-lookup"><span data-stu-id="7b720-125">It calls a LoadMap() helper function that we'll define within our Map.js script file to load the virtual earth map control.</span></span> <span data-ttu-id="7b720-126">Druga funkcja to procedura obsługi zdarzeń wywołania zwrotnego, która dodaje kod PIN do mapy, która identyfikuje lokalizację.</span><span class="sxs-lookup"><span data-stu-id="7b720-126">The second function is a callback event handler that adds a pin to the map that identifies a location.</span></span>

<span data-ttu-id="7b720-127">Zwróć uwagę na to, jak korzystamy z bloku &lt;% =%&gt; w bloku skryptu po stronie klienta, aby osadzić szerokość i długość obszaru obiadu, który chcemy zmapować na kod JavaScript.</span><span class="sxs-lookup"><span data-stu-id="7b720-127">Notice how we are using a server-side &lt;%= %&gt; block within the client-side script block to embed the latitude and longitude of the Dinner we want to map into the JavaScript.</span></span> <span data-ttu-id="7b720-128">Jest to przydatna technika do wyprowadzania wartości dynamicznych, które mogą być używane przez skrypt po stronie klienta (bez konieczności oddzielenia wywołania AJAX z powrotem do serwera w celu pobrania wartości, co sprawia, że jest to szybsze).</span><span class="sxs-lookup"><span data-stu-id="7b720-128">This is a useful technique to output dynamic values that can be used by client-side script (without requiring a separate AJAX call back to the server to retrieve the values – which makes it faster).</span></span> <span data-ttu-id="7b720-129">Bloki &lt;% =%&gt; będą wykonywane, gdy widok jest renderowany na serwerze, a więc dane wyjściowe HTML zakończą się po prostu z osadzonymi wartościami JavaScript (na przykład: var Latitude = 47,64312;).</span><span class="sxs-lookup"><span data-stu-id="7b720-129">The &lt;%= %&gt; blocks will execute when the view is rendering on the server – and so the output of the HTML will just end up with embedded JavaScript values (for example: var latitude = 47.64312;).</span></span>

### <a name="creating-a-mapjs-utility-library"></a><span data-ttu-id="7b720-130">Tworzenie biblioteki narzędzi map. js</span><span class="sxs-lookup"><span data-stu-id="7b720-130">Creating a Map.js utility library</span></span>

<span data-ttu-id="7b720-131">Utwórzmy teraz plik map. js, którego można użyć do hermetyzacji funkcji języka JavaScript dla mapy (i implementacji powyższych metod LoadMap i LoadPin).</span><span class="sxs-lookup"><span data-stu-id="7b720-131">Let's now create the Map.js file that we can use to encapsulate the JavaScript functionality for our map (and implement the LoadMap and LoadPin methods above).</span></span> <span data-ttu-id="7b720-132">Możemy to zrobić, klikając prawym przyciskiem myszy katalog \Scripts w naszym projekcie, a następnie wybierając polecenie menu "Dodaj&gt;nowy element", wybierz element JScript i nadaj mu nazwę "map. js".</span><span class="sxs-lookup"><span data-stu-id="7b720-132">We can do this by right-clicking on the \Scripts directory within our project, and then choose the "Add-&gt;New Item" menu command, select the JScript item, and name it "Map.js".</span></span>

<span data-ttu-id="7b720-133">Poniżej znajduje się kod JavaScript, który dodamy do pliku map. js, który będzie współdziałać z platformą Virtual Earth w celu wyświetlenia naszej mapy i dodania do niej numerów PIN dla naszych obiadów:</span><span class="sxs-lookup"><span data-stu-id="7b720-133">Below is the JavaScript code we'll add to the Map.js file that will interact with Virtual Earth to display our map and add locations pins to it for our dinners:</span></span>

[!code-javascript[Main](use-ajax-to-implement-mapping-scenarios/samples/sample2.js)]

### <a name="integrating-the-map-with-create-and-edit-forms"></a><span data-ttu-id="7b720-134">Integrowanie mapy za pomocą formularzy Utwórz i edytuj</span><span class="sxs-lookup"><span data-stu-id="7b720-134">Integrating the Map with Create and Edit Forms</span></span>

<span data-ttu-id="7b720-135">Teraz integrujemy obsługę mapy z naszymi istniejącymi scenariuszami tworzenia i edytowania.</span><span class="sxs-lookup"><span data-stu-id="7b720-135">We'll now integrate the Map support with our existing Create and Edit scenarios.</span></span> <span data-ttu-id="7b720-136">Dobrą nowością jest to, że jest to łatwe w użyciu i nie wymagamy od nas zmiany kodu kontrolera.</span><span class="sxs-lookup"><span data-stu-id="7b720-136">The good news is that this is pretty easy to-do, and doesn't require us to change any of our Controller code.</span></span> <span data-ttu-id="7b720-137">Ponieważ nasze widoki tworzenia i edytowania współdzielą wspólny widok częściowy "DinnerForm" w celu zaimplementowania interfejsu użytkownika w formie obiadu, możemy dodać mapę w jednym miejscu i mieć nasze scenariusze tworzenia i edytowania.</span><span class="sxs-lookup"><span data-stu-id="7b720-137">Because our Create and Edit views share a common "DinnerForm" partial view to implement the dinner form UI, we can add the map in one place and have both our Create and Edit scenarios use it.</span></span>

<span data-ttu-id="7b720-138">Wszystko, czego potrzebujemy, aby otworzyć widok częściowy \Views\Dinners\DinnerForm.ascx i zaktualizować go w celu uwzględnienia naszej nowej mapy częściowej.</span><span class="sxs-lookup"><span data-stu-id="7b720-138">All we need to-do is to open the \Views\Dinners\DinnerForm.ascx partial view and update it to include our new map partial.</span></span> <span data-ttu-id="7b720-139">Poniżej znajdują się informacje o zaktualizowanym DinnerForm po dodaniu mapy (Uwaga: elementy formularza HTML są pomijane w poniższym fragmencie kodu dla zwięzłości):</span><span class="sxs-lookup"><span data-stu-id="7b720-139">Below is what the updated DinnerForm will look like once the map is added (note: the HTML form elements are omitted from the code snippet below for brevity):</span></span>

[!code-aspx[Main](use-ajax-to-implement-mapping-scenarios/samples/sample3.aspx)]

<span data-ttu-id="7b720-140">Część DinnerForm powyżej pobiera obiekt typu "DinnerFormViewModel" jako typ modelu (ponieważ wymaga zarówno obiektu obiadu, jak i SelectList do zapełnienia DropDownList krajów).</span><span class="sxs-lookup"><span data-stu-id="7b720-140">The DinnerForm partial above takes an object of type "DinnerFormViewModel" as its model type (because it needs both a Dinner object, as well as a SelectList to populate the dropdownlist of countries).</span></span> <span data-ttu-id="7b720-141">Nasza Mapa częściowa wystarczy do obiektu typu "obiad" jako typu modelu i dlatego, gdy renderuje częściową mapę, przekazujemy tylko podrzędną podwłaściwości DinnerFormViewModel do niej:</span><span class="sxs-lookup"><span data-stu-id="7b720-141">Our Map partial just needs an object of type "Dinner" as its model type, and so when we render the map partial we are passing just the Dinner sub-property of DinnerFormViewModel to it:</span></span>

[!code-aspx[Main](use-ajax-to-implement-mapping-scenarios/samples/sample4.aspx)]

<span data-ttu-id="7b720-142">Funkcja języka JavaScript dodana do częściowej używa jQuery do dołączania zdarzenia "rozmycie" do pola tekstowego HTML "Address".</span><span class="sxs-lookup"><span data-stu-id="7b720-142">The JavaScript function we've added to the partial uses jQuery to attach a "blur" event to the "Address" HTML textbox.</span></span> <span data-ttu-id="7b720-143">Prawdopodobnie wysłuchuje zdarzenia "Focus", które są wyzwalane, gdy użytkownik kliknie lub naciśnie kartę w polu tekstowym.</span><span class="sxs-lookup"><span data-stu-id="7b720-143">You've probably heard of "focus" events that fire when a user clicks or tabs into a textbox.</span></span> <span data-ttu-id="7b720-144">Przeciwieństwem jest zdarzenie "rozmycie", które jest wyzwalane, gdy użytkownik opuszcza pole tekstowe.</span><span class="sxs-lookup"><span data-stu-id="7b720-144">The opposite is a "blur" event that fires when a user exits a textbox.</span></span> <span data-ttu-id="7b720-145">Powyższa procedura obsługi zdarzeń czyści wartości pola tekstowego szerokość i Długość geograficzna, gdy tak się stanie, a następnie wykreśla nową lokalizację adresu na naszej mapie.</span><span class="sxs-lookup"><span data-stu-id="7b720-145">The above event handler clears the latitude and longitude textbox values when this happens, and then plots the new address location on our map.</span></span> <span data-ttu-id="7b720-146">Procedura obsługi zdarzeń wywołania zwrotnego, która została zdefiniowana w pliku map. js, następnie aktualizuje pola tekstowe długości i szerokości geograficznej w naszym formularzu przy użyciu wartości zwracanych przez program Virtual Earth na podstawie adresu, który podałeś.</span><span class="sxs-lookup"><span data-stu-id="7b720-146">A callback event handler that we defined within the map.js file will then update the longitude and latitude textboxes on our form using values returned by virtual earth based on the address we gave it.</span></span>

<span data-ttu-id="7b720-147">Teraz, po ponownym uruchomieniu aplikacji i kliknięciu karty "obiad z hostem" zobaczysz domyślną mapę wyświetlaną wraz z naszymi standardowymi elementami formularza obiadu:</span><span class="sxs-lookup"><span data-stu-id="7b720-147">And now when we run our application again and click the "Host Dinner" tab we'll see a default map displayed along with our standard Dinner form elements:</span></span>

![](use-ajax-to-implement-mapping-scenarios/_static/image2.png)

<span data-ttu-id="7b720-148">Gdy wpiszesz adres, a następnie tabulator zostanie przesunięty w górę, mapa zostanie dynamicznie zaktualizowana w celu wyświetlenia lokalizacji, a nasza procedura obsługi zdarzeń wypełni pola tekstowe szerokości/długości geograficznej wartościami lokalizacji:</span><span class="sxs-lookup"><span data-stu-id="7b720-148">When we type in an address, and then tab away, the map will dynamically update to display the location, and our event handler will populate the latitude/longitude textboxes with the location values:</span></span>

![](use-ajax-to-implement-mapping-scenarios/_static/image3.png)

<span data-ttu-id="7b720-149">Jeśli zapiszemy nowy obiad i otworzysz go ponownie do edycji, zobaczymy, że lokalizacja mapy zostanie wyświetlona po załadowaniu strony:</span><span class="sxs-lookup"><span data-stu-id="7b720-149">If we save the new dinner and then open it again for editing, we'll find that the map location is displayed when the page loads:</span></span>

![](use-ajax-to-implement-mapping-scenarios/_static/image4.png)

<span data-ttu-id="7b720-150">Za każdym razem, gdy pole adres zostanie zmienione, zostanie zaktualizowana Mapa i współrzędne szerokości geograficznej.</span><span class="sxs-lookup"><span data-stu-id="7b720-150">Every time the address field is changed, the map and the latitude/longitude coordinates will update.</span></span>

<span data-ttu-id="7b720-151">Teraz, gdy mapa Wyświetla lokalizację obiadu, można także zmienić pola formularza Latitude i długości geograficznej na widoczne jako elementy ukryte (ponieważ mapa jest automatycznie aktualizowana przy każdym wprowadzeniu adresu).</span><span class="sxs-lookup"><span data-stu-id="7b720-151">Now that the map displays the Dinner location, we can also change the Latitude and Longitude form fields from being visible textboxes to instead be hidden elements (since the map is automatically updating them each time an address is entered).</span></span> <span data-ttu-id="7b720-152">W tym celu będziemy przełączać się za pomocą pomocnika HTML HTML. TextBox () w celu użycia metody pomocnika html. Hidden ():</span><span class="sxs-lookup"><span data-stu-id="7b720-152">To-do this we'll switch from using the Html.TextBox() HTML helper to using the Html.Hidden() helper method:</span></span>

[!code-aspx[Main](use-ajax-to-implement-mapping-scenarios/samples/sample5.aspx)]

<span data-ttu-id="7b720-153">Teraz nasze formularze są nieco bardziej przyjazne dla użytkownika i nie należy wyświetlać surowej szerokości/długości geograficznej (przy czym są przechowywane z każdym obiadem w bazie danych):</span><span class="sxs-lookup"><span data-stu-id="7b720-153">And now our forms are a little more user-friendly and avoid displaying the raw latitude/longitude (while still storing them with each Dinner in the database):</span></span>

![](use-ajax-to-implement-mapping-scenarios/_static/image5.png)

### <a name="integrating-the-map-with-the-details-view"></a><span data-ttu-id="7b720-154">Integrowanie mapy z widokiem szczegółów</span><span class="sxs-lookup"><span data-stu-id="7b720-154">Integrating the Map with the Details View</span></span>

<span data-ttu-id="7b720-155">Po zintegrowaniu mapy z naszymi scenariuszami tworzenia i edytowania można także zintegrować ją z naszym scenariuszem szczegółowym.</span><span class="sxs-lookup"><span data-stu-id="7b720-155">Now that we have the map integrated with our Create and Edit scenarios, let's also integrate it with our Details scenario.</span></span> <span data-ttu-id="7b720-156">Wszystko, czego potrzebujemy do wywołania &lt;% html. RenderPartial ("map"); %&gt; w widoku szczegółów.</span><span class="sxs-lookup"><span data-stu-id="7b720-156">All we need to-do is to call &lt;% Html.RenderPartial("map"); %&gt; within the Details view.</span></span>

<span data-ttu-id="7b720-157">Poniżej przedstawiono sposób, w jaki kod źródłowy do pełnego widoku szczegółów (z integracją mapy) wygląda następująco:</span><span class="sxs-lookup"><span data-stu-id="7b720-157">Below is what the source code to the complete Details view (with map integration) looks like:</span></span>

[!code-aspx[Main](use-ajax-to-implement-mapping-scenarios/samples/sample6.aspx)]

<span data-ttu-id="7b720-158">A teraz, gdy użytkownik nawiguje do adresu URL/Dinners/Details/[ID], zobaczymy szczegółowe informacje o kolacji, lokalizacji obiadu na mapie (wykonane z użyciem wypychanego numeru PIN, gdy wskaźnik myszy zostanie wyświetlony w polu Tytuł obiadu i jego adres), a następnie masz link AJAX do RSVP:</span><span class="sxs-lookup"><span data-stu-id="7b720-158">And now when a user navigates to a /Dinners/Details/[id] URL they'll see details about the dinner, the location of the dinner on the map (complete with a push-pin that when hovered over displays the title of the dinner and the address of it), and have an AJAX link to RSVP for it:</span></span>

![](use-ajax-to-implement-mapping-scenarios/_static/image6.png)

### <a name="implementing-location-search-in-our-database-and-repository"></a><span data-ttu-id="7b720-159">Implementowanie wyszukiwania lokalizacji w naszej bazie danych i repozytorium</span><span class="sxs-lookup"><span data-stu-id="7b720-159">Implementing Location Search in our Database and Repository</span></span>

<span data-ttu-id="7b720-160">Aby zakończyć naszą implementację technologii AJAX, dodajmy mapę do strony głównej aplikacji, która umożliwia użytkownikom graficzne wyszukiwanie obiadów w sąsiedztwie.</span><span class="sxs-lookup"><span data-stu-id="7b720-160">To finish off our AJAX implementation, let's add a Map to the home page of the application that allows users to graphically search for dinners near them.</span></span>

![](use-ajax-to-implement-mapping-scenarios/_static/image7.png)

<span data-ttu-id="7b720-161">Zaczniemy od zaimplementowania obsługi bazy danych i warstwy repozytorium danych w celu wydajnego przeprowadzenia wyszukiwania za pomocą usługi RADIUS na podstawie lokalizacji.</span><span class="sxs-lookup"><span data-stu-id="7b720-161">We'll begin by implementing support within our database and data repository layer to efficiently perform a location-based radius search for Dinners.</span></span> <span data-ttu-id="7b720-162">Możemy użyć nowych [funkcji geoprzestrzennych programu sql 2008](https://www.microsoft.com/sqlserver/2008/en/us/spatial-data.aspx) do wdrożenia tego rozwiązania lub alternatywnie użyć podejścia do funkcji SQL, które Obserwuj Dryden omówione w artykule: [http://www.codeproject.com/KB/cs/distancebetweenlocations.aspx](http://www.codeproject.com/KB/cs/distancebetweenlocations.aspx) i robname Blogged dotyczące używania z usługą with LINQ to SQL tutaj: [http://blog.wekeroad.com/2007/08/30/linq-and-geocoding/](http://blog.wekeroad.com/2007/08/30/linq-and-geocoding/)</span><span class="sxs-lookup"><span data-stu-id="7b720-162">We could use the new [geospatial features of SQL 2008](https://www.microsoft.com/sqlserver/2008/en/us/spatial-data.aspx) to implement this, or alternatively we can use a SQL function approach that Gary Dryden discussed in article here: [http://www.codeproject.com/KB/cs/distancebetweenlocations.aspx](http://www.codeproject.com/KB/cs/distancebetweenlocations.aspx) and Rob Conery blogged about using with LINQ to SQL here: [http://blog.wekeroad.com/2007/08/30/linq-and-geocoding/](http://blog.wekeroad.com/2007/08/30/linq-and-geocoding/)</span></span>

<span data-ttu-id="7b720-163">Do zaimplementowania tej techniki zostanie otwarty "Eksplorator serwera" w programie Visual Studio, wybierz bazę danych NerdDinner, a następnie kliknij prawym przyciskiem myszy węzeł podrzędne "Functions" w obszarze IT i wybierz polecenie, aby utworzyć nową "funkcję zwracającą wartość skalarną":</span><span class="sxs-lookup"><span data-stu-id="7b720-163">To implement this technique, we will open the "Server Explorer" within Visual Studio, select the NerdDinner database, and then right-click on the "functions" sub-node under it and choose to create a new "Scalar-valued function":</span></span>

![](use-ajax-to-implement-mapping-scenarios/_static/image8.png)

<span data-ttu-id="7b720-164">Następnie wkleimy następujące funkcje DistanceBetween:</span><span class="sxs-lookup"><span data-stu-id="7b720-164">We'll then paste in the following DistanceBetween function:</span></span>

[!code-sql[Main](use-ajax-to-implement-mapping-scenarios/samples/sample7.sql)]

<span data-ttu-id="7b720-165">Następnie utworzymy nową funkcję zwracającą tabelę w SQL Server, że wywołamy "NearestDinners":</span><span class="sxs-lookup"><span data-stu-id="7b720-165">We'll then create a new table-valued function in SQL Server that we'll call "NearestDinners":</span></span>

![](use-ajax-to-implement-mapping-scenarios/_static/image9.png)

<span data-ttu-id="7b720-166">Ta funkcja tabeli "NearestDinners" korzysta z funkcji pomocnika DistanceBetween w celu zwrócenia wszystkich obiadów w ciągu 100 kilometrów długości geograficznej i dostosowanej przez nas wartości:</span><span class="sxs-lookup"><span data-stu-id="7b720-166">This "NearestDinners" table function uses the DistanceBetween helper function to return all Dinners within 100 miles of the latitude and longitude we supply it:</span></span>

[!code-sql[Main](use-ajax-to-implement-mapping-scenarios/samples/sample8.sql)]

<span data-ttu-id="7b720-167">Aby wywołać tę funkcję, najpierw otwieramy projektanta LINQ to SQL, klikając dwukrotnie plik NerdDinner. dbml w naszym katalogu \Models:</span><span class="sxs-lookup"><span data-stu-id="7b720-167">To call this function, we'll first open up the LINQ to SQL designer by double-clicking on the NerdDinner.dbml file within our \Models directory:</span></span>

![](use-ajax-to-implement-mapping-scenarios/_static/image10.png)

<span data-ttu-id="7b720-168">Następnie przeciągniemy funkcje NearestDinners i DistanceBetween do projektanta LINQ to SQL, co spowoduje, że zostaną dodane jako metody klasy LINQ to SQL NerdDinnerDataContext:</span><span class="sxs-lookup"><span data-stu-id="7b720-168">We'll then drag the NearestDinners and DistanceBetween functions onto the LINQ to SQL designer, which will cause them to be added as methods on our LINQ to SQL NerdDinnerDataContext class:</span></span>

![](use-ajax-to-implement-mapping-scenarios/_static/image11.png)

<span data-ttu-id="7b720-169">Następnie możemy uwidocznić metodę zapytania "FindByLocation" w klasie DinnerRepository, która korzysta z funkcji NearestDinner w celu zwrócenia nadchodzących obiadów, które znajdują się w odległości 100 kilometrów w określonej lokalizacji:</span><span class="sxs-lookup"><span data-stu-id="7b720-169">We can then expose a "FindByLocation" query method on our DinnerRepository class that uses the NearestDinner function to return upcoming Dinners that are within 100 miles of the specified location:</span></span>

[!code-csharp[Main](use-ajax-to-implement-mapping-scenarios/samples/sample9.cs)]

### <a name="implementing-a-json-based-ajax-search-action-method"></a><span data-ttu-id="7b720-170">Implementacja metody akcji wyszukiwania AJAX opartej na notacji JSON</span><span class="sxs-lookup"><span data-stu-id="7b720-170">Implementing a JSON-based AJAX Search Action Method</span></span>

<span data-ttu-id="7b720-171">Teraz implementujmy metodę akcji kontrolera, która wykorzystuje nową metodę repozytorium FindByLocation () w celu zwrócenia listy danych obiadu, których można użyć do wypełnienia mapy.</span><span class="sxs-lookup"><span data-stu-id="7b720-171">We'll now implement a controller action method that takes advantage of the new FindByLocation() repository method to return back a list of Dinner data that can be used to populate a map.</span></span> <span data-ttu-id="7b720-172">Ta metoda akcji zwraca z powrotem dane obiadu w formacie JSON (JavaScript Object Notation), dzięki czemu będzie można łatwo manipulować przy użyciu języka JavaScript na kliencie.</span><span class="sxs-lookup"><span data-stu-id="7b720-172">We'll have this action method return back the Dinner data in a JSON (JavaScript Object Notation) format so that it can be easily manipulated using JavaScript on the client.</span></span>

<span data-ttu-id="7b720-173">Aby zaimplementować ten element, utworzymy nową klasę "SearchController", klikając prawym przyciskiem myszy katalog \Controllers i wybierając polecenie menu Dodaj kontroler&gt;.</span><span class="sxs-lookup"><span data-stu-id="7b720-173">To implement this, we'll create a new "SearchController" class by right-clicking on the \Controllers directory and choosing the Add-&gt;Controller menu command.</span></span> <span data-ttu-id="7b720-174">Następnie zaimplementujemy metodę akcji "SearchByLocation" w nowej klasie SearchController podobnej do następującej:</span><span class="sxs-lookup"><span data-stu-id="7b720-174">We'll then implement a "SearchByLocation" action method within the new SearchController class like below:</span></span>

[!code-csharp[Main](use-ajax-to-implement-mapping-scenarios/samples/sample10.cs)]

<span data-ttu-id="7b720-175">Metoda akcji SearchByLocation SearchController wewnętrznie wywołuje metodę FindByLocation na DinnerRepository, aby uzyskać listę pobliskich obiadów.</span><span class="sxs-lookup"><span data-stu-id="7b720-175">The SearchController's SearchByLocation action method internally calls the FindByLocation method on DinnerRepository to get a list of nearby dinners.</span></span> <span data-ttu-id="7b720-176">Zamiast zwracać obiekty obiadu bezpośrednio do klienta, ale zamiast tego zwraca obiekty JsonDinner.</span><span class="sxs-lookup"><span data-stu-id="7b720-176">Rather than return the Dinner objects directly to the client, though, it instead returns JsonDinner objects.</span></span> <span data-ttu-id="7b720-177">Klasa JsonDinner uwidacznia podzestaw właściwości obiadu (na przykład: ze względów bezpieczeństwa nie ujawniają nazwiska osób, które mają zaproszenie na obiad).</span><span class="sxs-lookup"><span data-stu-id="7b720-177">The JsonDinner class exposes a subset of Dinner properties (for example: for security reasons it doesn't disclose the names of the people who have RSVP'd for a dinner).</span></span> <span data-ttu-id="7b720-178">Zawiera również właściwość RSVPCount, która nie istnieje na obiadu — i która jest obliczana dynamicznie przez liczenie obiektów RSVP skojarzonych z określonym obiadem.</span><span class="sxs-lookup"><span data-stu-id="7b720-178">It also includes an RSVPCount property that doesn't exist on Dinner– and which is dynamically calculated by counting the number of RSVP objects associated with a particular dinner.</span></span>

<span data-ttu-id="7b720-179">Następnie korzystamy z metody pomocnika JSON () w klasie podstawowej kontrolera, aby zwrócić sekwencję obiadów przy użyciu formatu sieci opartego na notacji JSON.</span><span class="sxs-lookup"><span data-stu-id="7b720-179">We are then using the Json() helper method on the Controller base class to return the sequence of dinners using a JSON-based wire format.</span></span> <span data-ttu-id="7b720-180">JSON to standardowy format tekstowy służący do reprezentowania prostych struktur danych.</span><span class="sxs-lookup"><span data-stu-id="7b720-180">JSON is a standard text format for representing simple data-structures.</span></span> <span data-ttu-id="7b720-181">Poniżej znajduje się przykładowa lista dwóch obiektów JsonDinner w formacie JSON, które wyglądają jak w przypadku powrotu z naszej metody działania:</span><span class="sxs-lookup"><span data-stu-id="7b720-181">Below is an example of what a JSON-formatted list of two JsonDinner objects looks like when returned from our action method:</span></span>

[!code-json[Main](use-ajax-to-implement-mapping-scenarios/samples/sample11.json)]

### <a name="calling-the-json-based-ajax-method-using-jquery"></a><span data-ttu-id="7b720-182">Wywoływanie metody AJAX opartej na notacji JSON przy użyciu jQuery</span><span class="sxs-lookup"><span data-stu-id="7b720-182">Calling the JSON-based AJAX method using jQuery</span></span>

<span data-ttu-id="7b720-183">Teraz można przystąpić do aktualizowania strony głównej aplikacji NerdDinner, aby używać metody akcji SearchByLocation SearchController.</span><span class="sxs-lookup"><span data-stu-id="7b720-183">We are now ready to update the home page of the NerdDinner application to use the SearchController's SearchByLocation action method.</span></span> <span data-ttu-id="7b720-184">Aby to zrobić, otworzymy szablon widoku/Views/Home/Index.aspx i zaktualizujesz go do postaci TextBox, przycisku wyszukiwania, naszej mapy i &lt;DIV&gt; elementu o nazwie dinnerList:</span><span class="sxs-lookup"><span data-stu-id="7b720-184">To-do this, we'll open the /Views/Home/Index.aspx view template and update it to have a textbox, search button, our map, and a &lt;div&gt; element named dinnerList:</span></span>

[!code-aspx[Main](use-ajax-to-implement-mapping-scenarios/samples/sample12.aspx)]

<span data-ttu-id="7b720-185">Następnie możemy dodać dwie funkcje JavaScript do strony:</span><span class="sxs-lookup"><span data-stu-id="7b720-185">We can then add two JavaScript functions to the page:</span></span>

[!code-html[Main](use-ajax-to-implement-mapping-scenarios/samples/sample13.html)]

<span data-ttu-id="7b720-186">Pierwsza funkcja JavaScript ładuje mapę podczas pierwszego ładowania strony.</span><span class="sxs-lookup"><span data-stu-id="7b720-186">The first JavaScript function loads the map when the page first loads.</span></span> <span data-ttu-id="7b720-187">Druga funkcja JavaScript dzieli na przycisk programu obsługi zdarzeń w języku JavaScript.</span><span class="sxs-lookup"><span data-stu-id="7b720-187">The second JavaScript function wires up a JavaScript click event handler on the search button.</span></span> <span data-ttu-id="7b720-188">Po naciśnięciu przycisku wywołuje funkcję języka JavaScript FindDinnersGivenLocation (), którą dodamy do naszego pliku map. js:</span><span class="sxs-lookup"><span data-stu-id="7b720-188">When the button is pressed it calls the FindDinnersGivenLocation() JavaScript function which we'll add to our Map.js file:</span></span>

[!code-javascript[Main](use-ajax-to-implement-mapping-scenarios/samples/sample14.js)]

<span data-ttu-id="7b720-189">Ta mapowanie wywołań funkcji FindDinnersGivenLocation (). Znajdź () w kontrolce Virtual Earth, aby wyśrodkować ją w podanej lokalizacji.</span><span class="sxs-lookup"><span data-stu-id="7b720-189">This FindDinnersGivenLocation() function calls map.Find() on the Virtual Earth Control to center it on the entered location.</span></span> <span data-ttu-id="7b720-190">Gdy usługa mapy usługi Virtual Earth zwróci wartość, mapa. Metoda Find () wywołuje metodę wywołania zwrotnego callbackUpdateMapDinners, która została przez nas przeniesiona jako argument końcowy.</span><span class="sxs-lookup"><span data-stu-id="7b720-190">When the virtual earth map service returns, the map.Find() method invokes the callbackUpdateMapDinners callback method we passed it as the final argument.</span></span>

<span data-ttu-id="7b720-191">Metoda callbackUpdateMapDinners () to miejsce, w którym wykonywane są rzeczywiste prace.</span><span class="sxs-lookup"><span data-stu-id="7b720-191">The callbackUpdateMapDinners() method is where the real work is done.</span></span> <span data-ttu-id="7b720-192">Używa metody pomocnika $. post () platformy jQuery do wykonania wywołania AJAX do metody akcji SearchByLocation () SearchController (), przekazując ją do szerokości i długości geograficznej nowo wyśrodkowanej mapy.</span><span class="sxs-lookup"><span data-stu-id="7b720-192">It uses jQuery's $.post() helper method to perform an AJAX call to our SearchController's SearchByLocation() action method – passing it the latitude and longitude of the newly centered map.</span></span> <span data-ttu-id="7b720-193">Definiuje wbudowaną funkcję, która będzie wywoływana po zakończeniu metody pomocnika $. post (), a wyniki obiadu w formacie JSON zwrócone z metody akcji SearchByLocation () zostaną przesłane przy użyciu zmiennej o nazwie "obiady".</span><span class="sxs-lookup"><span data-stu-id="7b720-193">It defines an inline function that will be called when the $.post() helper method completes, and the JSON-formatted dinner results returned from the SearchByLocation() action method will be passed it using a variable called "dinners".</span></span> <span data-ttu-id="7b720-194">Następnie wykonuje instrukcję foreach dla każdego zwróconego obiadu i używa szerokości i długości geograficznej obiadu oraz innych właściwości, aby dodać nowy numer PIN na mapie.</span><span class="sxs-lookup"><span data-stu-id="7b720-194">It then does a foreach over each returned dinner, and uses the dinner's latitude and longitude and other properties to add a new pin on the map.</span></span> <span data-ttu-id="7b720-195">Dodaje także wpis z obiadu do listy HTML obiadów z prawej strony mapy.</span><span class="sxs-lookup"><span data-stu-id="7b720-195">It also adds a dinner entry to the HTML list of dinners to the right of the map.</span></span> <span data-ttu-id="7b720-196">Następnie tworzy okablowanie, aby wyświetlić szczegółowe informacje o kolacji dla wszystkich pinezki i listę HTML, dzięki czemu szczegóły dotyczące obiadu są wyświetlane po umieszczeniu na nim wskaźnika myszy:</span><span class="sxs-lookup"><span data-stu-id="7b720-196">It then wires-up a hover event for both the pushpins and the HTML list so that details about the dinner are displayed when a user hovers over them:</span></span>

[!code-html[Main](use-ajax-to-implement-mapping-scenarios/samples/sample15.html)]

<span data-ttu-id="7b720-197">A teraz, gdy uruchomimy aplikację i odwiedź stronę główną, zostanie wyświetlona mapa.</span><span class="sxs-lookup"><span data-stu-id="7b720-197">And now when we run the application and visit the home-page we'll be presented with a map.</span></span> <span data-ttu-id="7b720-198">Gdy wprowadzimy nazwę miasta, mapa będzie wyświetlać nadchodzące obiady w najbliższym czasie:</span><span class="sxs-lookup"><span data-stu-id="7b720-198">When we enter the name of a city the map will display the upcoming dinners near it:</span></span>

![](use-ajax-to-implement-mapping-scenarios/_static/image12.png)

<span data-ttu-id="7b720-199">Umieszczenie wskaźnika na obiadu spowoduje wyświetlenie szczegółowych informacji o nim.</span><span class="sxs-lookup"><span data-stu-id="7b720-199">Hovering over a dinner will display details about it.</span></span>

<span data-ttu-id="7b720-200">Kliknięcie tytułu obiadu w dymku lub po prawej stronie na liście HTML spowoduje przejście do obiadu, a następnie opcjonalnego protokołu RSVP dla:</span><span class="sxs-lookup"><span data-stu-id="7b720-200">Clicking the Dinner title either in the bubble or on the right-hand side in the HTML list will navigate us to the dinner – which we can then optionally RSVP for:</span></span>

![](use-ajax-to-implement-mapping-scenarios/_static/image13.png)

### <a name="next-step"></a><span data-ttu-id="7b720-201">Następny krok</span><span class="sxs-lookup"><span data-stu-id="7b720-201">Next Step</span></span>

<span data-ttu-id="7b720-202">Teraz wdrożono wszystkie funkcje aplikacji aplikacji NerdDinner.</span><span class="sxs-lookup"><span data-stu-id="7b720-202">We've now implemented all the application functionality of our NerdDinner application.</span></span> <span data-ttu-id="7b720-203">Teraz przyjrzyjmy się sposobom, w jaki możemy włączyć zautomatyzowane testowanie jednostkowe.</span><span class="sxs-lookup"><span data-stu-id="7b720-203">Let's now look at how we can enable automated unit testing of it.</span></span>

> [!div class="step-by-step"]
> <span data-ttu-id="7b720-204">[Poprzednie](use-ajax-to-deliver-dynamic-updates.md)
> [dalej](enable-automated-unit-testing.md)</span><span class="sxs-lookup"><span data-stu-id="7b720-204">[Previous](use-ajax-to-deliver-dynamic-updates.md)
[Next](enable-automated-unit-testing.md)</span></span>
