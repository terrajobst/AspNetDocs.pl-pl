---
title: Zarządzanie kluczami w programie ASP.NET Core
author: rick-anderson
description: Dowiedz się, szczegóły implementacji interfejsów API zarządzania kluczami ochrony danych programu ASP.NET Core.
ms.author: riande
ms.date: 10/14/2016
uid: security/data-protection/implementation/key-management
ms.openlocfilehash: 431bdf2d3076c83279b78f327ddb647f69e6e584
ms.sourcegitcommit: 24b1f6decbb17bb22a45166e5fdb0845c65af498
ms.translationtype: MT
ms.contentlocale: pl-PL
ms.lasthandoff: 03/01/2019
ms.locfileid: "57071411"
---
# <a name="key-management-in-aspnet-core"></a><span data-ttu-id="3dfdd-103">Zarządzanie kluczami w programie ASP.NET Core</span><span class="sxs-lookup"><span data-stu-id="3dfdd-103">Key management in ASP.NET Core</span></span>

<a name="data-protection-implementation-key-management"></a>

<span data-ttu-id="3dfdd-104">System ochrony danych automatycznie zarządza czasem istnienia kluczy głównych używany do włączania i wyłączania ochrony ładunków.</span><span class="sxs-lookup"><span data-stu-id="3dfdd-104">The data protection system automatically manages the lifetime of master keys used to protect and unprotect payloads.</span></span> <span data-ttu-id="3dfdd-105">Każdy klucz może znajdować się w jednej z czterech etapów:</span><span class="sxs-lookup"><span data-stu-id="3dfdd-105">Each key can exist in one of four stages:</span></span>

* <span data-ttu-id="3dfdd-106">Utworzony — klucz istnieje w pierścienia klucza, ale nie został jeszcze aktywowany.</span><span class="sxs-lookup"><span data-stu-id="3dfdd-106">Created - the key exists in the key ring but has not yet been activated.</span></span> <span data-ttu-id="3dfdd-107">Klucz nie powinien służyć do nowych operacji ochrony przed upływem wystarczająco dużo czasu, klucz miała szansę zostanie rozpropagowany do wszystkich maszyn, które zużywają ten pierścień klucza.</span><span class="sxs-lookup"><span data-stu-id="3dfdd-107">The key shouldn't be used for new Protect operations until sufficient time has elapsed that the key has had a chance to propagate to all machines that are consuming this key ring.</span></span>

* <span data-ttu-id="3dfdd-108">Aktywny - klucz istnieje w pierścieniu klucza i powinien być używany dla wszystkich nowych operacji ochrony.</span><span class="sxs-lookup"><span data-stu-id="3dfdd-108">Active - the key exists in the key ring and should be used for all new Protect operations.</span></span>

* <span data-ttu-id="3dfdd-109">Wygasłe — klucz zostało uruchomione istnienia naturalnych i nie będzie używać dla nowych operacji ochrony.</span><span class="sxs-lookup"><span data-stu-id="3dfdd-109">Expired - the key has run its natural lifetime and should no longer be used for new Protect operations.</span></span>

* <span data-ttu-id="3dfdd-110">Odwołane - klucz zostanie naruszony i nie może być używany dla nowych operacji ochrony.</span><span class="sxs-lookup"><span data-stu-id="3dfdd-110">Revoked - the key is compromised and must not be used for new Protect operations.</span></span>

<span data-ttu-id="3dfdd-111">Utworzone, aktywnych i wygasłe klucze może być używane do wyłączanie ochrony ładunków, przychodzących.</span><span class="sxs-lookup"><span data-stu-id="3dfdd-111">Created, active, and expired keys may all be used to unprotect incoming payloads.</span></span> <span data-ttu-id="3dfdd-112">Odwołane kluczy domyślnie nie mogą służyć do wyłączanie ochrony ładunków, ale Deweloper aplikacji może [zastąpienia tego zachowania](xref:security/data-protection/consumer-apis/dangerous-unprotect#data-protection-consumer-apis-dangerous-unprotect) w razie potrzeby.</span><span class="sxs-lookup"><span data-stu-id="3dfdd-112">Revoked keys by default may not be used to unprotect payloads, but the application developer can [override this behavior](xref:security/data-protection/consumer-apis/dangerous-unprotect#data-protection-consumer-apis-dangerous-unprotect) if necessary.</span></span>

>[!WARNING]
> <span data-ttu-id="3dfdd-113">Deweloper może być uznasz, że można usunąć klucza z kluczem pierścienia (np. poprzez usunięcie odpowiedniego pliku z systemu plików).</span><span class="sxs-lookup"><span data-stu-id="3dfdd-113">The developer might be tempted to delete a key from the key ring (e.g., by deleting the corresponding file from the file system).</span></span> <span data-ttu-id="3dfdd-114">W tym momencie wszystkich danych chronionych za pomocą klucza jest trwale zapisane, a istnieje żadne przesłonięcie awaryjnego, tak jak ma to przy użyciu kluczy odwołane.</span><span class="sxs-lookup"><span data-stu-id="3dfdd-114">At that point, all data protected by the key is permanently undecipherable, and there's no emergency override like there's with revoked keys.</span></span> <span data-ttu-id="3dfdd-115">Usuwanie klucza jest naprawdę destrukcyjne zachowanie i w związku z tym system ochrony danych uwidacznia żadnych najwyższej klasy interfejsów API do wykonania tej operacji.</span><span class="sxs-lookup"><span data-stu-id="3dfdd-115">Deleting a key is truly destructive behavior, and consequently the data protection system exposes no first-class API for performing this operation.</span></span>

## <a name="default-key-selection"></a><span data-ttu-id="3dfdd-116">Domyślny wybór klucza</span><span class="sxs-lookup"><span data-stu-id="3dfdd-116">Default key selection</span></span>

<span data-ttu-id="3dfdd-117">Gdy system ochrony danych odczytuje pierścień klucza z repozytorium zapasowy, jej będzie podejmować próby zlokalizowania klucza "default" z pierścienia klucza.</span><span class="sxs-lookup"><span data-stu-id="3dfdd-117">When the data protection system reads the key ring from the backing repository, it will attempt to locate a "default" key from the key ring.</span></span> <span data-ttu-id="3dfdd-118">Domyślny klucz jest używany dla nowych operacji ochrony.</span><span class="sxs-lookup"><span data-stu-id="3dfdd-118">The default key is used for new Protect operations.</span></span>

<span data-ttu-id="3dfdd-119">Ogólny Algorytm heurystyczny jest, że system ochrony danych wybierze klucz z najbardziej aktualną datę aktywacji jako domyślnego klucza.</span><span class="sxs-lookup"><span data-stu-id="3dfdd-119">The general heuristic is that the data protection system chooses the key with the most recent activation date as the default key.</span></span> <span data-ttu-id="3dfdd-120">(Brak jest współczynnik małych grę fudge, aby umożliwić zegara serwer serwer pochylenia). Jeśli klucz jest wygasłe lub odwołane, i jeśli aplikacja nie została wyłączona automatyczna klucza generacji, a następnie zostanie wygenerowany nowy klucz za pomocą natychmiastowej aktywacji na [klucza wygaśnięcia i wycofania](xref:security/data-protection/implementation/key-management#data-protection-implementation-key-management-expiration) zasad poniżej.</span><span class="sxs-lookup"><span data-stu-id="3dfdd-120">(There's a small fudge factor to allow for server-to-server clock skew.) If the key is expired or revoked, and if the application has not disabled automatic key generation, then a new key will be generated with immediate activation per the [key expiration and rolling](xref:security/data-protection/implementation/key-management#data-protection-implementation-key-management-expiration) policy below.</span></span>

<span data-ttu-id="3dfdd-121">Przyczyna system ochrony danych natychmiast generuje nowy klucz, a nie nastąpi powrót do innego klucza jest, że wygenerowanie nowego klucza powinny być traktowane jako niejawne okresu wszystkie klucze, które zostały aktywowane przed nowego klucza.</span><span class="sxs-lookup"><span data-stu-id="3dfdd-121">The reason the data protection system generates a new key immediately rather than falling back to a different key is that new key generation should be treated as an implicit expiration of all keys that were activated prior to the new key.</span></span> <span data-ttu-id="3dfdd-122">Ogólne chodzi o to, że nowe klucze zostały skonfigurowane przy użyciu różnych algorytmów lub mechanizmów szyfrowania podczas spoczynku niż starych kluczy, a system powinien Preferuj bieżącej konfiguracji przed powrotem.</span><span class="sxs-lookup"><span data-stu-id="3dfdd-122">The general idea is that new keys may have been configured with different algorithms or encryption-at-rest mechanisms than old keys, and the system should prefer the current configuration over falling back.</span></span>

<span data-ttu-id="3dfdd-123">Występuje wyjątek.</span><span class="sxs-lookup"><span data-stu-id="3dfdd-123">There's an exception.</span></span> <span data-ttu-id="3dfdd-124">Jeśli Deweloper aplikacji ma [wyłączyć automatyczne generowanie klucza](xref:security/data-protection/configuration/overview#disableautomatickeygeneration), a następnie system ochrony danych, musisz wybrać coś jako domyślnego klucza.</span><span class="sxs-lookup"><span data-stu-id="3dfdd-124">If the application developer has [disabled automatic key generation](xref:security/data-protection/configuration/overview#disableautomatickeygeneration), then the data protection system must choose something as the default key.</span></span> <span data-ttu-id="3dfdd-125">W tym scenariuszu rezerwowy system wybierze klucz odwołać się najbardziej aktualną datę aktywacji, z preferencją kluczy, których czas propagacji dla innych maszyn w klastrze.</span><span class="sxs-lookup"><span data-stu-id="3dfdd-125">In this fallback scenario, the system will choose the non-revoked key with the most recent activation date, with preference given to keys that have had time to propagate to other machines in the cluster.</span></span> <span data-ttu-id="3dfdd-126">System rezerwowy może pozostać w wyniku wybór domyślny wygasły klucz.</span><span class="sxs-lookup"><span data-stu-id="3dfdd-126">The fallback system may end up choosing an expired default key as a result.</span></span> <span data-ttu-id="3dfdd-127">System rezerwowy nigdy nie wybierze odwołanych klucza jako klucza domyślne, a pierścień klucza jest pusta lub za każdy klucz został odwołany. następnie systemu powoduje wygenerowanie błędu po zainicjowaniu.</span><span class="sxs-lookup"><span data-stu-id="3dfdd-127">The fallback system will never choose a revoked key as the default key, and if the key ring is empty or every key has been revoked then the system will produce an error upon initialization.</span></span>

<a name="data-protection-implementation-key-management-expiration"></a>

## <a name="key-expiration-and-rolling"></a><span data-ttu-id="3dfdd-128">Data wygaśnięcia klucza i wycofania</span><span class="sxs-lookup"><span data-stu-id="3dfdd-128">Key expiration and rolling</span></span>

<span data-ttu-id="3dfdd-129">Gdy klucz jest tworzony, automatycznie dało się data aktywacji {teraz + 2 dni} i {teraz + 90 dni} datę wygaśnięcia.</span><span class="sxs-lookup"><span data-stu-id="3dfdd-129">When a key is created, it's automatically given an activation date of { now + 2 days } and an expiration date of { now + 90 days }.</span></span> <span data-ttu-id="3dfdd-130">2-dniowym opóźnieniem aktywacji zapewnia klucza czasu propagowane przez system.</span><span class="sxs-lookup"><span data-stu-id="3dfdd-130">The 2-day delay before activation gives the key time to propagate through the system.</span></span> <span data-ttu-id="3dfdd-131">Oznacza to, że umożliwia innym aplikacjom wskazującej na magazyn zapasowy przestrzegać klucz ich następnego okresu automatyczne odświeżanie, maksymalizując prawdopodobieństwo, że po klucz cyklicznego czy stanie się aktywny, który jej zakończeniem propagacji do wszystkich aplikacji, które może być konieczne jej używać.</span><span class="sxs-lookup"><span data-stu-id="3dfdd-131">That is, it allows other applications pointing at the backing store to observe the key at their next auto-refresh period, thus maximizing the chances that when the key ring does become active it has propagated to all applications that might need to use it.</span></span>

<span data-ttu-id="3dfdd-132">Domyślny klucz wygaśnie w ciągu 2 dni i pierścień klucz jeszcze jej nie ma klucza, który będzie aktywny po upływie domyślnego klucza, w system ochrony danych będzie automatycznie umieszczony nowy klucz do pierścienia klucza.</span><span class="sxs-lookup"><span data-stu-id="3dfdd-132">If the default key will expire within 2 days and if the key ring doesn't already have a key that will be active upon expiration of the default key, then the data protection system will automatically persist a new key to the key ring.</span></span> <span data-ttu-id="3dfdd-133">Ten nowy klucz ma Data aktywacji {Data wygaśnięcia domyślny klucz} i {teraz + 90 dni} datę wygaśnięcia.</span><span class="sxs-lookup"><span data-stu-id="3dfdd-133">This new key has an activation date of { default key's expiration date } and an expiration date of { now + 90 days }.</span></span> <span data-ttu-id="3dfdd-134">Dzięki temu system automatycznie przeprowadzić kluczy na bieżąco z nie przerw w działaniu usług.</span><span class="sxs-lookup"><span data-stu-id="3dfdd-134">This allows the system to automatically roll keys on a regular basis with no interruption of service.</span></span>

<span data-ttu-id="3dfdd-135">Mogą istnieć okoliczności gdzie klucz zostanie utworzony za pomocą natychmiastowej aktywacji.</span><span class="sxs-lookup"><span data-stu-id="3dfdd-135">There might be circumstances where a key will be created with immediate activation.</span></span> <span data-ttu-id="3dfdd-136">Jeden przykładem może być, gdy aplikacja nie zostało uruchomione przez czas wszystkie klucze w pierścienia klucz wygasł.</span><span class="sxs-lookup"><span data-stu-id="3dfdd-136">One example would be when the application hasn't run for a time and all keys in the key ring are expired.</span></span> <span data-ttu-id="3dfdd-137">W takim przypadku klucza jest podana data aktywacji {teraz} niezwłocznie normalne 2-dniowych aktywacji.</span><span class="sxs-lookup"><span data-stu-id="3dfdd-137">When this happens, the key is given an activation date of { now } without the normal 2-day activation delay.</span></span>

<span data-ttu-id="3dfdd-138">Domyślny okres istnienia klucza jest 90 dni, chociaż jest to można skonfigurować, jak w poniższym przykładzie.</span><span class="sxs-lookup"><span data-stu-id="3dfdd-138">The default key lifetime is 90 days, though this is configurable as in the following example.</span></span>

```csharp
services.AddDataProtection()
       // use 14-day lifetime instead of 90-day lifetime
       .SetDefaultKeyLifetime(TimeSpan.FromDays(14));
```

<span data-ttu-id="3dfdd-139">Administrator można również zmienić domyślne systemowe, chociaż jawnym wywołaniem `SetDefaultKeyLifetime` zastąpią wszelkie zasady systemowe.</span><span class="sxs-lookup"><span data-stu-id="3dfdd-139">An administrator can also change the default system-wide, though an explicit call to `SetDefaultKeyLifetime` will override any system-wide policy.</span></span> <span data-ttu-id="3dfdd-140">Domyślny okres istnienia klucza nie może być krótszy niż 7 dni.</span><span class="sxs-lookup"><span data-stu-id="3dfdd-140">The default key lifetime cannot be shorter than 7 days.</span></span>

## <a name="automatic-key-ring-refresh"></a><span data-ttu-id="3dfdd-141">Odświeżanie automatyczne pierścień klucza</span><span class="sxs-lookup"><span data-stu-id="3dfdd-141">Automatic key ring refresh</span></span>

<span data-ttu-id="3dfdd-142">Gdy system ochrony danych, odczytuje pierścień klucza podstawowego repozytorium i zapisuje go w pamięci podręcznej w pamięci.</span><span class="sxs-lookup"><span data-stu-id="3dfdd-142">When the data protection system initializes, it reads the key ring from the underlying repository and caches it in memory.</span></span> <span data-ttu-id="3dfdd-143">Ta pamięć podręczna umożliwia wykonywanie operacji Chroń i Unprotect kontynuować bez osiągnięcia magazyn zapasowy.</span><span class="sxs-lookup"><span data-stu-id="3dfdd-143">This cache allows Protect and Unprotect operations to proceed without hitting the backing store.</span></span> <span data-ttu-id="3dfdd-144">System automatycznie sprawdzi magazyn zapasowy zmiany mniej więcej co 24 godziny lub po upływie bieżącego klucza domyślne osiągnięta jako pierwsza.</span><span class="sxs-lookup"><span data-stu-id="3dfdd-144">The system will automatically check the backing store for changes approximately every 24 hours or when the current default key expires, whichever comes first.</span></span>

>[!WARNING]
> <span data-ttu-id="3dfdd-145">Deweloperzy powinien bardzo rzadko (Jeśli w ogóle) trzeba korzystać bezpośrednio zarządzanie kluczami interfejsów API.</span><span class="sxs-lookup"><span data-stu-id="3dfdd-145">Developers should very rarely (if ever) need to use the key management APIs directly.</span></span> <span data-ttu-id="3dfdd-146">System ochrony danych będzie wykonywać automatyczne zarządzanie kluczami, zgodnie z powyższym opisem.</span><span class="sxs-lookup"><span data-stu-id="3dfdd-146">The data protection system will perform automatic key management as described above.</span></span>

<span data-ttu-id="3dfdd-147">System ochrony danych udostępnia interfejs `IKeyManager` który może służyć do sprawdzania i wprowadzić zmiany do pierścienia klucza.</span><span class="sxs-lookup"><span data-stu-id="3dfdd-147">The data protection system exposes an interface `IKeyManager` that can be used to inspect and make changes to the key ring.</span></span> <span data-ttu-id="3dfdd-148">System DI podanym wystąpienie `IDataProtectionProvider` oferuje również wystąpienie `IKeyManager` za użycie.</span><span class="sxs-lookup"><span data-stu-id="3dfdd-148">The DI system that provided the instance of `IDataProtectionProvider` can also provide an instance of `IKeyManager` for your consumption.</span></span> <span data-ttu-id="3dfdd-149">Alternatywnie możesz ściągnąć `IKeyManager` bezpośrednio z `IServiceProvider` tak jak w poniższym przykładzie.</span><span class="sxs-lookup"><span data-stu-id="3dfdd-149">Alternatively, you can pull the `IKeyManager` straight from the `IServiceProvider` as in the example below.</span></span>

<span data-ttu-id="3dfdd-150">Każdej operacji, która modyfikuje pierścień klucza (Tworzenie nowego klucza jawnie lub odwołania) spowoduje unieważnienie w pamięci podręcznej.</span><span class="sxs-lookup"><span data-stu-id="3dfdd-150">Any operation which modifies the key ring (creating a new key explicitly or performing a revocation) will invalidate the in-memory cache.</span></span> <span data-ttu-id="3dfdd-151">Następne wywołanie `Protect` lub `Unprotect` spowoduje, że system ochrony danych, odświeżanie pierścień klucza i ponowne utworzenie pamięci podręcznej.</span><span class="sxs-lookup"><span data-stu-id="3dfdd-151">The next call to `Protect` or `Unprotect` will cause the data protection system to reread the key ring and recreate the cache.</span></span>

<span data-ttu-id="3dfdd-152">Poniższy przykład demonstruje użycie `IKeyManager` interfejs do sprawdzania i manipulowania ring klucza, w tym odwołaniem istniejących kluczy i ręczne Generowanie nowego klucza.</span><span class="sxs-lookup"><span data-stu-id="3dfdd-152">The sample below demonstrates using the `IKeyManager` interface to inspect and manipulate the key ring, including revoking existing keys and generating a new key manually.</span></span>

[!code-csharp[](key-management/samples/key-management.cs)]

## <a name="key-storage"></a><span data-ttu-id="3dfdd-153">Magazyn kluczy</span><span class="sxs-lookup"><span data-stu-id="3dfdd-153">Key storage</span></span>

<span data-ttu-id="3dfdd-154">System ochrony danych ma heurystyki, według którego próbuje automatycznie wywnioskować lokalizacji odpowiedniego magazynu kluczy i mechanizm szyfrowania podczas spoczynku.</span><span class="sxs-lookup"><span data-stu-id="3dfdd-154">The data protection system has a heuristic whereby it attempts to deduce an appropriate key storage location and encryption-at-rest mechanism automatically.</span></span> <span data-ttu-id="3dfdd-155">Mechanizm trwałość klucza jest także można skonfigurować przez dewelopera aplikacji.</span><span class="sxs-lookup"><span data-stu-id="3dfdd-155">The key persistence mechanism is also configurable by the app developer.</span></span> <span data-ttu-id="3dfdd-156">Następujące dokumenty omawia implementacje skrzynkach odbiorczych tych mechanizmów:</span><span class="sxs-lookup"><span data-stu-id="3dfdd-156">The following documents discuss the in-box implementations of these mechanisms:</span></span>

* <xref:security/data-protection/implementation/key-storage-providers>
* <xref:security/data-protection/implementation/key-encryption-at-rest>
